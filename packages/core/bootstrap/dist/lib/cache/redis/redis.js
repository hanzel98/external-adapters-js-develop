"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RedisCache = exports.redactOptions = exports.defaultOptions = void 0;
const tslib_1 = require("tslib");
const promise_timeout_1 = require("promise-timeout");
const redis_1 = require("redis");
const util_1 = require("util");
const external_adapter_1 = require("../../external-adapter");
const metrics = tslib_1.__importStar(require("./metrics"));
// Connection
const DEFAULT_WATCH_INTERVAL = 5000;
const DEFAULT_CACHE_REDIS_HOST = '127.0.0.1'; // IP address of the Redis server
const DEFAULT_CACHE_REDIS_PORT = 6379; // Port of the Redis server
const DEFAULT_CACHE_REDIS_PATH = undefined; // The UNIX socket string of the Redis server
const DEFAULT_CACHE_REDIS_URL = undefined; // The URL of the Redis server
const DEFAULT_CACHE_REDIS_PASSWORD = undefined; // The password required for redis auth
// const DEFAULT_CACHE_REDIS_CONNECTION_TIMEOUT = 15000 // Timeout per long lived connection in ms
const DEFAULT_CACHE_REDIS_REQUEST_TIMEOUT = 3000; // Timeout per request in ms
// const DEFAULT_CACHE_REDIS_INITIAL_DELAY = 30000
// Options
const DEFAULT_CACHE_MAX_AGE = 1000 * 60 * 1.5; // 1.5 minutes
const env = process.env;
const defaultOptions = () => ({
    type: 'redis',
    host: env.CACHE_REDIS_HOST || DEFAULT_CACHE_REDIS_HOST,
    port: Number(env.CACHE_REDIS_PORT) || DEFAULT_CACHE_REDIS_PORT,
    path: env.CACHE_REDIS_PATH || DEFAULT_CACHE_REDIS_PATH,
    url: env.CACHE_REDIS_URL || DEFAULT_CACHE_REDIS_URL,
    password: env.CACHE_REDIS_PASSWORD || DEFAULT_CACHE_REDIS_PASSWORD,
    maxAge: Number(env.CACHE_MAX_AGE) || DEFAULT_CACHE_MAX_AGE,
    timeout: Number(env.CACHE_REDIS_TIMEOUT) || DEFAULT_CACHE_REDIS_REQUEST_TIMEOUT,
    // connect_timeout:
    //   Number(env.CACHE_REDIS_CONNECTION_TIMEOUT) || DEFAULT_CACHE_REDIS_CONNECTION_TIMEOUT,
    // socket_initial_delay: Number(env.CACHE_REDIS_INITIAL_DELAY) || DEFAULT_CACHE_REDIS_INITIAL_DELAY,
});
exports.defaultOptions = defaultOptions;
// Options without sensitive data
const redactOptions = (opts) => {
    if (opts.password)
        opts.password = opts.password.replace(/.+/g, '*****');
    if (opts.url)
        opts.url = opts.url.replace(/:\/\/.+@/g, '://*****@');
    return opts;
};
exports.redactOptions = redactOptions;
const retryStrategy = (options) => {
    metrics.redis_retries_count.inc();
    external_adapter_1.logger.warn('Redis retry strategy activated.', options);
    if (options.error && options.error.code === 'ECONNREFUSED') {
        // End reconnecting on a specific error and flush all commands with
        // a individual error
        external_adapter_1.logger.warn('Connection refused.', options);
        return new Error('The server refused the connection');
    }
    if (options.total_retry_time > 1000 * 60 * 60) {
        // End reconnecting after a specific timeout and flush all commands
        // with a individual error
        external_adapter_1.logger.warn('Redis retry strategy exhausted.', options);
        return new Error('Retry time exhausted');
    }
    if (options.attempt > 10) {
        external_adapter_1.logger.warn(`Redis retry attempt #${options.attempt}`, options);
        return undefined;
    }
    // reconnect after
    return Math.min(options.attempt * 100, 3000);
};
class RedisCache {
    constructor(options) {
        external_adapter_1.logger.info('Creating new redis client instance...');
        this.options = options;
        const client = redis_1.createClient({ ...options, retry_strategy: retryStrategy });
        client.on('error', (err) => external_adapter_1.logger.error('Error connecting to Redis. ', err));
        client.on('end', () => external_adapter_1.logger.error('Redis connection ended.'));
        client.on('connected', () => {
            external_adapter_1.logger.info(`Redis client connected: ${client.connected}`);
        });
        client.on('ready', () => external_adapter_1.logger.info('Redis client ready to serve requests, queued requests will be replayed'));
        this._auth = util_1.promisify(client.auth).bind(client);
        this._get = util_1.promisify(client.get).bind(client);
        this._set = util_1.promisify(client.set).bind(client);
        this._del = util_1.promisify(client.del).bind(client);
        this._quit = util_1.promisify(client.quit).bind(client);
        this._pttl = util_1.promisify(client.pttl).bind(client);
        this.client = client;
    }
    initialize(options) {
        external_adapter_1.logger.info('Re-initializing new redis client instance...');
        const client = redis_1.createClient({ ...options, retry_strategy: retryStrategy });
        client.on('error', (err) => external_adapter_1.logger.error('Error connecting to Redis. ', err));
        client.on('end', () => external_adapter_1.logger.error('Redis connection ended.'));
        this._auth = util_1.promisify(client.auth).bind(client);
        this._get = util_1.promisify(client.get).bind(client);
        this._set = util_1.promisify(client.set).bind(client);
        this._del = util_1.promisify(client.del).bind(client);
        this._quit = util_1.promisify(client.quit).bind(client);
        this._pttl = util_1.promisify(client.pttl).bind(client);
        this.client = client;
    }
    async connect() {
        if (!this.options.password)
            return;
        return this.contextualTimeout(this._auth(this.options.password), 'connect', {
            includedPassword: !!this.options.password,
        });
    }
    async checkHealth() {
        if (this.client.connected) {
            return;
        }
        try {
            this.initialize(this.options);
            this.connect();
        }
        catch (err) {
            external_adapter_1.logger.warn(`Failed to recreate redis client: [${err.message}]`);
        }
    }
    async startWatching() {
        if (this.watchdog)
            this.stopWatching();
        this.watchdog = setInterval(() => this.checkHealth(), DEFAULT_WATCH_INTERVAL);
    }
    async stopWatching() {
        if (this.watchdog)
            clearInterval(this.watchdog);
        this.watchdog = undefined;
    }
    static async build(options) {
        metrics.redis_connections_open.inc();
        const cache = new RedisCache(options);
        cache.startWatching();
        return cache;
    }
    async setResponse(key, value, maxAge) {
        const entry = JSON.stringify(value);
        return await this.contextualTimeout(this._set(key, entry, 'PX', maxAge), 'set', {
            key,
            value,
            maxAge,
        });
    }
    // TODO: We should have seperate services for response entries, and coalescing support
    async setFlightMarker(key, maxAge) {
        return this.contextualTimeout(this._set(key, true, 'PX', maxAge), 'set', {
            key,
            maxAge,
        });
    }
    async getResponse(key) {
        const entry = await this.contextualTimeout(this._get(key), 'get', { key });
        return JSON.parse(entry);
    }
    async getFlightMarker(key) {
        const entry = await this.contextualTimeout(this._get(key), 'get', { key });
        return JSON.parse(entry);
    }
    async del(key) {
        return this.contextualTimeout(this._del(key), 'del', { key });
    }
    async ttl(key) {
        // TTL in ms
        return this.contextualTimeout(this._pttl(key), 'ttl', { key });
    }
    /**
     * Forcibly close the connection to the Redis server.
     *
     * AWS Lambda will timeout if the connection is not closed, because the connection
     * keeps the event loop busy.
     *
     * The alternative is to use: `context.callbackWaitsForEmtpyEventLoop = false`
     */
    async close() {
        if (!this.client)
            return;
        try {
            // No further commands will be processed
            this.stopWatching();
            const res = await this.contextualTimeout(this._quit(), 'close', {
                clientExists: !!this.client,
            });
            external_adapter_1.logger.debug(`Redis connection shutdown completed with: ${res}`);
        }
        finally {
            this.client.removeAllListeners();
        }
    }
    async contextualTimeout(promise, fnName, context) {
        try {
            const result = await promise_timeout_1.timeout(promise, this.options.timeout);
            metrics.redis_commands_sent_count
                .labels({ status: metrics.CMD_SENT_STATUS.SUCCESS, function_name: fnName })
                .inc();
            return result;
        }
        catch (e) {
            if (e instanceof promise_timeout_1.TimeoutError) {
                external_adapter_1.logger.error('Redis method timed out, consider increasing CACHE_REDIS_TIMEOUT or increasing your redis instance performance', { fnName, context });
                throw e;
            }
            external_adapter_1.logger.error('Redis method error', { fnName, context });
            metrics.redis_commands_sent_count
                .labels({
                status: metrics.CMD_SENT_STATUS.FAIL,
                function_name: fnName,
            })
                .inc();
            throw e;
        }
    }
}
exports.RedisCache = RedisCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NhY2hlL3JlZGlzL3JlZGlzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxxREFBdUQ7QUFDdkQsaUNBQTRFO0FBQzVFLCtCQUFnQztBQUNoQyw2REFBK0M7QUFFL0MsMkRBQW9DO0FBRXBDLGFBQWE7QUFDYixNQUFNLHNCQUFzQixHQUFHLElBQUksQ0FBQTtBQUNuQyxNQUFNLHdCQUF3QixHQUFHLFdBQVcsQ0FBQSxDQUFDLGlDQUFpQztBQUM5RSxNQUFNLHdCQUF3QixHQUFHLElBQUksQ0FBQSxDQUFDLDJCQUEyQjtBQUNqRSxNQUFNLHdCQUF3QixHQUFHLFNBQVMsQ0FBQSxDQUFDLDZDQUE2QztBQUN4RixNQUFNLHVCQUF1QixHQUFHLFNBQVMsQ0FBQSxDQUFDLDhCQUE4QjtBQUN4RSxNQUFNLDRCQUE0QixHQUFHLFNBQVMsQ0FBQSxDQUFDLHVDQUF1QztBQUN0RixrR0FBa0c7QUFDbEcsTUFBTSxtQ0FBbUMsR0FBRyxJQUFJLENBQUEsQ0FBQyw0QkFBNEI7QUFDN0Usa0RBQWtEO0FBQ2xELFVBQVU7QUFDVixNQUFNLHFCQUFxQixHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsR0FBRyxDQUFBLENBQUMsY0FBYztBQUU1RCxNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFBO0FBSWhCLE1BQU0sY0FBYyxHQUFHLEdBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2pELElBQUksRUFBRSxPQUFPO0lBQ2IsSUFBSSxFQUFFLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSx3QkFBd0I7SUFDdEQsSUFBSSxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUMsSUFBSSx3QkFBd0I7SUFDOUQsSUFBSSxFQUFFLEdBQUcsQ0FBQyxnQkFBZ0IsSUFBSSx3QkFBd0I7SUFDdEQsR0FBRyxFQUFFLEdBQUcsQ0FBQyxlQUFlLElBQUksdUJBQXVC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RSxhQUFhLEVBQUUsTUFBTSxFQUFFLENBQUM7aUJBQzFFLEdBQUcsRUFBRSxDQUFBO1lBQ1IsT0FBTyxNQUFNLENBQUE7U0FDZDtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsSUFBSSxDQUFDLFlBQVksOEJBQVksRUFBRTtnQkFDN0IseUJBQU0sQ0FBQyxLQUFLLENBQ1YsK0dBQStHLEVBQy9HLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxDQUNwQixDQUFBO2dCQUNELE1BQU0sQ0FBQyxDQUFBO2FBQ1I7WUFDRCx5QkFBTSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZELE9BQU8sQ0FBQyx5QkFBeUI7aUJBQzlCLE1BQU0sQ0FBQztnQkFDTixNQUFNLEVBQUUsT0FBTyxDQUFDLGVBQWUsQ0FBQyxJQUFJO2dCQUNwQyxhQUFhLEVBQUUsTUFBTTthQUN0QixDQUFDO2lCQUNELEdBQUcsRUFBRSxDQUFBO1lBQ1IsTUFBTSxDQUFDLENBQUE7U0FDUjtJQUNILENBQUM7Q0FDRjtBQTNLRCxnQ0EyS0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0aW1lb3V0LCBUaW1lb3V0RXJyb3IgfSBmcm9tICdwcm9taXNlLXRpbWVvdXQnXG5pbXBvcnQgeyBDbGllbnRPcHRzLCBjcmVhdGVDbGllbnQsIFJlZGlzQ2xpZW50LCBSZXRyeVN0cmF0ZWd5IH0gZnJvbSAncmVkaXMnXG5pbXBvcnQgeyBwcm9taXNpZnkgfSBmcm9tICd1dGlsJ1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vLi4vZXh0ZXJuYWwtYWRhcHRlcidcbmltcG9ydCB7IENhY2hlRW50cnkgfSBmcm9tICcuLi90eXBlcydcbmltcG9ydCAqIGFzIG1ldHJpY3MgZnJvbSAnLi9tZXRyaWNzJ1xuXG4vLyBDb25uZWN0aW9uXG5jb25zdCBERUZBVUxUX1dBVENIX0lOVEVSVkFMID0gNTAwMFxuY29uc3QgREVGQVVMVF9DQUNIRV9SRURJU19IT1NUID0gJzEyNy4wLjAuMScgLy8gSVAgYWRkcmVzcyBvZiB0aGUgUmVkaXMgc2VydmVyXG5jb25zdCBERUZBVUxUX0NBQ0hFX1JFRElTX1BPUlQgPSA2Mzc5IC8vIFBvcnQgb2YgdGhlIFJlZGlzIHNlcnZlclxuY29uc3QgREVGQVVMVF9DQUNIRV9SRURJU19QQVRIID0gdW5kZWZpbmVkIC8vIFRoZSBVTklYIHNvY2tldCBzdHJpbmcgb2YgdGhlIFJlZGlzIHNlcnZlclxuY29uc3QgREVGQVVMVF9DQUNIRV9SRURJU19VUkwgPSB1bmRlZmluZWQgLy8gVGhlIFVSTCBvZiB0aGUgUmVkaXMgc2VydmVyXG5jb25zdCBERUZBVUxUX0NBQ0hFX1JFRElTX1BBU1NXT1JEID0gdW5kZWZpbmVkIC8vIFRoZSBwYXNzd29yZCByZXF1aXJlZCBmb3IgcmVkaXMgYXV0aFxuLy8gY29uc3QgREVGQVVMVF9DQUNIRV9SRURJU19DT05ORUNUSU9OX1RJTUVPVVQgPSAxNTAwMCAvLyBUaW1lb3V0IHBlciBsb25nIGxpdmVkIGNvbm5lY3Rpb24gaW4gbXNcbmNvbnN0IERFRkFVTFRfQ0FDSEVfUkVESVNfUkVRVUVTVF9USU1FT1VUID0gMzAwMCAvLyBUaW1lb3V0IHBlciByZXF1ZXN0IGluIG1zXG4vLyBjb25zdCBERUZBVUxUX0NBQ0hFX1JFRElTX0lOSVRJQUxfREVMQVkgPSAzMDAwMFxuLy8gT3B0aW9uc1xuY29uc3QgREVGQVVMVF9DQUNIRV9NQVhfQUdFID0gMTAwMCAqIDYwICogMS41IC8vIDEuNSBtaW51dGVzXG5cbmNvbnN0IGVudiA9IHByb2Nlc3MuZW52XG5cbmV4cG9ydCB0eXBlIFJlZGlzT3B0aW9ucyA9IENsaWVudE9wdHMgJiB7IG1heEFnZTogbnVtYmVyOyB0aW1lb3V0OiBudW1iZXI7IHR5cGU6ICdyZWRpcycgfVxuXG5leHBvcnQgY29uc3QgZGVmYXVsdE9wdGlvbnMgPSAoKTogUmVkaXNPcHRpb25zID0+ICh7XG4gIHR5cGU6ICdyZWRpcycsXG4gIGhvc3Q6IGVudi5DQUNIRV9SRURJU19IT1NUIHx8IERFRkFVTFRfQ0FDSEVfUkVESVNfSE9TVCxcbiAgcG9ydDogTnVtYmVyKGVudi5DQUNIRV9SRURJU19QT1JUKSB8fCBERUZBVUxUX0NBQ0hFX1JFRElTX1BPUlQsXG4gIHBhdGg6IGVudi5DQUNIRV9SRURJU19QQVRIIHx8IERFRkFVTFRfQ0FDSEVfUkVESVNfUEFUSCxcbiAgdXJsOiBlbnYuQ0FDSEVfUkVESVNfVVJMIHx8IERFRkFVTFRfQ0FDSEVfUkVESVNfVVJMLFxuICBwYXNzd29yZDogZW52LkNBQ0hFX1JFRElTX1BBU1NXT1JEIHx8IERFRkFVTFRfQ0FDSEVfUkVESVNfUEFTU1dPUkQsXG4gIG1heEFnZTogTnVtYmVyKGVudi5DQUNIRV9NQVhfQUdFKSB8fCBERUZBVUxUX0NBQ0hFX01BWF9BR0UsXG4gIHRpbWVvdXQ6IE51bWJlcihlbnYuQ0FDSEVfUkVESVNfVElNRU9VVCkgfHwgREVGQVVMVF9DQUNIRV9SRURJU19SRVFVRVNUX1RJTUVPVVQsXG4gIC8vIGNvbm5lY3RfdGltZW91dDpcbiAgLy8gICBOdW1iZXIoZW52LkNBQ0hFX1JFRElTX0NPTk5FQ1RJT05fVElNRU9VVCkgfHwgREVGQVVMVF9DQUNIRV9SRURJU19DT05ORUNUSU9OX1RJTUVPVVQsXG4gIC8vIHNvY2tldF9pbml0aWFsX2RlbGF5OiBOdW1iZXIoZW52LkNBQ0hFX1JFRElTX0lOSVRJQUxfREVMQVkpIHx8IERFRkFVTFRfQ0FDSEVfUkVESVNfSU5JVElBTF9ERUxBWSxcbn0pXG5cbi8vIE9wdGlvbnMgd2l0aG91dCBzZW5zaXRpdmUgZGF0YVxuZXhwb3J0IGNvbnN0IHJlZGFjdE9wdGlvbnMgPSAob3B0czogUmVkaXNPcHRpb25zKSA9PiB7XG4gIGlmIChvcHRzLnBhc3N3b3JkKSBvcHRzLnBhc3N3b3JkID0gb3B0cy5wYXNzd29yZC5yZXBsYWNlKC8uKy9nLCAnKioqKionKVxuICBpZiAob3B0cy51cmwpIG9wdHMudXJsID0gb3B0cy51cmwucmVwbGFjZSgvOlxcL1xcLy4rQC9nLCAnOi8vKioqKipAJylcbiAgcmV0dXJuIG9wdHNcbn1cblxuY29uc3QgcmV0cnlTdHJhdGVneTogUmV0cnlTdHJhdGVneSA9IChvcHRpb25zKSA9PiB7XG4gIG1ldHJpY3MucmVkaXNfcmV0cmllc19jb3VudC5pbmMoKVxuICBsb2dnZXIud2FybignUmVkaXMgcmV0cnkgc3RyYXRlZ3kgYWN0aXZhdGVkLicsIG9wdGlvbnMpXG4gIGlmIChvcHRpb25zLmVycm9yICYmIG9wdGlvbnMuZXJyb3IuY29kZSA9PT0gJ0VDT05OUkVGVVNFRCcpIHtcbiAgICAvLyBFbmQgcmVjb25uZWN0aW5nIG9uIGEgc3BlY2lmaWMgZXJyb3IgYW5kIGZsdXNoIGFsbCBjb21tYW5kcyB3aXRoXG4gICAgLy8gYSBpbmRpdmlkdWFsIGVycm9yXG4gICAgbG9nZ2VyLndhcm4oJ0Nvbm5lY3Rpb24gcmVmdXNlZC4nLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgRXJyb3IoJ1RoZSBzZXJ2ZXIgcmVmdXNlZCB0aGUgY29ubmVjdGlvbicpXG4gIH1cbiAgaWYgKG9wdGlvbnMudG90YWxfcmV0cnlfdGltZSA+IDEwMDAgKiA2MCAqIDYwKSB7XG4gICAgLy8gRW5kIHJlY29ubmVjdGluZyBhZnRlciBhIHNwZWNpZmljIHRpbWVvdXQgYW5kIGZsdXNoIGFsbCBjb21tYW5kc1xuICAgIC8vIHdpdGggYSBpbmRpdmlkdWFsIGVycm9yXG4gICAgbG9nZ2VyLndhcm4oJ1JlZGlzIHJldHJ5IHN0cmF0ZWd5IGV4aGF1c3RlZC4nLCBvcHRpb25zKVxuICAgIHJldHVybiBuZXcgRXJyb3IoJ1JldHJ5IHRpbWUgZXhoYXVzdGVkJylcbiAgfVxuICBpZiAob3B0aW9ucy5hdHRlbXB0ID4gMTApIHtcbiAgICBsb2dnZXIud2FybihgUmVkaXMgcmV0cnkgYXR0ZW1wdCAjJHtvcHRpb25zLmF0dGVtcHR9YCwgb3B0aW9ucylcbiAgICByZXR1cm4gdW5kZWZpbmVkXG4gIH1cbiAgLy8gcmVjb25uZWN0IGFmdGVyXG4gIHJldHVybiBNYXRoLm1pbihvcHRpb25zLmF0dGVtcHQgKiAxMDAsIDMwMDApXG59XG5cbmV4cG9ydCBjbGFzcyBSZWRpc0NhY2hlIHtcbiAgb3B0aW9uczogUmVkaXNPcHRpb25zXG4gIGNsaWVudDogUmVkaXNDbGllbnRcbiAgX2F1dGg6IGFueVxuICBfZ2V0OiBhbnlcbiAgX3NldDogYW55XG4gIF9kZWw6IGFueVxuICBfcXVpdDogYW55XG4gIF9wdHRsOiBhbnlcbiAgd2F0Y2hkb2c/OiBSZXR1cm5UeXBlPHR5cGVvZiBzZXRJbnRlcnZhbD5cblxuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBSZWRpc09wdGlvbnMpIHtcbiAgICBsb2dnZXIuaW5mbygnQ3JlYXRpbmcgbmV3IHJlZGlzIGNsaWVudCBpbnN0YW5jZS4uLicpXG5cbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zXG4gICAgY29uc3QgY2xpZW50ID0gY3JlYXRlQ2xpZW50KHsgLi4ub3B0aW9ucywgcmV0cnlfc3RyYXRlZ3k6IHJldHJ5U3RyYXRlZ3kgfSlcbiAgICBjbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4gbG9nZ2VyLmVycm9yKCdFcnJvciBjb25uZWN0aW5nIHRvIFJlZGlzLiAnLCBlcnIpKVxuICAgIGNsaWVudC5vbignZW5kJywgKCkgPT4gbG9nZ2VyLmVycm9yKCdSZWRpcyBjb25uZWN0aW9uIGVuZGVkLicpKVxuICAgIGNsaWVudC5vbignY29ubmVjdGVkJywgKCkgPT4ge1xuICAgICAgbG9nZ2VyLmluZm8oYFJlZGlzIGNsaWVudCBjb25uZWN0ZWQ6ICR7Y2xpZW50LmNvbm5lY3RlZH1gKVxuICAgIH0pXG4gICAgY2xpZW50Lm9uKCdyZWFkeScsICgpID0+XG4gICAgICBsb2dnZXIuaW5mbygnUmVkaXMgY2xpZW50IHJlYWR5IHRvIHNlcnZlIHJlcXVlc3RzLCBxdWV1ZWQgcmVxdWVzdHMgd2lsbCBiZSByZXBsYXllZCcpLFxuICAgIClcbiAgICB0aGlzLl9hdXRoID0gcHJvbWlzaWZ5KGNsaWVudC5hdXRoKS5iaW5kKGNsaWVudClcbiAgICB0aGlzLl9nZXQgPSBwcm9taXNpZnkoY2xpZW50LmdldCkuYmluZChjbGllbnQpXG4gICAgdGhpcy5fc2V0ID0gcHJvbWlzaWZ5KGNsaWVudC5zZXQpLmJpbmQoY2xpZW50KVxuICAgIHRoaXMuX2RlbCA9IHByb21pc2lmeShjbGllbnQuZGVsKS5iaW5kKGNsaWVudClcbiAgICB0aGlzLl9xdWl0ID0gcHJvbWlzaWZ5KGNsaWVudC5xdWl0KS5iaW5kKGNsaWVudClcbiAgICB0aGlzLl9wdHRsID0gcHJvbWlzaWZ5KGNsaWVudC5wdHRsKS5iaW5kKGNsaWVudClcbiAgICB0aGlzLmNsaWVudCA9IGNsaWVudFxuICB9XG5cbiAgaW5pdGlhbGl6ZShvcHRpb25zOiBSZWRpc09wdGlvbnMpOiB2b2lkIHtcbiAgICBsb2dnZXIuaW5mbygnUmUtaW5pdGlhbGl6aW5nIG5ldyByZWRpcyBjbGllbnQgaW5zdGFuY2UuLi4nKVxuXG4gICAgY29uc3QgY2xpZW50ID0gY3JlYXRlQ2xpZW50KHsgLi4ub3B0aW9ucywgcmV0cnlfc3RyYXRlZ3k6IHJldHJ5U3RyYXRlZ3kgfSlcbiAgICBjbGllbnQub24oJ2Vycm9yJywgKGVycikgPT4gbG9nZ2VyLmVycm9yKCdFcnJvciBjb25uZWN0aW5nIHRvIFJlZGlzLiAnLCBlcnIpKVxuICAgIGNsaWVudC5vbignZW5kJywgKCkgPT4gbG9nZ2VyLmVycm9yKCdSZWRpcyBjb25uZWN0aW9uIGVuZGVkLicpKVxuXG4gICAgdGhpcy5fYXV0aCA9IHByb21pc2lmeShjbGllbnQuYXV0aCkuYmluZChjbGllbnQpXG4gICAgdGhpcy5fZ2V0ID0gcHJvbWlzaWZ5KGNsaWVudC5nZXQpLmJpbmQoY2xpZW50KVxuICAgIHRoaXMuX3NldCA9IHByb21pc2lmeShjbGllbnQuc2V0KS5iaW5kKGNsaWVudClcbiAgICB0aGlzLl9kZWwgPSBwcm9taXNpZnkoY2xpZW50LmRlbCkuYmluZChjbGllbnQpXG4gICAgdGhpcy5fcXVpdCA9IHByb21pc2lmeShjbGllbnQucXVpdCkuYmluZChjbGllbnQpXG4gICAgdGhpcy5fcHR0bCA9IHByb21pc2lmeShjbGllbnQucHR0bCkuYmluZChjbGllbnQpXG4gICAgdGhpcy5jbGllbnQgPSBjbGllbnRcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QoKSB7XG4gICAgaWYgKCF0aGlzLm9wdGlvbnMucGFzc3dvcmQpIHJldHVyblxuXG4gICAgcmV0dXJuIHRoaXMuY29udGV4dHVhbFRpbWVvdXQodGhpcy5fYXV0aCh0aGlzLm9wdGlvbnMucGFzc3dvcmQpLCAnY29ubmVjdCcsIHtcbiAgICAgIGluY2x1ZGVkUGFzc3dvcmQ6ICEhdGhpcy5vcHRpb25zLnBhc3N3b3JkLFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBjaGVja0hlYWx0aCgpIHtcbiAgICBpZiAodGhpcy5jbGllbnQuY29ubmVjdGVkKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZSh0aGlzLm9wdGlvbnMpXG4gICAgICB0aGlzLmNvbm5lY3QoKVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYEZhaWxlZCB0byByZWNyZWF0ZSByZWRpcyBjbGllbnQ6IFske2Vyci5tZXNzYWdlfV1gKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHN0YXJ0V2F0Y2hpbmcoKSB7XG4gICAgaWYgKHRoaXMud2F0Y2hkb2cpIHRoaXMuc3RvcFdhdGNoaW5nKClcbiAgICB0aGlzLndhdGNoZG9nID0gc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5jaGVja0hlYWx0aCgpLCBERUZBVUxUX1dBVENIX0lOVEVSVkFMKVxuICB9XG5cbiAgYXN5bmMgc3RvcFdhdGNoaW5nKCkge1xuICAgIGlmICh0aGlzLndhdGNoZG9nKSBjbGVhckludGVydmFsKHRoaXMud2F0Y2hkb2cpXG4gICAgdGhpcy53YXRjaGRvZyA9IHVuZGVmaW5lZFxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGJ1aWxkKG9wdGlvbnM6IFJlZGlzT3B0aW9ucykge1xuICAgIG1ldHJpY3MucmVkaXNfY29ubmVjdGlvbnNfb3Blbi5pbmMoKVxuICAgIGNvbnN0IGNhY2hlID0gbmV3IFJlZGlzQ2FjaGUob3B0aW9ucylcbiAgICBjYWNoZS5zdGFydFdhdGNoaW5nKClcbiAgICByZXR1cm4gY2FjaGVcbiAgfVxuXG4gIGFzeW5jIHNldFJlc3BvbnNlKGtleTogc3RyaW5nLCB2YWx1ZTogQ2FjaGVFbnRyeSwgbWF4QWdlOiBudW1iZXIpIHtcbiAgICBjb25zdCBlbnRyeSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmNvbnRleHR1YWxUaW1lb3V0KHRoaXMuX3NldChrZXksIGVudHJ5LCAnUFgnLCBtYXhBZ2UpLCAnc2V0Jywge1xuICAgICAga2V5LFxuICAgICAgdmFsdWUsXG4gICAgICBtYXhBZ2UsXG4gICAgfSlcbiAgfVxuXG4gIC8vIFRPRE86IFdlIHNob3VsZCBoYXZlIHNlcGVyYXRlIHNlcnZpY2VzIGZvciByZXNwb25zZSBlbnRyaWVzLCBhbmQgY29hbGVzY2luZyBzdXBwb3J0XG4gIGFzeW5jIHNldEZsaWdodE1hcmtlcihrZXk6IHN0cmluZywgbWF4QWdlOiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0dWFsVGltZW91dCh0aGlzLl9zZXQoa2V5LCB0cnVlLCAnUFgnLCBtYXhBZ2UpLCAnc2V0Jywge1xuICAgICAga2V5LFxuICAgICAgbWF4QWdlLFxuICAgIH0pXG4gIH1cblxuICBhc3luYyBnZXRSZXNwb25zZShrZXk6IHN0cmluZyk6IFByb21pc2U8Q2FjaGVFbnRyeSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IGVudHJ5OiBzdHJpbmcgPSBhd2FpdCB0aGlzLmNvbnRleHR1YWxUaW1lb3V0KHRoaXMuX2dldChrZXkpLCAnZ2V0JywgeyBrZXkgfSlcbiAgICByZXR1cm4gSlNPTi5wYXJzZShlbnRyeSlcbiAgfVxuXG4gIGFzeW5jIGdldEZsaWdodE1hcmtlcihrZXk6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGVudHJ5OiBzdHJpbmcgPSBhd2FpdCB0aGlzLmNvbnRleHR1YWxUaW1lb3V0KHRoaXMuX2dldChrZXkpLCAnZ2V0JywgeyBrZXkgfSlcblxuICAgIHJldHVybiBKU09OLnBhcnNlKGVudHJ5KVxuICB9XG5cbiAgYXN5bmMgZGVsKGtleTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udGV4dHVhbFRpbWVvdXQodGhpcy5fZGVsKGtleSksICdkZWwnLCB7IGtleSB9KVxuICB9XG5cbiAgYXN5bmMgdHRsKGtleTogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICAvLyBUVEwgaW4gbXNcbiAgICByZXR1cm4gdGhpcy5jb250ZXh0dWFsVGltZW91dCh0aGlzLl9wdHRsKGtleSksICd0dGwnLCB7IGtleSB9KVxuICB9XG5cbiAgLyoqXG4gICAqIEZvcmNpYmx5IGNsb3NlIHRoZSBjb25uZWN0aW9uIHRvIHRoZSBSZWRpcyBzZXJ2ZXIuXG4gICAqXG4gICAqIEFXUyBMYW1iZGEgd2lsbCB0aW1lb3V0IGlmIHRoZSBjb25uZWN0aW9uIGlzIG5vdCBjbG9zZWQsIGJlY2F1c2UgdGhlIGNvbm5lY3Rpb25cbiAgICoga2VlcHMgdGhlIGV2ZW50IGxvb3AgYnVzeS5cbiAgICpcbiAgICogVGhlIGFsdGVybmF0aXZlIGlzIHRvIHVzZTogYGNvbnRleHQuY2FsbGJhY2tXYWl0c0ZvckVtdHB5RXZlbnRMb29wID0gZmFsc2VgXG4gICAqL1xuICBhc3luYyBjbG9zZSgpIHtcbiAgICBpZiAoIXRoaXMuY2xpZW50KSByZXR1cm5cblxuICAgIHRyeSB7XG4gICAgICAvLyBObyBmdXJ0aGVyIGNvbW1hbmRzIHdpbGwgYmUgcHJvY2Vzc2VkXG4gICAgICB0aGlzLnN0b3BXYXRjaGluZygpXG4gICAgICBjb25zdCByZXMgPSBhd2FpdCB0aGlzLmNvbnRleHR1YWxUaW1lb3V0KHRoaXMuX3F1aXQoKSwgJ2Nsb3NlJywge1xuICAgICAgICBjbGllbnRFeGlzdHM6ICEhdGhpcy5jbGllbnQsXG4gICAgICB9KVxuICAgICAgbG9nZ2VyLmRlYnVnKGBSZWRpcyBjb25uZWN0aW9uIHNodXRkb3duIGNvbXBsZXRlZCB3aXRoOiAke3Jlc31gKVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmNsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoKVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGNvbnRleHR1YWxUaW1lb3V0KHByb21pc2U6IFByb21pc2U8YW55PiwgZm5OYW1lOiBzdHJpbmcsIGNvbnRleHQ6IGFueSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aW1lb3V0KHByb21pc2UsIHRoaXMub3B0aW9ucy50aW1lb3V0KVxuICAgICAgbWV0cmljcy5yZWRpc19jb21tYW5kc19zZW50X2NvdW50XG4gICAgICAgIC5sYWJlbHMoeyBzdGF0dXM6IG1ldHJpY3MuQ01EX1NFTlRfU1RBVFVTLlNVQ0NFU1MsIGZ1bmN0aW9uX25hbWU6IGZuTmFtZSB9KVxuICAgICAgICAuaW5jKClcbiAgICAgIHJldHVybiByZXN1bHRcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoZSBpbnN0YW5jZW9mIFRpbWVvdXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ1JlZGlzIG1ldGhvZCB0aW1lZCBvdXQsIGNvbnNpZGVyIGluY3JlYXNpbmcgQ0FDSEVfUkVESVNfVElNRU9VVCBvciBpbmNyZWFzaW5nIHlvdXIgcmVkaXMgaW5zdGFuY2UgcGVyZm9ybWFuY2UnLFxuICAgICAgICAgIHsgZm5OYW1lLCBjb250ZXh0IH0sXG4gICAgICAgIClcbiAgICAgICAgdGhyb3cgZVxuICAgICAgfVxuICAgICAgbG9nZ2VyLmVycm9yKCdSZWRpcyBtZXRob2QgZXJyb3InLCB7IGZuTmFtZSwgY29udGV4dCB9KVxuICAgICAgbWV0cmljcy5yZWRpc19jb21tYW5kc19zZW50X2NvdW50XG4gICAgICAgIC5sYWJlbHMoe1xuICAgICAgICAgIHN0YXR1czogbWV0cmljcy5DTURfU0VOVF9TVEFUVVMuRkFJTCxcbiAgICAgICAgICBmdW5jdGlvbl9uYW1lOiBmbk5hbWUsXG4gICAgICAgIH0pXG4gICAgICAgIC5pbmMoKVxuICAgICAgdGhyb3cgZVxuICAgIH1cbiAgfVxufVxuIl19