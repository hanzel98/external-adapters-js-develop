"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Requester = void 0;
const tslib_1 = require("tslib");
const axios_1 = tslib_1.__importDefault(require("axios"));
const util_1 = require("../util");
const config_1 = require("./config");
const errors_1 = require("./errors");
const logger_1 = require("./logger");
const object_path_1 = tslib_1.__importDefault(require("object-path"));
const getFalse = () => false;
const DEFAULT_RETRY = 1;
class Requester {
    static async request(config, customError, retries = Number(process.env.RETRY) || DEFAULT_RETRY, delay = 1000) {
        if (typeof config === 'string')
            config = { url: config };
        if (typeof config.timeout === 'undefined') {
            const timeout = Number(process.env.TIMEOUT);
            config.timeout = !isNaN(timeout) ? timeout : 3000;
        }
        if (!customError)
            customError = getFalse;
        if (typeof customError !== 'function') {
            delay = retries;
            retries = customError;
            customError = getFalse;
        }
        const _retry = async (n) => {
            const _delayRetry = async (message) => {
                logger_1.logger.warn(message);
                await new Promise((resolve) => setTimeout(resolve, delay));
                return await _retry(n - 1);
            };
            let response;
            try {
                response = await axios_1.default(config);
            }
            catch (error) {
                // Request error
                if (n === 1) {
                    logger_1.logger.error(`Could not reach endpoint: ${JSON.stringify(error.message)}`);
                    throw new errors_1.AdapterError({
                        statusCode: error?.response?.status,
                        message: error?.message,
                        cause: error,
                    });
                }
                return await _delayRetry(`Caught error. Retrying: ${JSON.stringify(error.message)}`);
            }
            if (response.data.error || customError(response.data)) {
                // Response error
                if (n === 1) {
                    const message = `Could not retrieve valid data: ${JSON.stringify(response.data)}`;
                    logger_1.logger.error(message);
                    const cause = response.data.error || 'customError';
                    throw new errors_1.AdapterError({ message, cause });
                }
                return await _delayRetry(`Error in response. Retrying: ${JSON.stringify(response.data)}`);
            }
            // Success
            const { data, status, statusText } = response;
            logger_1.logger.debug({
                message: 'Received response',
                data,
                status,
                statusText,
            });
            return response;
        };
        return await _retry(retries);
    }
    static validateResultNumber(data, path, options) {
        const result = this.getResult(data, path);
        if (typeof result === 'undefined') {
            const message = 'Result could not be found in path';
            logger_1.logger.error(message, { data, path });
            throw new errors_1.AdapterError({ message });
        }
        if (Number(result) === 0 || isNaN(Number(result))) {
            const message = 'Invalid result';
            logger_1.logger.error(message, { data, path });
            throw new errors_1.AdapterError({ message });
        }
        const num = Number(result);
        if (options?.inverse && num != 0) {
            return 1 / num;
        }
        return num;
    }
    static getResult(data, path) {
        return object_path_1.default.get(data, path);
    }
    /**
     * Extend a typed Axios response with a single result or group of results
     * @param response Axios response object
     * @param result (optional) a single result value
     * @param results (optional) a group of results from a batch request
     */
    static withResult(response, result, results) {
        const isObj = util_1.deepType(response.data) === 'object';
        const output = isObj
            ? response
            : {
                ...response,
                data: { payload: response.data },
            };
        if (result)
            output.data.result = result;
        if (results)
            output.data.results = results;
        return output;
    }
    static errored(jobRunID = '1', error, statusCode = 500) {
        if (error instanceof errors_1.AdapterError) {
            error.jobRunID = jobRunID;
            return error.toJSONResponse();
        }
        if (error instanceof Error) {
            return new errors_1.AdapterError({
                jobRunID,
                statusCode,
                message: error.message,
                cause: error,
            }).toJSONResponse();
        }
        return new errors_1.AdapterError({ jobRunID, statusCode, message: error }).toJSONResponse();
    }
    /**
     * Conforms the .request() response to the expected Chainlink response structure
     * @param jobRunID
     * @param response The response data object
     * @param verbose Return full response data (optional, default: false)
     */
    static success(jobRunID = '1', response, verbose = false, batchablePropertyPath) {
        const debug = batchablePropertyPath ? { batchablePropertyPath } : undefined;
        return {
            jobRunID,
            data: verbose ? response.data : { result: response.data?.result },
            result: response.data?.result,
            statusCode: response.status || 200,
            debug,
        };
    }
}
exports.Requester = Requester;
Requester.getDefaultConfig = config_1.getDefaultConfig;
Requester.logConfig = config_1.logConfig;
Requester.toVendorName = (key, names) => names[String(key)];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVxdWVzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2xpYi9leHRlcm5hbC1hZGFwdGVyL3JlcXVlc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBU0EsMERBQTRDO0FBQzVDLGtDQUFrQztBQUNsQyxxQ0FBc0Q7QUFDdEQscUNBQXVDO0FBQ3ZDLHFDQUFpQztBQUNqQyxzRUFBb0M7QUFFcEMsTUFBTSxRQUFRLEdBQUcsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFBO0FBRTVCLE1BQU0sYUFBYSxHQUFHLENBQUMsQ0FBQTtBQUV2QixNQUFhLFNBQVM7SUFDcEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQ2xCLE1BQXFCLEVBQ3JCLFdBQWlCLEVBQ2pCLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxhQUFhLEVBQ3BELEtBQUssR0FBRyxJQUFJO1FBRVosSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRO1lBQUUsTUFBTSxHQUFHLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxDQUFBO1FBQ3hELElBQUksT0FBTyxNQUFNLENBQUMsT0FBTyxLQUFLLFdBQVcsRUFBRTtZQUN6QyxNQUFNLE9BQU8sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQTtZQUMzQyxNQUFNLENBQUMsT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQTtTQUNsRDtRQUVELElBQUksQ0FBQyxXQUFXO1lBQUUsV0FBVyxHQUFHLFFBQVEsQ0FBQTtRQUN4QyxJQUFJLE9BQU8sV0FBVyxLQUFLLFVBQVUsRUFBRTtZQUNyQyxLQUFLLEdBQUcsT0FBTyxDQUFBO1lBQ2YsT0FBTyxHQUFHLFdBQVcsQ0FBQTtZQUNyQixXQUFXLEdBQUcsUUFBUSxDQUFBO1NB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LENBQUMsTUFBTSxJQUFJLEdBQUc7WUFDbEMsS0FBSztTQUNOLENBQUE7SUFDSCxDQUFDOztBQWxLSCw4QkF3S0M7QUFKUSwwQkFBZ0IsR0FBRyx5QkFBZ0IsQ0FBQTtBQUNuQyxtQkFBUyxHQUFHLGtCQUFTLENBQUE7QUFFckIsc0JBQVksR0FBRyxDQUFPLEdBQU0sRUFBRSxLQUEyQixFQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZGFwdGVyRXJyb3JSZXNwb25zZSxcbiAgQWRhcHRlclJlc3BvbnNlLFxuICBSZXF1ZXN0Q29uZmlnLFxuICBBZGFwdGVyUmVxdWVzdCxcbiAgQWRhcHRlclJlcXVlc3REYXRhLFxuICBSZXN1bHRQYXRoLFxufSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgcmVkdWNlciB9IGZyb20gJy4uL2NhY2hlLXdhcm1lcidcbmltcG9ydCBheGlvcywgeyBBeGlvc1Jlc3BvbnNlIH0gZnJvbSAnYXhpb3MnXG5pbXBvcnQgeyBkZWVwVHlwZSB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBnZXREZWZhdWx0Q29uZmlnLCBsb2dDb25maWcgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB7IEFkYXB0ZXJFcnJvciB9IGZyb20gJy4vZXJyb3JzJ1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInXG5pbXBvcnQgb2JqZWN0UGF0aCBmcm9tICdvYmplY3QtcGF0aCdcblxuY29uc3QgZ2V0RmFsc2UgPSAoKSA9PiBmYWxzZVxuXG5jb25zdCBERUZBVUxUX1JFVFJZID0gMVxuXG5leHBvcnQgY2xhc3MgUmVxdWVzdGVyIHtcbiAgc3RhdGljIGFzeW5jIHJlcXVlc3Q8VCBleHRlbmRzIEFkYXB0ZXJSZXF1ZXN0RGF0YT4oXG4gICAgY29uZmlnOiBSZXF1ZXN0Q29uZmlnLFxuICAgIGN1c3RvbUVycm9yPzogYW55LFxuICAgIHJldHJpZXMgPSBOdW1iZXIocHJvY2Vzcy5lbnYuUkVUUlkpIHx8IERFRkFVTFRfUkVUUlksXG4gICAgZGVsYXkgPSAxMDAwLFxuICApOiBQcm9taXNlPEF4aW9zUmVzcG9uc2U8VD4+IHtcbiAgICBpZiAodHlwZW9mIGNvbmZpZyA9PT0gJ3N0cmluZycpIGNvbmZpZyA9IHsgdXJsOiBjb25maWcgfVxuICAgIGlmICh0eXBlb2YgY29uZmlnLnRpbWVvdXQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjb25zdCB0aW1lb3V0ID0gTnVtYmVyKHByb2Nlc3MuZW52LlRJTUVPVVQpXG4gICAgICBjb25maWcudGltZW91dCA9ICFpc05hTih0aW1lb3V0KSA/IHRpbWVvdXQgOiAzMDAwXG4gICAgfVxuXG4gICAgaWYgKCFjdXN0b21FcnJvcikgY3VzdG9tRXJyb3IgPSBnZXRGYWxzZVxuICAgIGlmICh0eXBlb2YgY3VzdG9tRXJyb3IgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGRlbGF5ID0gcmV0cmllc1xuICAgICAgcmV0cmllcyA9IGN1c3RvbUVycm9yXG4gICAgICBjdXN0b21FcnJvciA9IGdldEZhbHNlXG4gICAgfVxuXG4gICAgY29uc3QgX3JldHJ5ID0gYXN5bmMgKG46IG51bWJlcik6IFByb21pc2U8QXhpb3NSZXNwb25zZTxUPj4gPT4ge1xuICAgICAgY29uc3QgX2RlbGF5UmV0cnkgPSBhc3luYyAobWVzc2FnZTogc3RyaW5nKSA9PiB7XG4gICAgICAgIGxvZ2dlci53YXJuKG1lc3NhZ2UpXG4gICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIGRlbGF5KSlcbiAgICAgICAgcmV0dXJuIGF3YWl0IF9yZXRyeShuIC0gMSlcbiAgICAgIH1cblxuICAgICAgbGV0IHJlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlPFQ+XG4gICAgICB0cnkge1xuICAgICAgICByZXNwb25zZSA9IGF3YWl0IGF4aW9zKGNvbmZpZylcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIC8vIFJlcXVlc3QgZXJyb3JcbiAgICAgICAgaWYgKG4gPT09IDEpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoYENvdWxkIG5vdCByZWFjaCBlbmRwb2ludDogJHtKU09OLnN0cmluZ2lmeShlcnJvci5tZXNzYWdlKX1gKVxuXG4gICAgICAgICAgdGhyb3cgbmV3IEFkYXB0ZXJFcnJvcih7XG4gICAgICAgICAgICBzdGF0dXNDb2RlOiBlcnJvcj8ucmVzcG9uc2U/LnN0YXR1cyxcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yPy5tZXNzYWdlLFxuICAgICAgICAgICAgY2F1c2U6IGVycm9yLFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXdhaXQgX2RlbGF5UmV0cnkoYENhdWdodCBlcnJvci4gUmV0cnlpbmc6ICR7SlNPTi5zdHJpbmdpZnkoZXJyb3IubWVzc2FnZSl9YClcbiAgICAgIH1cblxuICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuZXJyb3IgfHwgY3VzdG9tRXJyb3IocmVzcG9uc2UuZGF0YSkpIHtcbiAgICAgICAgLy8gUmVzcG9uc2UgZXJyb3JcbiAgICAgICAgaWYgKG4gPT09IDEpIHtcbiAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYENvdWxkIG5vdCByZXRyaWV2ZSB2YWxpZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KHJlc3BvbnNlLmRhdGEpfWBcbiAgICAgICAgICBsb2dnZXIuZXJyb3IobWVzc2FnZSlcbiAgICAgICAgICBjb25zdCBjYXVzZSA9IHJlc3BvbnNlLmRhdGEuZXJyb3IgfHwgJ2N1c3RvbUVycm9yJ1xuICAgICAgICAgIHRocm93IG5ldyBBZGFwdGVyRXJyb3IoeyBtZXNzYWdlLCBjYXVzZSB9KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IF9kZWxheVJldHJ5KGBFcnJvciBpbiByZXNwb25zZS4gUmV0cnlpbmc6ICR7SlNPTi5zdHJpbmdpZnkocmVzcG9uc2UuZGF0YSl9YClcbiAgICAgIH1cblxuICAgICAgLy8gU3VjY2Vzc1xuICAgICAgY29uc3QgeyBkYXRhLCBzdGF0dXMsIHN0YXR1c1RleHQgfSA9IHJlc3BvbnNlXG4gICAgICBsb2dnZXIuZGVidWcoe1xuICAgICAgICBtZXNzYWdlOiAnUmVjZWl2ZWQgcmVzcG9uc2UnLFxuICAgICAgICBkYXRhLFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHN0YXR1c1RleHQsXG4gICAgICB9KVxuICAgICAgcmV0dXJuIHJlc3BvbnNlXG4gICAgfVxuXG4gICAgcmV0dXJuIGF3YWl0IF9yZXRyeShyZXRyaWVzKVxuICB9XG5cbiAgc3RhdGljIHZhbGlkYXRlUmVzdWx0TnVtYmVyKFxuICAgIGRhdGE6IHsgW2tleTogc3RyaW5nXTogYW55IH0sXG4gICAgcGF0aDogUmVzdWx0UGF0aCxcbiAgICBvcHRpb25zPzogeyBpbnZlcnNlPzogYm9vbGVhbiB9LFxuICApOiBudW1iZXIge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZ2V0UmVzdWx0KGRhdGEsIHBhdGgpXG4gICAgaWYgKHR5cGVvZiByZXN1bHQgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjb25zdCBtZXNzYWdlID0gJ1Jlc3VsdCBjb3VsZCBub3QgYmUgZm91bmQgaW4gcGF0aCdcbiAgICAgIGxvZ2dlci5lcnJvcihtZXNzYWdlLCB7IGRhdGEsIHBhdGggfSlcbiAgICAgIHRocm93IG5ldyBBZGFwdGVyRXJyb3IoeyBtZXNzYWdlIH0pXG4gICAgfVxuICAgIGlmIChOdW1iZXIocmVzdWx0KSA9PT0gMCB8fCBpc05hTihOdW1iZXIocmVzdWx0KSkpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2UgPSAnSW52YWxpZCByZXN1bHQnXG4gICAgICBsb2dnZXIuZXJyb3IobWVzc2FnZSwgeyBkYXRhLCBwYXRoIH0pXG4gICAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHsgbWVzc2FnZSB9KVxuICAgIH1cbiAgICBjb25zdCBudW0gPSBOdW1iZXIocmVzdWx0KVxuICAgIGlmIChvcHRpb25zPy5pbnZlcnNlICYmIG51bSAhPSAwKSB7XG4gICAgICByZXR1cm4gMSAvIG51bVxuICAgIH1cbiAgICByZXR1cm4gbnVtXG4gIH1cblxuICBzdGF0aWMgZ2V0UmVzdWx0KGRhdGE6IHsgW2tleTogc3RyaW5nXTogdW5rbm93biB9LCBwYXRoOiBSZXN1bHRQYXRoKTogdW5rbm93biB7XG4gICAgcmV0dXJuIG9iamVjdFBhdGguZ2V0KGRhdGEsIHBhdGgpXG4gIH1cblxuICAvKipcbiAgICogRXh0ZW5kIGEgdHlwZWQgQXhpb3MgcmVzcG9uc2Ugd2l0aCBhIHNpbmdsZSByZXN1bHQgb3IgZ3JvdXAgb2YgcmVzdWx0c1xuICAgKiBAcGFyYW0gcmVzcG9uc2UgQXhpb3MgcmVzcG9uc2Ugb2JqZWN0XG4gICAqIEBwYXJhbSByZXN1bHQgKG9wdGlvbmFsKSBhIHNpbmdsZSByZXN1bHQgdmFsdWVcbiAgICogQHBhcmFtIHJlc3VsdHMgKG9wdGlvbmFsKSBhIGdyb3VwIG9mIHJlc3VsdHMgZnJvbSBhIGJhdGNoIHJlcXVlc3RcbiAgICovXG5cbiAgc3RhdGljIHdpdGhSZXN1bHQ8VD4oXG4gICAgcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2U8VD4sXG4gICAgcmVzdWx0PzogbnVtYmVyIHwgc3RyaW5nLFxuICAgIHJlc3VsdHM/OiBbQWRhcHRlclJlcXVlc3QsIG51bWJlcl1bXSxcbiAgKTogQXhpb3NSZXNwb25zZVdpdGhMaWZ0ZWRSZXN1bHQ8VD4gfCBBeGlvc1Jlc3BvbnNlV2l0aFBheWxvYWRBbmRMaWZ0ZWRSZXN1bHQ8VD4ge1xuICAgIGNvbnN0IGlzT2JqID0gZGVlcFR5cGUocmVzcG9uc2UuZGF0YSkgPT09ICdvYmplY3QnXG4gICAgY29uc3Qgb3V0cHV0ID0gaXNPYmpcbiAgICAgID8gKHJlc3BvbnNlIGFzIEF4aW9zUmVzcG9uc2VXaXRoTGlmdGVkUmVzdWx0PFQ+KVxuICAgICAgOiAoe1xuICAgICAgICAgIC4uLnJlc3BvbnNlLFxuICAgICAgICAgIGRhdGE6IHsgcGF5bG9hZDogcmVzcG9uc2UuZGF0YSB9LFxuICAgICAgICB9IGFzIEF4aW9zUmVzcG9uc2VXaXRoUGF5bG9hZEFuZExpZnRlZFJlc3VsdDxUPilcbiAgICBpZiAocmVzdWx0KSBvdXRwdXQuZGF0YS5yZXN1bHQgPSByZXN1bHRcbiAgICBpZiAocmVzdWx0cykgb3V0cHV0LmRhdGEucmVzdWx0cyA9IHJlc3VsdHNcbiAgICByZXR1cm4gb3V0cHV0XG4gIH1cblxuICBzdGF0aWMgZXJyb3JlZChcbiAgICBqb2JSdW5JRCA9ICcxJyxcbiAgICBlcnJvcj86IEFkYXB0ZXJFcnJvciB8IEVycm9yIHwgc3RyaW5nLFxuICAgIHN0YXR1c0NvZGUgPSA1MDAsXG4gICk6IEFkYXB0ZXJFcnJvclJlc3BvbnNlIHtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBBZGFwdGVyRXJyb3IpIHtcbiAgICAgIGVycm9yLmpvYlJ1bklEID0gam9iUnVuSURcbiAgICAgIHJldHVybiBlcnJvci50b0pTT05SZXNwb25zZSgpXG4gICAgfVxuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICByZXR1cm4gbmV3IEFkYXB0ZXJFcnJvcih7XG4gICAgICAgIGpvYlJ1bklELFxuICAgICAgICBzdGF0dXNDb2RlLFxuICAgICAgICBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuICAgICAgICBjYXVzZTogZXJyb3IsXG4gICAgICB9KS50b0pTT05SZXNwb25zZSgpXG4gICAgfVxuICAgIHJldHVybiBuZXcgQWRhcHRlckVycm9yKHsgam9iUnVuSUQsIHN0YXR1c0NvZGUsIG1lc3NhZ2U6IGVycm9yIH0pLnRvSlNPTlJlc3BvbnNlKClcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25mb3JtcyB0aGUgLnJlcXVlc3QoKSByZXNwb25zZSB0byB0aGUgZXhwZWN0ZWQgQ2hhaW5saW5rIHJlc3BvbnNlIHN0cnVjdHVyZVxuICAgKiBAcGFyYW0gam9iUnVuSURcbiAgICogQHBhcmFtIHJlc3BvbnNlIFRoZSByZXNwb25zZSBkYXRhIG9iamVjdFxuICAgKiBAcGFyYW0gdmVyYm9zZSBSZXR1cm4gZnVsbCByZXNwb25zZSBkYXRhIChvcHRpb25hbCwgZGVmYXVsdDogZmFsc2UpXG4gICAqL1xuICBzdGF0aWMgc3VjY2VzcyhcbiAgICBqb2JSdW5JRCA9ICcxJyxcbiAgICByZXNwb25zZTogUGFydGlhbDxBeGlvc1Jlc3BvbnNlPixcbiAgICB2ZXJib3NlID0gZmFsc2UsXG4gICAgYmF0Y2hhYmxlUHJvcGVydHlQYXRoPzogcmVkdWNlci5CYXRjaGFibGVQcm9wZXJ0eVtdLFxuICApOiBBZGFwdGVyUmVzcG9uc2Uge1xuICAgIGNvbnN0IGRlYnVnID0gYmF0Y2hhYmxlUHJvcGVydHlQYXRoID8geyBiYXRjaGFibGVQcm9wZXJ0eVBhdGggfSA6IHVuZGVmaW5lZFxuICAgIHJldHVybiB7XG4gICAgICBqb2JSdW5JRCxcbiAgICAgIGRhdGE6IHZlcmJvc2UgPyByZXNwb25zZS5kYXRhIDogeyByZXN1bHQ6IHJlc3BvbnNlLmRhdGE/LnJlc3VsdCB9LFxuICAgICAgcmVzdWx0OiByZXNwb25zZS5kYXRhPy5yZXN1bHQsXG4gICAgICBzdGF0dXNDb2RlOiByZXNwb25zZS5zdGF0dXMgfHwgMjAwLFxuICAgICAgZGVidWcsXG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGdldERlZmF1bHRDb25maWcgPSBnZXREZWZhdWx0Q29uZmlnXG4gIHN0YXRpYyBsb2dDb25maWcgPSBsb2dDb25maWdcblxuICBzdGF0aWMgdG9WZW5kb3JOYW1lID0gPEssIFY+KGtleTogSywgbmFtZXM6IHsgW2tleTogc3RyaW5nXTogViB9KTogViA9PiBuYW1lc1tTdHJpbmcoa2V5KV1cbn1cblxuLyoqXG4gKiBDb250YWluZWQgd2l0aGluIHRoZSBib2R5IG9mIGFuIGFwaSByZXNwb25zZVxuICogZnJvbSBhIHJlcXVlc3QgdGhhdCBhc2tlZCBmb3IgYSBzaW5nbGUgZGF0YSBwb2ludFxuICpcbiAqIEBleGFtcGxlIFJlcXVlc3QgUGFyYW1ldGVyc1xuICogYGBgXG4gKiB7XG4gKiAgXCJkYXRhXCI6IHtcbiAqICAgICAgXCJiYXNlXCI6IFwiRVRIXCIsXG4gKiAgICAgIFwicXVvdGVcIjogXCJVU0RcIlxuICogICB9XG4gKn1cbiAqIGBgYFxuICovXG5pbnRlcmZhY2UgU2luZ2xlUmVzdWx0IHtcbiAgcmVzdWx0PzogbnVtYmVyIHwgc3RyaW5nXG59XG5cbi8qKlxuICogQ29udGFpbmVkIHdpdGhpbiB0aGUgYm9keSBvZiBhbiBhcGkgcmVzcG9uc2VcbiAqIGZyb20gYSByZXF1ZXN0IHRoYXQgYXNrZWQgZm9yIG11bHRpcGxlIGRhdGEgcG9pbnRzXG4gKlxuICogQGV4YW1wbGUgUmVxdWVzdCBQYXJhbWV0ZXJzXG4gKiBgYGBcbiAqIHtcbiAqICBcImRhdGFcIjoge1xuICogICAgICBcImJhc2VcIjogXCJFVEgsQlRDXCIsXG4gKiAgICAgIFwicXVvdGVcIjogXCJVU0RcIlxuICogICB9XG4gKn1cbiAqIGBgYFxuICovXG5pbnRlcmZhY2UgQmF0Y2hlZFJlc3VsdCB7XG4gIC8qKlxuICAgKiBUdXBsZXMgZm9yXG4gICAqIFtcbiAgICogICAgaXRzIGlucHV0IHBhcmFtZXRlcnMgYXMgYSBzaW5nbGUgcmVxdWVzdCAodXNlZCBpbiBjYWNoaW5nKSxcbiAgICogICAgaXRzIHJlc3VsdFxuICAgKiBdXG4gICAqL1xuICByZXN1bHRzPzogW0FkYXB0ZXJSZXF1ZXN0LCBudW1iZXJdW11cbn1cblxuLyoqXG4gKiBBIGxpZnRlZCByZXN1bHQgaXMgZGVyaXZlZCBmcm9tIGEgcmF3IHJlc3BvbnNlLFxuICogd2hlcmUgdGhlIHJlc3BvbnNlIHBheWxvYWQgd2lsbCBiZSBzbGlnaHRseSBub3JtYWxpemVkLFxuICogXCJsaWZ0aW5nXCIgbmVzdGVkIGRhdGEgaW50byB0aGUgcm9vdCBvYmplY3RcbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgdHNcbiAqIC8vIFJhdyByZXNwb25zZSBwYXlsb2FkXG4gKiB7XG4gKiAgcGF5bG9hZDoge1xuICogICBkYXRhOiB7XG4gKiAgICAgbmVzdGVkOiB7XG4gKiAgICAgIHJlc3VsdDoge31cbiAqICAgICB9XG4gKiAgIH1cbiAqICB9XG4gKiAvLyBsaWZ0ZWRcbiAqXG4gKiB7XG4gKiAgZGF0YTogeyByZXN1bHRzOiB7fX1cbiAqIH1cbiAqIGBgYFxuICovXG50eXBlIExpZnRlZFJlc3VsdCA9IFNpbmdsZVJlc3VsdCAmIEJhdGNoZWRSZXN1bHRcblxuLyoqXG4gKiBBbiBBeGlvcyByZXNwb25zZSB3aXRoIGEgcmVzdWx0IG9yIHJlc3VsdHMgYWRkZWQgdG8gdGhlIHJlc3BvbnNlIGRhdGEuXG4gKi9cbnR5cGUgQXhpb3NSZXNwb25zZVdpdGhMaWZ0ZWRSZXN1bHQ8VD4gPSBBeGlvc1Jlc3BvbnNlPFQgJiBMaWZ0ZWRSZXN1bHQ+XG4vKipcbiAqIEFuIEF4aW9zIHJlc3BvbnNlIHRoYXQgaGFzIHJlc3BvbnNlIGRhdGEgdGhhdCBpcyBub3QgYW4gb2JqZWN0XG4gKiBuZWVkcyB0byBiZSB0cmFuc2Zvcm1lZCBpbnRvIGFuIG9iamVjdCB0byBob2xkIHRoZSByZXN1bHQgb3IgcmVzdWx0cyBmaWVsZHMuXG4gKlxuICogVGhlIG9yaWdpbmFsIHJlc3BvbnNlIGRhdGEgd2lsbCBiZSBzdG9yZSB1bmRlciB0aGUga2V5IG9mIHBheWxvYWQuXG4gKi9cbnR5cGUgQXhpb3NSZXNwb25zZVdpdGhQYXlsb2FkQW5kTGlmdGVkUmVzdWx0PFQ+ID0gQXhpb3NSZXNwb25zZTx7IHBheWxvYWQ6IFQgfSAmIExpZnRlZFJlc3VsdD5cbiJdfQ==