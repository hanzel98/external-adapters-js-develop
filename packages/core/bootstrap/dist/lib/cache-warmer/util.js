"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.concatenateBatchResults = exports.splitIntoBatches = exports.getSubscriptionKey = void 0;
const lodash_1 = require("lodash");
const config_1 = require("./config");
const util_1 = require("../util");
const conf = config_1.get();
function getSubscriptionKey(request) {
    return util_1.hash(lodash_1.omit(request, ['id', 'parent', 'children', 'result', 'batchablePropertyPath']), conf.hashOpts);
}
exports.getSubscriptionKey = getSubscriptionKey;
function splitIntoBatches(requestData) {
    const { batchablePropertyPath, origin } = requestData;
    if (!batchablePropertyPath) {
        return [];
    }
    const batchesByPath = groupBatchesByPath(batchablePropertyPath, origin);
    return getBatchesArray(batchesByPath);
}
exports.splitIntoBatches = splitIntoBatches;
function groupBatchesByPath(batchablePropertyPath, origin) {
    const batchesByPath = {};
    for (const { name, limit } of batchablePropertyPath) {
        if (origin[name]) {
            const batchedValues = origin[name];
            if (limit) {
                batchesByPath[name] = splitValuesIntoBatches(limit, batchedValues);
            }
            else {
                batchesByPath[name] = [batchedValues];
            }
        }
    }
    return batchesByPath;
}
function splitValuesIntoBatches(limit, values) {
    const batches = [];
    let idx = 0;
    while (idx < values.length) {
        const batch = values.slice(idx, Math.min(idx + limit, values.length));
        idx += limit;
        batches.push(batch);
    }
    return batches;
}
function getBatchesArray(batchesByPath) {
    const batches = [];
    populateBatchesArray(batchesByPath, batches, Object.keys(batchesByPath), 0, {});
    return batches;
}
function populateBatchesArray(batchesByPath, batches, batchPaths, idx, currBatch) {
    if (idx >= batchPaths.length) {
        batches.push(JSON.parse(JSON.stringify(currBatch)));
    }
    else {
        const currPath = batchPaths[idx];
        const pathBatch = batchesByPath[currPath];
        for (const batchValue of pathBatch) {
            currBatch[currPath] = batchValue;
            populateBatchesArray(batchesByPath, batches, batchPaths, idx + 1, currBatch);
            delete currBatch[currPath];
        }
    }
}
function concatenateBatchResults(result, latestResult) {
    if (!result) {
        return latestResult;
    }
    const mergedResult = JSON.parse(JSON.stringify(result));
    const bases = Object.keys(latestResult.data).filter((base) => base !== 'results');
    for (const base of bases) {
        if (mergedResult.data[base]) {
            mergedResult.data[base] = {
                ...mergedResult.data[base],
                ...latestResult.data[base],
            };
        }
        else {
            mergedResult.data[base] = latestResult.data[base];
        }
    }
    mergedResult.data.results = mergedResult.data.results.concat(latestResult.data.results);
    return mergedResult;
}
exports.concatenateBatchResults = concatenateBatchResults;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvY2FjaGUtd2FybWVyL3V0aWwudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQTZCO0FBRTdCLHFDQUE4QjtBQUc5QixrQ0FBOEI7QUFFOUIsTUFBTSxJQUFJLEdBQUcsWUFBRyxFQUFFLENBQUE7QUFDbEIsU0FBZ0Isa0JBQWtCLENBQ2hDLE9BQXVEO0lBRXZELE9BQU8sV0FBSSxDQUNULGFBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsdUJBQXVCLENBQUMsQ0FBQyxFQUM5RSxJQUFJLENBQUMsUUFBUSxDQUNkLENBQUE7QUFDSCxDQUFDO0FBUEQsZ0RBT0M7QUFRRCxTQUFnQixnQkFBZ0IsQ0FBQyxXQUE2QjtJQUM1RCxNQUFNLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFBO0lBQ3JELElBQUksQ0FBQyxxQkFBcUIsRUFBRTtRQUMxQixPQUFPLEVBQUUsQ0FBQTtLQUNWO0lBQ0QsTUFBTSxhQUFhLEdBQUcsa0JBQWtCLENBQUMscUJBQXFCLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDdkUsT0FBTyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUE7QUFDdkMsQ0FBQztBQVBELDRDQU9DO0FBTUQsU0FBUyxrQkFBa0IsQ0FDekIscUJBQTBDLEVBQzFDLE1BQThCO0lBRTlCLE1BQU0sYUFBYSxHQUFtQixFQUFFLENBQUE7SUFDeEMsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLHFCQUFxQixFQUFFO1FBQ25ELElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQ2hCLE1BQU0sYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUNsQyxJQUFJLEtBQUssRUFBRTtnQkFDVCxhQUFhLENBQUMsSUFBSSxDQUFDLEdBQUcsc0JBQXNCLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQyxDQUFBO2FBQ25FO2lCQUFNO2dCQUNMLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFBO2FBQ3RDO1NBQ0Y7S0FDRjtJQUNELE9BQU8sYUFBYSxDQUFBO0FBQ3RCLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLEtBQWEsRUFBRSxNQUFnQjtJQUM3RCxNQUFNLE9BQU8sR0FBRyxFQUFFLENBQUE7SUFDbEIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFBO0lBQ1gsT0FBTyxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRTtRQUMxQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDckUsR0FBRyxJQUFJLEtBQUssQ0FBQTtRQUNaLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7S0FDcEI7SUFDRCxPQUFPLE9BQU8sQ0FBQTtBQUNoQixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsYUFBNkI7SUFDcEQsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQTtJQUN2QyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQy9FLE9BQU8sT0FBTyxDQUFBO0FBQ2hCLENBQUM7QUFFRCxTQUFTLG9CQUFvQixDQUMzQixhQUE2QixFQUM3QixPQUE0QixFQUM1QixVQUFxQixFQUNyQixHQUFXLEVBQ1gsU0FBNEI7SUFFNUIsSUFBSSxHQUFHLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtRQUM1QixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUE7S0FDcEQ7U0FBTTtRQUNMLE1BQU0sUUFBUSxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUNoQyxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDekMsS0FBSyxNQUFNLFVBQVUsSUFBSSxTQUFTLEVBQUU7WUFDbEMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLFVBQVUsQ0FBQTtZQUNoQyxvQkFBb0IsQ0FBQyxhQUFhLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFBO1lBQzVFLE9BQU8sU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1NBQzNCO0tBQ0Y7QUFDSCxDQUFDO0FBRUQsU0FBZ0IsdUJBQXVCLENBQ3JDLE1BQThCLEVBQzlCLFlBQTZCO0lBRTdCLElBQUksQ0FBQyxNQUFNLEVBQUU7UUFDWCxPQUFPLFlBQVksQ0FBQTtLQUNwQjtJQUNELE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO0lBQ3ZELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFBO0lBQ2pGLEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO1FBQ3hCLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUMzQixZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHO2dCQUN4QixHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2dCQUMxQixHQUFHLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO2FBQzNCLENBQUE7U0FDRjthQUFNO1lBQ0wsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1NBQ2xEO0tBQ0Y7SUFDRCxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUN2RixPQUFPLFlBQVksQ0FBQTtBQUNyQixDQUFDO0FBckJELDBEQXFCQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG9taXQgfSBmcm9tICdsb2Rhc2gnXG5pbXBvcnQgeyBXYXJtdXBFeGVjdXRlUGF5bG9hZCwgV2FybXVwU3Vic2NyaWJlZFBheWxvYWQgfSBmcm9tICcuL2FjdGlvbnMnXG5pbXBvcnQgeyBnZXQgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB7IEJhdGNoYWJsZVByb3BlcnR5LCBTdWJzY3JpcHRpb25EYXRhIH0gZnJvbSAnLi9yZWR1Y2VyJ1xuaW1wb3J0IHsgQWRhcHRlclJlcXVlc3QsIEFkYXB0ZXJSZXNwb25zZSB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBoYXNoIH0gZnJvbSAnLi4vdXRpbCdcblxuY29uc3QgY29uZiA9IGdldCgpXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3Vic2NyaXB0aW9uS2V5KFxuICByZXF1ZXN0OiBXYXJtdXBTdWJzY3JpYmVkUGF5bG9hZCB8IFdhcm11cEV4ZWN1dGVQYXlsb2FkLFxuKTogc3RyaW5nIHtcbiAgcmV0dXJuIGhhc2goXG4gICAgb21pdChyZXF1ZXN0LCBbJ2lkJywgJ3BhcmVudCcsICdjaGlsZHJlbicsICdyZXN1bHQnLCAnYmF0Y2hhYmxlUHJvcGVydHlQYXRoJ10pLFxuICAgIGNvbmYuaGFzaE9wdHMsXG4gIClcbn1cblxudHlwZSBCYXRjaFBhdGggPSBzdHJpbmdbXVxuXG5pbnRlcmZhY2UgQmF0Y2hSZXF1ZXN0Q2h1bmsge1xuICBbcGF0aDogc3RyaW5nXTogQmF0Y2hQYXRoXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzcGxpdEludG9CYXRjaGVzKHJlcXVlc3REYXRhOiBTdWJzY3JpcHRpb25EYXRhKTogQmF0Y2hSZXF1ZXN0Q2h1bmtbXSB7XG4gIGNvbnN0IHsgYmF0Y2hhYmxlUHJvcGVydHlQYXRoLCBvcmlnaW4gfSA9IHJlcXVlc3REYXRhXG4gIGlmICghYmF0Y2hhYmxlUHJvcGVydHlQYXRoKSB7XG4gICAgcmV0dXJuIFtdXG4gIH1cbiAgY29uc3QgYmF0Y2hlc0J5UGF0aCA9IGdyb3VwQmF0Y2hlc0J5UGF0aChiYXRjaGFibGVQcm9wZXJ0eVBhdGgsIG9yaWdpbilcbiAgcmV0dXJuIGdldEJhdGNoZXNBcnJheShiYXRjaGVzQnlQYXRoKVxufVxuXG50eXBlIEdyb3VwZWRCYXRjaGVzID0ge1xuICBbcGF0aDogc3RyaW5nXTogQmF0Y2hQYXRoW11cbn1cblxuZnVuY3Rpb24gZ3JvdXBCYXRjaGVzQnlQYXRoKFxuICBiYXRjaGFibGVQcm9wZXJ0eVBhdGg6IEJhdGNoYWJsZVByb3BlcnR5W10sXG4gIG9yaWdpbjogQWRhcHRlclJlcXVlc3RbJ2RhdGEnXSxcbik6IEdyb3VwZWRCYXRjaGVzIHtcbiAgY29uc3QgYmF0Y2hlc0J5UGF0aDogR3JvdXBlZEJhdGNoZXMgPSB7fVxuICBmb3IgKGNvbnN0IHsgbmFtZSwgbGltaXQgfSBvZiBiYXRjaGFibGVQcm9wZXJ0eVBhdGgpIHtcbiAgICBpZiAob3JpZ2luW25hbWVdKSB7XG4gICAgICBjb25zdCBiYXRjaGVkVmFsdWVzID0gb3JpZ2luW25hbWVdXG4gICAgICBpZiAobGltaXQpIHtcbiAgICAgICAgYmF0Y2hlc0J5UGF0aFtuYW1lXSA9IHNwbGl0VmFsdWVzSW50b0JhdGNoZXMobGltaXQsIGJhdGNoZWRWYWx1ZXMpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBiYXRjaGVzQnlQYXRoW25hbWVdID0gW2JhdGNoZWRWYWx1ZXNdXG4gICAgICB9XG4gICAgfVxuICB9XG4gIHJldHVybiBiYXRjaGVzQnlQYXRoXG59XG5cbmZ1bmN0aW9uIHNwbGl0VmFsdWVzSW50b0JhdGNoZXMobGltaXQ6IG51bWJlciwgdmFsdWVzOiBzdHJpbmdbXSk6IEJhdGNoUGF0aFtdIHtcbiAgY29uc3QgYmF0Y2hlcyA9IFtdXG4gIGxldCBpZHggPSAwXG4gIHdoaWxlIChpZHggPCB2YWx1ZXMubGVuZ3RoKSB7XG4gICAgY29uc3QgYmF0Y2ggPSB2YWx1ZXMuc2xpY2UoaWR4LCBNYXRoLm1pbihpZHggKyBsaW1pdCwgdmFsdWVzLmxlbmd0aCkpXG4gICAgaWR4ICs9IGxpbWl0XG4gICAgYmF0Y2hlcy5wdXNoKGJhdGNoKVxuICB9XG4gIHJldHVybiBiYXRjaGVzXG59XG5cbmZ1bmN0aW9uIGdldEJhdGNoZXNBcnJheShiYXRjaGVzQnlQYXRoOiBHcm91cGVkQmF0Y2hlcyk6IEJhdGNoUmVxdWVzdENodW5rW10ge1xuICBjb25zdCBiYXRjaGVzOiBCYXRjaFJlcXVlc3RDaHVua1tdID0gW11cbiAgcG9wdWxhdGVCYXRjaGVzQXJyYXkoYmF0Y2hlc0J5UGF0aCwgYmF0Y2hlcywgT2JqZWN0LmtleXMoYmF0Y2hlc0J5UGF0aCksIDAsIHt9KVxuICByZXR1cm4gYmF0Y2hlc1xufVxuXG5mdW5jdGlvbiBwb3B1bGF0ZUJhdGNoZXNBcnJheShcbiAgYmF0Y2hlc0J5UGF0aDogR3JvdXBlZEJhdGNoZXMsXG4gIGJhdGNoZXM6IEJhdGNoUmVxdWVzdENodW5rW10sXG4gIGJhdGNoUGF0aHM6IEJhdGNoUGF0aCxcbiAgaWR4OiBudW1iZXIsXG4gIGN1cnJCYXRjaDogQmF0Y2hSZXF1ZXN0Q2h1bmssXG4pOiB2b2lkIHtcbiAgaWYgKGlkeCA+PSBiYXRjaFBhdGhzLmxlbmd0aCkge1xuICAgIGJhdGNoZXMucHVzaChKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGN1cnJCYXRjaCkpKVxuICB9IGVsc2Uge1xuICAgIGNvbnN0IGN1cnJQYXRoID0gYmF0Y2hQYXRoc1tpZHhdXG4gICAgY29uc3QgcGF0aEJhdGNoID0gYmF0Y2hlc0J5UGF0aFtjdXJyUGF0aF1cbiAgICBmb3IgKGNvbnN0IGJhdGNoVmFsdWUgb2YgcGF0aEJhdGNoKSB7XG4gICAgICBjdXJyQmF0Y2hbY3VyclBhdGhdID0gYmF0Y2hWYWx1ZVxuICAgICAgcG9wdWxhdGVCYXRjaGVzQXJyYXkoYmF0Y2hlc0J5UGF0aCwgYmF0Y2hlcywgYmF0Y2hQYXRocywgaWR4ICsgMSwgY3VyckJhdGNoKVxuICAgICAgZGVsZXRlIGN1cnJCYXRjaFtjdXJyUGF0aF1cbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbmNhdGVuYXRlQmF0Y2hSZXN1bHRzKFxuICByZXN1bHQ6IEFkYXB0ZXJSZXNwb25zZSB8IG51bGwsXG4gIGxhdGVzdFJlc3VsdDogQWRhcHRlclJlc3BvbnNlLFxuKTogQWRhcHRlclJlc3BvbnNlIHtcbiAgaWYgKCFyZXN1bHQpIHtcbiAgICByZXR1cm4gbGF0ZXN0UmVzdWx0XG4gIH1cbiAgY29uc3QgbWVyZ2VkUmVzdWx0ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShyZXN1bHQpKVxuICBjb25zdCBiYXNlcyA9IE9iamVjdC5rZXlzKGxhdGVzdFJlc3VsdC5kYXRhKS5maWx0ZXIoKGJhc2UpID0+IGJhc2UgIT09ICdyZXN1bHRzJylcbiAgZm9yIChjb25zdCBiYXNlIG9mIGJhc2VzKSB7XG4gICAgaWYgKG1lcmdlZFJlc3VsdC5kYXRhW2Jhc2VdKSB7XG4gICAgICBtZXJnZWRSZXN1bHQuZGF0YVtiYXNlXSA9IHtcbiAgICAgICAgLi4ubWVyZ2VkUmVzdWx0LmRhdGFbYmFzZV0sXG4gICAgICAgIC4uLmxhdGVzdFJlc3VsdC5kYXRhW2Jhc2VdLFxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBtZXJnZWRSZXN1bHQuZGF0YVtiYXNlXSA9IGxhdGVzdFJlc3VsdC5kYXRhW2Jhc2VdXG4gICAgfVxuICB9XG4gIG1lcmdlZFJlc3VsdC5kYXRhLnJlc3VsdHMgPSBtZXJnZWRSZXN1bHQuZGF0YS5yZXN1bHRzLmNvbmNhdChsYXRlc3RSZXN1bHQuZGF0YS5yZXN1bHRzKVxuICByZXR1cm4gbWVyZ2VkUmVzdWx0XG59XG4iXX0=