"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rootReducer = exports.warmupReducer = exports.subscriptionsReducer = void 0;
const tslib_1 = require("tslib");
const toolkit_1 = require("@reduxjs/toolkit");
const external_adapter_1 = require("../external-adapter");
const actions = tslib_1.__importStar(require("./actions"));
const util_1 = require("./util");
const lodash_1 = require("lodash");
exports.subscriptionsReducer = toolkit_1.createReducer({}, (builder) => {
    builder.addCase(actions.warmupSubscribed, (state, { payload }) => {
        const key = payload.key || util_1.getSubscriptionKey(payload);
        state[key] = {
            origin: payload.data,
            executeFn: payload.executeFn,
            startedAt: state[key]?.startedAt ?? Date.now(),
            isDuplicate: !!state[key],
            parent: payload.parent || state[key]?.parent,
            batchablePropertyPath: payload.batchablePropertyPath || state[key]?.batchablePropertyPath,
            childLastSeenById: payload?.childLastSeenById,
        };
    });
    builder.addCase(actions.warmupSubscribedMultiple, (state, { payload }) => {
        for (const member of payload.members) {
            const key = member.key || util_1.getSubscriptionKey(member);
            state[key] = {
                origin: member.data,
                executeFn: member.executeFn,
                startedAt: state[key]?.startedAt ?? Date.now(),
                isDuplicate: !!state[key],
                parent: member.parent || state[key]?.parent,
                batchablePropertyPath: member.batchablePropertyPath || state[key]?.batchablePropertyPath,
                childLastSeenById: member?.childLastSeenById,
            };
        }
    });
    builder.addCase(actions.warmupUnsubscribed, (state, action) => {
        const subscription = state[action.payload.key];
        if (subscription) {
            delete state[action.payload.key];
            if (!subscription.childLastSeenById) {
                return;
            }
            const children = Object.keys(subscription.childLastSeenById);
            for (const childKey of children) {
                delete state[childKey];
            }
        }
    });
    builder.addCase(actions.warmupJoinGroup, (state, { payload }) => {
        const batchWarmer = state[payload.parent];
        batchWarmer.childLastSeenById = {
            ...batchWarmer.childLastSeenById,
            ...payload.childLastSeenById,
        };
        for (const childKey in payload.childLastSeenById) {
            const childRequestData = state[childKey]?.origin;
            if (childRequestData) {
                // Join request data
                for (const { name } of payload.batchablePropertyPath) {
                    const uniqueBatchableValue = new Set(batchWarmer.origin[name]);
                    uniqueBatchableValue.add(childRequestData[name] || childRequestData.data[name]);
                    batchWarmer.origin[name] = [...uniqueBatchableValue];
                }
                // Join overrides
                if (batchWarmer.origin.overrides || childRequestData.overrides)
                    batchWarmer.origin.overrides = lodash_1.merge(batchWarmer.origin.overrides, childRequestData.overrides);
                if (batchWarmer.origin.tokenOverrides || childRequestData.tokenOverrides)
                    batchWarmer.origin.tokenOverrides = lodash_1.merge(batchWarmer.origin.tokenOverrides, childRequestData.tokenOverrides);
                if (batchWarmer.origin.includes || childRequestData.includes)
                    batchWarmer.origin.includes = lodash_1.uniq([
                        ...(batchWarmer.origin.includes || []),
                        ...(childRequestData.includes || []),
                    ]);
            }
        }
    });
    builder.addCase(actions.warmupLeaveGroup, (state, { payload }) => {
        const batchWarmer = state[payload.parent];
        const childIdsToRemove = Object.keys(payload.childLastSeenById);
        const remainingChildIds = Object.keys(batchWarmer.childLastSeenById || {}).filter((childId) => !childIdsToRemove.includes(childId));
        // The request data for a batch request should only contain unique values
        const requestDataWithUniqueValues = Object.fromEntries(payload.batchablePropertyPath.map(({ name }) => [name, new Set()]));
        // Rebuild the request data without the removed children's data
        const batchRequestData = remainingChildIds.reduce((acc, childId) => {
            for (const { name } of payload.batchablePropertyPath) {
                acc[name].add(state[childId].origin[name]);
            }
            return acc;
        }, requestDataWithUniqueValues);
        // Transform the sets back into arrays
        const batchableRequestData = Object.fromEntries(Object.entries(batchRequestData).map(([path, map]) => [path, [...map]]));
        // Rebuild the overrides
        const overrides = remainingChildIds.reduce((acc, childId) => {
            const childOriginData = state[childId].origin;
            if (childOriginData.overrides)
                acc.overrides = lodash_1.merge(acc.overrides || {}, childOriginData.overrides);
            if (childOriginData.tokenOverrides)
                acc.tokenOverrides = lodash_1.merge(acc.tokenOverrides || {}, childOriginData.tokenOverrides);
            if (childOriginData.includes)
                acc.includes = lodash_1.uniq([...(acc.includes || []), ...childOriginData.includes]);
            return acc;
        }, {});
        batchWarmer.origin = {
            ...batchWarmer.origin,
            ...batchableRequestData,
            ...overrides,
        };
        for (const childKey in payload.childLastSeenById) {
            if (batchWarmer?.childLastSeenById?.[childKey])
                delete batchWarmer.childLastSeenById?.[childKey];
        }
    });
});
exports.warmupReducer = toolkit_1.createReducer({}, (builder) => {
    builder.addCase(actions.warmupRequested, (state, action) => {
        if (!state[action.payload.key]) {
            external_adapter_1.logger.info('[warmupReducer] Creating subscription', {
                warmupSubscriptionKey: action.payload.key,
            });
            state[action.payload.key] = { error: null, successCount: 0, errorCount: 0 };
        }
    });
    builder.addCase(actions.warmupFulfilled, (state, action) => {
        const { key } = action.payload;
        const subscription = state[key];
        if (!subscription) {
            external_adapter_1.logger.error('[warmupReducer] Attempted to fulfill warmup request for a non-existing subscription', { warmupSubscriptionKey: key });
            return state;
        }
        subscription.successCount++;
        subscription.error = null;
        subscription.errorCount = 0;
        return state;
    });
    builder.addCase(actions.warmupFailed, (state, action) => {
        const { key, feedLabel: id, error } = action.payload;
        const subscription = state[key];
        if (!subscription) {
            external_adapter_1.logger.error('[warmupReducer] Attempted to fulfill warmup request for a non-existing subscription', { warmupSubscriptionKey: key });
            return state;
        }
        external_adapter_1.logger.error(`[${id}] Cache Warmer failed`, { error: error?.message });
        subscription.error = action.payload.error;
        subscription.errorCount++;
        subscription.successCount = 0;
        return state;
    });
    builder.addCase(actions.warmupUnsubscribed, (state, action) => {
        const { key, reason } = action.payload;
        external_adapter_1.logger.info('[warmupReducer] Deleting subscription. ', { reason });
        delete state[key];
    });
    builder.addCase(actions.warmupStopped, (state, action) => {
        external_adapter_1.logger.info('[warmupReducer] Stopping subscriptions', {
            warmupSubscriptionKey: action.payload.keys,
        });
        for (const key in action.payload.keys) {
            delete state[key];
        }
    });
});
exports.rootReducer = toolkit_1.combineReducers({
    subscriptions: exports.subscriptionsReducer,
    warmups: exports.warmupReducer,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvY2FjaGUtd2FybWVyL3JlZHVjZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUNBLDhDQUFpRTtBQUNqRSwwREFBNEM7QUFDNUMsMkRBQW9DO0FBQ3BDLGlDQUEyQztBQUMzQyxtQ0FBb0M7QUFrRHZCLFFBQUEsb0JBQW9CLEdBQUcsdUJBQWEsQ0FBb0IsRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7SUFDbkYsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFO1FBQy9ELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLElBQUkseUJBQWtCLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDdEQsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHO1lBQ1gsTUFBTSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1lBQ3BCLFNBQVMsRUFBRSxPQUFPLENBQUMsU0FBUztZQUM1QixTQUFTLEVBQUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFO1lBQzlDLFdBQVcsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztZQUN6QixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsTUFBTTtZQUM1QyxxQkFBcUIsRUFBRSxPQUFPLENBQUMscUJBQXFCLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFLHFCQUFxQjtZQUN6RixpQkFBaUIsRUFBRSxPQUFPLEVBQUUsaUJBQWlCO1NBQzlDLENBQUE7SUFDSCxDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLHdCQUF3QixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FB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QUFhLEVBQUUsNEJBQW9CO0lBQ25DLE9BQU8sRUFBRSxxQkFBYTtDQUN2QixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZGFwdGVyUmVxdWVzdCwgRXhlY3V0ZSB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBjb21iaW5lUmVkdWNlcnMsIGNyZWF0ZVJlZHVjZXIgfSBmcm9tICdAcmVkdXhqcy90b29sa2l0J1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vZXh0ZXJuYWwtYWRhcHRlcidcbmltcG9ydCAqIGFzIGFjdGlvbnMgZnJvbSAnLi9hY3Rpb25zJ1xuaW1wb3J0IHsgZ2V0U3Vic2NyaXB0aW9uS2V5IH0gZnJvbSAnLi91dGlsJ1xuaW1wb3J0IHsgbWVyZ2UsIHVuaXEgfSBmcm9tICdsb2Rhc2gnXG5cbmV4cG9ydCBpbnRlcmZhY2UgQmF0Y2hhYmxlUHJvcGVydHkge1xuICBuYW1lOiBzdHJpbmdcbiAgbGltaXQ/OiBudW1iZXJcbn1cblxuLyoqXG4gKiBNZXRhZGF0YSBhYm91dCBhIHJlcXVlc3RcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdWJzY3JpcHRpb25EYXRhIHtcbiAgLyoqXG4gICAqIFRoZSBvcmlnaW5hbCByZXF1ZXN0IGRhdGEgdGhhdCB0cmlnZ2VyZWQgdGhpcyBzdWJzY3JpcHRpb25cbiAgICovXG4gIG9yaWdpbjogQWRhcHRlclJlcXVlc3RbJ2RhdGEnXVxuICAvKipcbiAgICogVGhlIHdyYXBwZWQgZXhlY3V0ZSBmdW5jdGlvbiB0aGF0IHdhcyB1c2VkIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3RcbiAgICovXG4gIGV4ZWN1dGVGbjogRXhlY3V0ZVxuICAvKipcbiAgICogVGhlIHRpbWUgdGhpcyBzdWJzY3JpcHRpb24gc3RhcnRlZCBpbiB1bml4IHRpbWVcbiAgICovXG4gIHN0YXJ0ZWRBdDogbnVtYmVyXG4gIC8qKlxuICAgKiBCb29sZWFuIHRyaWdnZXIgdG8gcHJldmVudCBtdWx0aXBsZSBzdWJzY3JpcHRpb25zIG9uIHRoZSBzYW1lIGtleVxuICAgKiBXZSBuZWVkIHRoaXMgYmVjYXVzZSBjaGVja2luZyBzdGF0ZSBmb3IgdGhpcyB3aXRoaW4gYW4gZXBpYyBkb2VzbnQgd29yayxcbiAgICogdGhlIHJlZHVjZXJzIGFyZSBhbHdheXMgZXhlY3V0ZWQgYmVmb3JlIGVwaWNzIGFyZVxuICAgKi9cbiAgaXNEdXBsaWNhdGU6IGJvb2xlYW5cbiAgLyoqXG4gICAqIElmIGEgc3Vic2NyaXB0aW9uIGlzIGJlaW5nIHdhcm1lZCBieSBhIHBhcmVudCBiYXRjaCByZXF1ZXN0XG4gICAqIFRoaXMgd2lsbCBob2xkIHRoZSBzdWJzY3JpcHRpb24ga2V5IG9mIHRoZSBwYXJlbnRcbiAgICovXG4gIHBhcmVudD86IHN0cmluZ1xuICAvKipcbiAgICogSWYgYSBzdWJzY3JpcHRpb24gaXMgYmVpbmcgd2FybWVkIGJ5IGEgcGFyZW50IGJhdGNoIHJlcXVlc3RcbiAgICogVGhpcyB3aWxsIGhvbGQgdGhlIGtleSBvZiB0aGUgcmVxdWVzdCBkYXRhIHRvIGpvaW5cbiAgICovXG4gIGJhdGNoYWJsZVByb3BlcnR5UGF0aD86IEJhdGNoYWJsZVByb3BlcnR5W11cbiAgLyoqXG4gICAqIElmIGEgc3Vic2NyaXB0aW9uIGlzIHdhcm1pbmcgbXVsdGlwbGUgb3RoZXIgcmVxdWVzdHNcbiAgICogVGhpcyB3aWxsIGhvbGQgYSBtYXAgb2YgdGhlIHN1YnNjcmlwdGlvbiBrZXkgdG8gdGhlIGxhc3QgdGltZSBpdCB3YXMgc2VlblxuICAgKi9cbiAgY2hpbGRMYXN0U2VlbkJ5SWQ/OiB7IFtjaGlsZEtleTogc3RyaW5nXTogbnVtYmVyIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBTdWJzY3JpcHRpb25TdGF0ZSB7XG4gIFtyZXF1ZXN0S2V5OiBzdHJpbmddOiBTdWJzY3JpcHRpb25EYXRhXG59XG5cbmV4cG9ydCBjb25zdCBzdWJzY3JpcHRpb25zUmVkdWNlciA9IGNyZWF0ZVJlZHVjZXI8U3Vic2NyaXB0aW9uU3RhdGU+KHt9LCAoYnVpbGRlcikgPT4ge1xuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBTdWJzY3JpYmVkLCAoc3RhdGUsIHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgY29uc3Qga2V5ID0gcGF5bG9hZC5rZXkgfHwgZ2V0U3Vic2NyaXB0aW9uS2V5KHBheWxvYWQpXG4gICAgc3RhdGVba2V5XSA9IHtcbiAgICAgIG9yaWdpbjogcGF5bG9hZC5kYXRhLFxuICAgICAgZXhlY3V0ZUZuOiBwYXlsb2FkLmV4ZWN1dGVGbixcbiAgICAgIHN0YXJ0ZWRBdDogc3RhdGVba2V5XT8uc3RhcnRlZEF0ID8/IERhdGUubm93KCksXG4gICAgICBpc0R1cGxpY2F0ZTogISFzdGF0ZVtrZXldLFxuICAgICAgcGFyZW50OiBwYXlsb2FkLnBhcmVudCB8fCBzdGF0ZVtrZXldPy5wYXJlbnQsXG4gICAgICBiYXRjaGFibGVQcm9wZXJ0eVBhdGg6IHBheWxvYWQuYmF0Y2hhYmxlUHJvcGVydHlQYXRoIHx8IHN0YXRlW2tleV0/LmJhdGNoYWJsZVByb3BlcnR5UGF0aCxcbiAgICAgIGNoaWxkTGFzdFNlZW5CeUlkOiBwYXlsb2FkPy5jaGlsZExhc3RTZWVuQnlJZCxcbiAgICB9XG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwU3Vic2NyaWJlZE11bHRpcGxlLCAoc3RhdGUsIHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgZm9yIChjb25zdCBtZW1iZXIgb2YgcGF5bG9hZC5tZW1iZXJzKSB7XG4gICAgICBjb25zdCBrZXkgPSBtZW1iZXIua2V5IHx8IGdldFN1YnNjcmlwdGlvbktleShtZW1iZXIpXG4gICAgICBzdGF0ZVtrZXldID0ge1xuICAgICAgICBvcmlnaW46IG1lbWJlci5kYXRhLFxuICAgICAgICBleGVjdXRlRm46IG1lbWJlci5leGVjdXRlRm4sXG4gICAgICAgIHN0YXJ0ZWRBdDogc3RhdGVba2V5XT8uc3RhcnRlZEF0ID8/IERhdGUubm93KCksXG4gICAgICAgIGlzRHVwbGljYXRlOiAhIXN0YXRlW2tleV0sXG4gICAgICAgIHBhcmVudDogbWVtYmVyLnBhcmVudCB8fCBzdGF0ZVtrZXldPy5wYXJlbnQsXG4gICAgICAgIGJhdGNoYWJsZVByb3BlcnR5UGF0aDogbWVtYmVyLmJhdGNoYWJsZVByb3BlcnR5UGF0aCB8fCBzdGF0ZVtrZXldPy5iYXRjaGFibGVQcm9wZXJ0eVBhdGgsXG4gICAgICAgIGNoaWxkTGFzdFNlZW5CeUlkOiBtZW1iZXI/LmNoaWxkTGFzdFNlZW5CeUlkLFxuICAgICAgfVxuICAgIH1cbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBVbnN1YnNjcmliZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gc3RhdGVbYWN0aW9uLnBheWxvYWQua2V5XVxuICAgIGlmIChzdWJzY3JpcHRpb24pIHtcbiAgICAgIGRlbGV0ZSBzdGF0ZVthY3Rpb24ucGF5bG9hZC5rZXldXG5cbiAgICAgIGlmICghc3Vic2NyaXB0aW9uLmNoaWxkTGFzdFNlZW5CeUlkKSB7XG4gICAgICAgIHJldHVyblxuICAgICAgfVxuICAgICAgY29uc3QgY2hpbGRyZW4gPSBPYmplY3Qua2V5cyhzdWJzY3JpcHRpb24uY2hpbGRMYXN0U2VlbkJ5SWQpXG4gICAgICBmb3IgKGNvbnN0IGNoaWxkS2V5IG9mIGNoaWxkcmVuKSB7XG4gICAgICAgIGRlbGV0ZSBzdGF0ZVtjaGlsZEtleV1cbiAgICAgIH1cbiAgICB9XG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwSm9pbkdyb3VwLCAoc3RhdGUsIHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgY29uc3QgYmF0Y2hXYXJtZXIgPSBzdGF0ZVtwYXlsb2FkLnBhcmVudF1cblxuICAgIGJhdGNoV2FybWVyLmNoaWxkTGFzdFNlZW5CeUlkID0ge1xuICAgICAgLi4uYmF0Y2hXYXJtZXIuY2hpbGRMYXN0U2VlbkJ5SWQsXG4gICAgICAuLi5wYXlsb2FkLmNoaWxkTGFzdFNlZW5CeUlkLFxuICAgIH1cbiAgICBmb3IgKGNvbnN0IGNoaWxkS2V5IGluIHBheWxvYWQuY2hpbGRMYXN0U2VlbkJ5SWQpIHtcbiAgICAgIGNvbnN0IGNoaWxkUmVxdWVzdERhdGEgPSBzdGF0ZVtjaGlsZEtleV0/Lm9yaWdpblxuICAgICAgaWYgKGNoaWxkUmVxdWVzdERhdGEpIHtcbiAgICAgICAgLy8gSm9pbiByZXF1ZXN0IGRhdGFcbiAgICAgICAgZm9yIChjb25zdCB7IG5hbWUgfSBvZiBwYXlsb2FkLmJhdGNoYWJsZVByb3BlcnR5UGF0aCkge1xuICAgICAgICAgIGNvbnN0IHVuaXF1ZUJhdGNoYWJsZVZhbHVlID0gbmV3IFNldChiYXRjaFdhcm1lci5vcmlnaW5bbmFtZV0pXG4gICAgICAgICAgdW5pcXVlQmF0Y2hhYmxlVmFsdWUuYWRkKGNoaWxkUmVxdWVzdERhdGFbbmFtZV0gfHwgY2hpbGRSZXF1ZXN0RGF0YS5kYXRhW25hbWVdKVxuICAgICAgICAgIGJhdGNoV2FybWVyLm9yaWdpbltuYW1lXSA9IFsuLi51bmlxdWVCYXRjaGFibGVWYWx1ZV1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEpvaW4gb3ZlcnJpZGVzXG4gICAgICAgIGlmIChiYXRjaFdhcm1lci5vcmlnaW4ub3ZlcnJpZGVzIHx8IGNoaWxkUmVxdWVzdERhdGEub3ZlcnJpZGVzKVxuICAgICAgICAgIGJhdGNoV2FybWVyLm9yaWdpbi5vdmVycmlkZXMgPSBtZXJnZShcbiAgICAgICAgICAgIGJhdGNoV2FybWVyLm9yaWdpbi5vdmVycmlkZXMsXG4gICAgICAgICAgICBjaGlsZFJlcXVlc3REYXRhLm92ZXJyaWRlcyxcbiAgICAgICAgICApXG4gICAgICAgIGlmIChiYXRjaFdhcm1lci5vcmlnaW4udG9rZW5PdmVycmlkZXMgfHwgY2hpbGRSZXF1ZXN0RGF0YS50b2tlbk92ZXJyaWRlcylcbiAgICAgICAgICBiYXRjaFdhcm1lci5vcmlnaW4udG9rZW5PdmVycmlkZXMgPSBtZXJnZShcbiAgICAgICAgICAgIGJhdGNoV2FybWVyLm9yaWdpbi50b2tlbk92ZXJyaWRlcyxcbiAgICAgICAgICAgIGNoaWxkUmVxdWVzdERhdGEudG9rZW5PdmVycmlkZXMsXG4gICAgICAgICAgKVxuICAgICAgICBpZiAoYmF0Y2hXYXJtZXIub3JpZ2luLmluY2x1ZGVzIHx8IGNoaWxkUmVxdWVzdERhdGEuaW5jbHVkZXMpXG4gICAgICAgICAgYmF0Y2hXYXJtZXIub3JpZ2luLmluY2x1ZGVzID0gdW5pcShbXG4gICAgICAgICAgICAuLi4oYmF0Y2hXYXJtZXIub3JpZ2luLmluY2x1ZGVzIHx8IFtdKSxcbiAgICAgICAgICAgIC4uLihjaGlsZFJlcXVlc3REYXRhLmluY2x1ZGVzIHx8IFtdKSxcbiAgICAgICAgICBdKVxuICAgICAgfVxuICAgIH1cbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBMZWF2ZUdyb3VwLCAoc3RhdGUsIHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgY29uc3QgYmF0Y2hXYXJtZXIgPSBzdGF0ZVtwYXlsb2FkLnBhcmVudF1cblxuICAgIGNvbnN0IGNoaWxkSWRzVG9SZW1vdmUgPSBPYmplY3Qua2V5cyhwYXlsb2FkLmNoaWxkTGFzdFNlZW5CeUlkKVxuXG4gICAgY29uc3QgcmVtYWluaW5nQ2hpbGRJZHMgPSBPYmplY3Qua2V5cyhiYXRjaFdhcm1lci5jaGlsZExhc3RTZWVuQnlJZCB8fCB7fSkuZmlsdGVyKFxuICAgICAgKGNoaWxkSWQpID0+ICFjaGlsZElkc1RvUmVtb3ZlLmluY2x1ZGVzKGNoaWxkSWQpLFxuICAgIClcblxuICAgIC8vIFRoZSByZXF1ZXN0IGRhdGEgZm9yIGEgYmF0Y2ggcmVxdWVzdCBzaG91bGQgb25seSBjb250YWluIHVuaXF1ZSB2YWx1ZXNcbiAgICBjb25zdCByZXF1ZXN0RGF0YVdpdGhVbmlxdWVWYWx1ZXMgPSBPYmplY3QuZnJvbUVudHJpZXM8U2V0PHN0cmluZz4+KFxuICAgICAgcGF5bG9hZC5iYXRjaGFibGVQcm9wZXJ0eVBhdGgubWFwKCh7IG5hbWUgfSkgPT4gW25hbWUsIG5ldyBTZXQoKV0pLFxuICAgIClcblxuICAgIC8vIFJlYnVpbGQgdGhlIHJlcXVlc3QgZGF0YSB3aXRob3V0IHRoZSByZW1vdmVkIGNoaWxkcmVuJ3MgZGF0YVxuICAgIGNvbnN0IGJhdGNoUmVxdWVzdERhdGEgPSByZW1haW5pbmdDaGlsZElkcy5yZWR1Y2UoKGFjYywgY2hpbGRJZCkgPT4ge1xuICAgICAgZm9yIChjb25zdCB7IG5hbWUgfSBvZiBwYXlsb2FkLmJhdGNoYWJsZVByb3BlcnR5UGF0aCkge1xuICAgICAgICBhY2NbbmFtZV0uYWRkKHN0YXRlW2NoaWxkSWRdLm9yaWdpbltuYW1lXSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY2NcbiAgICB9LCByZXF1ZXN0RGF0YVdpdGhVbmlxdWVWYWx1ZXMpXG5cbiAgICAvLyBUcmFuc2Zvcm0gdGhlIHNldHMgYmFjayBpbnRvIGFycmF5c1xuICAgIGNvbnN0IGJhdGNoYWJsZVJlcXVlc3REYXRhID0gT2JqZWN0LmZyb21FbnRyaWVzKFxuICAgICAgT2JqZWN0LmVudHJpZXMoYmF0Y2hSZXF1ZXN0RGF0YSkubWFwKChbcGF0aCwgbWFwXSkgPT4gW3BhdGgsIFsuLi5tYXBdXSksXG4gICAgKVxuXG4gICAgLy8gUmVidWlsZCB0aGUgb3ZlcnJpZGVzXG4gICAgY29uc3Qgb3ZlcnJpZGVzID0gcmVtYWluaW5nQ2hpbGRJZHMucmVkdWNlPHtcbiAgICAgIG92ZXJyaWRlcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbiAgICAgIHRva2VuT3ZlcnJpZGVzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgICAgaW5jbHVkZXM/OiBzdHJpbmdbXVxuICAgIH0+KChhY2MsIGNoaWxkSWQpID0+IHtcbiAgICAgIGNvbnN0IGNoaWxkT3JpZ2luRGF0YSA9IHN0YXRlW2NoaWxkSWRdLm9yaWdpblxuICAgICAgaWYgKGNoaWxkT3JpZ2luRGF0YS5vdmVycmlkZXMpXG4gICAgICAgIGFjYy5vdmVycmlkZXMgPSBtZXJnZShhY2Mub3ZlcnJpZGVzIHx8IHt9LCBjaGlsZE9yaWdpbkRhdGEub3ZlcnJpZGVzKVxuICAgICAgaWYgKGNoaWxkT3JpZ2luRGF0YS50b2tlbk92ZXJyaWRlcylcbiAgICAgICAgYWNjLnRva2VuT3ZlcnJpZGVzID0gbWVyZ2UoYWNjLnRva2VuT3ZlcnJpZGVzIHx8IHt9LCBjaGlsZE9yaWdpbkRhdGEudG9rZW5PdmVycmlkZXMpXG4gICAgICBpZiAoY2hpbGRPcmlnaW5EYXRhLmluY2x1ZGVzKVxuICAgICAgICBhY2MuaW5jbHVkZXMgPSB1bmlxKFsuLi4oYWNjLmluY2x1ZGVzIHx8IFtdKSwgLi4uY2hpbGRPcmlnaW5EYXRhLmluY2x1ZGVzXSlcbiAgICAgIHJldHVybiBhY2NcbiAgICB9LCB7fSlcblxuICAgIGJhdGNoV2FybWVyLm9yaWdpbiA9IHtcbiAgICAgIC4uLmJhdGNoV2FybWVyLm9yaWdpbixcbiAgICAgIC4uLmJhdGNoYWJsZVJlcXVlc3REYXRhLFxuICAgICAgLi4ub3ZlcnJpZGVzLFxuICAgIH1cblxuICAgIGZvciAoY29uc3QgY2hpbGRLZXkgaW4gcGF5bG9hZC5jaGlsZExhc3RTZWVuQnlJZCkge1xuICAgICAgaWYgKGJhdGNoV2FybWVyPy5jaGlsZExhc3RTZWVuQnlJZD8uW2NoaWxkS2V5XSlcbiAgICAgICAgZGVsZXRlIGJhdGNoV2FybWVyLmNoaWxkTGFzdFNlZW5CeUlkPy5bY2hpbGRLZXldXG4gICAgfVxuICB9KVxufSlcblxuZXhwb3J0IGludGVyZmFjZSBSZXF1ZXN0RGF0YSB7XG4gIC8qKlxuICAgKiBDdXJyZW50IGVycm9yIGZvciB3YXJtdXAgcmVxdWVzdCwgaWYgYW55XG4gICAqL1xuICBlcnJvcjogRXJyb3IgfCBudWxsXG4gIC8qKlxuICAgKiBUaGUgY29uc2VjdXRpdmUgbnVtYmVyIG9mIHRpbWVzIHdlJ3ZlIGhhZCBzdWNjZXNzZnVsIHdhcm11cHNcbiAgICovXG4gIHN1Y2Nlc3NDb3VudDogbnVtYmVyXG4gIC8qKlxuICAgKiBUaGUgY29uc2VjdXRpdmUgbnVtYmVyIG9mIHRpbWVzIHdlJ3ZlIGhhZCBlcnJvcnMgdHJ5aW5nIHRvIHNlbmQgYSB3YXJtdXAgcmVxdWVzdFxuICAgKi9cbiAgZXJyb3JDb3VudDogbnVtYmVyXG59XG5leHBvcnQgaW50ZXJmYWNlIFJlcXVlc3RTdGF0ZSB7XG4gIFtrZXk6IHN0cmluZ106IFJlcXVlc3REYXRhXG59XG5cbmV4cG9ydCBjb25zdCB3YXJtdXBSZWR1Y2VyID0gY3JlYXRlUmVkdWNlcjxSZXF1ZXN0U3RhdGU+KHt9LCAoYnVpbGRlcikgPT4ge1xuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBSZXF1ZXN0ZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgaWYgKCFzdGF0ZVthY3Rpb24ucGF5bG9hZC5rZXldKSB7XG4gICAgICBsb2dnZXIuaW5mbygnW3dhcm11cFJlZHVjZXJdIENyZWF0aW5nIHN1YnNjcmlwdGlvbicsIHtcbiAgICAgICAgd2FybXVwU3Vic2NyaXB0aW9uS2V5OiBhY3Rpb24ucGF5bG9hZC5rZXksXG4gICAgICB9KVxuICAgICAgc3RhdGVbYWN0aW9uLnBheWxvYWQua2V5XSA9IHsgZXJyb3I6IG51bGwsIHN1Y2Nlc3NDb3VudDogMCwgZXJyb3JDb3VudDogMCB9XG4gICAgfVxuICB9KVxuXG4gIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLndhcm11cEZ1bGZpbGxlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICBjb25zdCB7IGtleSB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICBjb25zdCBzdWJzY3JpcHRpb24gPSBzdGF0ZVtrZXldXG4gICAgaWYgKCFzdWJzY3JpcHRpb24pIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgJ1t3YXJtdXBSZWR1Y2VyXSBBdHRlbXB0ZWQgdG8gZnVsZmlsbCB3YXJtdXAgcmVxdWVzdCBmb3IgYSBub24tZXhpc3Rpbmcgc3Vic2NyaXB0aW9uJyxcbiAgICAgICAgeyB3YXJtdXBTdWJzY3JpcHRpb25LZXk6IGtleSB9LFxuICAgICAgKVxuICAgICAgcmV0dXJuIHN0YXRlXG4gICAgfVxuICAgIHN1YnNjcmlwdGlvbi5zdWNjZXNzQ291bnQrK1xuICAgIHN1YnNjcmlwdGlvbi5lcnJvciA9IG51bGxcbiAgICBzdWJzY3JpcHRpb24uZXJyb3JDb3VudCA9IDBcbiAgICByZXR1cm4gc3RhdGVcbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBGYWlsZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgY29uc3QgeyBrZXksIGZlZWRMYWJlbDogaWQsIGVycm9yIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHN0YXRlW2tleV1cbiAgICBpZiAoIXN1YnNjcmlwdGlvbikge1xuICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAnW3dhcm11cFJlZHVjZXJdIEF0dGVtcHRlZCB0byBmdWxmaWxsIHdhcm11cCByZXF1ZXN0IGZvciBhIG5vbi1leGlzdGluZyBzdWJzY3JpcHRpb24nLFxuICAgICAgICB7IHdhcm11cFN1YnNjcmlwdGlvbktleToga2V5IH0sXG4gICAgICApXG4gICAgICByZXR1cm4gc3RhdGVcbiAgICB9XG4gICAgbG9nZ2VyLmVycm9yKGBbJHtpZH1dIENhY2hlIFdhcm1lciBmYWlsZWRgLCB7IGVycm9yOiBlcnJvcj8ubWVzc2FnZSB9KVxuICAgIHN1YnNjcmlwdGlvbi5lcnJvciA9IGFjdGlvbi5wYXlsb2FkLmVycm9yXG4gICAgc3Vic2NyaXB0aW9uLmVycm9yQ291bnQrK1xuICAgIHN1YnNjcmlwdGlvbi5zdWNjZXNzQ291bnQgPSAwXG4gICAgcmV0dXJuIHN0YXRlXG4gIH0pXG5cbiAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMud2FybXVwVW5zdWJzY3JpYmVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGNvbnN0IHsga2V5LCByZWFzb24gfSA9IGFjdGlvbi5wYXlsb2FkXG4gICAgbG9nZ2VyLmluZm8oJ1t3YXJtdXBSZWR1Y2VyXSBEZWxldGluZyBzdWJzY3JpcHRpb24uICcsIHsgcmVhc29uIH0pXG4gICAgZGVsZXRlIHN0YXRlW2tleV1cbiAgfSlcblxuICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy53YXJtdXBTdG9wcGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgIGxvZ2dlci5pbmZvKCdbd2FybXVwUmVkdWNlcl0gU3RvcHBpbmcgc3Vic2NyaXB0aW9ucycsIHtcbiAgICAgIHdhcm11cFN1YnNjcmlwdGlvbktleTogYWN0aW9uLnBheWxvYWQua2V5cyxcbiAgICB9KVxuICAgIGZvciAoY29uc3Qga2V5IGluIGFjdGlvbi5wYXlsb2FkLmtleXMpIHtcbiAgICAgIGRlbGV0ZSBzdGF0ZVtrZXldXG4gICAgfVxuICB9KVxufSlcblxuZXhwb3J0IGNvbnN0IHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHtcbiAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9uc1JlZHVjZXIsXG4gIHdhcm11cHM6IHdhcm11cFJlZHVjZXIsXG59KVxuXG5leHBvcnQgdHlwZSBDYWNoZVdhcm1lclN0YXRlID0gUmV0dXJuVHlwZTx0eXBlb2Ygcm9vdFJlZHVjZXI+XG4iXX0=