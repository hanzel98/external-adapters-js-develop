"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.epicMiddleware = exports.rootEpic = exports.metricsEpic = exports.writeMessageToCacheEpic = exports.recordErrorEpic = exports.connectEpic = exports.subscribeReadyEpic = void 0;
const tslib_1 = require("tslib");
const redux_observable_1 = require("redux-observable");
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const webSocket_1 = require("rxjs/webSocket");
const ws_1 = tslib_1.__importDefault(require("ws"));
const cache_1 = require("../cache");
const external_adapter_1 = require("../external-adapter");
const util_1 = require("../metrics/util");
const actions_1 = require("./actions");
const metrics_1 = require("./metrics");
const reducer_1 = require("./reducer");
const utils_1 = require("./utils");
const config_1 = require("./config");
// Rxjs deserializer defaults to JSON.parse.
// We need to handle errors from non-parsable messages
const deserializer = (message) => {
    try {
        return JSON.parse(message.data);
    }
    catch (e) {
        external_adapter_1.logger.debug('WS: Message received with invalid format');
        return message;
    }
};
const subscribeReadyEpic = (action$) => action$.pipe(operators_1.filter(actions_1.wsSubscriptionReady.match), operators_1.concatMap(async ({ payload }) => {
    const { wsHandler, config, context, request } = payload;
    const subscriptionPayloads = [];
    await utils_1.separateBatches(request, async (singleInput) => {
        const subscriptionMsg = wsHandler.onConnectChain
            ? wsHandler.onConnectChain[0].payload
            : wsHandler.subscribe(singleInput);
        if (!subscriptionMsg) {
            external_adapter_1.logger.error(`No subscription message found while seperating batches`, {
                singleInput,
                request,
            });
            return;
        }
        const subscriptionPayload = {
            connectionInfo: {
                key: config.connectionInfo.key,
                url: wsHandler.connection.url,
            },
            subscriptionMsg,
            input: singleInput,
            context,
        };
        subscriptionPayloads.push(subscriptionPayload);
    });
    return subscriptionPayloads;
}), operators_1.mergeMap(([subscriptionPayload]) => {
    const action = actions_1.subscribeRequested(subscriptionPayload);
    if (!subscriptionPayload) {
        external_adapter_1.logger.debug('INVALID_SUBSCRIBE_REQUESTED_IN_READY_EPIC', action);
        return rxjs_1.EMPTY;
    }
    return rxjs_1.of(action);
}));
exports.subscribeReadyEpic = subscribeReadyEpic;
const connectEpic = (action$, state$) => action$.pipe(operators_1.filter(actions_1.connectRequested.match), operators_1.map(({ payload }) => ({ payload, connectionKey: payload.config.connectionInfo.key })), operators_1.withLatestFrom(state$), operators_1.filter(([{ connectionKey }, state]) => {
    const connectionState = state.ws.connections.all[connectionKey];
    const isActiveConnection = connectionState?.active;
    const isConnecting = connectionState?.connecting > 1;
    const hasErrored = connectionState?.shouldNotRetryConnecting;
    return (!hasErrored &&
        !isActiveConnection &&
        !isConnecting &&
        (!connectionState || connectionState.requestId === 0));
}), operators_1.concatMap(async (data) => {
    const getUrl = data[0].payload.wsHandler.connection.getUrl;
    if (getUrl)
        data[0].payload.wsHandler.connection.url = await getUrl(data[0].payload.request);
    return data;
}), 
// on a connect action being dispatched, open a new WS connection if one doesn't exist yet
operators_1.mergeMap(([{ connectionKey, payload }]) => {
    const { config, wsHandler } = payload;
    const { connection: { url, protocol }, } = wsHandler;
    const connectionMeta = (payload) => ({
        key: payload.config.connectionInfo.key,
        url: external_adapter_1.censor(url),
    });
    const subscriptionMeta = (payload) => ({
        connection_key: payload.connectionInfo.key,
        connection_url: external_adapter_1.censor(url),
        feed_id: util_1.getFeedId({ ...payload.input }),
        subscription_key: reducer_1.getSubsId(payload.subscriptionMsg),
    });
    const openObserver = new rxjs_1.Subject();
    const closeObserver = new rxjs_1.Subject();
    const errorObserver = new rxjs_1.Subject();
    const error$ = errorObserver.asObservable();
    const WebSocketCtor = ws_1.default;
    const wsSubject = webSocket_1.webSocket({
        url,
        protocol,
        deserializer,
        openObserver,
        closeObserver,
        WebSocketCtor: WebSocketCtor, // TODO: fix types don't match
    });
    wsHandler.onConnect && wsSubject.next(wsHandler.onConnect(payload.request));
    // Stream of WS connected & disconnected events
    const open$ = openObserver.pipe(operators_1.map(() => actions_1.connectFulfilled({ config, wsHandler, connectionInfo: config.connectionInfo })), operators_1.tap((action) => external_adapter_1.logger.info('WS: Connected', connectionMeta(action.payload))));
    const close$ = closeObserver.pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([closeContext, state]) => {
        const key = config.connectionInfo.key;
        const activeSubs = Object.entries(state.ws.subscriptions.all)
            .filter(([_, info]) => (info.active || info.subscribing > 0) && info.connectionKey === key)
            .map(([_, info]) => ({
            connectionInfo: {
                url,
                key: config.connectionInfo.key,
            },
            subscriptionMsg: wsHandler.subscribe(info.input),
            input: info.input,
        }));
        const toUnsubscribed = (payload) => actions_1.unsubscribeFulfilled(payload);
        external_adapter_1.logger.info('Closing websocket connection', {
            context: {
                type: closeContext.type,
                wasClean: closeContext.wasClean,
                reason: closeContext.reason,
                code: closeContext.code,
            },
        });
        return rxjs_1.from([
            ...activeSubs.map(toUnsubscribed),
            actions_1.disconnectFulfilled({
                config,
                wsHandler,
            }),
        ]);
    }));
    // Close the WS connection on disconnect
    const disconnect$ = action$.pipe(operators_1.filter(actions_1.disconnectRequested.match), operators_1.filter(({ payload }) => payload.config.connectionInfo.key === connectionKey), operators_1.tap(() => wsSubject.closed || wsSubject.complete()), operators_1.tap((action) => external_adapter_1.logger.info('WS: Disconnected', connectionMeta(action.payload))), operators_1.filter(() => false));
    // Subscription requests
    const subscriptions$ = action$.pipe(operators_1.filter(actions_1.subscribeRequested.match));
    const updateSubscriptionInput$ = subscriptions$.pipe(operators_1.filter(({ payload }) => payload.connectionInfo.key === connectionKey), operators_1.map(({ payload }) => ({
        payload,
        subscriptionKey: reducer_1.getSubsId(payload.subscriptionMsg),
    })), operators_1.withLatestFrom(state$), operators_1.filter(([{ subscriptionKey, payload }, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const isSubscribing = state.ws.subscriptions.all[subscriptionKey]?.subscribing > 1;
        if (!isActiveSubscription || isSubscribing) {
            return false;
        }
        const currentInput = state.ws.subscriptions.all[subscriptionKey]?.input;
        return reducer_1.getSubsId(currentInput) !== reducer_1.getSubsId(payload.input);
    }), operators_1.mergeMap(async ([{ subscriptionKey, payload }]) => {
        return actions_1.updateSubscriptionInput({
            subscriptionKey,
            input: payload.input,
        });
    }));
    // Multiplex subscriptions
    const multiplexSubscriptions$ = subscriptions$.pipe(operators_1.filter(({ payload }) => payload.connectionInfo.key === connectionKey), operators_1.map(({ payload }) => ({
        payload,
        subscriptionKey: reducer_1.getSubsId(payload.subscriptionMsg),
    })), operators_1.withLatestFrom(state$), operators_1.filter(([{ subscriptionKey, payload }, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const isSubscribing = state.ws.subscriptions.all[subscriptionKey]?.subscribing > 1;
        const shouldNotRetrySubscribing = state.ws.subscriptions.all[subscriptionKey]?.shouldNotRetry;
        const isNotActive = !isActiveSubscription && !isSubscribing;
        const { isDataMessage, onConnectChain } = wsHandler;
        if (isDataMessage && onConnectChain && isDataMessage(payload.subscriptionMsg)) {
            const connectionState = state.ws.connections.all[payload.connectionInfo.key];
            const hasOnConnectChainCompleted = connectionState.requestId >= onConnectChain.length;
            return !shouldNotRetrySubscribing && isNotActive && hasOnConnectChainCompleted;
        }
        return !shouldNotRetrySubscribing && isNotActive;
    }), 
    // on a subscribe action being dispatched, open a new WS subscription if one doesn't exist yet
    operators_1.mergeMap(([{ subscriptionKey, payload }, state]) => wsSubject
        .multiplex(() => {
        const clonedPayload = JSON.parse(JSON.stringify(payload.subscriptionMsg));
        const shouldModifyPayload = !!wsHandler.shouldModifyPayload &&
            wsHandler.shouldModifyPayload(clonedPayload) &&
            wsHandler.modifySubscriptionPayload;
        const connectionState = state.ws.connections.all[payload.connectionInfo.key];
        const subMsg = shouldModifyPayload && wsHandler.modifySubscriptionPayload
            ? wsHandler.modifySubscriptionPayload(clonedPayload, state.ws.subscriptions.all[subscriptionKey]?.subscriptionParams, connectionState.connectionParams, connectionState.requestId)
            : clonedPayload;
        return subMsg;
    }, () => wsHandler.unsubscribe(payload.input, state.ws.subscriptions.all[subscriptionKey]?.subscriptionParams), (message) => {
        const connectionState = state.ws.connections.all[payload.connectionInfo.key];
        const shouldPassAlong = (payload.filterMultiplex && payload.filterMultiplex(message)) ||
            reducer_1.getSubsId(wsHandler.subsFromMessage(message, payload.subscriptionMsg, payload.input, connectionState?.connectionParams)) === subscriptionKey;
        if (!shouldPassAlong) {
            return false;
        }
        /**
         * If the error happens on the subscription, it will be on subscribing state and eventually unresponsiveTimeout will take care of it (unsubs/subs)
         * If the error happens during a subscription, and is only eventual, can be ignored
         * If the error happens during a subscription, and the subscription stop receiving messages, the unresponsiveTimeout will take care of it (unsubs/subs)
         */
        if (wsHandler.isError(message)) {
            const error = {
                reason: JSON.stringify(message),
                connectionInfo: { key: connectionKey, url },
                error: message,
            };
            external_adapter_1.logger.error('WS: Error', error);
            errorObserver.next(actions_1.subscriptionError({
                ...error,
                wsHandler,
            }));
            return false;
        }
        return true;
    })
        .pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([message, state]) => {
        const isActiveSubscription = !!state.ws.subscriptions.all[subscriptionKey]?.active;
        const actionPayload = {
            message,
            subscriptionKey,
            input: payload.input,
            context: payload.context,
            connectionInfo: payload.connectionInfo,
            wsHandler,
        };
        if (!isActiveSubscription) {
            external_adapter_1.logger.info('WS: Subscribed', subscriptionMeta(payload));
            return rxjs_1.of(actions_1.subscribeFulfilled(payload), actions_1.messageReceived(actionPayload));
        }
        return rxjs_1.of(actions_1.messageReceived(actionPayload));
    }), operators_1.takeUntil(rxjs_1.merge(action$.pipe(operators_1.filter(actions_1.unsubscribeRequested.match), operators_1.filter((a) => reducer_1.getSubsId(a.payload.subscriptionMsg) === subscriptionKey), operators_1.tap((a) => external_adapter_1.logger.info('WS: Unsubscribed', subscriptionMeta(a.payload)))), action$.pipe(operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((a) => a.payload.config.connectionInfo.key === connectionKey)))), operators_1.endWith(actions_1.unsubscribeFulfilled(payload)))), operators_1.catchError((e) => {
        external_adapter_1.logger.error(e);
        return rxjs_1.of(actions_1.connectFailed({ connectionInfo: { key: connectionKey, url }, reason: e.message }));
    }));
    const withHeartbeatAtIntervals$ = action$.pipe(operators_1.filter((action) => {
        return actions_1.connectFulfilled.match(action) && !!wsHandler.heartbeatMessage;
    }), operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const connectionKey = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[connectionKey];
        return !!connectionState && connectionState.active;
    }), operators_1.mergeMap(([action, state]) => {
        const connectionKey = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[connectionKey];
        const interval = wsHandler.heartbeatIntervalInMS || config.defaultHeartbeatIntervalInMS;
        return rxjs_1.timer(interval, interval).pipe(operators_1.tap(() => external_adapter_1.logger.debug('Sending heartbeat message')), operators_1.mergeMap(() => {
            if (wsHandler.heartbeatMessage) {
                const heartbeatPayload = wsHandler.heartbeatMessage(connectionState.requestId, connectionState.connectionParams);
                wsSubject.next(heartbeatPayload);
            }
            return rxjs_1.EMPTY;
        }), operators_1.takeUntil(action$.pipe(operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((action) => action.payload.config.connectionInfo.key === connectionKey))));
    }));
    // All received messages using the same connection key
    const message$ = action$.pipe(operators_1.filter(actions_1.messageReceived.match), operators_1.filter((action) => action.payload.connectionInfo.key === connectionKey));
    const withContinueOnConnectChain$ = message$.pipe(operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const key = action.payload.connectionInfo.key;
        const connectionState = state.ws.connections.all[key];
        return (!!connectionState &&
            !!wsHandler.onConnectChain &&
            connectionState.requestId <= wsHandler.onConnectChain.length);
    }), operators_1.mergeMap(([{ payload }, state]) => {
        const { input, context, message } = payload;
        const onConnectIdx = state.ws.connections.all[payload.connectionInfo.key]
            ? state.ws.connections.all[payload.connectionInfo.key].requestId
            : 0;
        if (!wsHandler.onConnectChain || onConnectIdx === undefined) {
            return rxjs_1.EMPTY;
        }
        const onConnectChainFinished = onConnectIdx >= wsHandler.onConnectChain.length;
        const subscriptionMsg = onConnectChainFinished
            ? wsHandler.subscribe(input)
            : wsHandler.onConnectChain[onConnectIdx].payload;
        const subscriptionPayload = {
            connectionInfo: {
                key: config.connectionInfo.key,
                url: wsHandler.connection.url,
            },
            subscriptionMsg,
            input,
            context,
            messageToSave: wsHandler.shouldSaveToConnection &&
                wsHandler.shouldSaveToConnection(message) &&
                wsHandler.saveOnConnectToConnection
                ? wsHandler.saveOnConnectToConnection(message)
                : null,
            filterMultiplex: onConnectChainFinished
                ? undefined
                : wsHandler.onConnectChain[onConnectIdx].filter,
            shouldNeverUnsubscribe: onConnectChainFinished
                ? false
                : wsHandler.onConnectChain[onConnectIdx].shouldNeverUnsubscribe,
        };
        const subscribeRequestedAction = actions_1.subscribeRequested(subscriptionPayload);
        if (onConnectChainFinished) {
            return rxjs_1.of(subscribeRequestedAction, actions_1.onConnectComplete(subscriptionPayload));
        }
        return rxjs_1.of(subscribeRequestedAction);
    }));
    const withSaveFirstMessageToStore$ = message$.pipe(operators_1.filter(() => {
        return !!wsHandler.toSaveFromFirstMessage;
    }), operators_1.withLatestFrom(state$), operators_1.filter(([action, state]) => {
        const key = action.payload.subscriptionKey;
        const subscription = state.ws.subscriptions.all[key];
        return subscription && !subscription.subscriptionParams;
    }), operators_1.mergeMap(([action]) => {
        const toSave = wsHandler.toSaveFromFirstMessage &&
            wsHandler.toSaveFromFirstMessage(action.payload.message);
        return toSave
            ? rxjs_1.of(actions_1.saveFirstMessageReceived({
                subscriptionKey: action.payload.subscriptionKey,
                message: toSave,
            }))
            : rxjs_1.EMPTY;
    }));
    const respondWithHeartbeat$ = message$.pipe(operators_1.filter((action) => !!wsHandler.shouldReplyToServerHeartbeat &&
        wsHandler.shouldReplyToServerHeartbeat(action.payload.message)), operators_1.withLatestFrom(state$), operators_1.mergeMap(([action, state]) => {
        const { connectionInfo, message } = action.payload;
        const key = connectionInfo.key;
        const { requestId, connectionParams } = state.ws.connections.all[key];
        if (wsHandler.heartbeatReplyMessage) {
            const heartbeatMessage = wsHandler.heartbeatReplyMessage(message, requestId, connectionParams);
            external_adapter_1.logger.debug('Responding with heartbeat payload', heartbeatMessage);
            wsSubject.next(heartbeatMessage);
        }
        return rxjs_1.of(action);
    }), operators_1.filter(() => false));
    // Once a request happens, a subscription timeout starts. If no more requests ask for
    // this subscription before the time runs out, it will be unsubscribed
    const unsubscribeOnTimeout$ = subscriptions$.pipe(operators_1.filter((action) => !action.payload.shouldNeverUnsubscribe), 
    // when a subscription comes in
    // TODO: we need to filter duplicated subscriptions here
    operators_1.mergeMap(({ payload }) => {
        const subscriptionKey = reducer_1.getSubsId(payload.subscriptionMsg);
        // we look for matching subscriptions of the same type
        // which deactivates the current timer
        const reset$ = subscriptions$.pipe(operators_1.filter(({ payload }) => subscriptionKey === reducer_1.getSubsId(payload.subscriptionMsg)), operators_1.take(1));
        // start the current unsubscription timer
        const timeout$ = rxjs_1.of(actions_1.unsubscribeRequested({ ...payload })).pipe(operators_1.delay(config.subscriptionTTL), operators_1.tap(() => external_adapter_1.logger.debug('WS: unsubscribe (inactive feed)', { payload: payload.subscriptionMsg })));
        // if a re-subscription comes in before timeout emits, then we emit nothing
        // else we unsubscribe from the current subscription
        return rxjs_1.race(reset$, timeout$).pipe(operators_1.filter((a) => !actions_1.subscribeRequested.match(a)));
    }));
    const unsubscribeOnNoResponse$ = message$.pipe(operators_1.withLatestFrom(state$), operators_1.mergeMap(([{ payload: { subscriptionKey }, }, state,]) => {
        let input = state.ws.subscriptions.all[subscriptionKey]?.input;
        if (!input) {
            external_adapter_1.logger.warn(`WS: Could not find subscription from incoming message`);
            input = {};
        }
        const reset$ = message$.pipe(operators_1.filter(({ payload }) => subscriptionKey === payload.subscriptionKey), operators_1.take(1));
        let context = state.ws.subscriptions.all[subscriptionKey]?.context;
        if (!context) {
            external_adapter_1.logger.warn(`WS Unsubscribe No Response: Could not find context`);
            context = {};
        }
        const action = {
            input,
            subscriptionMsg: wsHandler.subscribe(input),
            connectionInfo: { key: connectionKey, url },
            context,
        };
        const subReqAction = actions_1.subscribeRequested(action);
        const timeout$ = rxjs_1.of(actions_1.subscriptionError({
            ...action,
            reason: 'WS: unsubscribe -> subscribe (unresponsive channel)',
            wsHandler,
        }), actions_1.unsubscribeRequested(action), subReqAction).pipe(operators_1.delay(config.subscriptionUnresponsiveTTL), operators_1.tap((a) => {
            if (actions_1.subscriptionError.match(a)) {
                external_adapter_1.logger.warn('[unsubscribeOnNoResponse] Resubscribing due to unresponsive subscription, this happens when a subscription does not receive a message for longer than the subscriptionUnresponsiveTTL value', { feedId: a.payload.input ? util_1.getFeedId(a.payload.input) : 'undefined' });
            }
        }), operators_1.withLatestFrom(state$), 
        // Filters by active subscription.
        // The timeout could think we don't receive messages because of unresponsiveness, and it's actually unsubscribed
        // isSubscribing is considered too as we want to trigger an unsubscription from a hung channel
        operators_1.mergeMap(([action, state]) => {
            const isActive = !!state.ws.subscriptions.all[subscriptionKey]?.active;
            const isSubscribing = !!(state.ws.subscriptions.all[subscriptionKey]?.subscribing > 0);
            return isActive || isSubscribing ? rxjs_1.of(action) : rxjs_1.EMPTY;
        }));
        return rxjs_1.race(reset$, timeout$).pipe(operators_1.filter((a) => !actions_1.messageReceived.match(a)));
    }));
    // Merge all & unsubscribe ws connection when a matching unsubscribe comes in
    const unsubscribe$ = rxjs_1.merge(unsubscribeOnTimeout$, unsubscribeOnNoResponse$);
    const ws$ = rxjs_1.merge(open$, close$, disconnect$, multiplexSubscriptions$, unsubscribe$, withSaveFirstMessageToStore$, updateSubscriptionInput$, withContinueOnConnectChain$, withHeartbeatAtIntervals$, error$, respondWithHeartbeat$).pipe(operators_1.takeUntil(action$.pipe(
    // TODO: not seeing unsubscribe events because of this
    operators_1.filter(actions_1.disconnectFulfilled.match), operators_1.filter((a) => a.payload.config.connectionInfo.key === connectionKey), operators_1.tap((action) => {
        external_adapter_1.logger.debug('WS: Disconnected Fulfilled', connectionMeta(action.payload));
    }))));
    return rxjs_1.concat(rxjs_1.of(actions_1.wsSubscriptionReady(payload)), ws$);
}));
exports.connectEpic = connectEpic;
const recordErrorEpic = (action$) => action$.pipe(operators_1.filter((action) => actions_1.subscriptionError.match(action) && !!action.payload.error), operators_1.mergeMap(({ payload }) => {
    const { wsHandler, error, connectionInfo, subscriptionMsg } = payload;
    const { shouldNotRetryConnection, shouldNotRetrySubscription } = wsHandler;
    return rxjs_1.of(actions_1.subscriptionErrorHandler({
        connectionInfo,
        subscriptionMsg,
        shouldNotRetryConnection: !!shouldNotRetryConnection && shouldNotRetryConnection(error),
        shouldNotRetrySubscription: !!shouldNotRetrySubscription && shouldNotRetrySubscription(error),
    }));
}));
exports.recordErrorEpic = recordErrorEpic;
const writeMessageToCacheEpic = (action$, state$) => action$.pipe(operators_1.filter(actions_1.messageReceived.match), operators_1.filter((action) => action.payload.wsHandler.filter(action.payload.message)), operators_1.withLatestFrom(state$), operators_1.mergeMap(async ([action, state]) => {
    const wsHandler = action.payload.wsHandler;
    try {
        const subscriptionState = state.ws.subscriptions.all[action.payload.subscriptionKey];
        const input = subscriptionState?.input || {};
        if (!input)
            external_adapter_1.logger.warn(`WS: Could not find subscription from incoming message`);
        /**
         * Wrap the payload so that the cache middleware treats it as if
         * it is calling out to the underlying API, which immediately resolves
         * to the websocket message here instead.
         *
         * This results in the cache middleware storing the payload message as a
         * cache value, with the following `wsResponse` as the cache key
         */
        const isToResponseAsync = wsHandler.toResponse.constructor.name === 'AsyncFunction';
        const response = isToResponseAsync
            ? await wsHandler.toResponse(action.payload.message, input)
            : wsHandler.toResponse(action.payload.message, input);
        if (!response)
            return action;
        const execute = () => Promise.resolve(response);
        let context = subscriptionState?.context;
        if (!context) {
            external_adapter_1.logger.warn(`WS Unsubscribe No Response: Could not find context`);
            context = {};
        }
        const cache = await cache_1.withCache()(execute, context);
        const wsConfig = config_1.getWSConfig(input.data?.endpoint);
        /**
         * Create an adapter request we send to the cache middleware
         * so it uses the following object for setting cache keys
         */
        const wsResponse = {
            ...input,
            data: { maxAge: wsConfig.subscriptionTTL, ...input.data },
            debug: { ws: true },
            metricsMeta: { feedId: util_1.getFeedId(input) },
        };
        await cache(wsResponse, context);
        external_adapter_1.logger.trace('WS: Saved result', { input, result: response.result });
    }
    catch (e) {
        external_adapter_1.logger.error(`WS: Cache error: ${e.message}`);
    }
    return action;
}), operators_1.filter(() => false));
exports.writeMessageToCacheEpic = writeMessageToCacheEpic;
const metricsEpic = (action$, state$) => action$.pipe(operators_1.withLatestFrom(state$), operators_1.tap(([action, state]) => {
    const connectionLabels = (payload) => ({
        key: payload.config.connectionInfo.key,
    });
    const connectionErrorLabels = (payload) => ({
        key: payload.connectionInfo.key,
        message: payload.reason,
    });
    const subscriptionLabels = (payload) => ({
        connection_key: payload.connectionInfo.key,
        feed_id: util_1.getFeedId({ ...payload.input }),
        subscription_key: reducer_1.getSubsId(payload.subscriptionMsg),
    });
    const subscriptionErrorLabels = (payload) => ({
        connection_key: payload.connectionInfo.key,
        feed_id: payload.input ? util_1.getFeedId({ ...payload.input }) : 'N/A',
        message: payload.reason,
        subscription_key: payload.subscriptionMsg ? reducer_1.getSubsId(payload.subscriptionMsg) : 'N/A',
    });
    const messageLabels = (payload) => ({
        feed_id: util_1.getFeedId({
            ...state.ws.subscriptions.all[action.payload.subscriptionKey]?.input,
        }),
        subscription_key: payload.subscriptionKey,
    });
    switch (action.type) {
        case actions_1.connectFulfilled.type:
            metrics_1.ws_connection_active.labels(connectionLabels(action.payload)).inc();
            break;
        case actions_1.connectFailed.type:
            metrics_1.ws_connection_errors.labels(connectionErrorLabels(action.payload)).inc();
            break;
        case actions_1.disconnectFulfilled.type:
            if (state.ws.connections.all[connectionLabels(action.payload).key]?.wasEverConnected) {
                metrics_1.ws_connection_active.labels(connectionLabels(action.payload)).dec();
            }
            break;
        case actions_1.subscribeFulfilled.type:
            metrics_1.ws_subscription_total.labels(subscriptionLabels(action.payload)).inc();
            metrics_1.ws_subscription_active.labels(subscriptionLabels(action.payload)).inc();
            break;
        case actions_1.subscriptionError.type:
            metrics_1.ws_subscription_errors.labels(subscriptionErrorLabels(action.payload)).inc();
            break;
        case actions_1.unsubscribeFulfilled.type: {
            if (state.ws.subscriptions.all[reducer_1.getSubsId(action.payload.subscriptionMsg)]?.wasEverActive) {
                metrics_1.ws_subscription_active.labels(subscriptionLabels(action.payload)).dec();
            }
            break;
        }
        case actions_1.messageReceived.type:
            metrics_1.ws_message_total.labels(messageLabels(action.payload)).inc();
            break;
    }
}), operators_1.map(([action]) => action), operators_1.filter(() => false));
exports.metricsEpic = metricsEpic;
exports.rootEpic = redux_observable_1.combineEpics(exports.connectEpic, exports.metricsEpic, exports.subscribeReadyEpic, exports.writeMessageToCacheEpic, exports.recordErrorEpic);
exports.epicMiddleware = redux_observable_1.createEpicMiddleware();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXBpY3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbGliL3dzL2VwaWNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFFQSx1REFBMkU7QUFDM0UsK0JBQXVGO0FBQ3ZGLDhDQVl1QjtBQUN2Qiw4Q0FBMEM7QUFDMUMsb0RBQTBCO0FBQzFCLG9DQUFvQztBQUNwQywwREFBb0Q7QUFDcEQsMENBQTJDO0FBQzNDLHVDQXVCa0I7QUFDbEIsdUNBT2tCO0FBQ2xCLHVDQUFnRDtBQUNoRCxtQ0FBeUM7QUFDekMscUNBQXNDO0FBRXRDLDRDQUE0QztBQUM1QyxzREFBc0Q7QUFDdEQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxPQUFZLEVBQUUsRUFBRTtJQUNwQyxJQUFJO1FBQ0YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtLQUNoQztJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1YseUJBQU0sQ0FBQyxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQTtRQUN4RCxPQUFPLE9BQU8sQ0FBQTtLQUNmO0FBQ0gsQ0FBQyxDQUFBO0FBWU0sTUFBTSxrQkFBa0IsR0FBdUQsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUNoRyxPQUFPLENBQUMsSUFBSSxDQUNWLGtCQUFNLENBQUMsNkJBQW1CLENBQUMsS0FBSyxDQUFDLEVBQ2pDLHFCQUFTLENBQUMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLEVBQUUsRUFBRTtJQUM5QixNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsT0FBTyxDQUFBO0lBQ3ZELE1BQU0sb0JBQW9CLEdBQTRCLEVBQUUsQ0FBQTtJQUN4RCxNQUFNLHVCQUFlLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxXQUEyQixFQUFFLEVBQUU7UUFDbkUsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLGNBQWM7WUFDOUMsQ0FBQyxDQUFDLFNB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QUFzQixDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQTtZQUM1RSxNQUFLO1FBQ1AsS0FBSyw4QkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5QixJQUNFLEtBQUssQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxtQkFBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsRUFBRSxhQUFhLEVBQ3BGO2dCQUNBLGdDQUFzQixDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQTthQUN4RTtZQUNELE1BQUs7U0FDTjtRQUNELEtBQUsseUJBQWUsQ0FBQyxJQUFJO1lBQ3ZCLDBCQUFnQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUE7WUFDNUQsTUFBSztLQUNSO0FBQ0gsQ0FBQyxDQUFDLEVBQ0YsZUFBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQ3pCLGtCQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQ3BCLENBQUE7QUEvRFUsUUFBQSxXQUFXLGVBK0RyQjtBQUVVLFFBQUEsUUFBUSxHQUFHLCtCQUFZLENBQ2xDLG1CQUFXLEVBQ1gsbUJBQVcsRUFDWCwwQkFBa0IsRUFDbEIsK0JBQXVCLEVBQ3ZCLHVCQUFlLENBQ2hCLENBQUE7QUFFWSxRQUFBLGNBQWMsR0FBRyx1Q0FBb0IsRUFBRSxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWRhcHRlclJlcXVlc3QsIEFkYXB0ZXJSZXNwb25zZSwgRXhlY3V0ZSB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBBbnlBY3Rpb24gfSBmcm9tICdyZWR1eCdcbmltcG9ydCB7IGNvbWJpbmVFcGljcywgY3JlYXRlRXBpY01pZGRsZXdhcmUsIEVwaWMgfSBmcm9tICdyZWR1eC1vYnNlcnZhYmxlJ1xuaW1wb3J0IHsgY29uY2F0LCBFTVBUWSwgZnJvbSwgbWVyZ2UsIE9ic2VydmFibGUsIG9mLCByYWNlLCBTdWJqZWN0LCB0aW1lciB9IGZyb20gJ3J4anMnXG5pbXBvcnQge1xuICBjYXRjaEVycm9yLFxuICBjb25jYXRNYXAsXG4gIGRlbGF5LFxuICBlbmRXaXRoLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgbWVyZ2VNYXAsXG4gIHRha2UsXG4gIHRha2VVbnRpbCxcbiAgdGFwLFxuICB3aXRoTGF0ZXN0RnJvbSxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnXG5pbXBvcnQgeyB3ZWJTb2NrZXQgfSBmcm9tICdyeGpzL3dlYlNvY2tldCdcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnXG5pbXBvcnQgeyB3aXRoQ2FjaGUgfSBmcm9tICcuLi9jYWNoZSdcbmltcG9ydCB7IGNlbnNvciwgbG9nZ2VyIH0gZnJvbSAnLi4vZXh0ZXJuYWwtYWRhcHRlcidcbmltcG9ydCB7IGdldEZlZWRJZCB9IGZyb20gJy4uL21ldHJpY3MvdXRpbCdcbmltcG9ydCB7XG4gIGNvbm5lY3RGYWlsZWQsXG4gIGNvbm5lY3RGdWxmaWxsZWQsXG4gIGNvbm5lY3RSZXF1ZXN0ZWQsXG4gIGRpc2Nvbm5lY3RGdWxmaWxsZWQsXG4gIGRpc2Nvbm5lY3RSZXF1ZXN0ZWQsXG4gIG1lc3NhZ2VSZWNlaXZlZCxcbiAgc3Vic2NyaWJlRnVsZmlsbGVkLFxuICBzdWJzY3JpYmVSZXF1ZXN0ZWQsXG4gIHN1YnNjcmlwdGlvbkVycm9yLFxuICB1bnN1YnNjcmliZUZ1bGZpbGxlZCxcbiAgdW5zdWJzY3JpYmVSZXF1ZXN0ZWQsXG4gIFdTQ29uZmlnUGF5bG9hZCxcbiAgV1NFcnJvclBheWxvYWQsXG4gIFdTTWVzc2FnZVBheWxvYWQsXG4gIFdTU3Vic2NyaXB0aW9uRXJyb3JQYXlsb2FkLFxuICBXU1N1YnNjcmlwdGlvblBheWxvYWQsXG4gIFdTQ29uZmlnT3ZlcnJpZGUsXG4gIHdzU3Vic2NyaXB0aW9uUmVhZHksXG4gIHNhdmVGaXJzdE1lc3NhZ2VSZWNlaXZlZCxcbiAgdXBkYXRlU3Vic2NyaXB0aW9uSW5wdXQsXG4gIG9uQ29ubmVjdENvbXBsZXRlLFxuICBzdWJzY3JpcHRpb25FcnJvckhhbmRsZXIsXG59IGZyb20gJy4vYWN0aW9ucydcbmltcG9ydCB7XG4gIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLFxuICB3c19jb25uZWN0aW9uX2Vycm9ycyxcbiAgd3NfbWVzc2FnZV90b3RhbCxcbiAgd3Nfc3Vic2NyaXB0aW9uX2FjdGl2ZSxcbiAgd3Nfc3Vic2NyaXB0aW9uX2Vycm9ycyxcbiAgd3Nfc3Vic2NyaXB0aW9uX3RvdGFsLFxufSBmcm9tICcuL21ldHJpY3MnXG5pbXBvcnQgeyBnZXRTdWJzSWQsIFJvb3RTdGF0ZSB9IGZyb20gJy4vcmVkdWNlcidcbmltcG9ydCB7IHNlcGFyYXRlQmF0Y2hlcyB9IGZyb20gJy4vdXRpbHMnXG5pbXBvcnQgeyBnZXRXU0NvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuXG4vLyBSeGpzIGRlc2VyaWFsaXplciBkZWZhdWx0cyB0byBKU09OLnBhcnNlLlxuLy8gV2UgbmVlZCB0byBoYW5kbGUgZXJyb3JzIGZyb20gbm9uLXBhcnNhYmxlIG1lc3NhZ2VzXG5jb25zdCBkZXNlcmlhbGl6ZXIgPSAobWVzc2FnZTogYW55KSA9PiB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIEpTT04ucGFyc2UobWVzc2FnZS5kYXRhKVxuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdXUzogTWVzc2FnZSByZWNlaXZlZCB3aXRoIGludmFsaWQgZm9ybWF0JylcbiAgICByZXR1cm4gbWVzc2FnZVxuICB9XG59XG5cbnR5cGUgQ29ubmVjdFJlcXVlc3RlZEFjdGlvbldpdGhTdGF0ZSA9IFtcbiAge1xuICAgIHBheWxvYWQ6IFdTQ29uZmlnT3ZlcnJpZGVcbiAgICBjb25uZWN0aW9uS2V5OiBzdHJpbmdcbiAgfSxcbiAge1xuICAgIHdzOiBSb290U3RhdGVcbiAgfSxcbl1cblxuZXhwb3J0IGNvbnN0IHN1YnNjcmliZVJlYWR5RXBpYzogRXBpYzxBbnlBY3Rpb24sIEFueUFjdGlvbiwgeyB3czogUm9vdFN0YXRlIH0sIGFueT4gPSAoYWN0aW9uJCkgPT5cbiAgYWN0aW9uJC5waXBlKFxuICAgIGZpbHRlcih3c1N1YnNjcmlwdGlvblJlYWR5Lm1hdGNoKSxcbiAgICBjb25jYXRNYXAoYXN5bmMgKHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgICBjb25zdCB7IHdzSGFuZGxlciwgY29uZmlnLCBjb250ZXh0LCByZXF1ZXN0IH0gPSBwYXlsb2FkXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25QYXlsb2FkczogV1NTdWJzY3JpcHRpb25QYXlsb2FkW10gPSBbXVxuICAgICAgYXdhaXQgc2VwYXJhdGVCYXRjaGVzKHJlcXVlc3QsIGFzeW5jIChzaW5nbGVJbnB1dDogQWRhcHRlclJlcXVlc3QpID0+IHtcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uTXNnID0gd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluXG4gICAgICAgICAgPyB3c0hhbmRsZXIub25Db25uZWN0Q2hhaW5bMF0ucGF5bG9hZFxuICAgICAgICAgIDogd3NIYW5kbGVyLnN1YnNjcmliZShzaW5nbGVJbnB1dClcbiAgICAgICAgaWYgKCFzdWJzY3JpcHRpb25Nc2cpIHtcbiAgICAgICAgICBsb2dnZXIuZXJyb3IoYE5vIHN1YnNjcmlwdGlvbiBtZXNzYWdlIGZvdW5kIHdoaWxlIHNlcGVyYXRpbmcgYmF0Y2hlc2AsIHtcbiAgICAgICAgICAgIHNpbmdsZUlucHV0LFxuICAgICAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgICB9KVxuICAgICAgICAgIHJldHVyblxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvblBheWxvYWQ6IFdTU3Vic2NyaXB0aW9uUGF5bG9hZCA9IHtcbiAgICAgICAgICBjb25uZWN0aW9uSW5mbzoge1xuICAgICAgICAgICAga2V5OiBjb25maWcuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgICAgICAgdXJsOiB3c0hhbmRsZXIuY29ubmVjdGlvbi51cmwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdWJzY3JpcHRpb25Nc2csXG4gICAgICAgICAgaW5wdXQ6IHNpbmdsZUlucHV0LFxuICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgIH1cbiAgICAgICAgc3Vic2NyaXB0aW9uUGF5bG9hZHMucHVzaChzdWJzY3JpcHRpb25QYXlsb2FkKVxuICAgICAgfSlcbiAgICAgIHJldHVybiBzdWJzY3JpcHRpb25QYXlsb2Fkc1xuICAgIH0pLFxuICAgIG1lcmdlTWFwKChbc3Vic2NyaXB0aW9uUGF5bG9hZF0pID0+IHtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IHN1YnNjcmliZVJlcXVlc3RlZChzdWJzY3JpcHRpb25QYXlsb2FkKVxuICAgICAgaWYgKCFzdWJzY3JpcHRpb25QYXlsb2FkKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZygnSU5WQUxJRF9TVUJTQ1JJQkVfUkVRVUVTVEVEX0lOX1JFQURZX0VQSUMnLCBhY3Rpb24pXG4gICAgICAgIHJldHVybiBFTVBUWVxuICAgICAgfVxuICAgICAgcmV0dXJuIG9mKGFjdGlvbilcbiAgICB9KSxcbiAgKVxuXG5leHBvcnQgY29uc3QgY29ubmVjdEVwaWM6IEVwaWM8QW55QWN0aW9uLCBBbnlBY3Rpb24sIHsgd3M6IFJvb3RTdGF0ZSB9LCBhbnk+ID0gKGFjdGlvbiQsIHN0YXRlJCkgPT5cbiAgYWN0aW9uJC5waXBlKFxuICAgIGZpbHRlcihjb25uZWN0UmVxdWVzdGVkLm1hdGNoKSxcbiAgICBtYXAoKHsgcGF5bG9hZCB9KSA9PiAoeyBwYXlsb2FkLCBjb25uZWN0aW9uS2V5OiBwYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXkgfSkpLFxuICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgZmlsdGVyKChbeyBjb25uZWN0aW9uS2V5IH0sIHN0YXRlXSkgPT4ge1xuICAgICAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW2Nvbm5lY3Rpb25LZXldXG4gICAgICBjb25zdCBpc0FjdGl2ZUNvbm5lY3Rpb24gPSBjb25uZWN0aW9uU3RhdGU/LmFjdGl2ZVxuICAgICAgY29uc3QgaXNDb25uZWN0aW5nID0gY29ubmVjdGlvblN0YXRlPy5jb25uZWN0aW5nID4gMVxuICAgICAgY29uc3QgaGFzRXJyb3JlZCA9IGNvbm5lY3Rpb25TdGF0ZT8uc2hvdWxkTm90UmV0cnlDb25uZWN0aW5nXG4gICAgICByZXR1cm4gKFxuICAgICAgICAhaGFzRXJyb3JlZCAmJlxuICAgICAgICAhaXNBY3RpdmVDb25uZWN0aW9uICYmXG4gICAgICAgICFpc0Nvbm5lY3RpbmcgJiZcbiAgICAgICAgKCFjb25uZWN0aW9uU3RhdGUgfHwgY29ubmVjdGlvblN0YXRlLnJlcXVlc3RJZCA9PT0gMClcbiAgICAgIClcbiAgICB9KSxcbiAgICBjb25jYXRNYXAoYXN5bmMgKGRhdGEpID0+IHtcbiAgICAgIGNvbnN0IGdldFVybCA9IGRhdGFbMF0ucGF5bG9hZC53c0hhbmRsZXIuY29ubmVjdGlvbi5nZXRVcmxcbiAgICAgIGlmIChnZXRVcmwpIGRhdGFbMF0ucGF5bG9hZC53c0hhbmRsZXIuY29ubmVjdGlvbi51cmwgPSBhd2FpdCBnZXRVcmwoZGF0YVswXS5wYXlsb2FkLnJlcXVlc3QpXG4gICAgICByZXR1cm4gZGF0YSBhcyBDb25uZWN0UmVxdWVzdGVkQWN0aW9uV2l0aFN0YXRlXG4gICAgfSksXG4gICAgLy8gb24gYSBjb25uZWN0IGFjdGlvbiBiZWluZyBkaXNwYXRjaGVkLCBvcGVuIGEgbmV3IFdTIGNvbm5lY3Rpb24gaWYgb25lIGRvZXNuJ3QgZXhpc3QgeWV0XG4gICAgbWVyZ2VNYXAoKFt7IGNvbm5lY3Rpb25LZXksIHBheWxvYWQgfV0pID0+IHtcbiAgICAgIGNvbnN0IHsgY29uZmlnLCB3c0hhbmRsZXIgfSA9IHBheWxvYWRcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgY29ubmVjdGlvbjogeyB1cmwsIHByb3RvY29sIH0sXG4gICAgICB9ID0gd3NIYW5kbGVyXG4gICAgICBjb25zdCBjb25uZWN0aW9uTWV0YSA9IChwYXlsb2FkOiBXU0NvbmZpZ1BheWxvYWQpID0+ICh7XG4gICAgICAgIGtleTogcGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgICB1cmw6IGNlbnNvcih1cmwpLFxuICAgICAgfSlcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbk1ldGEgPSAocGF5bG9hZDogV1NTdWJzY3JpcHRpb25QYXlsb2FkKSA9PiAoe1xuICAgICAgICBjb25uZWN0aW9uX2tleTogcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICAgIGNvbm5lY3Rpb25fdXJsOiBjZW5zb3IodXJsKSxcbiAgICAgICAgZmVlZF9pZDogZ2V0RmVlZElkKHsgLi4ucGF5bG9hZC5pbnB1dCB9KSxcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IG9wZW5PYnNlcnZlciA9IG5ldyBTdWJqZWN0KClcbiAgICAgIGNvbnN0IGNsb3NlT2JzZXJ2ZXIgPSBuZXcgU3ViamVjdDxDbG9zZUV2ZW50PigpXG4gICAgICBjb25zdCBlcnJvck9ic2VydmVyID0gbmV3IFN1YmplY3QoKVxuICAgICAgY29uc3QgZXJyb3IkID0gZXJyb3JPYnNlcnZlci5hc09ic2VydmFibGUoKSBhcyBPYnNlcnZhYmxlPEFueUFjdGlvbj5cbiAgICAgIGNvbnN0IFdlYlNvY2tldEN0b3IgPSBXZWJTb2NrZXRcbiAgICAgIGNvbnN0IHdzU3ViamVjdCA9IHdlYlNvY2tldCh7XG4gICAgICAgIHVybCxcbiAgICAgICAgcHJvdG9jb2wsIC8vIFRPRE86IERvdWJsZSBjaGVjayB0aGlzXG4gICAgICAgIGRlc2VyaWFsaXplcixcbiAgICAgICAgb3Blbk9ic2VydmVyLFxuICAgICAgICBjbG9zZU9ic2VydmVyLFxuICAgICAgICBXZWJTb2NrZXRDdG9yOiBXZWJTb2NrZXRDdG9yIGFzIGFueSwgLy8gVE9ETzogZml4IHR5cGVzIGRvbid0IG1hdGNoXG4gICAgICB9KVxuXG4gICAgICB3c0hhbmRsZXIub25Db25uZWN0ICYmIHdzU3ViamVjdC5uZXh0KHdzSGFuZGxlci5vbkNvbm5lY3QocGF5bG9hZC5yZXF1ZXN0KSlcblxuICAgICAgLy8gU3RyZWFtIG9mIFdTIGNvbm5lY3RlZCAmIGRpc2Nvbm5lY3RlZCBldmVudHNcbiAgICAgIGNvbnN0IG9wZW4kID0gb3Blbk9ic2VydmVyLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiBjb25uZWN0RnVsZmlsbGVkKHsgY29uZmlnLCB3c0hhbmRsZXIsIGNvbm5lY3Rpb25JbmZvOiBjb25maWcuY29ubmVjdGlvbkluZm8gfSkpLFxuICAgICAgICB0YXAoKGFjdGlvbikgPT4gbG9nZ2VyLmluZm8oJ1dTOiBDb25uZWN0ZWQnLCBjb25uZWN0aW9uTWV0YShhY3Rpb24ucGF5bG9hZCkpKSxcbiAgICAgIClcbiAgICAgIGNvbnN0IGNsb3NlJCA9IGNsb3NlT2JzZXJ2ZXIucGlwZShcbiAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgbWVyZ2VNYXAoKFtjbG9zZUNvbnRleHQsIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGtleSA9IGNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXlcbiAgICAgICAgICBjb25zdCBhY3RpdmVTdWJzID0gT2JqZWN0LmVudHJpZXMoc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGwpXG4gICAgICAgICAgICAuZmlsdGVyKFxuICAgICAgICAgICAgICAoW18sIGluZm9dKSA9PiAoaW5mby5hY3RpdmUgfHwgaW5mby5zdWJzY3JpYmluZyA+IDApICYmIGluZm8uY29ubmVjdGlvbktleSA9PT0ga2V5LFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLm1hcChcbiAgICAgICAgICAgICAgKFtfLCBpbmZvXSkgPT5cbiAgICAgICAgICAgICAgICAoe1xuICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbkluZm86IHtcbiAgICAgICAgICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgICAgICAgICBrZXk6IGNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uTXNnOiB3c0hhbmRsZXIuc3Vic2NyaWJlKGluZm8uaW5wdXQpLFxuICAgICAgICAgICAgICAgICAgaW5wdXQ6IGluZm8uaW5wdXQsXG4gICAgICAgICAgICAgICAgfSBhcyBXU1N1YnNjcmlwdGlvblBheWxvYWQpLFxuICAgICAgICAgICAgKVxuICAgICAgICAgIGNvbnN0IHRvVW5zdWJzY3JpYmVkID0gKHBheWxvYWQ6IFdTU3Vic2NyaXB0aW9uUGF5bG9hZCkgPT4gdW5zdWJzY3JpYmVGdWxmaWxsZWQocGF5bG9hZClcbiAgICAgICAgICBsb2dnZXIuaW5mbygnQ2xvc2luZyB3ZWJzb2NrZXQgY29ubmVjdGlvbicsIHtcbiAgICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgICAgdHlwZTogY2xvc2VDb250ZXh0LnR5cGUsXG4gICAgICAgICAgICAgIHdhc0NsZWFuOiBjbG9zZUNvbnRleHQud2FzQ2xlYW4sXG4gICAgICAgICAgICAgIHJlYXNvbjogY2xvc2VDb250ZXh0LnJlYXNvbixcbiAgICAgICAgICAgICAgY29kZTogY2xvc2VDb250ZXh0LmNvZGUsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmV0dXJuIGZyb20oW1xuICAgICAgICAgICAgLi4uYWN0aXZlU3Vicy5tYXAodG9VbnN1YnNjcmliZWQpLFxuICAgICAgICAgICAgZGlzY29ubmVjdEZ1bGZpbGxlZCh7XG4gICAgICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICAgICAgd3NIYW5kbGVyLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgXSlcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIC8vIENsb3NlIHRoZSBXUyBjb25uZWN0aW9uIG9uIGRpc2Nvbm5lY3RcbiAgICAgIGNvbnN0IGRpc2Nvbm5lY3QkID0gYWN0aW9uJC5waXBlKFxuICAgICAgICBmaWx0ZXIoZGlzY29ubmVjdFJlcXVlc3RlZC5tYXRjaCksXG4gICAgICAgIGZpbHRlcigoeyBwYXlsb2FkIH0pID0+IHBheWxvYWQuY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSA9PT0gY29ubmVjdGlvbktleSksXG4gICAgICAgIHRhcCgoKSA9PiB3c1N1YmplY3QuY2xvc2VkIHx8IHdzU3ViamVjdC5jb21wbGV0ZSgpKSxcbiAgICAgICAgdGFwKChhY3Rpb24pID0+IGxvZ2dlci5pbmZvKCdXUzogRGlzY29ubmVjdGVkJywgY29ubmVjdGlvbk1ldGEoYWN0aW9uLnBheWxvYWQpKSksXG4gICAgICAgIGZpbHRlcigoKSA9PiBmYWxzZSksIC8vIGRvIG5vdCBkdXBsaWNhdGUgZXZlbnRzXG4gICAgICApXG5cbiAgICAgIC8vIFN1YnNjcmlwdGlvbiByZXF1ZXN0c1xuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9ucyQgPSBhY3Rpb24kLnBpcGUoZmlsdGVyKHN1YnNjcmliZVJlcXVlc3RlZC5tYXRjaCkpXG5cbiAgICAgIGNvbnN0IHVwZGF0ZVN1YnNjcmlwdGlvbklucHV0JCA9IHN1YnNjcmlwdGlvbnMkLnBpcGUoXG4gICAgICAgIGZpbHRlcigoeyBwYXlsb2FkIH0pID0+IHBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgbWFwKCh7IHBheWxvYWQgfSkgPT4gKHtcbiAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgIHN1YnNjcmlwdGlvbktleTogZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSxcbiAgICAgICAgfSkpLFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBmaWx0ZXIoKFt7IHN1YnNjcmlwdGlvbktleSwgcGF5bG9hZCB9LCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICBjb25zdCBpc0FjdGl2ZVN1YnNjcmlwdGlvbiA9ICEhc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uYWN0aXZlXG4gICAgICAgICAgY29uc3QgaXNTdWJzY3JpYmluZyA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LnN1YnNjcmliaW5nID4gMVxuICAgICAgICAgIGlmICghaXNBY3RpdmVTdWJzY3JpcHRpb24gfHwgaXNTdWJzY3JpYmluZykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRJbnB1dCA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LmlucHV0XG4gICAgICAgICAgcmV0dXJuIGdldFN1YnNJZChjdXJyZW50SW5wdXQpICE9PSBnZXRTdWJzSWQocGF5bG9hZC5pbnB1dClcbiAgICAgICAgfSksXG4gICAgICAgIG1lcmdlTWFwKGFzeW5jIChbeyBzdWJzY3JpcHRpb25LZXksIHBheWxvYWQgfV0pID0+IHtcbiAgICAgICAgICByZXR1cm4gdXBkYXRlU3Vic2NyaXB0aW9uSW5wdXQoe1xuICAgICAgICAgICAgc3Vic2NyaXB0aW9uS2V5LFxuICAgICAgICAgICAgaW5wdXQ6IHBheWxvYWQuaW5wdXQsXG4gICAgICAgICAgfSlcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIC8vIE11bHRpcGxleCBzdWJzY3JpcHRpb25zXG4gICAgICBjb25zdCBtdWx0aXBsZXhTdWJzY3JpcHRpb25zJCA9IHN1YnNjcmlwdGlvbnMkLnBpcGUoXG4gICAgICAgIGZpbHRlcigoeyBwYXlsb2FkIH0pID0+IHBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgbWFwKCh7IHBheWxvYWQgfSkgPT4gKHtcbiAgICAgICAgICBwYXlsb2FkLFxuICAgICAgICAgIHN1YnNjcmlwdGlvbktleTogZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSxcbiAgICAgICAgfSkpLFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBmaWx0ZXIoKFt7IHN1YnNjcmlwdGlvbktleSwgcGF5bG9hZCB9LCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICBjb25zdCBpc0FjdGl2ZVN1YnNjcmlwdGlvbiA9ICEhc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uYWN0aXZlXG4gICAgICAgICAgY29uc3QgaXNTdWJzY3JpYmluZyA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LnN1YnNjcmliaW5nID4gMVxuICAgICAgICAgIGNvbnN0IHNob3VsZE5vdFJldHJ5U3Vic2NyaWJpbmcgPVxuICAgICAgICAgICAgc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uc2hvdWxkTm90UmV0cnlcbiAgICAgICAgICBjb25zdCBpc05vdEFjdGl2ZSA9ICFpc0FjdGl2ZVN1YnNjcmlwdGlvbiAmJiAhaXNTdWJzY3JpYmluZ1xuICAgICAgICAgIGNvbnN0IHsgaXNEYXRhTWVzc2FnZSwgb25Db25uZWN0Q2hhaW4gfSA9IHdzSGFuZGxlclxuICAgICAgICAgIGlmIChpc0RhdGFNZXNzYWdlICYmIG9uQ29ubmVjdENoYWluICYmIGlzRGF0YU1lc3NhZ2UocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpKSB7XG4gICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdGUgPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldXG4gICAgICAgICAgICBjb25zdCBoYXNPbkNvbm5lY3RDaGFpbkNvbXBsZXRlZCA9IGNvbm5lY3Rpb25TdGF0ZS5yZXF1ZXN0SWQgPj0gb25Db25uZWN0Q2hhaW4ubGVuZ3RoXG4gICAgICAgICAgICByZXR1cm4gIXNob3VsZE5vdFJldHJ5U3Vic2NyaWJpbmcgJiYgaXNOb3RBY3RpdmUgJiYgaGFzT25Db25uZWN0Q2hhaW5Db21wbGV0ZWRcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuICFzaG91bGROb3RSZXRyeVN1YnNjcmliaW5nICYmIGlzTm90QWN0aXZlXG4gICAgICAgIH0pLFxuICAgICAgICAvLyBvbiBhIHN1YnNjcmliZSBhY3Rpb24gYmVpbmcgZGlzcGF0Y2hlZCwgb3BlbiBhIG5ldyBXUyBzdWJzY3JpcHRpb24gaWYgb25lIGRvZXNuJ3QgZXhpc3QgeWV0XG4gICAgICAgIG1lcmdlTWFwKChbeyBzdWJzY3JpcHRpb25LZXksIHBheWxvYWQgfSwgc3RhdGVdKSA9PlxuICAgICAgICAgIHdzU3ViamVjdFxuICAgICAgICAgICAgLm11bHRpcGxleChcbiAgICAgICAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNsb25lZFBheWxvYWQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSlcbiAgICAgICAgICAgICAgICBjb25zdCBzaG91bGRNb2RpZnlQYXlsb2FkID1cbiAgICAgICAgICAgICAgICAgICEhd3NIYW5kbGVyLnNob3VsZE1vZGlmeVBheWxvYWQgJiZcbiAgICAgICAgICAgICAgICAgIHdzSGFuZGxlci5zaG91bGRNb2RpZnlQYXlsb2FkKGNsb25lZFBheWxvYWQpICYmXG4gICAgICAgICAgICAgICAgICB3c0hhbmRsZXIubW9kaWZ5U3Vic2NyaXB0aW9uUGF5bG9hZFxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLndzLmNvbm5lY3Rpb25zLmFsbFtwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleV1cbiAgICAgICAgICAgICAgICBjb25zdCBzdWJNc2cgPVxuICAgICAgICAgICAgICAgICAgc2hvdWxkTW9kaWZ5UGF5bG9hZCAmJiB3c0hhbmRsZXIubW9kaWZ5U3Vic2NyaXB0aW9uUGF5bG9hZFxuICAgICAgICAgICAgICAgICAgICA/IHdzSGFuZGxlci5tb2RpZnlTdWJzY3JpcHRpb25QYXlsb2FkKFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xvbmVkUGF5bG9hZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LnN1YnNjcmlwdGlvblBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZS5jb25uZWN0aW9uUGFyYW1zLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLnJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIDogY2xvbmVkUGF5bG9hZFxuICAgICAgICAgICAgICAgIHJldHVybiBzdWJNc2dcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgKCkgPT5cbiAgICAgICAgICAgICAgICB3c0hhbmRsZXIudW5zdWJzY3JpYmUoXG4gICAgICAgICAgICAgICAgICBwYXlsb2FkLmlucHV0LFxuICAgICAgICAgICAgICAgICAgc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uc3Vic2NyaXB0aW9uUGFyYW1zLFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIChtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW3BheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XVxuICAgICAgICAgICAgICAgIGNvbnN0IHNob3VsZFBhc3NBbG9uZyA9XG4gICAgICAgICAgICAgICAgICAocGF5bG9hZC5maWx0ZXJNdWx0aXBsZXggJiYgcGF5bG9hZC5maWx0ZXJNdWx0aXBsZXgobWVzc2FnZSkpIHx8XG4gICAgICAgICAgICAgICAgICBnZXRTdWJzSWQoXG4gICAgICAgICAgICAgICAgICAgIHdzSGFuZGxlci5zdWJzRnJvbU1lc3NhZ2UoXG4gICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLnN1YnNjcmlwdGlvbk1zZyxcbiAgICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLmlucHV0LFxuICAgICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZT8uY29ubmVjdGlvblBhcmFtcyxcbiAgICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgICkgPT09IHN1YnNjcmlwdGlvbktleVxuICAgICAgICAgICAgICAgIGlmICghc2hvdWxkUGFzc0Fsb25nKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogSWYgdGhlIGVycm9yIGhhcHBlbnMgb24gdGhlIHN1YnNjcmlwdGlvbiwgaXQgd2lsbCBiZSBvbiBzdWJzY3JpYmluZyBzdGF0ZSBhbmQgZXZlbnR1YWxseSB1bnJlc3BvbnNpdmVUaW1lb3V0IHdpbGwgdGFrZSBjYXJlIG9mIGl0ICh1bnN1YnMvc3VicylcbiAgICAgICAgICAgICAgICAgKiBJZiB0aGUgZXJyb3IgaGFwcGVucyBkdXJpbmcgYSBzdWJzY3JpcHRpb24sIGFuZCBpcyBvbmx5IGV2ZW50dWFsLCBjYW4gYmUgaWdub3JlZFxuICAgICAgICAgICAgICAgICAqIElmIHRoZSBlcnJvciBoYXBwZW5zIGR1cmluZyBhIHN1YnNjcmlwdGlvbiwgYW5kIHRoZSBzdWJzY3JpcHRpb24gc3RvcCByZWNlaXZpbmcgbWVzc2FnZXMsIHRoZSB1bnJlc3BvbnNpdmVUaW1lb3V0IHdpbGwgdGFrZSBjYXJlIG9mIGl0ICh1bnN1YnMvc3VicylcbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICBpZiAod3NIYW5kbGVyLmlzRXJyb3IobWVzc2FnZSkpIHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0ge1xuICAgICAgICAgICAgICAgICAgICByZWFzb246IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpLFxuICAgICAgICAgICAgICAgICAgICBjb25uZWN0aW9uSW5mbzogeyBrZXk6IGNvbm5lY3Rpb25LZXksIHVybCB9LFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcignV1M6IEVycm9yJywgZXJyb3IpXG4gICAgICAgICAgICAgICAgICBlcnJvck9ic2VydmVyLm5leHQoXG4gICAgICAgICAgICAgICAgICAgIHN1YnNjcmlwdGlvbkVycm9yKHtcbiAgICAgICAgICAgICAgICAgICAgICAuLi5lcnJvcixcbiAgICAgICAgICAgICAgICAgICAgICB3c0hhbmRsZXIsXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlXG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgd2l0aExhdGVzdEZyb20oc3RhdGUkKSxcbiAgICAgICAgICAgICAgbWVyZ2VNYXAoKFttZXNzYWdlLCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZVN1YnNjcmlwdGlvbiA9ICEhc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uYWN0aXZlXG4gICAgICAgICAgICAgICAgY29uc3QgYWN0aW9uUGF5bG9hZCA9IHtcbiAgICAgICAgICAgICAgICAgIG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICBzdWJzY3JpcHRpb25LZXksXG4gICAgICAgICAgICAgICAgICBpbnB1dDogcGF5bG9hZC5pbnB1dCxcbiAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHBheWxvYWQuY29udGV4dCxcbiAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25JbmZvOiBwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLFxuICAgICAgICAgICAgICAgICAgd3NIYW5kbGVyLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWlzQWN0aXZlU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygnV1M6IFN1YnNjcmliZWQnLCBzdWJzY3JpcHRpb25NZXRhKHBheWxvYWQpKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIG9mKHN1YnNjcmliZUZ1bGZpbGxlZChwYXlsb2FkKSwgbWVzc2FnZVJlY2VpdmVkKGFjdGlvblBheWxvYWQpKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gb2YobWVzc2FnZVJlY2VpdmVkKGFjdGlvblBheWxvYWQpKVxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgdGFrZVVudGlsKFxuICAgICAgICAgICAgICAgIG1lcmdlKFxuICAgICAgICAgICAgICAgICAgYWN0aW9uJC5waXBlKFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIodW5zdWJzY3JpYmVSZXF1ZXN0ZWQubWF0Y2gpLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKGEpID0+IGdldFN1YnNJZChhLnBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSA9PT0gc3Vic2NyaXB0aW9uS2V5KSxcbiAgICAgICAgICAgICAgICAgICAgdGFwKChhKSA9PiBsb2dnZXIuaW5mbygnV1M6IFVuc3Vic2NyaWJlZCcsIHN1YnNjcmlwdGlvbk1ldGEoYS5wYXlsb2FkKSkpLFxuICAgICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgICAgIGFjdGlvbiQucGlwZShcbiAgICAgICAgICAgICAgICAgICAgZmlsdGVyKGRpc2Nvbm5lY3RGdWxmaWxsZWQubWF0Y2gpLFxuICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoKGEpID0+IGEucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm8ua2V5ID09PSBjb25uZWN0aW9uS2V5KSxcbiAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgZW5kV2l0aCh1bnN1YnNjcmliZUZ1bGZpbGxlZChwYXlsb2FkKSksXG4gICAgICAgICAgICApLFxuICAgICAgICApLFxuICAgICAgICBjYXRjaEVycm9yKChlKSA9PiB7XG4gICAgICAgICAgbG9nZ2VyLmVycm9yKGUpXG4gICAgICAgICAgcmV0dXJuIG9mKFxuICAgICAgICAgICAgY29ubmVjdEZhaWxlZCh7IGNvbm5lY3Rpb25JbmZvOiB7IGtleTogY29ubmVjdGlvbktleSwgdXJsIH0sIHJlYXNvbjogZS5tZXNzYWdlIH0pLFxuICAgICAgICAgIClcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHdpdGhIZWFydGJlYXRBdEludGVydmFscyQgPSBhY3Rpb24kLnBpcGUoXG4gICAgICAgIGZpbHRlcigoYWN0aW9uKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIGNvbm5lY3RGdWxmaWxsZWQubWF0Y2goYWN0aW9uKSAmJiAhIXdzSGFuZGxlci5oZWFydGJlYXRNZXNzYWdlXG4gICAgICAgIH0pLFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBmaWx0ZXIoKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25LZXkgPSBhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXlcbiAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdGUgPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbY29ubmVjdGlvbktleV1cbiAgICAgICAgICByZXR1cm4gISFjb25uZWN0aW9uU3RhdGUgJiYgY29ubmVjdGlvblN0YXRlLmFjdGl2ZVxuICAgICAgICB9KSxcbiAgICAgICAgbWVyZ2VNYXAoKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbm5lY3Rpb25LZXkgPSBhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXlcbiAgICAgICAgICBjb25zdCBjb25uZWN0aW9uU3RhdGUgPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbY29ubmVjdGlvbktleV1cbiAgICAgICAgICBjb25zdCBpbnRlcnZhbCA9IHdzSGFuZGxlci5oZWFydGJlYXRJbnRlcnZhbEluTVMgfHwgY29uZmlnLmRlZmF1bHRIZWFydGJlYXRJbnRlcnZhbEluTVNcbiAgICAgICAgICByZXR1cm4gdGltZXIoaW50ZXJ2YWwsIGludGVydmFsKS5waXBlKFxuICAgICAgICAgICAgdGFwKCgpID0+IGxvZ2dlci5kZWJ1ZygnU2VuZGluZyBoZWFydGJlYXQgbWVzc2FnZScpKSxcbiAgICAgICAgICAgIG1lcmdlTWFwKCgpID0+IHtcbiAgICAgICAgICAgICAgaWYgKHdzSGFuZGxlci5oZWFydGJlYXRNZXNzYWdlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaGVhcnRiZWF0UGF5bG9hZCA9IHdzSGFuZGxlci5oZWFydGJlYXRNZXNzYWdlKFxuICAgICAgICAgICAgICAgICAgY29ubmVjdGlvblN0YXRlLnJlcXVlc3RJZCxcbiAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25TdGF0ZS5jb25uZWN0aW9uUGFyYW1zLFxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB3c1N1YmplY3QubmV4dChoZWFydGJlYXRQYXlsb2FkKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBFTVBUWVxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB0YWtlVW50aWwoXG4gICAgICAgICAgICAgIGFjdGlvbiQucGlwZShcbiAgICAgICAgICAgICAgICBmaWx0ZXIoZGlzY29ubmVjdEZ1bGZpbGxlZC5tYXRjaCksXG4gICAgICAgICAgICAgICAgZmlsdGVyKChhY3Rpb24pID0+IGFjdGlvbi5wYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXkgPT09IGNvbm5lY3Rpb25LZXkpLFxuICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApXG4gICAgICAgIH0pLFxuICAgICAgKVxuXG4gICAgICAvLyBBbGwgcmVjZWl2ZWQgbWVzc2FnZXMgdXNpbmcgdGhlIHNhbWUgY29ubmVjdGlvbiBrZXlcbiAgICAgIGNvbnN0IG1lc3NhZ2UkID0gYWN0aW9uJC5waXBlKFxuICAgICAgICBmaWx0ZXIobWVzc2FnZVJlY2VpdmVkLm1hdGNoKSxcbiAgICAgICAgZmlsdGVyKChhY3Rpb24pID0+IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleSA9PT0gY29ubmVjdGlvbktleSksXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHdpdGhDb250aW51ZU9uQ29ubmVjdENoYWluJCA9IG1lc3NhZ2UkLnBpcGUoXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIGZpbHRlcigoW2FjdGlvbiwgc3RhdGVdKSA9PiB7XG4gICAgICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XG4gICAgICAgICAgY29uc3QgY29ubmVjdGlvblN0YXRlID0gc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW2tleV1cbiAgICAgICAgICByZXR1cm4gKFxuICAgICAgICAgICAgISFjb25uZWN0aW9uU3RhdGUgJiZcbiAgICAgICAgICAgICEhd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluICYmXG4gICAgICAgICAgICBjb25uZWN0aW9uU3RhdGUucmVxdWVzdElkIDw9IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbi5sZW5ndGhcbiAgICAgICAgICApXG4gICAgICAgIH0pLFxuICAgICAgICBtZXJnZU1hcCgoW3sgcGF5bG9hZCB9LCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICBjb25zdCB7IGlucHV0LCBjb250ZXh0LCBtZXNzYWdlIH0gPSBwYXlsb2FkXG4gICAgICAgICAgY29uc3Qgb25Db25uZWN0SWR4ID0gc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW3BheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XVxuICAgICAgICAgICAgPyBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxbcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldLnJlcXVlc3RJZFxuICAgICAgICAgICAgOiAwXG4gICAgICAgICAgaWYgKCF3c0hhbmRsZXIub25Db25uZWN0Q2hhaW4gfHwgb25Db25uZWN0SWR4ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBFTVBUWVxuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBvbkNvbm5lY3RDaGFpbkZpbmlzaGVkID0gb25Db25uZWN0SWR4ID49IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbi5sZW5ndGhcbiAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25Nc2cgPSBvbkNvbm5lY3RDaGFpbkZpbmlzaGVkXG4gICAgICAgICAgICA/IHdzSGFuZGxlci5zdWJzY3JpYmUoaW5wdXQpXG4gICAgICAgICAgICA6IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbltvbkNvbm5lY3RJZHhdLnBheWxvYWRcbiAgICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25QYXlsb2FkOiBXU1N1YnNjcmlwdGlvblBheWxvYWQgPSB7XG4gICAgICAgICAgICBjb25uZWN0aW9uSW5mbzoge1xuICAgICAgICAgICAgICBrZXk6IGNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICAgICAgICAgIHVybDogd3NIYW5kbGVyLmNvbm5lY3Rpb24udXJsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN1YnNjcmlwdGlvbk1zZyxcbiAgICAgICAgICAgIGlucHV0LFxuICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIG1lc3NhZ2VUb1NhdmU6XG4gICAgICAgICAgICAgIHdzSGFuZGxlci5zaG91bGRTYXZlVG9Db25uZWN0aW9uICYmXG4gICAgICAgICAgICAgIHdzSGFuZGxlci5zaG91bGRTYXZlVG9Db25uZWN0aW9uKG1lc3NhZ2UpICYmXG4gICAgICAgICAgICAgIHdzSGFuZGxlci5zYXZlT25Db25uZWN0VG9Db25uZWN0aW9uXG4gICAgICAgICAgICAgICAgPyB3c0hhbmRsZXIuc2F2ZU9uQ29ubmVjdFRvQ29ubmVjdGlvbihtZXNzYWdlKVxuICAgICAgICAgICAgICAgIDogbnVsbCxcbiAgICAgICAgICAgIGZpbHRlck11bHRpcGxleDogb25Db25uZWN0Q2hhaW5GaW5pc2hlZFxuICAgICAgICAgICAgICA/IHVuZGVmaW5lZFxuICAgICAgICAgICAgICA6IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbltvbkNvbm5lY3RJZHhdLmZpbHRlcixcbiAgICAgICAgICAgIHNob3VsZE5ldmVyVW5zdWJzY3JpYmU6IG9uQ29ubmVjdENoYWluRmluaXNoZWRcbiAgICAgICAgICAgICAgPyBmYWxzZVxuICAgICAgICAgICAgICA6IHdzSGFuZGxlci5vbkNvbm5lY3RDaGFpbltvbkNvbm5lY3RJZHhdLnNob3VsZE5ldmVyVW5zdWJzY3JpYmUsXG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnN0IHN1YnNjcmliZVJlcXVlc3RlZEFjdGlvbiA9IHN1YnNjcmliZVJlcXVlc3RlZChzdWJzY3JpcHRpb25QYXlsb2FkKVxuICAgICAgICAgIGlmIChvbkNvbm5lY3RDaGFpbkZpbmlzaGVkKSB7XG4gICAgICAgICAgICByZXR1cm4gb2Yoc3Vic2NyaWJlUmVxdWVzdGVkQWN0aW9uLCBvbkNvbm5lY3RDb21wbGV0ZShzdWJzY3JpcHRpb25QYXlsb2FkKSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG9mKHN1YnNjcmliZVJlcXVlc3RlZEFjdGlvbilcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHdpdGhTYXZlRmlyc3RNZXNzYWdlVG9TdG9yZSQgPSBtZXNzYWdlJC5waXBlKFxuICAgICAgICBmaWx0ZXIoKCkgPT4ge1xuICAgICAgICAgIHJldHVybiAhIXdzSGFuZGxlci50b1NhdmVGcm9tRmlyc3RNZXNzYWdlXG4gICAgICAgIH0pLFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBmaWx0ZXIoKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGtleSA9IGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleVxuICAgICAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2tleV1cbiAgICAgICAgICByZXR1cm4gc3Vic2NyaXB0aW9uICYmICFzdWJzY3JpcHRpb24uc3Vic2NyaXB0aW9uUGFyYW1zXG4gICAgICAgIH0pLFxuICAgICAgICBtZXJnZU1hcCgoW2FjdGlvbl0pID0+IHtcbiAgICAgICAgICBjb25zdCB0b1NhdmUgPVxuICAgICAgICAgICAgd3NIYW5kbGVyLnRvU2F2ZUZyb21GaXJzdE1lc3NhZ2UgJiZcbiAgICAgICAgICAgIHdzSGFuZGxlci50b1NhdmVGcm9tRmlyc3RNZXNzYWdlKGFjdGlvbi5wYXlsb2FkLm1lc3NhZ2UpXG4gICAgICAgICAgcmV0dXJuIHRvU2F2ZVxuICAgICAgICAgICAgPyBvZihcbiAgICAgICAgICAgICAgICBzYXZlRmlyc3RNZXNzYWdlUmVjZWl2ZWQoe1xuICAgICAgICAgICAgICAgICAgc3Vic2NyaXB0aW9uS2V5OiBhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25LZXksXG4gICAgICAgICAgICAgICAgICBtZXNzYWdlOiB0b1NhdmUsXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIDogRU1QVFlcbiAgICAgICAgfSksXG4gICAgICApXG5cbiAgICAgIGNvbnN0IHJlc3BvbmRXaXRoSGVhcnRiZWF0JCA9IG1lc3NhZ2UkLnBpcGUoXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAoYWN0aW9uKSA9PlxuICAgICAgICAgICAgISF3c0hhbmRsZXIuc2hvdWxkUmVwbHlUb1NlcnZlckhlYXJ0YmVhdCAmJlxuICAgICAgICAgICAgd3NIYW5kbGVyLnNob3VsZFJlcGx5VG9TZXJ2ZXJIZWFydGJlYXQoYWN0aW9uLnBheWxvYWQubWVzc2FnZSksXG4gICAgICAgICksXG4gICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgIG1lcmdlTWFwKChbYWN0aW9uLCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICBjb25zdCB7IGNvbm5lY3Rpb25JbmZvLCBtZXNzYWdlIH0gPSBhY3Rpb24ucGF5bG9hZFxuICAgICAgICAgIGNvbnN0IGtleSA9IGNvbm5lY3Rpb25JbmZvLmtleVxuICAgICAgICAgIGNvbnN0IHsgcmVxdWVzdElkLCBjb25uZWN0aW9uUGFyYW1zIH0gPSBzdGF0ZS53cy5jb25uZWN0aW9ucy5hbGxba2V5XVxuICAgICAgICAgIGlmICh3c0hhbmRsZXIuaGVhcnRiZWF0UmVwbHlNZXNzYWdlKSB7XG4gICAgICAgICAgICBjb25zdCBoZWFydGJlYXRNZXNzYWdlID0gd3NIYW5kbGVyLmhlYXJ0YmVhdFJlcGx5TWVzc2FnZShcbiAgICAgICAgICAgICAgbWVzc2FnZSxcbiAgICAgICAgICAgICAgcmVxdWVzdElkLFxuICAgICAgICAgICAgICBjb25uZWN0aW9uUGFyYW1zLFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdSZXNwb25kaW5nIHdpdGggaGVhcnRiZWF0IHBheWxvYWQnLCBoZWFydGJlYXRNZXNzYWdlKVxuICAgICAgICAgICAgd3NTdWJqZWN0Lm5leHQoaGVhcnRiZWF0TWVzc2FnZSlcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIG9mKGFjdGlvbilcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcigoKSA9PiBmYWxzZSksXG4gICAgICApXG5cbiAgICAgIC8vIE9uY2UgYSByZXF1ZXN0IGhhcHBlbnMsIGEgc3Vic2NyaXB0aW9uIHRpbWVvdXQgc3RhcnRzLiBJZiBubyBtb3JlIHJlcXVlc3RzIGFzayBmb3JcbiAgICAgIC8vIHRoaXMgc3Vic2NyaXB0aW9uIGJlZm9yZSB0aGUgdGltZSBydW5zIG91dCwgaXQgd2lsbCBiZSB1bnN1YnNjcmliZWRcbiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlT25UaW1lb3V0JCA9IHN1YnNjcmlwdGlvbnMkLnBpcGUoXG4gICAgICAgIGZpbHRlcigoYWN0aW9uKSA9PiAhYWN0aW9uLnBheWxvYWQuc2hvdWxkTmV2ZXJVbnN1YnNjcmliZSksXG4gICAgICAgIC8vIHdoZW4gYSBzdWJzY3JpcHRpb24gY29tZXMgaW5cbiAgICAgICAgLy8gVE9ETzogd2UgbmVlZCB0byBmaWx0ZXIgZHVwbGljYXRlZCBzdWJzY3JpcHRpb25zIGhlcmVcbiAgICAgICAgbWVyZ2VNYXAoKHsgcGF5bG9hZCB9KSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uS2V5ID0gZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKVxuICAgICAgICAgIC8vIHdlIGxvb2sgZm9yIG1hdGNoaW5nIHN1YnNjcmlwdGlvbnMgb2YgdGhlIHNhbWUgdHlwZVxuICAgICAgICAgIC8vIHdoaWNoIGRlYWN0aXZhdGVzIHRoZSBjdXJyZW50IHRpbWVyXG4gICAgICAgICAgY29uc3QgcmVzZXQkID0gc3Vic2NyaXB0aW9ucyQucGlwZShcbiAgICAgICAgICAgIGZpbHRlcigoeyBwYXlsb2FkIH0pID0+IHN1YnNjcmlwdGlvbktleSA9PT0gZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSksXG4gICAgICAgICAgICB0YWtlKDEpLFxuICAgICAgICAgIClcbiAgICAgICAgICAvLyBzdGFydCB0aGUgY3VycmVudCB1bnN1YnNjcmlwdGlvbiB0aW1lclxuICAgICAgICAgIGNvbnN0IHRpbWVvdXQkID0gb2YodW5zdWJzY3JpYmVSZXF1ZXN0ZWQoeyAuLi5wYXlsb2FkIH0pKS5waXBlKFxuICAgICAgICAgICAgZGVsYXkoY29uZmlnLnN1YnNjcmlwdGlvblRUTCksXG4gICAgICAgICAgICB0YXAoKCkgPT5cbiAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdXUzogdW5zdWJzY3JpYmUgKGluYWN0aXZlIGZlZWQpJywgeyBwYXlsb2FkOiBwYXlsb2FkLnN1YnNjcmlwdGlvbk1zZyB9KSxcbiAgICAgICAgICAgICksXG4gICAgICAgICAgKVxuICAgICAgICAgIC8vIGlmIGEgcmUtc3Vic2NyaXB0aW9uIGNvbWVzIGluIGJlZm9yZSB0aW1lb3V0IGVtaXRzLCB0aGVuIHdlIGVtaXQgbm90aGluZ1xuICAgICAgICAgIC8vIGVsc2Ugd2UgdW5zdWJzY3JpYmUgZnJvbSB0aGUgY3VycmVudCBzdWJzY3JpcHRpb25cbiAgICAgICAgICByZXR1cm4gcmFjZShyZXNldCQsIHRpbWVvdXQkKS5waXBlKGZpbHRlcigoYSkgPT4gIXN1YnNjcmliZVJlcXVlc3RlZC5tYXRjaChhKSkpXG4gICAgICAgIH0pLFxuICAgICAgKVxuXG4gICAgICBjb25zdCB1bnN1YnNjcmliZU9uTm9SZXNwb25zZSQgPSBtZXNzYWdlJC5waXBlKFxuICAgICAgICB3aXRoTGF0ZXN0RnJvbShzdGF0ZSQpLFxuICAgICAgICBtZXJnZU1hcChcbiAgICAgICAgICAoW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBwYXlsb2FkOiB7IHN1YnNjcmlwdGlvbktleSB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHN0YXRlLFxuICAgICAgICAgIF0pID0+IHtcbiAgICAgICAgICAgIGxldCBpbnB1dCA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW3N1YnNjcmlwdGlvbktleV0/LmlucHV0XG4gICAgICAgICAgICBpZiAoIWlucHV0KSB7XG4gICAgICAgICAgICAgIGxvZ2dlci53YXJuKGBXUzogQ291bGQgbm90IGZpbmQgc3Vic2NyaXB0aW9uIGZyb20gaW5jb21pbmcgbWVzc2FnZWApXG4gICAgICAgICAgICAgIGlucHV0ID0ge30gYXMgQWRhcHRlclJlcXVlc3RcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVzZXQkID0gbWVzc2FnZSQucGlwZShcbiAgICAgICAgICAgICAgZmlsdGVyKCh7IHBheWxvYWQgfSkgPT4gc3Vic2NyaXB0aW9uS2V5ID09PSBwYXlsb2FkLnN1YnNjcmlwdGlvbktleSksXG4gICAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICApXG5cbiAgICAgICAgICAgIGxldCBjb250ZXh0ID0gc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uY29udGV4dFxuICAgICAgICAgICAgaWYgKCFjb250ZXh0KSB7XG4gICAgICAgICAgICAgIGxvZ2dlci53YXJuKGBXUyBVbnN1YnNjcmliZSBObyBSZXNwb25zZTogQ291bGQgbm90IGZpbmQgY29udGV4dGApXG4gICAgICAgICAgICAgIGNvbnRleHQgPSB7fVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICAgICAgICAgIGlucHV0LFxuICAgICAgICAgICAgICBzdWJzY3JpcHRpb25Nc2c6IHdzSGFuZGxlci5zdWJzY3JpYmUoaW5wdXQpLFxuICAgICAgICAgICAgICBjb25uZWN0aW9uSW5mbzogeyBrZXk6IGNvbm5lY3Rpb25LZXksIHVybCB9LFxuICAgICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBzdWJSZXFBY3Rpb24gPSBzdWJzY3JpYmVSZXF1ZXN0ZWQoYWN0aW9uKVxuXG4gICAgICAgICAgICBjb25zdCB0aW1lb3V0JCA9IG9mKFxuICAgICAgICAgICAgICBzdWJzY3JpcHRpb25FcnJvcih7XG4gICAgICAgICAgICAgICAgLi4uYWN0aW9uLFxuICAgICAgICAgICAgICAgIHJlYXNvbjogJ1dTOiB1bnN1YnNjcmliZSAtPiBzdWJzY3JpYmUgKHVucmVzcG9uc2l2ZSBjaGFubmVsKScsXG4gICAgICAgICAgICAgICAgd3NIYW5kbGVyLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgdW5zdWJzY3JpYmVSZXF1ZXN0ZWQoYWN0aW9uKSxcbiAgICAgICAgICAgICAgc3ViUmVxQWN0aW9uLFxuICAgICAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgICBkZWxheShjb25maWcuc3Vic2NyaXB0aW9uVW5yZXNwb25zaXZlVFRMKSxcbiAgICAgICAgICAgICAgdGFwKChhKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHN1YnNjcmlwdGlvbkVycm9yLm1hdGNoKGEpKSB7XG4gICAgICAgICAgICAgICAgICBsb2dnZXIud2FybihcbiAgICAgICAgICAgICAgICAgICAgJ1t1bnN1YnNjcmliZU9uTm9SZXNwb25zZV0gUmVzdWJzY3JpYmluZyBkdWUgdG8gdW5yZXNwb25zaXZlIHN1YnNjcmlwdGlvbiwgdGhpcyBoYXBwZW5zIHdoZW4gYSBzdWJzY3JpcHRpb24gZG9lcyBub3QgcmVjZWl2ZSBhIG1lc3NhZ2UgZm9yIGxvbmdlciB0aGFuIHRoZSBzdWJzY3JpcHRpb25VbnJlc3BvbnNpdmVUVEwgdmFsdWUnLFxuICAgICAgICAgICAgICAgICAgICB7IGZlZWRJZDogYS5wYXlsb2FkLmlucHV0ID8gZ2V0RmVlZElkKGEucGF5bG9hZC5pbnB1dCkgOiAndW5kZWZpbmVkJyB9LFxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgICAgICAgICAgIC8vIEZpbHRlcnMgYnkgYWN0aXZlIHN1YnNjcmlwdGlvbi5cbiAgICAgICAgICAgICAgLy8gVGhlIHRpbWVvdXQgY291bGQgdGhpbmsgd2UgZG9uJ3QgcmVjZWl2ZSBtZXNzYWdlcyBiZWNhdXNlIG9mIHVucmVzcG9uc2l2ZW5lc3MsIGFuZCBpdCdzIGFjdHVhbGx5IHVuc3Vic2NyaWJlZFxuICAgICAgICAgICAgICAvLyBpc1N1YnNjcmliaW5nIGlzIGNvbnNpZGVyZWQgdG9vIGFzIHdlIHdhbnQgdG8gdHJpZ2dlciBhbiB1bnN1YnNjcmlwdGlvbiBmcm9tIGEgaHVuZyBjaGFubmVsXG4gICAgICAgICAgICAgIG1lcmdlTWFwKChbYWN0aW9uLCBzdGF0ZV0pID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBpc0FjdGl2ZSA9ICEhc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uYWN0aXZlXG4gICAgICAgICAgICAgICAgY29uc3QgaXNTdWJzY3JpYmluZyA9ICEhKFxuICAgICAgICAgICAgICAgICAgc3RhdGUud3Muc3Vic2NyaXB0aW9ucy5hbGxbc3Vic2NyaXB0aW9uS2V5XT8uc3Vic2NyaWJpbmcgPiAwXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIHJldHVybiBpc0FjdGl2ZSB8fCBpc1N1YnNjcmliaW5nID8gb2YoYWN0aW9uKSA6IEVNUFRZXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgKVxuXG4gICAgICAgICAgICByZXR1cm4gcmFjZShyZXNldCQsIHRpbWVvdXQkKS5waXBlKGZpbHRlcigoYSkgPT4gIW1lc3NhZ2VSZWNlaXZlZC5tYXRjaChhKSkpXG4gICAgICAgICAgfSxcbiAgICAgICAgKSxcbiAgICAgIClcblxuICAgICAgLy8gTWVyZ2UgYWxsICYgdW5zdWJzY3JpYmUgd3MgY29ubmVjdGlvbiB3aGVuIGEgbWF0Y2hpbmcgdW5zdWJzY3JpYmUgY29tZXMgaW5cbiAgICAgIGNvbnN0IHVuc3Vic2NyaWJlJCA9IG1lcmdlKHVuc3Vic2NyaWJlT25UaW1lb3V0JCwgdW5zdWJzY3JpYmVPbk5vUmVzcG9uc2UkKVxuICAgICAgY29uc3Qgd3MkID0gbWVyZ2UoXG4gICAgICAgIG9wZW4kLFxuICAgICAgICBjbG9zZSQsXG4gICAgICAgIGRpc2Nvbm5lY3QkLFxuICAgICAgICBtdWx0aXBsZXhTdWJzY3JpcHRpb25zJCxcbiAgICAgICAgdW5zdWJzY3JpYmUkLFxuICAgICAgICB3aXRoU2F2ZUZpcnN0TWVzc2FnZVRvU3RvcmUkLFxuICAgICAgICB1cGRhdGVTdWJzY3JpcHRpb25JbnB1dCQsXG4gICAgICAgIHdpdGhDb250aW51ZU9uQ29ubmVjdENoYWluJCxcbiAgICAgICAgd2l0aEhlYXJ0YmVhdEF0SW50ZXJ2YWxzJCxcbiAgICAgICAgZXJyb3IkLFxuICAgICAgICByZXNwb25kV2l0aEhlYXJ0YmVhdCQsXG4gICAgICApLnBpcGUoXG4gICAgICAgIHRha2VVbnRpbChcbiAgICAgICAgICBhY3Rpb24kLnBpcGUoXG4gICAgICAgICAgICAvLyBUT0RPOiBub3Qgc2VlaW5nIHVuc3Vic2NyaWJlIGV2ZW50cyBiZWNhdXNlIG9mIHRoaXNcbiAgICAgICAgICAgIGZpbHRlcihkaXNjb25uZWN0RnVsZmlsbGVkLm1hdGNoKSxcbiAgICAgICAgICAgIGZpbHRlcigoYSkgPT4gYS5wYXlsb2FkLmNvbmZpZy5jb25uZWN0aW9uSW5mby5rZXkgPT09IGNvbm5lY3Rpb25LZXkpLFxuICAgICAgICAgICAgdGFwKChhY3Rpb24pID0+IHtcbiAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdXUzogRGlzY29ubmVjdGVkIEZ1bGZpbGxlZCcsIGNvbm5lY3Rpb25NZXRhKGFjdGlvbi5wYXlsb2FkKSlcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICksXG4gICAgICAgICksXG4gICAgICApXG4gICAgICByZXR1cm4gY29uY2F0KG9mKHdzU3Vic2NyaXB0aW9uUmVhZHkocGF5bG9hZCkpLCB3cyQpXG4gICAgfSksXG4gIClcblxuZXhwb3J0IGNvbnN0IHJlY29yZEVycm9yRXBpYzogRXBpYzxBbnlBY3Rpb24sIEFueUFjdGlvbiwgeyB3czogUm9vdFN0YXRlIH0sIGFueT4gPSAoYWN0aW9uJCkgPT5cbiAgYWN0aW9uJC5waXBlKFxuICAgIGZpbHRlcigoYWN0aW9uKSA9PiBzdWJzY3JpcHRpb25FcnJvci5tYXRjaChhY3Rpb24pICYmICEhYWN0aW9uLnBheWxvYWQuZXJyb3IpLFxuICAgIG1lcmdlTWFwKCh7IHBheWxvYWQgfSkgPT4ge1xuICAgICAgY29uc3QgeyB3c0hhbmRsZXIsIGVycm9yLCBjb25uZWN0aW9uSW5mbywgc3Vic2NyaXB0aW9uTXNnIH0gPSBwYXlsb2FkXG4gICAgICBjb25zdCB7IHNob3VsZE5vdFJldHJ5Q29ubmVjdGlvbiwgc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb24gfSA9IHdzSGFuZGxlclxuICAgICAgcmV0dXJuIG9mKFxuICAgICAgICBzdWJzY3JpcHRpb25FcnJvckhhbmRsZXIoe1xuICAgICAgICAgIGNvbm5lY3Rpb25JbmZvLFxuICAgICAgICAgIHN1YnNjcmlwdGlvbk1zZyxcbiAgICAgICAgICBzaG91bGROb3RSZXRyeUNvbm5lY3Rpb246ICEhc2hvdWxkTm90UmV0cnlDb25uZWN0aW9uICYmIHNob3VsZE5vdFJldHJ5Q29ubmVjdGlvbihlcnJvciksXG4gICAgICAgICAgc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb246XG4gICAgICAgICAgICAhIXNob3VsZE5vdFJldHJ5U3Vic2NyaXB0aW9uICYmIHNob3VsZE5vdFJldHJ5U3Vic2NyaXB0aW9uKGVycm9yKSxcbiAgICAgICAgfSksXG4gICAgICApXG4gICAgfSksXG4gIClcblxuZXhwb3J0IGNvbnN0IHdyaXRlTWVzc2FnZVRvQ2FjaGVFcGljOiBFcGljPEFueUFjdGlvbiwgQW55QWN0aW9uLCB7IHdzOiBSb290U3RhdGUgfSwgYW55PiA9IChcbiAgYWN0aW9uJCxcbiAgc3RhdGUkLFxuKSA9PlxuICBhY3Rpb24kLnBpcGUoXG4gICAgZmlsdGVyKG1lc3NhZ2VSZWNlaXZlZC5tYXRjaCksXG4gICAgZmlsdGVyKChhY3Rpb24pID0+IGFjdGlvbi5wYXlsb2FkLndzSGFuZGxlci5maWx0ZXIoYWN0aW9uLnBheWxvYWQubWVzc2FnZSkpLFxuICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgbWVyZ2VNYXAoYXN5bmMgKFthY3Rpb24sIHN0YXRlXSkgPT4ge1xuICAgICAgY29uc3Qgd3NIYW5kbGVyID0gYWN0aW9uLnBheWxvYWQud3NIYW5kbGVyXG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzdWJzY3JpcHRpb25TdGF0ZSA9IHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2FjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleV1cbiAgICAgICAgY29uc3QgaW5wdXQgPSBzdWJzY3JpcHRpb25TdGF0ZT8uaW5wdXQgfHwge31cblxuICAgICAgICBpZiAoIWlucHV0KSBsb2dnZXIud2FybihgV1M6IENvdWxkIG5vdCBmaW5kIHN1YnNjcmlwdGlvbiBmcm9tIGluY29taW5nIG1lc3NhZ2VgKVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBXcmFwIHRoZSBwYXlsb2FkIHNvIHRoYXQgdGhlIGNhY2hlIG1pZGRsZXdhcmUgdHJlYXRzIGl0IGFzIGlmXG4gICAgICAgICAqIGl0IGlzIGNhbGxpbmcgb3V0IHRvIHRoZSB1bmRlcmx5aW5nIEFQSSwgd2hpY2ggaW1tZWRpYXRlbHkgcmVzb2x2ZXNcbiAgICAgICAgICogdG8gdGhlIHdlYnNvY2tldCBtZXNzYWdlIGhlcmUgaW5zdGVhZC5cbiAgICAgICAgICpcbiAgICAgICAgICogVGhpcyByZXN1bHRzIGluIHRoZSBjYWNoZSBtaWRkbGV3YXJlIHN0b3JpbmcgdGhlIHBheWxvYWQgbWVzc2FnZSBhcyBhXG4gICAgICAgICAqIGNhY2hlIHZhbHVlLCB3aXRoIHRoZSBmb2xsb3dpbmcgYHdzUmVzcG9uc2VgIGFzIHRoZSBjYWNoZSBrZXlcbiAgICAgICAgICovXG4gICAgICAgIGNvbnN0IGlzVG9SZXNwb25zZUFzeW5jID0gd3NIYW5kbGVyLnRvUmVzcG9uc2UuY29uc3RydWN0b3IubmFtZSA9PT0gJ0FzeW5jRnVuY3Rpb24nXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gaXNUb1Jlc3BvbnNlQXN5bmNcbiAgICAgICAgICA/IGF3YWl0IHdzSGFuZGxlci50b1Jlc3BvbnNlKGFjdGlvbi5wYXlsb2FkLm1lc3NhZ2UsIGlucHV0KVxuICAgICAgICAgIDogKHdzSGFuZGxlci50b1Jlc3BvbnNlKGFjdGlvbi5wYXlsb2FkLm1lc3NhZ2UsIGlucHV0KSBhcyBBZGFwdGVyUmVzcG9uc2UpXG4gICAgICAgIGlmICghcmVzcG9uc2UpIHJldHVybiBhY3Rpb25cbiAgICAgICAgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZSA9ICgpID0+IFByb21pc2UucmVzb2x2ZShyZXNwb25zZSlcbiAgICAgICAgbGV0IGNvbnRleHQgPSBzdWJzY3JpcHRpb25TdGF0ZT8uY29udGV4dFxuICAgICAgICBpZiAoIWNvbnRleHQpIHtcbiAgICAgICAgICBsb2dnZXIud2FybihgV1MgVW5zdWJzY3JpYmUgTm8gUmVzcG9uc2U6IENvdWxkIG5vdCBmaW5kIGNvbnRleHRgKVxuICAgICAgICAgIGNvbnRleHQgPSB7fVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2FjaGUgPSBhd2FpdCB3aXRoQ2FjaGUoKShleGVjdXRlLCBjb250ZXh0KVxuICAgICAgICBjb25zdCB3c0NvbmZpZyA9IGdldFdTQ29uZmlnKGlucHV0LmRhdGE/LmVuZHBvaW50KVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBDcmVhdGUgYW4gYWRhcHRlciByZXF1ZXN0IHdlIHNlbmQgdG8gdGhlIGNhY2hlIG1pZGRsZXdhcmVcbiAgICAgICAgICogc28gaXQgdXNlcyB0aGUgZm9sbG93aW5nIG9iamVjdCBmb3Igc2V0dGluZyBjYWNoZSBrZXlzXG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCB3c1Jlc3BvbnNlOiBBZGFwdGVyUmVxdWVzdCA9IHtcbiAgICAgICAgICAuLi5pbnB1dCxcbiAgICAgICAgICBkYXRhOiB7IG1heEFnZTogd3NDb25maWcuc3Vic2NyaXB0aW9uVFRMLCAuLi5pbnB1dC5kYXRhIH0sXG4gICAgICAgICAgZGVidWc6IHsgd3M6IHRydWUgfSxcbiAgICAgICAgICBtZXRyaWNzTWV0YTogeyBmZWVkSWQ6IGdldEZlZWRJZChpbnB1dCkgfSxcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCBjYWNoZSh3c1Jlc3BvbnNlLCBjb250ZXh0KVxuICAgICAgICBsb2dnZXIudHJhY2UoJ1dTOiBTYXZlZCByZXN1bHQnLCB7IGlucHV0LCByZXN1bHQ6IHJlc3BvbnNlLnJlc3VsdCB9KVxuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYFdTOiBDYWNoZSBlcnJvcjogJHtlLm1lc3NhZ2V9YClcbiAgICAgIH1cbiAgICAgIHJldHVybiBhY3Rpb25cbiAgICB9KSxcbiAgICBmaWx0ZXIoKCkgPT4gZmFsc2UpLFxuICApXG5cbmV4cG9ydCBjb25zdCBtZXRyaWNzRXBpYzogRXBpYzxBbnlBY3Rpb24sIEFueUFjdGlvbiwgYW55LCBhbnk+ID0gKGFjdGlvbiQsIHN0YXRlJCkgPT5cbiAgYWN0aW9uJC5waXBlKFxuICAgIHdpdGhMYXRlc3RGcm9tKHN0YXRlJCksXG4gICAgdGFwKChbYWN0aW9uLCBzdGF0ZV0pID0+IHtcbiAgICAgIGNvbnN0IGNvbm5lY3Rpb25MYWJlbHMgPSAocGF5bG9hZDogV1NDb25maWdQYXlsb2FkKSA9PiAoe1xuICAgICAgICBrZXk6IHBheWxvYWQuY29uZmlnLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBjb25uZWN0aW9uRXJyb3JMYWJlbHMgPSAocGF5bG9hZDogV1NFcnJvclBheWxvYWQpID0+ICh7XG4gICAgICAgIGtleTogcGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICAgIG1lc3NhZ2U6IHBheWxvYWQucmVhc29uLFxuICAgICAgfSlcbiAgICAgIGNvbnN0IHN1YnNjcmlwdGlvbkxhYmVscyA9IChwYXlsb2FkOiBXU1N1YnNjcmlwdGlvblBheWxvYWQpID0+ICh7XG4gICAgICAgIGNvbm5lY3Rpb25fa2V5OiBwYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleSxcbiAgICAgICAgZmVlZF9pZDogZ2V0RmVlZElkKHsgLi4ucGF5bG9hZC5pbnB1dCB9KSxcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogZ2V0U3Vic0lkKHBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKSxcbiAgICAgIH0pXG4gICAgICBjb25zdCBzdWJzY3JpcHRpb25FcnJvckxhYmVscyA9IChwYXlsb2FkOiBXU1N1YnNjcmlwdGlvbkVycm9yUGF5bG9hZCkgPT4gKHtcbiAgICAgICAgY29ubmVjdGlvbl9rZXk6IHBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgICBmZWVkX2lkOiBwYXlsb2FkLmlucHV0ID8gZ2V0RmVlZElkKHsgLi4ucGF5bG9hZC5pbnB1dCB9KSA6ICdOL0EnLFxuICAgICAgICBtZXNzYWdlOiBwYXlsb2FkLnJlYXNvbixcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogcGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cgPyBnZXRTdWJzSWQocGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpIDogJ04vQScsXG4gICAgICB9KVxuICAgICAgY29uc3QgbWVzc2FnZUxhYmVscyA9IChwYXlsb2FkOiBXU01lc3NhZ2VQYXlsb2FkKSA9PiAoe1xuICAgICAgICBmZWVkX2lkOiBnZXRGZWVkSWQoe1xuICAgICAgICAgIC4uLnN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2FjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbktleV0/LmlucHV0LFxuICAgICAgICB9KSxcbiAgICAgICAgc3Vic2NyaXB0aW9uX2tleTogcGF5bG9hZC5zdWJzY3JpcHRpb25LZXksXG4gICAgICB9KVxuXG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgY29ubmVjdEZ1bGZpbGxlZC50eXBlOlxuICAgICAgICAgIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLmxhYmVscyhjb25uZWN0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIGNvbm5lY3RGYWlsZWQudHlwZTpcbiAgICAgICAgICB3c19jb25uZWN0aW9uX2Vycm9ycy5sYWJlbHMoY29ubmVjdGlvbkVycm9yTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIGRpc2Nvbm5lY3RGdWxmaWxsZWQudHlwZTpcbiAgICAgICAgICBpZiAoc3RhdGUud3MuY29ubmVjdGlvbnMuYWxsW2Nvbm5lY3Rpb25MYWJlbHMoYWN0aW9uLnBheWxvYWQpLmtleV0/Lndhc0V2ZXJDb25uZWN0ZWQpIHtcbiAgICAgICAgICAgIHdzX2Nvbm5lY3Rpb25fYWN0aXZlLmxhYmVscyhjb25uZWN0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuZGVjKClcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgY2FzZSBzdWJzY3JpYmVGdWxmaWxsZWQudHlwZTpcbiAgICAgICAgICB3c19zdWJzY3JpcHRpb25fdG90YWwubGFiZWxzKHN1YnNjcmlwdGlvbkxhYmVscyhhY3Rpb24ucGF5bG9hZCkpLmluYygpXG4gICAgICAgICAgd3Nfc3Vic2NyaXB0aW9uX2FjdGl2ZS5sYWJlbHMoc3Vic2NyaXB0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuaW5jKClcbiAgICAgICAgICBicmVha1xuICAgICAgICBjYXNlIHN1YnNjcmlwdGlvbkVycm9yLnR5cGU6XG4gICAgICAgICAgd3Nfc3Vic2NyaXB0aW9uX2Vycm9ycy5sYWJlbHMoc3Vic2NyaXB0aW9uRXJyb3JMYWJlbHMoYWN0aW9uLnBheWxvYWQpKS5pbmMoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIGNhc2UgdW5zdWJzY3JpYmVGdWxmaWxsZWQudHlwZToge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHN0YXRlLndzLnN1YnNjcmlwdGlvbnMuYWxsW2dldFN1YnNJZChhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpXT8ud2FzRXZlckFjdGl2ZVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgd3Nfc3Vic2NyaXB0aW9uX2FjdGl2ZS5sYWJlbHMoc3Vic2NyaXB0aW9uTGFiZWxzKGFjdGlvbi5wYXlsb2FkKSkuZGVjKClcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWtcbiAgICAgICAgfVxuICAgICAgICBjYXNlIG1lc3NhZ2VSZWNlaXZlZC50eXBlOlxuICAgICAgICAgIHdzX21lc3NhZ2VfdG90YWwubGFiZWxzKG1lc3NhZ2VMYWJlbHMoYWN0aW9uLnBheWxvYWQpKS5pbmMoKVxuICAgICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfSksXG4gICAgbWFwKChbYWN0aW9uXSkgPT4gYWN0aW9uKSxcbiAgICBmaWx0ZXIoKCkgPT4gZmFsc2UpLCAvLyBkbyBub3QgZHVwbGljYXRlIGV2ZW50c1xuICApXG5cbmV4cG9ydCBjb25zdCByb290RXBpYyA9IGNvbWJpbmVFcGljcyhcbiAgY29ubmVjdEVwaWMsXG4gIG1ldHJpY3NFcGljLFxuICBzdWJzY3JpYmVSZWFkeUVwaWMsXG4gIHdyaXRlTWVzc2FnZVRvQ2FjaGVFcGljLFxuICByZWNvcmRFcnJvckVwaWMsXG4pXG5cbmV4cG9ydCBjb25zdCBlcGljTWlkZGxld2FyZSA9IGNyZWF0ZUVwaWNNaWRkbGV3YXJlKClcbiJdfQ==