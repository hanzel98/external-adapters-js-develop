"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rootReducer = exports.subscriptionsReducer = exports.connectionsReducer = exports.getSubsId = void 0;
const tslib_1 = require("tslib");
const toolkit_1 = require("@reduxjs/toolkit");
const external_adapter_1 = require("../external-adapter");
const util_1 = require("../util");
const actions = tslib_1.__importStar(require("./actions"));
/**
 * Generate a key for the WS middleware
 *
 * NOTE:
 * Exclude mode is enforced because the data given to the WS framework
 * is not an Adapter Request, but a subscription message.
 *
 * (e.g. Cryptocompare)
 * { action: 'SubAdd', subs: [ '5~CCCAGG~BTC~USD' ] }
 *
 * The structure of which may change with every adapter, so we need to
 * use exclude mode to handle dynamically changing properties.
 */
const getSubsId = (subscriptionMsg) => util_1.hash(subscriptionMsg, util_1.getHashOpts(), 'exclude');
exports.getSubsId = getSubsId;
const initConnectionsState = { total: 0, all: {} };
exports.connectionsReducer = toolkit_1.createReducer(initConnectionsState, (builder) => {
    builder.addCase(actions.onConnectComplete, (state, action) => {
        const { connectionInfo: { key }, } = action.payload;
        state.all[key] = {
            ...state.all[key],
            isOnConnectChainComplete: true,
        };
    });
    builder.addCase(actions.connectFulfilled, (state, action) => {
        // Add connection
        const { key } = action.payload.config.connectionInfo;
        state.all[key] = {
            ...state.all[key],
            active: true,
            connecting: 0,
            wasEverConnected: true,
            requestId: Math.max(state.all[key].requestId, 0),
        };
    });
    builder.addCase(actions.subscribeRequested, (state, action) => {
        if (!action.payload.connectionInfo) {
            external_adapter_1.logger.error(`Missing connection info: ${JSON.stringify(action.payload)}`);
            return;
        }
        const key = action.payload.connectionInfo.key;
        if (!state.all[key])
            return;
        state.all[key] = {
            ...state.all[key],
            requestId: state.all[key].requestId + 1,
            connectionParams: action.payload.messageToSave || state.all[key].connectionParams,
        };
    });
    builder.addCase(actions.connectRequested, (state, action) => {
        const { key } = action.payload.config.connectionInfo;
        const connectionState = state.all[key];
        const isActive = connectionState?.active;
        if (isActive)
            return;
        const wsHandler = action.payload.wsHandler;
        const hasNoOnConnectChain = !wsHandler.onConnectChain;
        const isConnecting = !isNaN(Number(connectionState?.connecting));
        state.all[key] = {
            ...connectionState,
            active: false,
            connecting: isConnecting ? connectionState.connecting + 1 : 1,
            requestId: isConnecting ? connectionState.requestId : 0,
            isOnConnectChainComplete: hasNoOnConnectChain,
        };
    });
    builder.addCase(actions.connectFailed, (state, action) => {
        state.all[action.payload.connectionInfo.key].connecting = 0;
        state.all[action.payload.connectionInfo.key].active = false;
    });
    builder.addCase(actions.disconnectFulfilled, (state, action) => {
        // Remove connection
        const { key } = action.payload.config.connectionInfo;
        state.all[key].active = false;
        state.all[key].connecting = 0; // turn off connecting
        state.all[key].requestId = 0;
    });
    builder.addCase(actions.subscriptionErrorHandler, (state, action) => {
        const { key } = action.payload.connectionInfo;
        state.all[key].shouldNotRetryConnecting = action.payload.shouldNotRetryConnection;
    });
    builder.addMatcher(toolkit_1.isAnyOf(actions.connectRequested, actions.connectFulfilled, actions.connectFailed, actions.disconnectFulfilled), (state) => {
        state.total = Object.values(state.all).filter((s) => s?.active).length;
    });
});
const initSubscriptionsState = { total: 0, all: {} };
exports.subscriptionsReducer = toolkit_1.createReducer(initSubscriptionsState, (builder) => {
    builder.addCase(actions.updateSubscriptionInput, (state, action) => {
        const key = action.payload.subscriptionKey;
        state.all[key] = {
            ...state.all[key],
            input: action.payload.input,
        };
    });
    builder.addCase(actions.saveFirstMessageReceived, (state, action) => {
        const key = action.payload.subscriptionKey;
        state.all[key] = {
            ...state.all[key],
            subscriptionParams: action.payload.message,
        };
    });
    builder.addCase(actions.subscribeFulfilled, (state, action) => {
        // Add subscription
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        state.all[key] = {
            active: true,
            wasEverActive: true,
            unsubscribed: false,
            subscribing: 0,
            input: { ...action.payload.input },
            context: action.payload.context,
            connectionKey: action.payload.connectionInfo.key,
        };
    });
    builder.addCase(actions.subscribeRequested, (state, action) => {
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        const isActive = state.all[key]?.active;
        if (isActive)
            return;
        if (!action.payload.connectionInfo) {
            external_adapter_1.logger.error(`Missing connection info: ${JSON.stringify(action.payload)}`);
            return;
        }
        const isSubscribing = state.all[key]?.subscribing;
        state.all[key] = {
            active: false,
            subscribing: isSubscribing ? state.all[key].subscribing + 1 : 1,
            input: { ...action.payload.input },
            context: action.payload.context,
            connectionKey: action.payload.connectionInfo.key,
        };
    });
    builder.addCase(actions.unsubscribeFulfilled, (state, action) => {
        // Remove subscription
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        state.all[key].active = false;
        state.all[key].unsubscribed = true;
        state.all[key].subscribing = 0;
    });
    builder.addCase(actions.subscriptionErrorHandler, (state, action) => {
        const key = exports.getSubsId(action.payload.subscriptionMsg);
        if (state.all[key]) {
            state.all[key].shouldNotRetry = action.payload.shouldNotRetrySubscription;
        }
    });
    builder.addCase(actions.disconnectFulfilled, (state) => {
        state.all = {};
        return state;
    });
    builder.addMatcher(toolkit_1.isAnyOf(actions.subscribeRequested, actions.subscribeFulfilled, actions.unsubscribeFulfilled), (state) => {
        state.total = Object.values(state.all).filter((s) => s?.active).length;
    });
});
exports.rootReducer = toolkit_1.combineReducers({
    connections: exports.connectionsReducer,
    subscriptions: exports.subscriptionsReducer,
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvd3MvcmVkdWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQ0EsOENBQTBFO0FBQzFFLDBEQUE0QztBQUM1QyxrQ0FBMkM7QUFDM0MsMkRBQW9DO0FBRXBDOzs7Ozs7Ozs7Ozs7R0FZRztBQUNJLE1BQU0sU0FBUyxHQUFHLENBQUMsZUFBK0IsRUFBVSxFQUFFLENBQ25FLFdBQUksQ0FBQyxlQUFlLEVBQUUsa0JBQVcsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0FBRHBDLFFBQUEsU0FBUyxhQUMyQjtBQW1CakQsTUFBTSxvQkFBb0IsR0FBcUIsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsQ0FBQTtBQUV2RCxRQUFBLGtCQUFrQixHQUFHLHVCQUFhLENBQzdDLG9CQUFvQixFQUNwQixDQUFDLE9BQU8sRUFBRSxFQUFFO0lBQ1YsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDM0QsTUFBTSxFQUNKLGNBQWMsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUN4QixHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUE7UUFDbEIsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRztZQUNmLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7WUFDakIsd0JBQXdCLEVBQUUsSUFBSTtTQUMvQixDQUFBO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUMxRCxpQkFBaUI7UUFDakIsTUFBTSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FB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R0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUFBO1NBQzFFO0lBQ0gsQ0FBQyxDQUFDLENBQUE7SUFFRixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1FBQ3JELEtBQUssQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFBO1FBQ2QsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDLENBQUMsQ0FBQTtJQUVGLE9BQU8sQ0FBQyxVQUFVLENBQ2hCLGlCQUFPLENBQUMsT0FBTyxDQUFDLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxPQUFPLENBQUMsb0JBQW9CLENBQUMsRUFDN0YsQ0FBQyxLQUFLLEVBQUUsRUFBRTtRQUNSLEtBQUssQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUMsTUFBTSxDQUFBO0lBQ3hFLENBQUMsQ0FDRixDQUFBO0FBQ0gsQ0FBQyxDQUNGLENBQUE7QUFFWSxRQUFBLFdBQVcsR0FBRyx5QkFBZSxDQUFDO0lBQ3pDLFdBQVcsRUFBRSwwQkFBa0I7SUFDL0IsYUFBYSxFQUFFLDRCQUFvQjtDQUNwQyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZGFwdGVyQ29udGV4dCwgQWRhcHRlclJlcXVlc3QgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgY29tYmluZVJlZHVjZXJzLCBjcmVhdGVSZWR1Y2VyLCBpc0FueU9mIH0gZnJvbSAnQHJlZHV4anMvdG9vbGtpdCdcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2V4dGVybmFsLWFkYXB0ZXInXG5pbXBvcnQgeyBnZXRIYXNoT3B0cywgaGFzaCB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgKiBhcyBhY3Rpb25zIGZyb20gJy4vYWN0aW9ucydcblxuLyoqXG4gKiBHZW5lcmF0ZSBhIGtleSBmb3IgdGhlIFdTIG1pZGRsZXdhcmVcbiAqXG4gKiBOT1RFOlxuICogRXhjbHVkZSBtb2RlIGlzIGVuZm9yY2VkIGJlY2F1c2UgdGhlIGRhdGEgZ2l2ZW4gdG8gdGhlIFdTIGZyYW1ld29ya1xuICogaXMgbm90IGFuIEFkYXB0ZXIgUmVxdWVzdCwgYnV0IGEgc3Vic2NyaXB0aW9uIG1lc3NhZ2UuXG4gKlxuICogKGUuZy4gQ3J5cHRvY29tcGFyZSlcbiAqIHsgYWN0aW9uOiAnU3ViQWRkJywgc3ViczogWyAnNX5DQ0NBR0d+QlRDflVTRCcgXSB9XG4gKlxuICogVGhlIHN0cnVjdHVyZSBvZiB3aGljaCBtYXkgY2hhbmdlIHdpdGggZXZlcnkgYWRhcHRlciwgc28gd2UgbmVlZCB0b1xuICogdXNlIGV4Y2x1ZGUgbW9kZSB0byBoYW5kbGUgZHluYW1pY2FsbHkgY2hhbmdpbmcgcHJvcGVydGllcy5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldFN1YnNJZCA9IChzdWJzY3JpcHRpb25Nc2c6IEFkYXB0ZXJSZXF1ZXN0KTogc3RyaW5nID0+XG4gIGhhc2goc3Vic2NyaXB0aW9uTXNnLCBnZXRIYXNoT3B0cygpLCAnZXhjbHVkZScpXG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvbnNTdGF0ZSB7XG4gIHRvdGFsOiBudW1iZXJcbiAgYWxsOiB7XG4gICAgW2tleTogc3RyaW5nXToge1xuICAgICAgc2hvdWxkTm90UmV0cnlDb25uZWN0aW5nPzogYm9vbGVhblxuICAgICAgYWN0aXZlOiBib29sZWFuXG4gICAgICBjb25uZWN0aW5nOiBudW1iZXJcbiAgICAgIHdhc0V2ZXJDb25uZWN0ZWQ/OiBib29sZWFuXG4gICAgICBjb25uZWN0aW9uUGFyYW1zPzoge1xuICAgICAgICBbVDogc3RyaW5nXTogc3RyaW5nXG4gICAgICB9XG4gICAgICByZXF1ZXN0SWQ6IG51bWJlclxuICAgICAgaXNPbkNvbm5lY3RDaGFpbkNvbXBsZXRlOiBib29sZWFuXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IGluaXRDb25uZWN0aW9uc1N0YXRlOiBDb25uZWN0aW9uc1N0YXRlID0geyB0b3RhbDogMCwgYWxsOiB7fSB9XG5cbmV4cG9ydCBjb25zdCBjb25uZWN0aW9uc1JlZHVjZXIgPSBjcmVhdGVSZWR1Y2VyPENvbm5lY3Rpb25zU3RhdGU+KFxuICBpbml0Q29ubmVjdGlvbnNTdGF0ZSxcbiAgKGJ1aWxkZXIpID0+IHtcbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5vbkNvbm5lY3RDb21wbGV0ZSwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIGNvbnN0IHtcbiAgICAgICAgY29ubmVjdGlvbkluZm86IHsga2V5IH0sXG4gICAgICB9ID0gYWN0aW9uLnBheWxvYWRcbiAgICAgIHN0YXRlLmFsbFtrZXldID0ge1xuICAgICAgICAuLi5zdGF0ZS5hbGxba2V5XSxcbiAgICAgICAgaXNPbkNvbm5lY3RDaGFpbkNvbXBsZXRlOiB0cnVlLFxuICAgICAgfVxuICAgIH0pXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuY29ubmVjdEZ1bGZpbGxlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIC8vIEFkZCBjb25uZWN0aW9uXG4gICAgICBjb25zdCB7IGtleSB9ID0gYWN0aW9uLnBheWxvYWQuY29uZmlnLmNvbm5lY3Rpb25JbmZvXG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgLi4uc3RhdGUuYWxsW2tleV0sXG4gICAgICAgIGFjdGl2ZTogdHJ1ZSxcbiAgICAgICAgY29ubmVjdGluZzogMCxcbiAgICAgICAgd2FzRXZlckNvbm5lY3RlZDogdHJ1ZSxcbiAgICAgICAgcmVxdWVzdElkOiBNYXRoLm1heChzdGF0ZS5hbGxba2V5XS5yZXF1ZXN0SWQsIDApLFxuICAgICAgfVxuICAgIH0pXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuc3Vic2NyaWJlUmVxdWVzdGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgaWYgKCFhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mbykge1xuICAgICAgICBsb2dnZXIuZXJyb3IoYE1pc3NpbmcgY29ubmVjdGlvbiBpbmZvOiAke0pTT04uc3RyaW5naWZ5KGFjdGlvbi5wYXlsb2FkKX1gKVxuICAgICAgICByZXR1cm5cbiAgICAgIH1cbiAgICAgIGNvbnN0IGtleSA9IGFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvLmtleVxuICAgICAgaWYgKCFzdGF0ZS5hbGxba2V5XSkgcmV0dXJuXG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgLi4uc3RhdGUuYWxsW2tleV0sXG4gICAgICAgIHJlcXVlc3RJZDogc3RhdGUuYWxsW2tleV0ucmVxdWVzdElkICsgMSxcbiAgICAgICAgY29ubmVjdGlvblBhcmFtczogYWN0aW9uLnBheWxvYWQubWVzc2FnZVRvU2F2ZSB8fCBzdGF0ZS5hbGxba2V5XS5jb25uZWN0aW9uUGFyYW1zLFxuICAgICAgfVxuICAgIH0pXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuY29ubmVjdFJlcXVlc3RlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIGNvbnN0IHsga2V5IH0gPSBhY3Rpb24ucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm9cbiAgICAgIGNvbnN0IGNvbm5lY3Rpb25TdGF0ZSA9IHN0YXRlLmFsbFtrZXldXG4gICAgICBjb25zdCBpc0FjdGl2ZSA9IGNvbm5lY3Rpb25TdGF0ZT8uYWN0aXZlXG4gICAgICBpZiAoaXNBY3RpdmUpIHJldHVyblxuXG4gICAgICBjb25zdCB3c0hhbmRsZXIgPSBhY3Rpb24ucGF5bG9hZC53c0hhbmRsZXJcbiAgICAgIGNvbnN0IGhhc05vT25Db25uZWN0Q2hhaW4gPSAhd3NIYW5kbGVyLm9uQ29ubmVjdENoYWluXG5cbiAgICAgIGNvbnN0IGlzQ29ubmVjdGluZyA9ICFpc05hTihOdW1iZXIoY29ubmVjdGlvblN0YXRlPy5jb25uZWN0aW5nKSlcbiAgICAgIHN0YXRlLmFsbFtrZXldID0ge1xuICAgICAgICAuLi5jb25uZWN0aW9uU3RhdGUsXG4gICAgICAgIGFjdGl2ZTogZmFsc2UsXG4gICAgICAgIGNvbm5lY3Rpbmc6IGlzQ29ubmVjdGluZyA/IGNvbm5lY3Rpb25TdGF0ZS5jb25uZWN0aW5nICsgMSA6IDEsXG4gICAgICAgIHJlcXVlc3RJZDogaXNDb25uZWN0aW5nID8gY29ubmVjdGlvblN0YXRlLnJlcXVlc3RJZCA6IDAsXG4gICAgICAgIGlzT25Db25uZWN0Q2hhaW5Db21wbGV0ZTogaGFzTm9PbkNvbm5lY3RDaGFpbixcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuY29ubmVjdEZhaWxlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIHN0YXRlLmFsbFthY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXldLmNvbm5lY3RpbmcgPSAwXG4gICAgICBzdGF0ZS5hbGxbYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5XS5hY3RpdmUgPSBmYWxzZVxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5kaXNjb25uZWN0RnVsZmlsbGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgLy8gUmVtb3ZlIGNvbm5lY3Rpb25cbiAgICAgIGNvbnN0IHsga2V5IH0gPSBhY3Rpb24ucGF5bG9hZC5jb25maWcuY29ubmVjdGlvbkluZm9cbiAgICAgIHN0YXRlLmFsbFtrZXldLmFjdGl2ZSA9IGZhbHNlXG4gICAgICBzdGF0ZS5hbGxba2V5XS5jb25uZWN0aW5nID0gMCAvLyB0dXJuIG9mZiBjb25uZWN0aW5nXG4gICAgICBzdGF0ZS5hbGxba2V5XS5yZXF1ZXN0SWQgPSAwXG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLnN1YnNjcmlwdGlvbkVycm9ySGFuZGxlciwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIGNvbnN0IHsga2V5IH0gPSBhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mb1xuICAgICAgc3RhdGUuYWxsW2tleV0uc2hvdWxkTm90UmV0cnlDb25uZWN0aW5nID0gYWN0aW9uLnBheWxvYWQuc2hvdWxkTm90UmV0cnlDb25uZWN0aW9uXG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihcbiAgICAgIGlzQW55T2YoXG4gICAgICAgIGFjdGlvbnMuY29ubmVjdFJlcXVlc3RlZCxcbiAgICAgICAgYWN0aW9ucy5jb25uZWN0RnVsZmlsbGVkLFxuICAgICAgICBhY3Rpb25zLmNvbm5lY3RGYWlsZWQsXG4gICAgICAgIGFjdGlvbnMuZGlzY29ubmVjdEZ1bGZpbGxlZCxcbiAgICAgICksXG4gICAgICAoc3RhdGUpID0+IHtcbiAgICAgICAgc3RhdGUudG90YWwgPSBPYmplY3QudmFsdWVzKHN0YXRlLmFsbCkuZmlsdGVyKChzKSA9PiBzPy5hY3RpdmUpLmxlbmd0aFxuICAgICAgfSxcbiAgICApXG4gIH0sXG4pXG5cbmV4cG9ydCBpbnRlcmZhY2UgU3Vic2NyaXB0aW9uc1N0YXRlIHtcbiAgLyoqIE1hcCBvZiBhbGwgc3Vic2NyaXB0aW9ucyBieSBrZXkgKi9cbiAgdG90YWw6IG51bWJlclxuICBhbGw6IHtcbiAgICBba2V5OiBzdHJpbmddOiB7XG4gICAgICBhY3RpdmU6IGJvb2xlYW5cbiAgICAgIHdhc0V2ZXJBY3RpdmU/OiBib29sZWFuXG4gICAgICB1bnN1YnNjcmliZWQ/OiBib29sZWFuXG4gICAgICBzdWJzY3JpYmluZzogbnVtYmVyXG4gICAgICBpbnB1dDogQWRhcHRlclJlcXVlc3RcbiAgICAgIGNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0XG4gICAgICBzdWJzY3JpcHRpb25QYXJhbXM/OiBhbnlcbiAgICAgIGNvbm5lY3Rpb25LZXk6IHN0cmluZ1xuICAgICAgc2hvdWxkTm90UmV0cnk/OiBib29sZWFuXG4gICAgfVxuICB9XG59XG5cbmNvbnN0IGluaXRTdWJzY3JpcHRpb25zU3RhdGU6IFN1YnNjcmlwdGlvbnNTdGF0ZSA9IHsgdG90YWw6IDAsIGFsbDoge30gfVxuXG5leHBvcnQgY29uc3Qgc3Vic2NyaXB0aW9uc1JlZHVjZXIgPSBjcmVhdGVSZWR1Y2VyPFN1YnNjcmlwdGlvbnNTdGF0ZT4oXG4gIGluaXRTdWJzY3JpcHRpb25zU3RhdGUsXG4gIChidWlsZGVyKSA9PiB7XG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMudXBkYXRlU3Vic2NyaXB0aW9uSW5wdXQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25LZXlcbiAgICAgIHN0YXRlLmFsbFtrZXldID0ge1xuICAgICAgICAuLi5zdGF0ZS5hbGxba2V5XSxcbiAgICAgICAgaW5wdXQ6IGFjdGlvbi5wYXlsb2FkLmlucHV0LFxuICAgICAgfVxuICAgIH0pXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuc2F2ZUZpcnN0TWVzc2FnZVJlY2VpdmVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgY29uc3Qga2V5ID0gYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uS2V5XG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgLi4uc3RhdGUuYWxsW2tleV0sXG4gICAgICAgIHN1YnNjcmlwdGlvblBhcmFtczogYWN0aW9uLnBheWxvYWQubWVzc2FnZSxcbiAgICAgIH1cbiAgICB9KVxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLnN1YnNjcmliZUZ1bGZpbGxlZCwgKHN0YXRlLCBhY3Rpb24pID0+IHtcbiAgICAgIC8vIEFkZCBzdWJzY3JpcHRpb25cbiAgICAgIGNvbnN0IGtleSA9IGdldFN1YnNJZChhY3Rpb24ucGF5bG9hZC5zdWJzY3JpcHRpb25Nc2cpXG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgYWN0aXZlOiB0cnVlLFxuICAgICAgICB3YXNFdmVyQWN0aXZlOiB0cnVlLFxuICAgICAgICB1bnN1YnNjcmliZWQ6IGZhbHNlLFxuICAgICAgICBzdWJzY3JpYmluZzogMCxcbiAgICAgICAgaW5wdXQ6IHsgLi4uYWN0aW9uLnBheWxvYWQuaW5wdXQgfSxcbiAgICAgICAgY29udGV4dDogYWN0aW9uLnBheWxvYWQuY29udGV4dCxcbiAgICAgICAgY29ubmVjdGlvbktleTogYWN0aW9uLnBheWxvYWQuY29ubmVjdGlvbkluZm8ua2V5LFxuICAgICAgfVxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5zdWJzY3JpYmVSZXF1ZXN0ZWQsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBnZXRTdWJzSWQoYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKVxuICAgICAgY29uc3QgaXNBY3RpdmUgPSBzdGF0ZS5hbGxba2V5XT8uYWN0aXZlXG4gICAgICBpZiAoaXNBY3RpdmUpIHJldHVyblxuXG4gICAgICBpZiAoIWFjdGlvbi5wYXlsb2FkLmNvbm5lY3Rpb25JbmZvKSB7XG4gICAgICAgIGxvZ2dlci5lcnJvcihgTWlzc2luZyBjb25uZWN0aW9uIGluZm86ICR7SlNPTi5zdHJpbmdpZnkoYWN0aW9uLnBheWxvYWQpfWApXG4gICAgICAgIHJldHVyblxuICAgICAgfVxuXG4gICAgICBjb25zdCBpc1N1YnNjcmliaW5nID0gc3RhdGUuYWxsW2tleV0/LnN1YnNjcmliaW5nXG4gICAgICBzdGF0ZS5hbGxba2V5XSA9IHtcbiAgICAgICAgYWN0aXZlOiBmYWxzZSxcbiAgICAgICAgc3Vic2NyaWJpbmc6IGlzU3Vic2NyaWJpbmcgPyBzdGF0ZS5hbGxba2V5XS5zdWJzY3JpYmluZyArIDEgOiAxLFxuICAgICAgICBpbnB1dDogeyAuLi5hY3Rpb24ucGF5bG9hZC5pbnB1dCB9LFxuICAgICAgICBjb250ZXh0OiBhY3Rpb24ucGF5bG9hZC5jb250ZXh0LFxuICAgICAgICBjb25uZWN0aW9uS2V5OiBhY3Rpb24ucGF5bG9hZC5jb25uZWN0aW9uSW5mby5rZXksXG4gICAgICB9XG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkQ2FzZShhY3Rpb25zLnVuc3Vic2NyaWJlRnVsZmlsbGVkLCAoc3RhdGUsIGFjdGlvbikgPT4ge1xuICAgICAgLy8gUmVtb3ZlIHN1YnNjcmlwdGlvblxuICAgICAgY29uc3Qga2V5ID0gZ2V0U3Vic0lkKGFjdGlvbi5wYXlsb2FkLnN1YnNjcmlwdGlvbk1zZylcblxuICAgICAgc3RhdGUuYWxsW2tleV0uYWN0aXZlID0gZmFsc2VcbiAgICAgIHN0YXRlLmFsbFtrZXldLnVuc3Vic2NyaWJlZCA9IHRydWVcbiAgICAgIHN0YXRlLmFsbFtrZXldLnN1YnNjcmliaW5nID0gMFxuICAgIH0pXG5cbiAgICBidWlsZGVyLmFkZENhc2UoYWN0aW9ucy5zdWJzY3JpcHRpb25FcnJvckhhbmRsZXIsIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgICBjb25zdCBrZXkgPSBnZXRTdWJzSWQoYWN0aW9uLnBheWxvYWQuc3Vic2NyaXB0aW9uTXNnKVxuICAgICAgaWYgKHN0YXRlLmFsbFtrZXldKSB7XG4gICAgICAgIHN0YXRlLmFsbFtrZXldLnNob3VsZE5vdFJldHJ5ID0gYWN0aW9uLnBheWxvYWQuc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb25cbiAgICAgIH1cbiAgICB9KVxuXG4gICAgYnVpbGRlci5hZGRDYXNlKGFjdGlvbnMuZGlzY29ubmVjdEZ1bGZpbGxlZCwgKHN0YXRlKSA9PiB7XG4gICAgICBzdGF0ZS5hbGwgPSB7fVxuICAgICAgcmV0dXJuIHN0YXRlXG4gICAgfSlcblxuICAgIGJ1aWxkZXIuYWRkTWF0Y2hlcihcbiAgICAgIGlzQW55T2YoYWN0aW9ucy5zdWJzY3JpYmVSZXF1ZXN0ZWQsIGFjdGlvbnMuc3Vic2NyaWJlRnVsZmlsbGVkLCBhY3Rpb25zLnVuc3Vic2NyaWJlRnVsZmlsbGVkKSxcbiAgICAgIChzdGF0ZSkgPT4ge1xuICAgICAgICBzdGF0ZS50b3RhbCA9IE9iamVjdC52YWx1ZXMoc3RhdGUuYWxsKS5maWx0ZXIoKHMpID0+IHM/LmFjdGl2ZSkubGVuZ3RoXG4gICAgICB9LFxuICAgIClcbiAgfSxcbilcblxuZXhwb3J0IGNvbnN0IHJvb3RSZWR1Y2VyID0gY29tYmluZVJlZHVjZXJzKHtcbiAgY29ubmVjdGlvbnM6IGNvbm5lY3Rpb25zUmVkdWNlcixcbiAgc3Vic2NyaXB0aW9uczogc3Vic2NyaXB0aW9uc1JlZHVjZXIsXG59KVxuXG5leHBvcnQgdHlwZSBSb290U3RhdGUgPSBSZXR1cm5UeXBlPHR5cGVvZiByb290UmVkdWNlcj5cbiJdfQ==