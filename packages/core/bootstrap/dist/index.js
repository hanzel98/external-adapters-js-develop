"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RateLimit = exports.server = exports.util = exports.Logger = exports.Builder = exports.AdapterError = exports.Validator = exports.Requester = exports.expose = exports.executeSync = exports.withMiddleware = exports.makeMiddleware = exports.withNormalizedInput = exports.withDebug = exports.store = void 0;
const tslib_1 = require("tslib");
const redux_1 = require("redux");
const cache_1 = require("./lib/cache");
const cacheWarmer = tslib_1.__importStar(require("./lib/cache-warmer"));
const config_1 = require("./lib/cache-warmer/config");
const external_adapter_1 = require("./lib/external-adapter");
Object.defineProperty(exports, "AdapterError", { enumerable: true, get: function () { return external_adapter_1.AdapterError; } });
Object.defineProperty(exports, "Logger", { enumerable: true, get: function () { return external_adapter_1.logger; } });
Object.defineProperty(exports, "Requester", { enumerable: true, get: function () { return external_adapter_1.Requester; } });
Object.defineProperty(exports, "Validator", { enumerable: true, get: function () { return external_adapter_1.Validator; } });
Object.defineProperty(exports, "Builder", { enumerable: true, get: function () { return external_adapter_1.Builder; } });
const metrics = tslib_1.__importStar(require("./lib/metrics"));
const RateLimit = tslib_1.__importStar(require("./lib/rate-limit"));
exports.RateLimit = RateLimit;
const burstLimit = tslib_1.__importStar(require("./lib/burst-limit"));
const server = tslib_1.__importStar(require("./lib/server"));
exports.server = server;
const store_1 = require("./lib/store");
const util = tslib_1.__importStar(require("./lib/util"));
exports.util = util;
const ws = tslib_1.__importStar(require("./lib/ws"));
const REDUX_MIDDLEWARE = ['burstLimit', 'cacheWarmer', 'rateLimit', 'ws'];
const rootReducer = redux_1.combineReducers({
    burstLimit: burstLimit.reducer.rootReducer,
    cacheWarmer: cacheWarmer.reducer.rootReducer,
    rateLimit: RateLimit.reducer.rootReducer,
    ws: ws.reducer.rootReducer,
});
// Init store
const initState = { burstLimit: {}, cacheWarmer: {}, rateLimit: {}, ws: {} };
exports.store = store_1.configureStore(rootReducer, initState, [
    cacheWarmer.epics.epicMiddleware,
    ws.epics.epicMiddleware,
]);
// Run epics
cacheWarmer.epics.epicMiddleware.run(cacheWarmer.epics.rootEpic);
ws.epics.epicMiddleware.run(ws.epics.rootEpic);
const storeSlice = (slice) => ({
    getState: () => exports.store.getState()[slice],
    dispatch: (a) => exports.store.dispatch(a),
});
// Make sure data has the same statusCode as the one we got as a result
const withStatusCode = async (execute, context) => async (input) => {
    const { statusCode, data, ...rest } = await execute(input, context);
    if (data && typeof data === 'object' && data.statusCode) {
        return {
            ...rest,
            statusCode,
            data: {
                ...data,
                statusCode,
            },
        };
    }
    return { ...rest, statusCode, data };
};
// Log adapter input & output data
const withLogger = async (execute, context) => async (input) => {
    external_adapter_1.logger.debug('Input: ', { input });
    try {
        const result = await execute(input, context);
        external_adapter_1.logger.debug(`Output: [${result.statusCode}]: `, { output: result.data });
        return result;
    }
    catch (error) {
        external_adapter_1.logger.error(error.toString(), { stack: error.stack });
        throw error;
    }
};
const withMetrics = async (execute, context) => async (input) => {
    const feedId = metrics.util.getFeedId(input);
    const metricsMeta = {
        feedId,
    };
    const recordMetrics = () => {
        const labels = {
            is_cache_warming: String(input.id === config_1.WARMUP_REQUEST_ID),
            method: 'POST',
            feed_id: feedId,
        };
        const end = metrics.httpRequestDurationSeconds.startTimer();
        return (statusCode, type) => {
            labels.type = type;
            labels.status_code = metrics.util.normalizeStatusCode(statusCode);
            end();
            metrics.httpRequestsTotal.labels(labels).inc();
        };
    };
    const record = recordMetrics();
    try {
        const result = await execute({ ...input, metricsMeta }, context);
        record(result.statusCode, result.data.maxAge || result.maxAge
            ? metrics.HttpRequestType.CACHE_HIT
            : metrics.HttpRequestType.DATA_PROVIDER_HIT);
        return { ...result, metricsMeta: { ...result.metricsMeta, ...metricsMeta } };
    }
    catch (error) {
        record();
        throw error;
    }
};
const withDebug = async (execute, context) => async (input) => {
    const result = await execute(input, context);
    if (!util.isDebug()) {
        const { debug, ...rest } = result;
        return rest;
    }
    return result;
};
exports.withDebug = withDebug;
const withNormalizedInput = (endpointSelector) => async (execute, context) => async (input) => {
    const normalizedInput = endpointSelector ? external_adapter_1.normalizeInput(input, endpointSelector(input)) : input;
    return execute(normalizedInput, context);
};
exports.withNormalizedInput = withNormalizedInput;
const makeMiddleware = (execute, makeWsHandler, endpointSelector) => {
    const warmerMiddleware = [
        cache_1.withCache(storeSlice('burstLimit')),
        RateLimit.withRateLimit(storeSlice('rateLimit')),
        withStatusCode,
        exports.withNormalizedInput(endpointSelector),
    ].concat(metrics.METRICS_ENABLED ? [withMetrics] : []);
    return [
        withLogger,
        cache_1.withCache(storeSlice('burstLimit')),
        cacheWarmer.withCacheWarmer(storeSlice('cacheWarmer'), warmerMiddleware, {
            store: storeSlice('ws'),
            makeWSHandler: makeWsHandler,
        })(execute),
        ws.withWebSockets(storeSlice('ws'), makeWsHandler),
        RateLimit.withRateLimit(storeSlice('rateLimit')),
        withStatusCode,
        exports.withNormalizedInput(endpointSelector),
    ].concat(metrics.METRICS_ENABLED ? [withMetrics, exports.withDebug] : [exports.withDebug]);
};
exports.makeMiddleware = makeMiddleware;
// Wrap raw Execute function with middleware
const withMiddleware = async (execute, context, middleware) => {
    // Init and wrap middleware one by one
    for (let i = 0; i < middleware.length; i++) {
        execute = await middleware[i](execute, context);
    }
    return execute;
};
exports.withMiddleware = withMiddleware;
// Execution helper async => sync
const executeSync = async (data, execute, context, callback) => {
    try {
        const result = await execute(data, context);
        return callback(result.statusCode, result);
    }
    catch (error) {
        return callback(error.statusCode || 500, external_adapter_1.Requester.errored(data.id, error));
    }
};
exports.executeSync = executeSync;
const expose = (name, execute, makeWsHandler, endpointSelector) => {
    const middleware = exports.makeMiddleware(execute, makeWsHandler, endpointSelector);
    return {
        server: server.initHandler(name, execute, middleware),
    };
};
exports.expose = expose;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQVlBLGlDQUE4QztBQUM5Qyx1Q0FBOEM7QUFDOUMsd0VBQWlEO0FBQ2pELHNEQUE2RDtBQUM3RCw2REFPK0I7QUF3TUEsNkZBOU03QiwrQkFBWSxPQThNNkI7QUFBVyx1RkE3TTFDLHlCQUFNLE9BNk0wQztBQUFuRCwwRkE1TVAsNEJBQVMsT0E0TU87QUFBRSwwRkEzTWxCLDRCQUFTLE9BMk1rQjtBQUFnQix3RkExTTNDLDBCQUFPLE9BME0yQztBQXZNcEQsK0RBQXdDO0FBQ3hDLG9FQUE2QztBQXNNc0MsOEJBQVM7QUFyTTVGLHNFQUErQztBQUMvQyw2REFBc0M7QUFvTThCLHdCQUFNO0FBbk0xRSx1Q0FBNEM7QUFDNUMseURBQWtDO0FBa000QixvQkFBSTtBQWpNbEUscURBQThCO0FBRzlCLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxZQUFZLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQVUsQ0FBQTtBQUdsRixNQUFNLFdBQVcsR0FBRyx1QkFBZSxDQUFDO0lBQ2xDLFVBQVUsRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVc7SUFDMUMsV0FBVyxFQUFFLFdBQVcsQ0FBQyxPQUFPLENBQUMsV0FBVztJQUM1QyxTQUFTLEVBQUUsU0FBUyxDQUFDLE9BQU8sQ0FBQyxXQUFXO0lBQ3hDLEVBQUUsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFdBQVc7Q0FDM0IsQ0FBQyxDQUFBO0FBSUYsYUFBYTtBQUNiLE1BQU0sU0FBUyxHQUFHLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxDQUFBO0FBQy9ELFFBQUEsS0FBSyxHQUFHLHNCQUFjLENBQUMsV0FBVyxFQUFFLFNBQVMsRUFBRTtJQUMxRCxXQUFX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QyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFFM0MsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQTtLQUMzQztJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2QsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLFVBQVUsSUFBSSxHQUFHLEVBQUUsNEJBQVMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFBO0tBQzVFO0FBQ0gsQ0FBQyxDQUFBO0FBYlksUUFBQSxXQUFXLGVBYXZCO0FBWU0sTUFBTSxNQUFNLEdBQUcsQ0FDcEIsSUFBWSxFQUNaLE9BQWdCLEVBQ2hCLGFBQTZCLEVBQzdCLGdCQUE4RCxFQUM5QyxFQUFFO0lBQ2xCLE1BQU0sVUFBVSxHQUFHLHNCQUFjLENBQUMsT0FBTyxFQUFFLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFBO0lBQzNFLE9BQU87UUFDTCxNQUFNLEVBQUUsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQztLQUN0RCxDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBVlksUUFBQSxNQUFNLFVBVWxCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWRhcHRlck1ldHJpY3NNZXRhLFxuICBBZGFwdGVyUmVxdWVzdCxcbiAgQWRhcHRlckNvbnRleHQsXG4gIEV4ZWN1dGUsXG4gIEV4ZWN1dGVTeW5jLFxuICBNYWtlV1NIYW5kbGVyLFxuICBNaWRkbGV3YXJlLFxuICBBUElFbmRwb2ludCxcbiAgQ2FsbGJhY2ssXG4gIENvbmZpZyxcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IGNvbWJpbmVSZWR1Y2VycywgU3RvcmUgfSBmcm9tICdyZWR1eCdcbmltcG9ydCB7IENhY2hlLCB3aXRoQ2FjaGUgfSBmcm9tICcuL2xpYi9jYWNoZSdcbmltcG9ydCAqIGFzIGNhY2hlV2FybWVyIGZyb20gJy4vbGliL2NhY2hlLXdhcm1lcidcbmltcG9ydCB7IFdBUk1VUF9SRVFVRVNUX0lEIH0gZnJvbSAnLi9saWIvY2FjaGUtd2FybWVyL2NvbmZpZydcbmltcG9ydCB7XG4gIEFkYXB0ZXJFcnJvcixcbiAgbG9nZ2VyIGFzIExvZ2dlcixcbiAgUmVxdWVzdGVyLFxuICBWYWxpZGF0b3IsXG4gIEJ1aWxkZXIsXG4gIG5vcm1hbGl6ZUlucHV0LFxufSBmcm9tICcuL2xpYi9leHRlcm5hbC1hZGFwdGVyJ1xuaW1wb3J0ICogYXMgbWV0cmljcyBmcm9tICcuL2xpYi9tZXRyaWNzJ1xuaW1wb3J0ICogYXMgUmF0ZUxpbWl0IGZyb20gJy4vbGliL3JhdGUtbGltaXQnXG5pbXBvcnQgKiBhcyBidXJzdExpbWl0IGZyb20gJy4vbGliL2J1cnN0LWxpbWl0J1xuaW1wb3J0ICogYXMgc2VydmVyIGZyb20gJy4vbGliL3NlcnZlcidcbmltcG9ydCB7IGNvbmZpZ3VyZVN0b3JlIH0gZnJvbSAnLi9saWIvc3RvcmUnXG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4vbGliL3V0aWwnXG5pbXBvcnQgKiBhcyB3cyBmcm9tICcuL2xpYi93cydcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnXG5cbmNvbnN0IFJFRFVYX01JRERMRVdBUkUgPSBbJ2J1cnN0TGltaXQnLCAnY2FjaGVXYXJtZXInLCAncmF0ZUxpbWl0JywgJ3dzJ10gYXMgY29uc3RcbnR5cGUgUmVkdXhNaWRkbGV3YXJlID0gdHlwZW9mIFJFRFVYX01JRERMRVdBUkVbbnVtYmVyXVxuXG5jb25zdCByb290UmVkdWNlciA9IGNvbWJpbmVSZWR1Y2Vycyh7XG4gIGJ1cnN0TGltaXQ6IGJ1cnN0TGltaXQucmVkdWNlci5yb290UmVkdWNlcixcbiAgY2FjaGVXYXJtZXI6IGNhY2hlV2FybWVyLnJlZHVjZXIucm9vdFJlZHVjZXIsXG4gIHJhdGVMaW1pdDogUmF0ZUxpbWl0LnJlZHVjZXIucm9vdFJlZHVjZXIsXG4gIHdzOiB3cy5yZWR1Y2VyLnJvb3RSZWR1Y2VyLFxufSlcblxuZXhwb3J0IHR5cGUgUm9vdFN0YXRlID0gUmV0dXJuVHlwZTx0eXBlb2Ygcm9vdFJlZHVjZXI+XG5cbi8vIEluaXQgc3RvcmVcbmNvbnN0IGluaXRTdGF0ZSA9IHsgYnVyc3RMaW1pdDoge30sIGNhY2hlV2FybWVyOiB7fSwgcmF0ZUxpbWl0OiB7fSwgd3M6IHt9IH1cbmV4cG9ydCBjb25zdCBzdG9yZSA9IGNvbmZpZ3VyZVN0b3JlKHJvb3RSZWR1Y2VyLCBpbml0U3RhdGUsIFtcbiAgY2FjaGVXYXJtZXIuZXBpY3MuZXBpY01pZGRsZXdhcmUsXG4gIHdzLmVwaWNzLmVwaWNNaWRkbGV3YXJlLFxuXSlcblxuLy8gUnVuIGVwaWNzXG5jYWNoZVdhcm1lci5lcGljcy5lcGljTWlkZGxld2FyZS5ydW4oY2FjaGVXYXJtZXIuZXBpY3Mucm9vdEVwaWMpXG53cy5lcGljcy5lcGljTWlkZGxld2FyZS5ydW4od3MuZXBpY3Mucm9vdEVwaWMpXG5cbmNvbnN0IHN0b3JlU2xpY2UgPSAoc2xpY2U6IFJlZHV4TWlkZGxld2FyZSkgPT5cbiAgKHtcbiAgICBnZXRTdGF0ZTogKCkgPT4gc3RvcmUuZ2V0U3RhdGUoKVtzbGljZV0sXG4gICAgZGlzcGF0Y2g6IChhKSA9PiBzdG9yZS5kaXNwYXRjaChhKSxcbiAgfSBhcyBTdG9yZSlcblxuLy8gTWFrZSBzdXJlIGRhdGEgaGFzIHRoZSBzYW1lIHN0YXR1c0NvZGUgYXMgdGhlIG9uZSB3ZSBnb3QgYXMgYSByZXN1bHRcbmNvbnN0IHdpdGhTdGF0dXNDb2RlOiBNaWRkbGV3YXJlID0gYXN5bmMgKGV4ZWN1dGUsIGNvbnRleHQpID0+IGFzeW5jIChpbnB1dCkgPT4ge1xuICBjb25zdCB7IHN0YXR1c0NvZGUsIGRhdGEsIC4uLnJlc3QgfSA9IGF3YWl0IGV4ZWN1dGUoaW5wdXQsIGNvbnRleHQpXG4gIGlmIChkYXRhICYmIHR5cGVvZiBkYXRhID09PSAnb2JqZWN0JyAmJiBkYXRhLnN0YXR1c0NvZGUpIHtcbiAgICByZXR1cm4ge1xuICAgICAgLi4ucmVzdCxcbiAgICAgIHN0YXR1c0NvZGUsXG4gICAgICBkYXRhOiB7XG4gICAgICAgIC4uLmRhdGEsXG4gICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICB9LFxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7IC4uLnJlc3QsIHN0YXR1c0NvZGUsIGRhdGEgfVxufVxuXG4vLyBMb2cgYWRhcHRlciBpbnB1dCAmIG91dHB1dCBkYXRhXG5jb25zdCB3aXRoTG9nZ2VyOiBNaWRkbGV3YXJlID0gYXN5bmMgKGV4ZWN1dGUsIGNvbnRleHQpID0+IGFzeW5jIChpbnB1dDogQWRhcHRlclJlcXVlc3QpID0+IHtcbiAgTG9nZ2VyLmRlYnVnKCdJbnB1dDogJywgeyBpbnB1dCB9KVxuICB0cnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dGUoaW5wdXQsIGNvbnRleHQpXG4gICAgTG9nZ2VyLmRlYnVnKGBPdXRwdXQ6IFske3Jlc3VsdC5zdGF0dXNDb2RlfV06IGAsIHsgb3V0cHV0OiByZXN1bHQuZGF0YSB9KVxuICAgIHJldHVybiByZXN1bHRcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBMb2dnZXIuZXJyb3IoZXJyb3IudG9TdHJpbmcoKSwgeyBzdGFjazogZXJyb3Iuc3RhY2sgfSlcbiAgICB0aHJvdyBlcnJvclxuICB9XG59XG5cbmNvbnN0IHdpdGhNZXRyaWNzOiBNaWRkbGV3YXJlID0gYXN5bmMgKGV4ZWN1dGUsIGNvbnRleHQpID0+IGFzeW5jIChpbnB1dDogQWRhcHRlclJlcXVlc3QpID0+IHtcbiAgY29uc3QgZmVlZElkID0gbWV0cmljcy51dGlsLmdldEZlZWRJZChpbnB1dClcbiAgY29uc3QgbWV0cmljc01ldGE6IEFkYXB0ZXJNZXRyaWNzTWV0YSA9IHtcbiAgICBmZWVkSWQsXG4gIH1cblxuICBjb25zdCByZWNvcmRNZXRyaWNzID0gKCkgPT4ge1xuICAgIGNvbnN0IGxhYmVsczogUGFyYW1ldGVyczx0eXBlb2YgbWV0cmljcy5odHRwUmVxdWVzdHNUb3RhbC5sYWJlbHM+WzBdID0ge1xuICAgICAgaXNfY2FjaGVfd2FybWluZzogU3RyaW5nKGlucHV0LmlkID09PSBXQVJNVVBfUkVRVUVTVF9JRCksXG4gICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgIGZlZWRfaWQ6IGZlZWRJZCxcbiAgICB9XG4gICAgY29uc3QgZW5kID0gbWV0cmljcy5odHRwUmVxdWVzdER1cmF0aW9uU2Vjb25kcy5zdGFydFRpbWVyKClcblxuICAgIHJldHVybiAoc3RhdHVzQ29kZT86IG51bWJlciwgdHlwZT86IG1ldHJpY3MuSHR0cFJlcXVlc3RUeXBlKSA9PiB7XG4gICAgICBsYWJlbHMudHlwZSA9IHR5cGVcbiAgICAgIGxhYmVscy5zdGF0dXNfY29kZSA9IG1ldHJpY3MudXRpbC5ub3JtYWxpemVTdGF0dXNDb2RlKHN0YXR1c0NvZGUpXG4gICAgICBlbmQoKVxuICAgICAgbWV0cmljcy5odHRwUmVxdWVzdHNUb3RhbC5sYWJlbHMobGFiZWxzKS5pbmMoKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJlY29yZCA9IHJlY29yZE1ldHJpY3MoKVxuICB0cnkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dGUoeyAuLi5pbnB1dCwgbWV0cmljc01ldGEgfSwgY29udGV4dClcbiAgICByZWNvcmQoXG4gICAgICByZXN1bHQuc3RhdHVzQ29kZSxcbiAgICAgIHJlc3VsdC5kYXRhLm1heEFnZSB8fCAocmVzdWx0IGFzIGFueSkubWF4QWdlXG4gICAgICAgID8gbWV0cmljcy5IdHRwUmVxdWVzdFR5cGUuQ0FDSEVfSElUXG4gICAgICAgIDogbWV0cmljcy5IdHRwUmVxdWVzdFR5cGUuREFUQV9QUk9WSURFUl9ISVQsXG4gICAgKVxuICAgIHJldHVybiB7IC4uLnJlc3VsdCwgbWV0cmljc01ldGE6IHsgLi4ucmVzdWx0Lm1ldHJpY3NNZXRhLCAuLi5tZXRyaWNzTWV0YSB9IH1cbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICByZWNvcmQoKVxuICAgIHRocm93IGVycm9yXG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IHdpdGhEZWJ1ZzogTWlkZGxld2FyZSA9IGFzeW5jIChleGVjdXRlLCBjb250ZXh0KSA9PiBhc3luYyAoaW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0KSA9PiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGV4ZWN1dGUoaW5wdXQsIGNvbnRleHQpXG4gIGlmICghdXRpbC5pc0RlYnVnKCkpIHtcbiAgICBjb25zdCB7IGRlYnVnLCAuLi5yZXN0IH0gPSByZXN1bHRcbiAgICByZXR1cm4gcmVzdFxuICB9XG4gIHJldHVybiByZXN1bHRcbn1cblxuZXhwb3J0IGNvbnN0IHdpdGhOb3JtYWxpemVkSW5wdXQ6IDxDIGV4dGVuZHMgQ29uZmlnPihcbiAgZW5kcG9pbnRTZWxlY3Rvcj86IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCkgPT4gQVBJRW5kcG9pbnQ8Qz4sXG4pID0+IE1pZGRsZXdhcmUgPSAoZW5kcG9pbnRTZWxlY3RvcikgPT4gYXN5bmMgKGV4ZWN1dGUsIGNvbnRleHQpID0+IGFzeW5jIChpbnB1dDogQWRhcHRlclJlcXVlc3QpID0+IHtcbiAgY29uc3Qgbm9ybWFsaXplZElucHV0ID0gZW5kcG9pbnRTZWxlY3RvciA/IG5vcm1hbGl6ZUlucHV0KGlucHV0LCBlbmRwb2ludFNlbGVjdG9yKGlucHV0KSkgOiBpbnB1dFxuICByZXR1cm4gZXhlY3V0ZShub3JtYWxpemVkSW5wdXQsIGNvbnRleHQpXG59XG5cbmV4cG9ydCBjb25zdCBtYWtlTWlkZGxld2FyZSA9IDxDIGV4dGVuZHMgQ29uZmlnPihcbiAgZXhlY3V0ZTogRXhlY3V0ZSxcbiAgbWFrZVdzSGFuZGxlcj86IE1ha2VXU0hhbmRsZXIsXG4gIGVuZHBvaW50U2VsZWN0b3I/OiAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IEFQSUVuZHBvaW50PEM+LFxuKTogTWlkZGxld2FyZVtdID0+IHtcbiAgY29uc3Qgd2FybWVyTWlkZGxld2FyZSA9IFtcbiAgICB3aXRoQ2FjaGUoc3RvcmVTbGljZSgnYnVyc3RMaW1pdCcpKSxcbiAgICBSYXRlTGltaXQud2l0aFJhdGVMaW1pdChzdG9yZVNsaWNlKCdyYXRlTGltaXQnKSksXG4gICAgd2l0aFN0YXR1c0NvZGUsXG4gICAgd2l0aE5vcm1hbGl6ZWRJbnB1dChlbmRwb2ludFNlbGVjdG9yKSxcbiAgXS5jb25jYXQobWV0cmljcy5NRVRSSUNTX0VOQUJMRUQgPyBbd2l0aE1ldHJpY3NdIDogW10pXG5cbiAgcmV0dXJuIFtcbiAgICB3aXRoTG9nZ2VyLFxuICAgIHdpdGhDYWNoZShzdG9yZVNsaWNlKCdidXJzdExpbWl0JykpLFxuICAgIGNhY2hlV2FybWVyLndpdGhDYWNoZVdhcm1lcihzdG9yZVNsaWNlKCdjYWNoZVdhcm1lcicpLCB3YXJtZXJNaWRkbGV3YXJlLCB7XG4gICAgICBzdG9yZTogc3RvcmVTbGljZSgnd3MnKSxcbiAgICAgIG1ha2VXU0hhbmRsZXI6IG1ha2VXc0hhbmRsZXIsXG4gICAgfSkoZXhlY3V0ZSksXG4gICAgd3Mud2l0aFdlYlNvY2tldHMoc3RvcmVTbGljZSgnd3MnKSwgbWFrZVdzSGFuZGxlciksXG4gICAgUmF0ZUxpbWl0LndpdGhSYXRlTGltaXQoc3RvcmVTbGljZSgncmF0ZUxpbWl0JykpLFxuICAgIHdpdGhTdGF0dXNDb2RlLFxuICAgIHdpdGhOb3JtYWxpemVkSW5wdXQoZW5kcG9pbnRTZWxlY3RvciksXG4gIF0uY29uY2F0KG1ldHJpY3MuTUVUUklDU19FTkFCTEVEID8gW3dpdGhNZXRyaWNzLCB3aXRoRGVidWddIDogW3dpdGhEZWJ1Z10pXG59XG5cbi8vIFdyYXAgcmF3IEV4ZWN1dGUgZnVuY3Rpb24gd2l0aCBtaWRkbGV3YXJlXG5leHBvcnQgY29uc3Qgd2l0aE1pZGRsZXdhcmUgPSBhc3luYyAoXG4gIGV4ZWN1dGU6IEV4ZWN1dGUsXG4gIGNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0LFxuICBtaWRkbGV3YXJlOiBNaWRkbGV3YXJlW10sXG4pOiBQcm9taXNlPEV4ZWN1dGU+ID0+IHtcbiAgLy8gSW5pdCBhbmQgd3JhcCBtaWRkbGV3YXJlIG9uZSBieSBvbmVcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaWRkbGV3YXJlLmxlbmd0aDsgaSsrKSB7XG4gICAgZXhlY3V0ZSA9IGF3YWl0IG1pZGRsZXdhcmVbaV0oZXhlY3V0ZSwgY29udGV4dClcbiAgfVxuICByZXR1cm4gZXhlY3V0ZVxufVxuXG4vLyBFeGVjdXRpb24gaGVscGVyIGFzeW5jID0+IHN5bmNcbmV4cG9ydCBjb25zdCBleGVjdXRlU3luYzogRXhlY3V0ZVN5bmMgPSBhc3luYyAoXG4gIGRhdGE6IEFkYXB0ZXJSZXF1ZXN0LFxuICBleGVjdXRlOiBFeGVjdXRlLFxuICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dCxcbiAgY2FsbGJhY2s6IENhbGxiYWNrLFxuKSA9PiB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZXhlY3V0ZShkYXRhLCBjb250ZXh0KVxuXG4gICAgcmV0dXJuIGNhbGxiYWNrKHJlc3VsdC5zdGF0dXNDb2RlLCByZXN1bHQpXG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIGNhbGxiYWNrKGVycm9yLnN0YXR1c0NvZGUgfHwgNTAwLCBSZXF1ZXN0ZXIuZXJyb3JlZChkYXRhLmlkLCBlcnJvcikpXG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgRXh0ZXJuYWxBZGFwdGVyID0ge1xuICBleGVjdXRlOiBFeGVjdXRlXG4gIG1ha2VXc0hhbmRsZXI/OiBNYWtlV1NIYW5kbGVyXG4gIGVuZHBvaW50U2VsZWN0b3I/OiAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IEFQSUVuZHBvaW50XG59XG5cbmV4cG9ydCB0eXBlIEV4ZWN1dGVIYW5kbGVyID0ge1xuICBzZXJ2ZXI6ICgpID0+IFByb21pc2U8aHR0cC5TZXJ2ZXI+XG59XG5cbmV4cG9ydCBjb25zdCBleHBvc2UgPSA8QyBleHRlbmRzIENvbmZpZz4oXG4gIG5hbWU6IHN0cmluZyxcbiAgZXhlY3V0ZTogRXhlY3V0ZSxcbiAgbWFrZVdzSGFuZGxlcj86IE1ha2VXU0hhbmRsZXIsXG4gIGVuZHBvaW50U2VsZWN0b3I/OiAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IEFQSUVuZHBvaW50PEM+LFxuKTogRXhlY3V0ZUhhbmRsZXIgPT4ge1xuICBjb25zdCBtaWRkbGV3YXJlID0gbWFrZU1pZGRsZXdhcmUoZXhlY3V0ZSwgbWFrZVdzSGFuZGxlciwgZW5kcG9pbnRTZWxlY3RvcilcbiAgcmV0dXJuIHtcbiAgICBzZXJ2ZXI6IHNlcnZlci5pbml0SGFuZGxlcihuYW1lLCBleGVjdXRlLCBtaWRkbGV3YXJlKSxcbiAgfVxufVxuXG5leHBvcnQgeyBSZXF1ZXN0ZXIsIFZhbGlkYXRvciwgQWRhcHRlckVycm9yLCBCdWlsZGVyLCBMb2dnZXIsIHV0aWwsIHNlcnZlciwgQ2FjaGUsIFJhdGVMaW1pdCB9XG4iXX0=