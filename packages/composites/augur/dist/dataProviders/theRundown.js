"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.resolve = exports.numToEventId = exports.create = exports.sportIdMapping = exports.SPORTS_SUPPORTED = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const TheRundown = tslib_1.__importStar(require("@chainlink/therundown-adapter"));
const ethers_1 = require("ethers");
exports.SPORTS_SUPPORTED = ['mlb', 'nba'];
exports.sportIdMapping = {
    MLB: 3,
    NBA: 4,
};
const eventIdToNum = (eventId) => ethers_1.BigNumber.from(`0x${eventId}`);
const TBD_TEAM_ID = 2756;
const createParams = {
    sport: true,
    daysInAdvance: true,
    startBuffer: true,
    contract: true,
    affiliateIds: true,
};
const addDays = (date, days) => {
    const newDate = new Date(date);
    newDate.setDate(date.getDate() + days);
    return newDate;
};
const create = async (input, context) => {
    const validator = new ea_bootstrap_1.Validator(input, createParams);
    if (validator.error)
        throw validator.error;
    const sport = validator.validated.data.sport.toUpperCase();
    const sportId = exports.sportIdMapping[sport];
    const daysInAdvance = validator.validated.data.daysInAdvance;
    const startBuffer = validator.validated.data.startBuffer;
    const contract = validator.validated.data.contract;
    const affiliateIds = validator.validated.data.affiliateIds;
    const getAffiliateId = (event) => affiliateIds.find((id) => !!event.lines && id in event.lines);
    const params = {
        id: input.id,
        data: {
            sportId,
            status: 'STATUS_SCHEDULED',
            date: new Date(),
            endpoint: 'events',
        },
    };
    const theRundownExec = TheRundown.makeExecute(TheRundown.makeConfig(TheRundown.NAME));
    const events = [];
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Fetching data from therundown for ${sport} (${sportId})`);
    for (let i = 0; i < daysInAdvance; i++) {
        params.data.date = addDays(params.data.date, 1);
        ea_bootstrap_1.Logger.debug(`Augur theRundown: Fetching data for date ${params.data.date}`);
        const response = await theRundownExec(params, context);
        events.push(...response.result);
    }
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Got ${events.length} events from data provider`);
    let skipTBD = 0, skipStartBuffer = 0, skipNoTeams = 0, cantCreate = 0, skipTBDTeams = 0;
    // filter markets and build payloads for market creation
    const eventsToCreate = [];
    for (const event of events) {
        if (event.score.event_status_detail.toUpperCase() === 'TBD') {
            skipTBD++;
            continue;
        }
        const startTime = Date.parse(event.event_date);
        if ((startTime - Date.now()) / 1000 < startBuffer) {
            // markets would end too soon
            skipStartBuffer++;
            continue;
        }
        // skip if data is missing
        const affiliateId = getAffiliateId(event);
        const homeTeam = event.teams_normalized.find((team) => team.is_home);
        const awayTeam = event.teams_normalized.find((team) => team.is_away);
        if (!homeTeam || !awayTeam) {
            skipNoTeams++;
            continue;
        }
        // skip if a team hasn't been announced yet
        if (homeTeam.team_id === TBD_TEAM_ID || awayTeam.team_id === TBD_TEAM_ID) {
            skipTBDTeams++;
            continue;
        }
        const eventId = eventIdToNum(event.event_id);
        const [headToHeadMarket, spreadMarket, totalScoreMarket] = await contract.getEventMarkets(eventId);
        // Only create head-to-head market if moneylines exist. Only create spread and total-score markets if their lines exist.
        const moneylineHome = transformSpecialNone(affiliateId && event.lines?.[affiliateId].moneyline.moneyline_home);
        const moneylineAway = transformSpecialNone(affiliateId && event.lines?.[affiliateId].moneyline.moneyline_away);
        const homeSpread = transformSpecialNone(affiliateId && event.lines?.[affiliateId].spread.point_spread_home);
        const totalScore = transformSpecialNone(affiliateId && event.lines?.[affiliateId].total.total_over);
        const createHeadToHead = headToHeadMarket.isZero() && moneylineHome && moneylineAway;
        const createSpread = sport !== 'MLB' && spreadMarket.isZero() && homeSpread !== undefined;
        const createTotalScore = sport !== 'MLB' && totalScoreMarket.isZero() && totalScore !== undefined;
        const canCreate = createHeadToHead || createSpread || createTotalScore;
        if (!canCreate) {
            cantCreate++;
            continue;
        }
        eventsToCreate.push({
            id: eventId,
            homeTeamName: 'Home',
            homeTeamId: homeTeam.team_id,
            awayTeamName: 'Away',
            awayTeamId: awayTeam.team_id,
            startTime,
            homeSpread: homeSpread || 0,
            totalScore: totalScore || 0,
            createSpread,
            createTotalScore,
            moneylines: [moneylineHome || 0, moneylineAway || 0],
        });
    }
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Skipping ${skipTBD} due to TBD status`);
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Skipping ${skipStartBuffer} due to startBuffer`);
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Skipping ${skipNoTeams} due to no teams`);
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Skipping ${skipTBDTeams} due to TBD teams`);
    ea_bootstrap_1.Logger.debug(`Augur theRundown: Skipping ${cantCreate} due to no market to create`);
    return ea_bootstrap_1.Requester.success(input.id, {
        data: { result: eventsToCreate },
    });
};
exports.create = create;
/**
 * TheRundown API returns `0.0001` as a special case which should
 * be treated as the value is `undefined`. This function transforms
 * `0.0001` to `undefined`, and leaves `val` unchanged otherwise.
 * @param {number} val - The value returned from the API
 * @return {number|undefined} Transformed `val`
 */
const transformSpecialNone = (val) => (val === 0.0001 ? undefined : val);
const eventStatus = {
    STATUS_SCHEDULED: 1,
    STATUS_FINAL: 2,
    STATUS_POSTPONED: 3,
    STATUS_CANCELED: 4,
    STATUS_SUSPENDED: 4, // treating as canceled
};
const resolveParams = {
    sport: true,
    eventId: true,
};
const numToEventId = (num) => num.toHexString().slice(2);
exports.numToEventId = numToEventId;
const resolve = async (input, context) => {
    const validator = new ea_bootstrap_1.Validator(input, resolveParams);
    if (validator.error)
        throw validator.error;
    const theRundownExec = TheRundown.makeExecute({
        ...TheRundown.makeConfig(TheRundown.NAME),
        // Need ALL the response data.
        verbose: true,
    });
    const sport = validator.validated.data.sport;
    const sportId = exports.sportIdMapping[sport.toUpperCase()];
    const eventId = exports.numToEventId(validator.validated.data.eventId);
    const req = {
        id: input.id,
        data: {
            endpoint: 'event',
            sportId,
            eventId,
        },
    };
    const response = (await theRundownExec(req, context)).data;
    const event = {
        id: eventIdToNum(response.event_id),
        status: eventStatus[response.score.event_status],
        homeScore: response.score.score_home,
        awayScore: response.score.score_away,
    };
    return ea_bootstrap_1.Requester.success(input.id, {
        data: { result: event },
    });
};
exports.resolve = resolve;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGhlUnVuZG93bi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kYXRhUHJvdmlkZXJzL3RoZVJ1bmRvd24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDBEQUFzRTtBQUV0RSxrRkFBMkQ7QUFJM0QsbUNBQWtDO0FBRXJCLFFBQUEsZ0JBQWdCLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLENBQUE7QUFFakMsUUFBQSxjQUFjLEdBQWdDO0lBQ3pELEdBQUcsRUFBRSxDQUFDO0lBQ04sR0FBRyxFQUFFLENBQUM7Q0FDUCxDQUFBO0FBRUQsTUFBTSxZQUFZLEdBQUcsQ0FBQyxPQUFlLEVBQWEsRUFBRSxDQUFDLGtCQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQTtBQW1DbkYsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFBO0FBRXhCLE1BQU0sWUFBWSxHQUFHO0lBQ25CLEtBQUssRUFBRSxJQUFJO0lBQ1gsYUFBYSxFQUFFLElBQUk7SUFDbkIsV0FBVyxFQUFFLElBQUk7SUFDakIsUUFBUSxFQUFFLElBQUk7SUFDZCxZQUFZLEVBQUUsSUFBSTtDQUNuQixDQUFBO0FBRUQsTUFBTSxPQUFPLEdBQUcsQ0FBQyxJQUFVLEVBQUUsSUFBWSxFQUFRLEVBQUU7SUFDakQsTUFBTSxPQUFPLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDOUIsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUE7SUFDdEMsT0FBTyxPQUFPLENBQUE7QUFDaEIsQ0FBQyxDQUFBO0FBRU0sTUFBTSxNQUFNLEdBQVksS0FBSyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRTtJQUN0RCxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFBO0lBQ3BELElBQUksU0FBUyxDQUFDLEtBQUs7UUFBRSxNQUFNLFNBQVMsQ0FBQyxLQUFLLENBQUE7SUFFMUMsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzFELE1BQU0sT0FBTyxHQUFHLHNCQUFjLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDckMsTUFBTSxhQUFhLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFBO0lBQzVELE1BQU0sV0FBVyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQTtJQUN4RCxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7SUFDbEQsTUFBTSxZQUFZLEdBQWEsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFBO0lBQ3BFLE1BQU0sY0FBYyxHQUFHLENBQUMsS0FBc0IsRUFBRSxFQUFFLENBQ2hELFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxJQUFJLEVBQUUsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUE7SUFFL0QsTUFBTSxNQUFNLEdBQUc7UUFDYixFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUU7UUFDWixJQUFJLEVBQUU7WUFDSixPQUFPO1lBQ1AsTUFBTSxFQUFFLGtCQUFrQjtZQUMxQixJQUFJLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDaEIsUUFBUSxFQUFFLFFBQVE7U0FDbkI7S0FDRixDQUFBO0lBQ0QsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0lBRXJGLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUNqQixxQkFBTSxDQUFDLEtBQUssQ0FBQyx1REFBdUQsS0FBSyxLQUFLLE9BQU8sR0FBRyxDQUFDLENBQUE7SUFDekYsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGFBQWEsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUN0QyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDL0MscUJBQU0sQ0FBQyxLQUFLLENBQUMsNENBQTRDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQTtRQUM1RSxNQUFNLFFBQVEsR0FBRyxNQUFNLGNBQWMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDdEQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFJLFFBQVEsQ0FBQyxNQUE0QixDQUFDLENBQUE7S0FDdkQ7SUFFRCxxQkFBTSxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsTUFBTSxDQUFDLE1BQU0sNEJBQTRCLENBQUMsQ0FBQTtJQUNoRixJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQ2IsZUFBZSxHQUFHLENBQUMsRUFDbkIsV0FBVyxHQUFHLENBQUMsRUFDZixVQUFVLEdBQUcsQ0FBQyxFQUNkLFlBQVksR0FBRyxDQUFDLENBQUE7SUFFbEIsd0RBQXdEO0lBQ3hELE1BQU0sY0FBYyxHQUFzQixFQUFFLENBQUE7SUFDNUMsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUU7UUFDMUIsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxLQUFLLEtBQUssRUFBRTtZQUMzRCxPQUFPLEVBQUUsQ0FBQTtZQUNULFNBQVE7U0FDVDtRQUVELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQzlDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsSUFBSSxHQUFHLFdBQVcsRUFBRTtZQUNqRCw2QkFBNkI7WUFDN0IsZUFBZSxFQUFFLENBQUE7WUFDakIsU0FBUTtTQUNUO1FBRUQsMEJBQTBCO1FBQzFCLE1BQU0sV0FBVyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUN6QyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDcEUsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3BFLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDMUIsV0FBVyxFQUFFLENBQUE7WUFDYixTQUFRO1NBQ1Q7UUFFRCwyQ0FBMkM7UUFDM0MsSUFBSSxRQUFRLENBQUMsT0FBTyxLQUFLLFdBQVcsSUFBSSxRQUFRLENBQUMsT0FBTyxLQUFLLFdBQVcsRUFBRTtZQUN4RSxZQUFZLEVBQUUsQ0FBQTtZQUNkLFNBQVE7U0FDVDtRQUVELE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDNUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLFlBQVksRUFBRSxnQkFBZ0IsQ0FBQyxHQUlwRCxNQUFNLFFBQVEsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUE7UUFFM0Msd0hBQXdIO1FBQ3hILE1BQU0sYUFBYSxHQUFHLG9CQUFvQixDQUN4QyxXQUFXLElBQUksS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQ25FLENBQUE7UUFDRCxNQUFNLGFBQWEsR0FBRyxvQkFBb0IsQ0FDeEMsV0FBVyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUNuRSxDQUFBO1FBQ0QsTUFBTSxVQUFVLEdBQUcsb0JBQW9CLENBQ3JDLFdBQVcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsTUFBTSxDQUFDLGlCQUFpQixDQUNuRSxDQUFBO1FBQ0QsTUFBTSxVQUFVLEdBQUcsb0JBQW9CLENBQ3JDLFdBQVcsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FDM0QsQ0FBQTtRQUVELE1BQU0sZ0JBQWdCLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksYUFBYSxJQUFJLGFBQWEsQ0FBQTtRQUNwRixNQUFNLFlBQVksR0FBRyxLQUFLLEtBQUssS0FBSyxJQUFJLFlBQVksQ0FBQyxNQUFNLEVBQUUsSUFBSSxVQUFVLEtBQUssU0FBUyxDQUFBO1FBQ3pGLE1BQU0sZ0JBQWdCLEdBQ3BCLEtBQUssS0FBSyxLQUFLLElBQUksZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksVUFBVSxLQUFLLFNBQVMsQ0FBQTtRQUMxRSxNQUFNLFNBQVMsR0FBRyxnQkFBZ0IsSUFBSSxZQUFZLElBQUksZ0JBQWdCLENBQUE7UUFDdEUsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLFVBQVUsRUFBRSxDQUFBO1lBQ1osU0FBUTtTQUNUO1FBRUQsY0FBYyxDQUFDLElBQUksQ0FBQztZQUNsQixFQUFFLEVBQUUsT0FBTztZQUNYLFlBQVksRUFBRSxNQUFNO1lBQ3BCLFVBQVUsRUFBRSxRQUFRLENBQUMsT0FBTztZQUM1QixZQUFZLEVBQUUsTUFBTTtZQUNwQixVQUFVLEVBQUUsUUFBUSxDQUFDLE9BQU87WUFDNUIsU0FBUztZQUNULFVBQVUsRUFBRSxVQUFVLElBQUksQ0FBQztZQUMzQixVQUFVLEVBQUUsVUFBVSxJQUFJLENBQUM7WUFDM0IsWUFBWTtZQUNaLGdCQUFnQjtZQUNoQixVQUFVLEVBQUUsQ0FBQyxhQUFhLElBQUksQ0FBQyxFQUFFLGFBQWEsSUFBSSxDQUFDLENBQUM7U0FDckQsQ0FBQyxDQUFBO0tBQ0g7SUFFRCxxQkFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsT0FBTyxvQkFBb0IsQ0FBQyxDQUFBO0lBQ3ZFLHFCQUFNLENBQUMsS0FBSyxDQUFDLDhCQUE4QixlQUFlLHFCQUFxQixDQUFDLENBQUE7SUFDaEYscUJBQU0sQ0FBQyxLQUFLLENBQUMsOEJBQThCLFdBQVcsa0JBQWtCLENBQUMsQ0FBQTtJQUN6RSxxQkFBTSxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsWUFBWSxtQkFBbUIsQ0FBQyxDQUFBO0lBQzNFLHFCQUFNLENBQUMsS0FBSyxDQUFDLDhCQUE4QixVQUFVLDZCQUE2QixDQUFDLENBQUE7SUFFbkYsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO1FBQ2pDLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxjQUFjLEVBQUU7S0FDakMsQ0FBQyxDQUFBO0FBQ0osQ0FBQyxDQUFBO0FBN0hZLFFBQUEsTUFBTSxVQTZIbEI7QUFFRDs7Ozs7O0dBTUc7QUFDSCxNQUFNLG9CQUFvQixHQUFHLENBQUMsR0FBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUE7QUFFakYsTUFBTSxXQUFXLEdBQThCO0lBQzdDLGdCQUFnQixFQUFFLENBQUM7SUFDbkIsWUFBWSxFQUFFLENBQUM7SUFDZixnQkFBZ0IsRUFBRSxDQUFDO0lBQ25CLGVBQWUsRUFBRSxDQUFDO0lBQ2xCLGdCQUFnQixFQUFFLENBQUMsRUFBRSx1QkFBdUI7Q0FDN0MsQ0FBQTtBQUVELE1BQU0sYUFBYSxHQUFHO0lBQ3BCLEtBQUssRUFBRSxJQUFJO0lBQ1gsT0FBTyxFQUFFLElBQUk7Q0FDZCxDQUFBO0FBRU0sTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFjLEVBQVUsRUFBRSxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7QUFBckUsUUFBQSxZQUFZLGdCQUF5RDtBQUUzRSxNQUFNLE9BQU8sR0FBWSxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO0lBQ3ZELE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVMsQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUE7SUFDckQsSUFBSSxTQUFTLENBQUMsS0FBSztRQUFFLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQTtJQUUxQyxNQUFNLGNBQWMsR0FBRyxVQUFVLENBQUMsV0FBVyxDQUFDO1FBQzVDLEdBQUcsVUFBVSxDQUFDLFVBQVUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBRXpDLDhCQUE4QjtRQUM5QixPQUFPLEVBQUUsSUFBSTtLQUNkLENBQUMsQ0FBQTtJQUVGLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUM1QyxNQUFNLE9BQU8sR0FBRyxzQkFBYyxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFBO0lBQ25ELE1BQU0sT0FBTyxHQUFHLG9CQUFZLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7SUFFOUQsTUFBTSxHQUFHLEdBQUc7UUFDVixFQUFFLEVBQUUsS0FBSyxDQUFDLEVBQUU7UUFDWixJQUFJLEVBQUU7WUFDSixRQUFRLEVBQUUsT0FBTztZQUNqQixPQUFPO1lBQ1AsT0FBTztTQUNSO0tBQ0YsQ0FBQTtJQUVELE1BQU0sUUFBUSxHQUFHLENBQUMsTUFBTSxjQUFjLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsSUFBdUIsQ0FBQTtJQUU3RSxNQUFNLEtBQUssR0FBZ0I7UUFDekIsRUFBRSxFQUFFLFlBQVksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO1FBQ25DLE1BQU0sRUFBRSxXQUFXLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUM7UUFDaEQsU0FBUyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVTtRQUNwQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVO0tBQ3JDLENBQUE7SUFFRCxPQUFPLHdCQUFTLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUU7UUFDakMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRTtLQUN4QixDQUFDLENBQUE7QUFDSixDQUFDLENBQUE7QUFwQ1ksUUFBQSxPQUFPLFdBb0NuQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IExvZ2dlciwgUmVxdWVzdGVyLCBWYWxpZGF0b3IgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7IEV4ZWN1dGUgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0ICogYXMgVGhlUnVuZG93biBmcm9tICdAY2hhaW5saW5rL3RoZXJ1bmRvd24tYWRhcHRlcidcbmltcG9ydCB7IGV0aGVycyB9IGZyb20gJ2V0aGVycydcbmltcG9ydCB7IENyZWF0ZVRlYW1FdmVudCB9IGZyb20gJy4uL21ldGhvZHMvY3JlYXRlTWFya2V0cydcbmltcG9ydCB7IFJlc29sdmVUZWFtIH0gZnJvbSAnLi4vbWV0aG9kcy9yZXNvbHZlTWFya2V0cydcbmltcG9ydCB7IEJpZ051bWJlciB9IGZyb20gJ2V0aGVycydcblxuZXhwb3J0IGNvbnN0IFNQT1JUU19TVVBQT1JURUQgPSBbJ21sYicsICduYmEnXVxuXG5leHBvcnQgY29uc3Qgc3BvcnRJZE1hcHBpbmc6IHsgW3Nwb3J0OiBzdHJpbmddOiBudW1iZXIgfSA9IHtcbiAgTUxCOiAzLFxuICBOQkE6IDQsXG59XG5cbmNvbnN0IGV2ZW50SWRUb051bSA9IChldmVudElkOiBzdHJpbmcpOiBCaWdOdW1iZXIgPT4gQmlnTnVtYmVyLmZyb20oYDB4JHtldmVudElkfWApXG5cbmludGVyZmFjZSBUaGVSdW5kb3duRXZlbnQge1xuICBldmVudF9pZDogc3RyaW5nXG4gIGV2ZW50X2RhdGU6IHN0cmluZ1xuICBsaW5lcz86IHtcbiAgICBba2V5OiBzdHJpbmddOiB7XG4gICAgICBhZmZpbGlhdGU6IHtcbiAgICAgICAgYWZmaWxpYXRlX2lkOiBudW1iZXJcbiAgICAgIH1cbiAgICAgIHNwcmVhZDoge1xuICAgICAgICBwb2ludF9zcHJlYWRfaG9tZTogbnVtYmVyXG4gICAgICB9XG4gICAgICB0b3RhbDoge1xuICAgICAgICB0b3RhbF9vdmVyOiBudW1iZXJcbiAgICAgIH1cbiAgICAgIG1vbmV5bGluZToge1xuICAgICAgICBtb25leWxpbmVfaG9tZTogbnVtYmVyXG4gICAgICAgIG1vbmV5bGluZV9hd2F5OiBudW1iZXJcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgc2NvcmU6IHtcbiAgICBldmVudF9zdGF0dXM6IHN0cmluZ1xuICAgIGV2ZW50X3N0YXR1c19kZXRhaWw6IHN0cmluZ1xuICAgIHNjb3JlX2hvbWU6IG51bWJlclxuICAgIHNjb3JlX2F3YXk6IG51bWJlclxuICB9XG4gIHRlYW1zX25vcm1hbGl6ZWQ6IHtcbiAgICBpc19hd2F5OiBib29sZWFuXG4gICAgaXNfaG9tZTogYm9vbGVhblxuICAgIHRlYW1faWQ6IG51bWJlclxuICB9W11cbn1cblxuY29uc3QgVEJEX1RFQU1fSUQgPSAyNzU2XG5cbmNvbnN0IGNyZWF0ZVBhcmFtcyA9IHtcbiAgc3BvcnQ6IHRydWUsXG4gIGRheXNJbkFkdmFuY2U6IHRydWUsXG4gIHN0YXJ0QnVmZmVyOiB0cnVlLFxuICBjb250cmFjdDogdHJ1ZSxcbiAgYWZmaWxpYXRlSWRzOiB0cnVlLFxufVxuXG5jb25zdCBhZGREYXlzID0gKGRhdGU6IERhdGUsIGRheXM6IG51bWJlcik6IERhdGUgPT4ge1xuICBjb25zdCBuZXdEYXRlID0gbmV3IERhdGUoZGF0ZSlcbiAgbmV3RGF0ZS5zZXREYXRlKGRhdGUuZ2V0RGF0ZSgpICsgZGF5cylcbiAgcmV0dXJuIG5ld0RhdGVcbn1cblxuZXhwb3J0IGNvbnN0IGNyZWF0ZTogRXhlY3V0ZSA9IGFzeW5jIChpbnB1dCwgY29udGV4dCkgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCBjcmVhdGVQYXJhbXMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IHNwb3J0ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnNwb3J0LnRvVXBwZXJDYXNlKClcbiAgY29uc3Qgc3BvcnRJZCA9IHNwb3J0SWRNYXBwaW5nW3Nwb3J0XVxuICBjb25zdCBkYXlzSW5BZHZhbmNlID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmRheXNJbkFkdmFuY2VcbiAgY29uc3Qgc3RhcnRCdWZmZXIgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuc3RhcnRCdWZmZXJcbiAgY29uc3QgY29udHJhY3QgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuY29udHJhY3RcbiAgY29uc3QgYWZmaWxpYXRlSWRzOiBudW1iZXJbXSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5hZmZpbGlhdGVJZHNcbiAgY29uc3QgZ2V0QWZmaWxpYXRlSWQgPSAoZXZlbnQ6IFRoZVJ1bmRvd25FdmVudCkgPT5cbiAgICBhZmZpbGlhdGVJZHMuZmluZCgoaWQpID0+ICEhZXZlbnQubGluZXMgJiYgaWQgaW4gZXZlbnQubGluZXMpXG5cbiAgY29uc3QgcGFyYW1zID0ge1xuICAgIGlkOiBpbnB1dC5pZCxcbiAgICBkYXRhOiB7XG4gICAgICBzcG9ydElkLFxuICAgICAgc3RhdHVzOiAnU1RBVFVTX1NDSEVEVUxFRCcsXG4gICAgICBkYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgZW5kcG9pbnQ6ICdldmVudHMnLFxuICAgIH0sXG4gIH1cbiAgY29uc3QgdGhlUnVuZG93bkV4ZWMgPSBUaGVSdW5kb3duLm1ha2VFeGVjdXRlKFRoZVJ1bmRvd24ubWFrZUNvbmZpZyhUaGVSdW5kb3duLk5BTUUpKVxuXG4gIGNvbnN0IGV2ZW50cyA9IFtdXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXIgdGhlUnVuZG93bjogRmV0Y2hpbmcgZGF0YSBmcm9tIHRoZXJ1bmRvd24gZm9yICR7c3BvcnR9ICgke3Nwb3J0SWR9KWApXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgZGF5c0luQWR2YW5jZTsgaSsrKSB7XG4gICAgcGFyYW1zLmRhdGEuZGF0ZSA9IGFkZERheXMocGFyYW1zLmRhdGEuZGF0ZSwgMSlcbiAgICBMb2dnZXIuZGVidWcoYEF1Z3VyIHRoZVJ1bmRvd246IEZldGNoaW5nIGRhdGEgZm9yIGRhdGUgJHtwYXJhbXMuZGF0YS5kYXRlfWApXG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGVSdW5kb3duRXhlYyhwYXJhbXMsIGNvbnRleHQpXG4gICAgZXZlbnRzLnB1c2goLi4uKHJlc3BvbnNlLnJlc3VsdCBhcyBUaGVSdW5kb3duRXZlbnRbXSkpXG4gIH1cblxuICBMb2dnZXIuZGVidWcoYEF1Z3VyIHRoZVJ1bmRvd246IEdvdCAke2V2ZW50cy5sZW5ndGh9IGV2ZW50cyBmcm9tIGRhdGEgcHJvdmlkZXJgKVxuICBsZXQgc2tpcFRCRCA9IDAsXG4gICAgc2tpcFN0YXJ0QnVmZmVyID0gMCxcbiAgICBza2lwTm9UZWFtcyA9IDAsXG4gICAgY2FudENyZWF0ZSA9IDAsXG4gICAgc2tpcFRCRFRlYW1zID0gMFxuXG4gIC8vIGZpbHRlciBtYXJrZXRzIGFuZCBidWlsZCBwYXlsb2FkcyBmb3IgbWFya2V0IGNyZWF0aW9uXG4gIGNvbnN0IGV2ZW50c1RvQ3JlYXRlOiBDcmVhdGVUZWFtRXZlbnRbXSA9IFtdXG4gIGZvciAoY29uc3QgZXZlbnQgb2YgZXZlbnRzKSB7XG4gICAgaWYgKGV2ZW50LnNjb3JlLmV2ZW50X3N0YXR1c19kZXRhaWwudG9VcHBlckNhc2UoKSA9PT0gJ1RCRCcpIHtcbiAgICAgIHNraXBUQkQrK1xuICAgICAgY29udGludWVcbiAgICB9XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLnBhcnNlKGV2ZW50LmV2ZW50X2RhdGUpXG4gICAgaWYgKChzdGFydFRpbWUgLSBEYXRlLm5vdygpKSAvIDEwMDAgPCBzdGFydEJ1ZmZlcikge1xuICAgICAgLy8gbWFya2V0cyB3b3VsZCBlbmQgdG9vIHNvb25cbiAgICAgIHNraXBTdGFydEJ1ZmZlcisrXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIC8vIHNraXAgaWYgZGF0YSBpcyBtaXNzaW5nXG4gICAgY29uc3QgYWZmaWxpYXRlSWQgPSBnZXRBZmZpbGlhdGVJZChldmVudClcbiAgICBjb25zdCBob21lVGVhbSA9IGV2ZW50LnRlYW1zX25vcm1hbGl6ZWQuZmluZCgodGVhbSkgPT4gdGVhbS5pc19ob21lKVxuICAgIGNvbnN0IGF3YXlUZWFtID0gZXZlbnQudGVhbXNfbm9ybWFsaXplZC5maW5kKCh0ZWFtKSA9PiB0ZWFtLmlzX2F3YXkpXG4gICAgaWYgKCFob21lVGVhbSB8fCAhYXdheVRlYW0pIHtcbiAgICAgIHNraXBOb1RlYW1zKytcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgLy8gc2tpcCBpZiBhIHRlYW0gaGFzbid0IGJlZW4gYW5ub3VuY2VkIHlldFxuICAgIGlmIChob21lVGVhbS50ZWFtX2lkID09PSBUQkRfVEVBTV9JRCB8fCBhd2F5VGVhbS50ZWFtX2lkID09PSBUQkRfVEVBTV9JRCkge1xuICAgICAgc2tpcFRCRFRlYW1zKytcbiAgICAgIGNvbnRpbnVlXG4gICAgfVxuXG4gICAgY29uc3QgZXZlbnRJZCA9IGV2ZW50SWRUb051bShldmVudC5ldmVudF9pZClcbiAgICBjb25zdCBbaGVhZFRvSGVhZE1hcmtldCwgc3ByZWFkTWFya2V0LCB0b3RhbFNjb3JlTWFya2V0XTogW1xuICAgICAgZXRoZXJzLkJpZ051bWJlcixcbiAgICAgIGV0aGVycy5CaWdOdW1iZXIsXG4gICAgICBldGhlcnMuQmlnTnVtYmVyLFxuICAgIF0gPSBhd2FpdCBjb250cmFjdC5nZXRFdmVudE1hcmtldHMoZXZlbnRJZClcblxuICAgIC8vIE9ubHkgY3JlYXRlIGhlYWQtdG8taGVhZCBtYXJrZXQgaWYgbW9uZXlsaW5lcyBleGlzdC4gT25seSBjcmVhdGUgc3ByZWFkIGFuZCB0b3RhbC1zY29yZSBtYXJrZXRzIGlmIHRoZWlyIGxpbmVzIGV4aXN0LlxuICAgIGNvbnN0IG1vbmV5bGluZUhvbWUgPSB0cmFuc2Zvcm1TcGVjaWFsTm9uZShcbiAgICAgIGFmZmlsaWF0ZUlkICYmIGV2ZW50LmxpbmVzPy5bYWZmaWxpYXRlSWRdLm1vbmV5bGluZS5tb25leWxpbmVfaG9tZSxcbiAgICApXG4gICAgY29uc3QgbW9uZXlsaW5lQXdheSA9IHRyYW5zZm9ybVNwZWNpYWxOb25lKFxuICAgICAgYWZmaWxpYXRlSWQgJiYgZXZlbnQubGluZXM/LlthZmZpbGlhdGVJZF0ubW9uZXlsaW5lLm1vbmV5bGluZV9hd2F5LFxuICAgIClcbiAgICBjb25zdCBob21lU3ByZWFkID0gdHJhbnNmb3JtU3BlY2lhbE5vbmUoXG4gICAgICBhZmZpbGlhdGVJZCAmJiBldmVudC5saW5lcz8uW2FmZmlsaWF0ZUlkXS5zcHJlYWQucG9pbnRfc3ByZWFkX2hvbWUsXG4gICAgKVxuICAgIGNvbnN0IHRvdGFsU2NvcmUgPSB0cmFuc2Zvcm1TcGVjaWFsTm9uZShcbiAgICAgIGFmZmlsaWF0ZUlkICYmIGV2ZW50LmxpbmVzPy5bYWZmaWxpYXRlSWRdLnRvdGFsLnRvdGFsX292ZXIsXG4gICAgKVxuXG4gICAgY29uc3QgY3JlYXRlSGVhZFRvSGVhZCA9IGhlYWRUb0hlYWRNYXJrZXQuaXNaZXJvKCkgJiYgbW9uZXlsaW5lSG9tZSAmJiBtb25leWxpbmVBd2F5XG4gICAgY29uc3QgY3JlYXRlU3ByZWFkID0gc3BvcnQgIT09ICdNTEInICYmIHNwcmVhZE1hcmtldC5pc1plcm8oKSAmJiBob21lU3ByZWFkICE9PSB1bmRlZmluZWRcbiAgICBjb25zdCBjcmVhdGVUb3RhbFNjb3JlID1cbiAgICAgIHNwb3J0ICE9PSAnTUxCJyAmJiB0b3RhbFNjb3JlTWFya2V0LmlzWmVybygpICYmIHRvdGFsU2NvcmUgIT09IHVuZGVmaW5lZFxuICAgIGNvbnN0IGNhbkNyZWF0ZSA9IGNyZWF0ZUhlYWRUb0hlYWQgfHwgY3JlYXRlU3ByZWFkIHx8IGNyZWF0ZVRvdGFsU2NvcmVcbiAgICBpZiAoIWNhbkNyZWF0ZSkge1xuICAgICAgY2FudENyZWF0ZSsrXG4gICAgICBjb250aW51ZVxuICAgIH1cblxuICAgIGV2ZW50c1RvQ3JlYXRlLnB1c2goe1xuICAgICAgaWQ6IGV2ZW50SWQsXG4gICAgICBob21lVGVhbU5hbWU6ICdIb21lJyxcbiAgICAgIGhvbWVUZWFtSWQ6IGhvbWVUZWFtLnRlYW1faWQsXG4gICAgICBhd2F5VGVhbU5hbWU6ICdBd2F5JyxcbiAgICAgIGF3YXlUZWFtSWQ6IGF3YXlUZWFtLnRlYW1faWQsXG4gICAgICBzdGFydFRpbWUsXG4gICAgICBob21lU3ByZWFkOiBob21lU3ByZWFkIHx8IDAsXG4gICAgICB0b3RhbFNjb3JlOiB0b3RhbFNjb3JlIHx8IDAsXG4gICAgICBjcmVhdGVTcHJlYWQsXG4gICAgICBjcmVhdGVUb3RhbFNjb3JlLFxuICAgICAgbW9uZXlsaW5lczogW21vbmV5bGluZUhvbWUgfHwgMCwgbW9uZXlsaW5lQXdheSB8fCAwXSxcbiAgICB9KVxuICB9XG5cbiAgTG9nZ2VyLmRlYnVnKGBBdWd1ciB0aGVSdW5kb3duOiBTa2lwcGluZyAke3NraXBUQkR9IGR1ZSB0byBUQkQgc3RhdHVzYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1ciB0aGVSdW5kb3duOiBTa2lwcGluZyAke3NraXBTdGFydEJ1ZmZlcn0gZHVlIHRvIHN0YXJ0QnVmZmVyYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1ciB0aGVSdW5kb3duOiBTa2lwcGluZyAke3NraXBOb1RlYW1zfSBkdWUgdG8gbm8gdGVhbXNgKVxuICBMb2dnZXIuZGVidWcoYEF1Z3VyIHRoZVJ1bmRvd246IFNraXBwaW5nICR7c2tpcFRCRFRlYW1zfSBkdWUgdG8gVEJEIHRlYW1zYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1ciB0aGVSdW5kb3duOiBTa2lwcGluZyAke2NhbnRDcmVhdGV9IGR1ZSB0byBubyBtYXJrZXQgdG8gY3JlYXRlYClcblxuICByZXR1cm4gUmVxdWVzdGVyLnN1Y2Nlc3MoaW5wdXQuaWQsIHtcbiAgICBkYXRhOiB7IHJlc3VsdDogZXZlbnRzVG9DcmVhdGUgfSxcbiAgfSlcbn1cblxuLyoqXG4gKiBUaGVSdW5kb3duIEFQSSByZXR1cm5zIGAwLjAwMDFgIGFzIGEgc3BlY2lhbCBjYXNlIHdoaWNoIHNob3VsZFxuICogYmUgdHJlYXRlZCBhcyB0aGUgdmFsdWUgaXMgYHVuZGVmaW5lZGAuIFRoaXMgZnVuY3Rpb24gdHJhbnNmb3Jtc1xuICogYDAuMDAwMWAgdG8gYHVuZGVmaW5lZGAsIGFuZCBsZWF2ZXMgYHZhbGAgdW5jaGFuZ2VkIG90aGVyd2lzZS5cbiAqIEBwYXJhbSB7bnVtYmVyfSB2YWwgLSBUaGUgdmFsdWUgcmV0dXJuZWQgZnJvbSB0aGUgQVBJXG4gKiBAcmV0dXJuIHtudW1iZXJ8dW5kZWZpbmVkfSBUcmFuc2Zvcm1lZCBgdmFsYFxuICovXG5jb25zdCB0cmFuc2Zvcm1TcGVjaWFsTm9uZSA9ICh2YWw/OiBudW1iZXIpID0+ICh2YWwgPT09IDAuMDAwMSA/IHVuZGVmaW5lZCA6IHZhbClcblxuY29uc3QgZXZlbnRTdGF0dXM6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0gPSB7XG4gIFNUQVRVU19TQ0hFRFVMRUQ6IDEsXG4gIFNUQVRVU19GSU5BTDogMixcbiAgU1RBVFVTX1BPU1RQT05FRDogMyxcbiAgU1RBVFVTX0NBTkNFTEVEOiA0LFxuICBTVEFUVVNfU1VTUEVOREVEOiA0LCAvLyB0cmVhdGluZyBhcyBjYW5jZWxlZFxufVxuXG5jb25zdCByZXNvbHZlUGFyYW1zID0ge1xuICBzcG9ydDogdHJ1ZSxcbiAgZXZlbnRJZDogdHJ1ZSxcbn1cblxuZXhwb3J0IGNvbnN0IG51bVRvRXZlbnRJZCA9IChudW06IEJpZ051bWJlcik6IHN0cmluZyA9PiBudW0udG9IZXhTdHJpbmcoKS5zbGljZSgyKVxuXG5leHBvcnQgY29uc3QgcmVzb2x2ZTogRXhlY3V0ZSA9IGFzeW5jIChpbnB1dCwgY29udGV4dCkgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCByZXNvbHZlUGFyYW1zKVxuICBpZiAodmFsaWRhdG9yLmVycm9yKSB0aHJvdyB2YWxpZGF0b3IuZXJyb3JcblxuICBjb25zdCB0aGVSdW5kb3duRXhlYyA9IFRoZVJ1bmRvd24ubWFrZUV4ZWN1dGUoe1xuICAgIC4uLlRoZVJ1bmRvd24ubWFrZUNvbmZpZyhUaGVSdW5kb3duLk5BTUUpLFxuXG4gICAgLy8gTmVlZCBBTEwgdGhlIHJlc3BvbnNlIGRhdGEuXG4gICAgdmVyYm9zZTogdHJ1ZSxcbiAgfSlcblxuICBjb25zdCBzcG9ydCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5zcG9ydFxuICBjb25zdCBzcG9ydElkID0gc3BvcnRJZE1hcHBpbmdbc3BvcnQudG9VcHBlckNhc2UoKV1cbiAgY29uc3QgZXZlbnRJZCA9IG51bVRvRXZlbnRJZCh2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuZXZlbnRJZClcblxuICBjb25zdCByZXEgPSB7XG4gICAgaWQ6IGlucHV0LmlkLFxuICAgIGRhdGE6IHtcbiAgICAgIGVuZHBvaW50OiAnZXZlbnQnLFxuICAgICAgc3BvcnRJZCxcbiAgICAgIGV2ZW50SWQsXG4gICAgfSxcbiAgfVxuXG4gIGNvbnN0IHJlc3BvbnNlID0gKGF3YWl0IHRoZVJ1bmRvd25FeGVjKHJlcSwgY29udGV4dCkpLmRhdGEgYXMgVGhlUnVuZG93bkV2ZW50XG5cbiAgY29uc3QgZXZlbnQ6IFJlc29sdmVUZWFtID0ge1xuICAgIGlkOiBldmVudElkVG9OdW0ocmVzcG9uc2UuZXZlbnRfaWQpLFxuICAgIHN0YXR1czogZXZlbnRTdGF0dXNbcmVzcG9uc2Uuc2NvcmUuZXZlbnRfc3RhdHVzXSxcbiAgICBob21lU2NvcmU6IHJlc3BvbnNlLnNjb3JlLnNjb3JlX2hvbWUsXG4gICAgYXdheVNjb3JlOiByZXNwb25zZS5zY29yZS5zY29yZV9hd2F5LFxuICB9XG5cbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGlucHV0LmlkLCB7XG4gICAgZGF0YTogeyByZXN1bHQ6IGV2ZW50IH0sXG4gIH0pXG59XG4iXX0=