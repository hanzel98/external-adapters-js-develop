"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const index_1 = require("./index");
const ethers_1 = require("ethers");
const dataProviders_1 = require("../dataProviders");
const mma_json_1 = tslib_1.__importDefault(require("../abis/mma.json"));
const createParams = {
    sport: true,
    contractAddress: true,
};
const execute = async (input, context, config) => {
    const validator = new ea_bootstrap_1.Validator(input, createParams);
    if (validator.error)
        throw validator.error;
    const sport = validator.validated.data.sport.toLowerCase();
    const contractAddress = validator.validated.data.contractAddress;
    ea_bootstrap_1.Logger.debug(`Augur: Picking code path for sport ${sport}`);
    if (index_1.TEAM_SPORTS.includes(sport)) {
        ea_bootstrap_1.Logger.debug(`Augur: Picked TEAM code path for sport`);
        return await createTeam(input.id, sport, contractAddress, input, context, config);
    }
    else if (index_1.FIGHTER_SPORTS.includes(sport)) {
        ea_bootstrap_1.Logger.debug(`Augur: Picked FIGHTER code path for sport`);
        return await createFighter(input.id, sport, contractAddress, input, context, config);
    }
    else {
        throw Error(`Unable to identify sport "${sport}"`);
    }
};
exports.execute = execute;
const createTeam = async (jobRunID, sport, contractAddress, input, context, config) => {
    const contract = new ethers_1.ethers.Contract(contractAddress, sport === 'nfl' ? index_1.NFL_ABI : index_1.TEAM_ABI, config.wallet);
    const req = {
        id: jobRunID,
        data: {
            ...input.data,
            contract,
            sport,
        },
    };
    let events = [];
    ea_bootstrap_1.Logger.debug(`Augur: Choosing data source for sport ${sport}`);
    if (dataProviders_1.theRundown.SPORTS_SUPPORTED.includes(sport)) {
        ea_bootstrap_1.Logger.debug(`Augur: Chose TheRundown as the data source`);
        events = (await dataProviders_1.theRundown.create(req, context)).result;
    }
    else if (dataProviders_1.sportsdataio.SPORTS_SUPPORTED.includes(sport)) {
        ea_bootstrap_1.Logger.debug(`Augur: Chose SportsDataIO as the data source`);
        events = (await dataProviders_1.sportsdataio.createTeam(req, context)).result;
    }
    else {
        throw Error(`Unknown data provider for sport ${sport}`);
    }
    ea_bootstrap_1.Logger.debug(`Augur: Prepared to create ${events.length} events`);
    let failed = 0;
    let succeeded = 0;
    let nonce = await config.wallet.getTransactionCount();
    for (let i = 0; i < events.length; i++) {
        const event = events[i];
        const payload = sport === 'nfl'
            ? [
                event.id,
                event.homeTeamName,
                event.homeTeamId,
                event.awayTeamName,
                event.awayTeamId,
                Math.floor(event.startTime / 1000),
                Math.round(event.homeSpread * 10),
                Math.round(event.totalScore * 10),
                event.createSpread,
                event.createTotalScore,
                event.moneylines,
                { nonce },
            ]
            : [
                event.id,
                event.homeTeamId,
                event.awayTeamId,
                Math.floor(event.startTime / 1000),
                Math.round(event.homeSpread * 10),
                Math.round(event.totalScore * 10),
                event.createSpread,
                event.createTotalScore,
                event.moneylines,
                { nonce },
            ];
        try {
            const tx = await contract.createMarket(...payload);
            ea_bootstrap_1.Logger.debug(`Created tx: ${tx.hash}`);
            nonce++;
            succeeded++;
        }
        catch (e) {
            failed++;
            ea_bootstrap_1.Logger.error(e);
        }
    }
    ea_bootstrap_1.Logger.debug(`Augur: ${succeeded} created markets`);
    ea_bootstrap_1.Logger.debug(`Augur: ${failed} markets failed to create`);
    return ea_bootstrap_1.Requester.success(jobRunID, {});
};
const createFighter = async (jobRunID, sport, contractAddress, input, context, config) => {
    const contract = new ethers_1.ethers.Contract(contractAddress, mma_json_1.default, config.wallet);
    const req = {
        id: jobRunID,
        data: {
            ...input.data,
            contract,
            sport,
        },
    };
    ea_bootstrap_1.Logger.debug('Creating fighter with req:', req);
    let events = [];
    if (dataProviders_1.theRundown.SPORTS_SUPPORTED.includes(sport)) {
        // Note: currently no fighter sports implemented here
        events = (await dataProviders_1.theRundown.create(req, context)).result;
    }
    else if (dataProviders_1.sportsdataio.SPORTS_SUPPORTED.includes(sport)) {
        events = (await dataProviders_1.sportsdataio.createFighter(req, context)).result;
    }
    else {
        throw Error(`Unknown data provider for sport ${sport}`);
    }
    ea_bootstrap_1.Logger.debug(`Augur: Prepared to create ${events.length} events`);
    let failed = 0;
    let succeeded = 0;
    let nonce = await config.wallet.getTransactionCount();
    for (let i = 0; i < events.length; i++) {
        const event = events[i];
        const payload = [
            event.id,
            event.fighterAname,
            event.fighterA,
            event.fighterBname,
            event.fighterB,
            Math.floor(event.startTime / 1000),
            event.moneylines,
            { nonce },
        ];
        try {
            const tx = await contract.createMarket(...payload);
            ea_bootstrap_1.Logger.debug(`Created tx: ${tx.hash}`);
            nonce++;
            succeeded++;
        }
        catch (e) {
            failed++;
            ea_bootstrap_1.Logger.error(e);
        }
    }
    ea_bootstrap_1.Logger.debug(`Augur: ${succeeded} created markets`);
    ea_bootstrap_1.Logger.debug(`Augur: ${failed} markets failed to create`);
    return ea_bootstrap_1.Requester.success(jobRunID, {});
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlTWFya2V0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tZXRob2RzL2NyZWF0ZU1hcmtldHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDBEQUFzRTtBQUd0RSxtQ0FBd0U7QUFDeEUsbUNBQStCO0FBQy9CLG9EQUEyRDtBQUMzRCx3RUFBcUM7QUFFckMsTUFBTSxZQUFZLEdBQUc7SUFDbkIsS0FBSyxFQUFFLElBQUk7SUFDWCxlQUFlLEVBQUUsSUFBSTtDQUN0QixDQUFBO0FBMEJNLE1BQU0sT0FBTyxHQUE4QixLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtJQUNqRixNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFBO0lBQ3BELElBQUksU0FBUyxDQUFDLEtBQUs7UUFBRSxNQUFNLFNBQVMsQ0FBQyxLQUFLLENBQUE7SUFFMUMsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzFELE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQTtJQUVoRSxxQkFBTSxDQUFDLEtBQUssQ0FBQyxzQ0FBc0MsS0FBSyxFQUFFLENBQUMsQ0FBQTtJQUMzRCxJQUFJLG1CQUFXLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQy9CLHFCQUFNLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxDQUFDLENBQUE7UUFDdEQsT0FBTyxNQUFNLFVBQVUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQTtLQUNsRjtTQUFNLElBQUksc0JBQWMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDekMscUJBQU0s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ciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgRXhlY3V0ZVdpdGhDb25maWcsIEFkYXB0ZXJSZXF1ZXN0LCBBZGFwdGVyQ29udGV4dCB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuLi9jb25maWcnXG5pbXBvcnQgeyBGSUdIVEVSX1NQT1JUUywgTkZMX0FCSSwgVEVBTV9BQkksIFRFQU1fU1BPUlRTIH0gZnJvbSAnLi9pbmRleCdcbmltcG9ydCB7IGV0aGVycyB9IGZyb20gJ2V0aGVycydcbmltcG9ydCB7IHRoZVJ1bmRvd24sIHNwb3J0c2RhdGFpbyB9IGZyb20gJy4uL2RhdGFQcm92aWRlcnMnXG5pbXBvcnQgbW1hQUJJIGZyb20gJy4uL2FiaXMvbW1hLmpzb24nXG5cbmNvbnN0IGNyZWF0ZVBhcmFtcyA9IHtcbiAgc3BvcnQ6IHRydWUsXG4gIGNvbnRyYWN0QWRkcmVzczogdHJ1ZSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVUZWFtRXZlbnQge1xuICBpZDogZXRoZXJzLkJpZ051bWJlclxuICBob21lVGVhbU5hbWU6IHN0cmluZ1xuICBob21lVGVhbUlkOiBudW1iZXJcbiAgYXdheVRlYW1OYW1lOiBzdHJpbmdcbiAgYXdheVRlYW1JZDogbnVtYmVyXG4gIHN0YXJ0VGltZTogbnVtYmVyXG4gIGhvbWVTcHJlYWQ6IG51bWJlclxuICB0b3RhbFNjb3JlOiBudW1iZXJcbiAgY3JlYXRlU3ByZWFkOiBib29sZWFuXG4gIGNyZWF0ZVRvdGFsU2NvcmU6IGJvb2xlYW5cbiAgbW9uZXlsaW5lczogbnVtYmVyW11cbn1cblxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVGaWdodGVyRXZlbnQge1xuICBpZDogZXRoZXJzLkJpZ051bWJlclxuICBmaWdodGVyQTogbnVtYmVyXG4gIGZpZ2h0ZXJBbmFtZTogc3RyaW5nXG4gIGZpZ2h0ZXJCOiBudW1iZXJcbiAgZmlnaHRlckJuYW1lOiBzdHJpbmdcbiAgc3RhcnRUaW1lOiBudW1iZXJcbiAgbW9uZXlsaW5lczogbnVtYmVyW11cbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAoaW5wdXQsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCBjcmVhdGVQYXJhbXMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IHNwb3J0ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnNwb3J0LnRvTG93ZXJDYXNlKClcbiAgY29uc3QgY29udHJhY3RBZGRyZXNzID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNvbnRyYWN0QWRkcmVzc1xuXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6IFBpY2tpbmcgY29kZSBwYXRoIGZvciBzcG9ydCAke3Nwb3J0fWApXG4gIGlmIChURUFNX1NQT1JUUy5pbmNsdWRlcyhzcG9ydCkpIHtcbiAgICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBQaWNrZWQgVEVBTSBjb2RlIHBhdGggZm9yIHNwb3J0YClcbiAgICByZXR1cm4gYXdhaXQgY3JlYXRlVGVhbShpbnB1dC5pZCwgc3BvcnQsIGNvbnRyYWN0QWRkcmVzcywgaW5wdXQsIGNvbnRleHQsIGNvbmZpZylcbiAgfSBlbHNlIGlmIChGSUdIVEVSX1NQT1JUUy5pbmNsdWRlcyhzcG9ydCkpIHtcbiAgICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBQaWNrZWQgRklHSFRFUiBjb2RlIHBhdGggZm9yIHNwb3J0YClcbiAgICByZXR1cm4gYXdhaXQgY3JlYXRlRmlnaHRlcihpbnB1dC5pZCwgc3BvcnQsIGNvbnRyYWN0QWRkcmVzcywgaW5wdXQsIGNvbnRleHQsIGNvbmZpZylcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBFcnJvcihgVW5hYmxlIHRvIGlkZW50aWZ5IHNwb3J0IFwiJHtzcG9ydH1cImApXG4gIH1cbn1cblxuY29uc3QgY3JlYXRlVGVhbSA9IGFzeW5jIChcbiAgam9iUnVuSUQ6IHN0cmluZyxcbiAgc3BvcnQ6IHN0cmluZyxcbiAgY29udHJhY3RBZGRyZXNzOiBzdHJpbmcsXG4gIGlucHV0OiBBZGFwdGVyUmVxdWVzdCxcbiAgY29udGV4dDogQWRhcHRlckNvbnRleHQsXG4gIGNvbmZpZzogQ29uZmlnLFxuKSA9PiB7XG4gIGNvbnN0IGNvbnRyYWN0ID0gbmV3IGV0aGVycy5Db250cmFjdChcbiAgICBjb250cmFjdEFkZHJlc3MsXG4gICAgc3BvcnQgPT09ICduZmwnID8gTkZMX0FCSSA6IFRFQU1fQUJJLFxuICAgIGNvbmZpZy53YWxsZXQsXG4gIClcbiAgY29uc3QgcmVxID0ge1xuICAgIGlkOiBqb2JSdW5JRCxcbiAgICBkYXRhOiB7XG4gICAgICAuLi5pbnB1dC5kYXRhLFxuICAgICAgY29udHJhY3QsXG4gICAgICBzcG9ydCxcbiAgICB9LFxuICB9XG5cbiAgbGV0IGV2ZW50czogQ3JlYXRlVGVhbUV2ZW50W10gPSBbXVxuICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBDaG9vc2luZyBkYXRhIHNvdXJjZSBmb3Igc3BvcnQgJHtzcG9ydH1gKVxuICBpZiAodGhlUnVuZG93bi5TUE9SVFNfU1VQUE9SVEVELmluY2x1ZGVzKHNwb3J0KSkge1xuICAgIExvZ2dlci5kZWJ1ZyhgQXVndXI6IENob3NlIFRoZVJ1bmRvd24gYXMgdGhlIGRhdGEgc291cmNlYClcbiAgICBldmVudHMgPSAoYXdhaXQgdGhlUnVuZG93bi5jcmVhdGUocmVxLCBjb250ZXh0KSkucmVzdWx0XG4gIH0gZWxzZSBpZiAoc3BvcnRzZGF0YWlvLlNQT1JUU19TVVBQT1JURUQuaW5jbHVkZXMoc3BvcnQpKSB7XG4gICAgTG9nZ2VyLmRlYnVnKGBBdWd1cjogQ2hvc2UgU3BvcnRzRGF0YUlPIGFzIHRoZSBkYXRhIHNvdXJjZWApXG4gICAgZXZlbnRzID0gKGF3YWl0IHNwb3J0c2RhdGFpby5jcmVhdGVUZWFtKHJlcSwgY29udGV4dCkpLnJlc3VsdFxuICB9IGVsc2Uge1xuICAgIHRocm93IEVycm9yKGBVbmtub3duIGRhdGEgcHJvdmlkZXIgZm9yIHNwb3J0ICR7c3BvcnR9YClcbiAgfVxuXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6IFByZXBhcmVkIHRvIGNyZWF0ZSAke2V2ZW50cy5sZW5ndGh9IGV2ZW50c2ApXG5cbiAgbGV0IGZhaWxlZCA9IDBcbiAgbGV0IHN1Y2NlZWRlZCA9IDBcblxuICBsZXQgbm9uY2UgPSBhd2FpdCBjb25maWcud2FsbGV0LmdldFRyYW5zYWN0aW9uQ291bnQoKVxuICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGV2ZW50ID0gZXZlbnRzW2ldXG4gICAgY29uc3QgcGF5bG9hZCA9XG4gICAgICBzcG9ydCA9PT0gJ25mbCdcbiAgICAgICAgPyBbXG4gICAgICAgICAgICBldmVudC5pZCxcbiAgICAgICAgICAgIGV2ZW50LmhvbWVUZWFtTmFtZSxcbiAgICAgICAgICAgIGV2ZW50LmhvbWVUZWFtSWQsXG4gICAgICAgICAgICBldmVudC5hd2F5VGVhbU5hbWUsXG4gICAgICAgICAgICBldmVudC5hd2F5VGVhbUlkLFxuICAgICAgICAgICAgTWF0aC5mbG9vcihldmVudC5zdGFydFRpbWUgLyAxMDAwKSxcbiAgICAgICAgICAgIE1hdGgucm91bmQoZXZlbnQuaG9tZVNwcmVhZCAqIDEwKSxcbiAgICAgICAgICAgIE1hdGgucm91bmQoZXZlbnQudG90YWxTY29yZSAqIDEwKSxcbiAgICAgICAgICAgIGV2ZW50LmNyZWF0ZVNwcmVhZCxcbiAgICAgICAgICAgIGV2ZW50LmNyZWF0ZVRvdGFsU2NvcmUsXG4gICAgICAgICAgICBldmVudC5tb25leWxpbmVzLFxuICAgICAgICAgICAgeyBub25jZSB9LFxuICAgICAgICAgIF1cbiAgICAgICAgOiBbXG4gICAgICAgICAgICBldmVudC5pZCxcbiAgICAgICAgICAgIGV2ZW50LmhvbWVUZWFtSWQsXG4gICAgICAgICAgICBldmVudC5hd2F5VGVhbUlkLFxuICAgICAgICAgICAgTWF0aC5mbG9vcihldmVudC5zdGFydFRpbWUgLyAxMDAwKSxcbiAgICAgICAgICAgIE1hdGgucm91bmQoZXZlbnQuaG9tZVNwcmVhZCAqIDEwKSxcbiAgICAgICAgICAgIE1hdGgucm91bmQoZXZlbnQudG90YWxTY29yZSAqIDEwKSxcbiAgICAgICAgICAgIGV2ZW50LmNyZWF0ZVNwcmVhZCxcbiAgICAgICAgICAgIGV2ZW50LmNyZWF0ZVRvdGFsU2NvcmUsXG4gICAgICAgICAgICBldmVudC5tb25leWxpbmVzLFxuICAgICAgICAgICAgeyBub25jZSB9LFxuICAgICAgICAgIF1cbiAgICB0cnkge1xuICAgICAgY29uc3QgdHggPSBhd2FpdCBjb250cmFjdC5jcmVhdGVNYXJrZXQoLi4ucGF5bG9hZClcbiAgICAgIExvZ2dlci5kZWJ1ZyhgQ3JlYXRlZCB0eDogJHt0eC5oYXNofWApXG4gICAgICBub25jZSsrXG4gICAgICBzdWNjZWVkZWQrK1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGZhaWxlZCsrXG4gICAgICBMb2dnZXIuZXJyb3IoZSlcbiAgICB9XG4gIH1cblxuICBMb2dnZXIuZGVidWcoYEF1Z3VyOiAke3N1Y2NlZWRlZH0gY3JlYXRlZCBtYXJrZXRzYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1cjogJHtmYWlsZWR9IG1hcmtldHMgZmFpbGVkIHRvIGNyZWF0ZWApXG5cbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCB7fSlcbn1cblxuY29uc3QgY3JlYXRlRmlnaHRlciA9IGFzeW5jIChcbiAgam9iUnVuSUQ6IHN0cmluZyxcbiAgc3BvcnQ6IHN0cmluZyxcbiAgY29udHJhY3RBZGRyZXNzOiBzdHJpbmcsXG4gIGlucHV0OiBBZGFwdGVyUmVxdWVzdCxcbiAgY29udGV4dDogQWRhcHRlckNvbnRleHQsXG4gIGNvbmZpZzogQ29uZmlnLFxuKSA9PiB7XG4gIGNvbnN0IGNvbnRyYWN0ID0gbmV3IGV0aGVycy5Db250cmFjdChjb250cmFjdEFkZHJlc3MsIG1tYUFCSSwgY29uZmlnLndhbGxldClcblxuICBjb25zdCByZXEgPSB7XG4gICAgaWQ6IGpvYlJ1bklELFxuICAgIGRhdGE6IHtcbiAgICAgIC4uLmlucHV0LmRhdGEsXG4gICAgICBjb250cmFjdCxcbiAgICAgIHNwb3J0LFxuICAgIH0sXG4gIH1cblxuICBMb2dnZXIuZGVidWcoJ0NyZWF0aW5nIGZpZ2h0ZXIgd2l0aCByZXE6JywgcmVxKVxuICBsZXQgZXZlbnRzOiBDcmVhdGVGaWdodGVyRXZlbnRbXSA9IFtdXG4gIGlmICh0aGVSdW5kb3duLlNQT1JUU19TVVBQT1JURUQuaW5jbHVkZXMoc3BvcnQpKSB7XG4gICAgLy8gTm90ZTogY3VycmVudGx5IG5vIGZpZ2h0ZXIgc3BvcnRzIGltcGxlbWVudGVkIGhlcmVcbiAgICBldmVudHMgPSAoYXdhaXQgdGhlUnVuZG93bi5jcmVhdGUocmVxLCBjb250ZXh0KSkucmVzdWx0XG4gIH0gZWxzZSBpZiAoc3BvcnRzZGF0YWlvLlNQT1JUU19TVVBQT1JURUQuaW5jbHVkZXMoc3BvcnQpKSB7XG4gICAgZXZlbnRzID0gKGF3YWl0IHNwb3J0c2RhdGFpby5jcmVhdGVGaWdodGVyKHJlcSwgY29udGV4dCkpLnJlc3VsdFxuICB9IGVsc2Uge1xuICAgIHRocm93IEVycm9yKGBVbmtub3duIGRhdGEgcHJvdmlkZXIgZm9yIHNwb3J0ICR7c3BvcnR9YClcbiAgfVxuXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6IFByZXBhcmVkIHRvIGNyZWF0ZSAke2V2ZW50cy5sZW5ndGh9IGV2ZW50c2ApXG5cbiAgbGV0IGZhaWxlZCA9IDBcbiAgbGV0IHN1Y2NlZWRlZCA9IDBcblxuICBsZXQgbm9uY2UgPSBhd2FpdCBjb25maWcud2FsbGV0LmdldFRyYW5zYWN0aW9uQ291bnQoKVxuICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50cy5sZW5ndGg7IGkrKykge1xuICAgIGNvbnN0IGV2ZW50ID0gZXZlbnRzW2ldXG4gICAgY29uc3QgcGF5bG9hZCA9IFtcbiAgICAgIGV2ZW50LmlkLFxuICAgICAgZXZlbnQuZmlnaHRlckFuYW1lLFxuICAgICAgZXZlbnQuZmlnaHRlckEsXG4gICAgICBldmVudC5maWdodGVyQm5hbWUsXG4gICAgICBldmVudC5maWdodGVyQixcbiAgICAgIE1hdGguZmxvb3IoZXZlbnQuc3RhcnRUaW1lIC8gMTAwMCksXG4gICAgICBldmVudC5tb25leWxpbmVzLFxuICAgICAgeyBub25jZSB9LFxuICAgIF1cbiAgICB0cnkge1xuICAgICAgY29uc3QgdHggPSBhd2FpdCBjb250cmFjdC5jcmVhdGVNYXJrZXQoLi4ucGF5bG9hZClcbiAgICAgIExvZ2dlci5kZWJ1ZyhgQ3JlYXRlZCB0eDogJHt0eC5oYXNofWApXG4gICAgICBub25jZSsrXG4gICAgICBzdWNjZWVkZWQrK1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGZhaWxlZCsrXG4gICAgICBMb2dnZXIuZXJyb3IoZSlcbiAgICB9XG4gIH1cblxuICBMb2dnZXIuZGVidWcoYEF1Z3VyOiAke3N1Y2NlZWRlZH0gY3JlYXRlZCBtYXJrZXRzYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1cjogJHtmYWlsZWR9IG1hcmtldHMgZmFpbGVkIHRvIGNyZWF0ZWApXG5cbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCB7fSlcbn1cbiJdfQ==