"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const index_1 = require("./index");
const ethers_1 = require("ethers");
const dataProviders_1 = require("../dataProviders");
const mma_json_1 = tslib_1.__importDefault(require("../abis/mma.json"));
const resolveParams = {
    contractAddress: true,
    sport: true,
};
const statusCompleted = [
    4,
    2,
    3, // Postponed
];
const execute = async (input, context, config) => {
    const validator = new ea_bootstrap_1.Validator(input, resolveParams);
    if (validator.error)
        throw validator.error;
    const sport = validator.validated.data.sport.toLowerCase();
    const contractAddress = validator.validated.data.contractAddress;
    if (index_1.TEAM_SPORTS.includes(sport)) {
        return await resolveTeam(input.id, sport, contractAddress, context, config);
    }
    else if (index_1.FIGHTER_SPORTS.includes(sport)) {
        return await resolveFights(input.id, sport, contractAddress, context, config);
    }
    else {
        throw Error(`Unable to identify sport "${sport}"`);
    }
};
exports.execute = execute;
const resolveTeam = async (jobRunID, sport, contractAddress, context, config) => {
    // The difference isn't meaningful here using the proper abis anyway.
    const contract = new ethers_1.ethers.Contract(contractAddress, sport === 'nfl' ? index_1.NFL_ABI : index_1.TEAM_ABI, config.wallet);
    let getEvent;
    if (dataProviders_1.theRundown.SPORTS_SUPPORTED.includes(sport)) {
        getEvent = dataProviders_1.theRundown.resolve;
    }
    else if (dataProviders_1.sportsdataio.SPORTS_SUPPORTED.includes(sport)) {
        getEvent = dataProviders_1.sportsdataio.resolveTeam;
    }
    else {
        throw Error(`Unknown data provider for sport ${sport}`);
    }
    const eventIDs = await contract.listResolvableEvents();
    const events = [];
    for (const eventId of eventIDs) {
        try {
            const response = await getEvent({
                id: jobRunID,
                data: {
                    sport,
                    eventId,
                },
            }, context);
            events.push(response.result);
        }
        catch (e) {
            ea_bootstrap_1.Logger.error(e);
        }
    }
    ea_bootstrap_1.Logger.debug(`Augur: Found ${events.length} events to attempt to resolve`);
    // Filters out events that aren't yet ready to resolve.
    const eventReadyToResolve = events.filter(({ id, status }) => {
        ea_bootstrap_1.Logger.debug(`Augur: status info`, {
            id: id.toHexString().slice(2),
            status,
            needs_resolve: statusCompleted.includes(status),
        });
        return statusCompleted.includes(status);
    });
    ea_bootstrap_1.Logger.debug(`Augur: Prepared to resolve ${eventReadyToResolve.length} events`);
    let failed = 0;
    let succeeded = 0;
    let nonce = await config.wallet.getTransactionCount();
    for (let i = 0; i < eventReadyToResolve.length; i++) {
        ea_bootstrap_1.Logger.info(`Augur: resolving event "${eventReadyToResolve[i].id}"`);
        try {
            const tx = await contract.trustedResolveMarkets(eventReadyToResolve[i].id, eventReadyToResolve[i].status, eventReadyToResolve[i].homeScore, eventReadyToResolve[i].awayScore, { nonce });
            ea_bootstrap_1.Logger.info(`Augur: Created tx: ${tx.hash}`);
            nonce++;
            succeeded++;
        }
        catch (e) {
            failed++;
            ea_bootstrap_1.Logger.error(e);
        }
    }
    ea_bootstrap_1.Logger.debug(`Augur: ${succeeded} resolved markets`);
    ea_bootstrap_1.Logger.debug(`Augur: ${failed} markets failed to resolve`);
    return ea_bootstrap_1.Requester.success(jobRunID, {});
};
const fightStatusMapping = {
    unknown: 0,
    home: 1,
    away: 2,
    draw: 3,
};
const resolveFights = async (jobRunID, sport, contractAddress, context, config) => {
    const contract = new ethers_1.ethers.Contract(contractAddress, mma_json_1.default, config.wallet);
    let getEvent;
    if (dataProviders_1.theRundown.SPORTS_SUPPORTED.includes(sport)) {
        getEvent = dataProviders_1.theRundown.resolve;
    }
    else if (dataProviders_1.sportsdataio.SPORTS_SUPPORTED.includes(sport)) {
        getEvent = dataProviders_1.sportsdataio.resolveFight;
    }
    else {
        throw Error(`Unknown data provider for sport ${sport}`);
    }
    ea_bootstrap_1.Logger.debug('Augur: Getting list of potentially resolvable events');
    const eventIDs = await contract.listResolvableEvents();
    ea_bootstrap_1.Logger.debug(`Augur: Found ${eventIDs.length} potentially resolvable events`);
    const events = [];
    for (const eventId of eventIDs) {
        try {
            const response = await getEvent({
                id: jobRunID,
                data: {
                    sport,
                    eventId,
                },
            }, context);
            events.push(response.result);
        }
        catch (e) {
            ea_bootstrap_1.Logger.error(e);
        }
    }
    // Filters out events that aren't yet ready to resolve.
    const eventReadyToResolve = events.filter(({ status }) => statusCompleted.includes(status));
    let failed = 0;
    let succeeded = 0;
    let nonce = await config.wallet.getTransactionCount();
    for (const fight of eventReadyToResolve) {
        ea_bootstrap_1.Logger.info(`Augur: resolving event "${fight.id.toString()}"`);
        let fightStatus = 0;
        if (fight.draw) {
            fightStatus = fightStatusMapping.draw;
        }
        else if (fight.winnerId === fight.fighterA) {
            fightStatus = fightStatusMapping.home;
        }
        else if (fight.winnerId === fight.fighterB) {
            fightStatus = fightStatusMapping.away;
        }
        const payload = [fight.id, fight.status, fight.fighterA, fight.fighterB, fightStatus, { nonce }];
        // This call resolves markets.
        try {
            ea_bootstrap_1.Logger.debug(`Augur: Resolving market with these arguments: ${JSON.stringify(payload)}`);
            const tx = await contract.trustedResolveMarkets(...payload);
            ea_bootstrap_1.Logger.info(`Augur: Created tx: ${tx.hash}`);
            nonce++;
            succeeded++;
        }
        catch (e) {
            failed++;
            ea_bootstrap_1.Logger.error(e);
        }
    }
    ea_bootstrap_1.Logger.debug(`Augur: ${succeeded} resolved markets`);
    ea_bootstrap_1.Logger.debug(`Augur: ${failed} markets failed to resolve`);
    return ea_bootstrap_1.Requester.success(jobRunID, {});
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb2x2ZU1hcmtldHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWV0aG9kcy9yZXNvbHZlTWFya2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQXNFO0FBR3RFLG1DQUF3RTtBQUN4RSxtQ0FBK0I7QUFDL0Isb0RBQTJEO0FBQzNELHdFQUFxQztBQUVyQyxNQUFNLGFBQWEsR0FBRztJQUNwQixlQUFlLEVBQUUsSUFBSTtJQUNyQixLQUFLLEVBQUUsSUFBSTtDQUNaLENBQUE7QUFrQkQsTUFBTSxlQUFlLEdBQUc7SUFDdEIsQ0FBQztJQUNELENBQUM7SUFDRCxDQUFDLEVBQUUsWUFBWTtDQUNoQixDQUFBO0FBRU0sTUFBTSxPQUFPLEdBQThCLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQ2pGLE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVMsQ0FBQyxLQUFLLEVBQUUsYUFBYSxDQUFDLENBQUE7SUFDckQsSUFBSSxTQUFTLENBQUMsS0FBSztRQUFFLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQTtJQUUxQyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDMUQsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFBO0lBRWhFLElBQUksbUJBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDL0IsT0FBTyxNQUFNLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFBO0tBQzVFO1NBQU0sSUFBSSxzQkFBYyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN6QyxPQUFPLE1BQU0sYUFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUs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QUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFBO1lBQzVDLEtBQUssRUFBRSxDQUFBO1lBQ1AsU0FBUyxFQUFFLENBQUE7U0FDWjtRQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ1YsTUFBTSxFQUFFLENBQUE7WUFDUixxQkFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUNoQjtLQUNGO0lBRUQscUJBQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxTQUFTLG1CQUFtQixDQUFDLENBQUE7SUFDcEQscUJBQU0sQ0FBQyxLQUFLLENBQUMsVUFBVSxNQUFNLDRCQUE0QixDQUFDLENBQUE7SUFFMUQsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUE7QUFDeEMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2VyLCBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgRXhlY3V0ZVdpdGhDb25maWcsIEV4ZWN1dGUsIEFkYXB0ZXJDb250ZXh0IH0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IENvbmZpZyB9IGZyb20gJy4uL2NvbmZpZydcbmltcG9ydCB7IFRFQU1fQUJJLCBURUFNX1NQT1JUUywgRklHSFRFUl9TUE9SVFMsIE5GTF9BQkkgfSBmcm9tICcuL2luZGV4J1xuaW1wb3J0IHsgZXRoZXJzIH0gZnJvbSAnZXRoZXJzJ1xuaW1wb3J0IHsgdGhlUnVuZG93biwgc3BvcnRzZGF0YWlvIH0gZnJvbSAnLi4vZGF0YVByb3ZpZGVycydcbmltcG9ydCBtbWFBQkkgZnJvbSAnLi4vYWJpcy9tbWEuanNvbidcblxuY29uc3QgcmVzb2x2ZVBhcmFtcyA9IHtcbiAgY29udHJhY3RBZGRyZXNzOiB0cnVlLFxuICBzcG9ydDogdHJ1ZSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXNvbHZlVGVhbSB7XG4gIGlkOiBldGhlcnMuQmlnTnVtYmVyXG4gIHN0YXR1czogbnVtYmVyXG4gIGhvbWVTY29yZTogbnVtYmVyXG4gIGF3YXlTY29yZTogbnVtYmVyXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzb2x2ZUZpZ2h0IHtcbiAgaWQ6IGV0aGVycy5CaWdOdW1iZXJcbiAgc3RhdHVzOiBudW1iZXJcbiAgZmlnaHRlckE6IG51bWJlclxuICBmaWdodGVyQjogbnVtYmVyXG4gIHdpbm5lcklkPzogbnVtYmVyXG4gIGRyYXc6IGJvb2xlYW5cbn1cblxuY29uc3Qgc3RhdHVzQ29tcGxldGVkID0gW1xuICA0LCAvLyBDYW5jZWxsZWRcbiAgMiwgLy8gRmluYWxcbiAgMywgLy8gUG9zdHBvbmVkXG5dXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKGlucHV0LCBjb250ZXh0LCBjb25maWcpID0+IHtcbiAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihpbnB1dCwgcmVzb2x2ZVBhcmFtcylcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG5cbiAgY29uc3Qgc3BvcnQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuc3BvcnQudG9Mb3dlckNhc2UoKVxuICBjb25zdCBjb250cmFjdEFkZHJlc3MgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuY29udHJhY3RBZGRyZXNzXG5cbiAgaWYgKFRFQU1fU1BPUlRTLmluY2x1ZGVzKHNwb3J0KSkge1xuICAgIHJldHVybiBhd2FpdCByZXNvbHZlVGVhbShpbnB1dC5pZCwgc3BvcnQsIGNvbnRyYWN0QWRkcmVzcywgY29udGV4dCwgY29uZmlnKVxuICB9IGVsc2UgaWYgKEZJR0hURVJfU1BPUlRTLmluY2x1ZGVzKHNwb3J0KSkge1xuICAgIHJldHVybiBhd2FpdCByZXNvbHZlRmlnaHRzKGlucHV0LmlkLCBzcG9ydCwgY29udHJhY3RBZGRyZXNzLCBjb250ZXh0LCBjb25maWcpXG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgRXJyb3IoYFVuYWJsZSB0byBpZGVudGlmeSBzcG9ydCBcIiR7c3BvcnR9XCJgKVxuICB9XG59XG5cbmNvbnN0IHJlc29sdmVUZWFtID0gYXN5bmMgKFxuICBqb2JSdW5JRDogc3RyaW5nLFxuICBzcG9ydDogc3RyaW5nLFxuICBjb250cmFjdEFkZHJlc3M6IHN0cmluZyxcbiAgY29udGV4dDogQWRhcHRlckNvbnRleHQsXG4gIGNvbmZpZzogQ29uZmlnLFxuKSA9PiB7XG4gIC8vIFRoZSBkaWZmZXJlbmNlIGlzbid0IG1lYW5pbmdmdWwgaGVyZSB1c2luZyB0aGUgcHJvcGVyIGFiaXMgYW55d2F5LlxuICBjb25zdCBjb250cmFjdCA9IG5ldyBldGhlcnMuQ29udHJhY3QoXG4gICAgY29udHJhY3RBZGRyZXNzLFxuICAgIHNwb3J0ID09PSAnbmZsJyA/IE5GTF9BQkkgOiBURUFNX0FCSSxcbiAgICBjb25maWcud2FsbGV0LFxuICApXG5cbiAgbGV0IGdldEV2ZW50OiBFeGVjdXRlXG4gIGlmICh0aGVSdW5kb3duLlNQT1JUU19TVVBQT1JURUQuaW5jbHVkZXMoc3BvcnQpKSB7XG4gICAgZ2V0RXZlbnQgPSB0aGVSdW5kb3duLnJlc29sdmVcbiAgfSBlbHNlIGlmIChzcG9ydHNkYXRhaW8uU1BPUlRTX1NVUFBPUlRFRC5pbmNsdWRlcyhzcG9ydCkpIHtcbiAgICBnZXRFdmVudCA9IHNwb3J0c2RhdGFpby5yZXNvbHZlVGVhbVxuICB9IGVsc2Uge1xuICAgIHRocm93IEVycm9yKGBVbmtub3duIGRhdGEgcHJvdmlkZXIgZm9yIHNwb3J0ICR7c3BvcnR9YClcbiAgfVxuXG4gIGNvbnN0IGV2ZW50SURzOiBldGhlcnMuQmlnTnVtYmVyW10gPSBhd2FpdCBjb250cmFjdC5saXN0UmVzb2x2YWJsZUV2ZW50cygpXG4gIGNvbnN0IGV2ZW50czogUmVzb2x2ZVRlYW1bXSA9IFtdXG4gIGZvciAoY29uc3QgZXZlbnRJZCBvZiBldmVudElEcykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEV2ZW50KFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6IGpvYlJ1bklELFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHNwb3J0LFxuICAgICAgICAgICAgZXZlbnRJZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjb250ZXh0LFxuICAgICAgKVxuICAgICAgZXZlbnRzLnB1c2gocmVzcG9uc2UucmVzdWx0IGFzIFJlc29sdmVUZWFtKVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIExvZ2dlci5lcnJvcihlKVxuICAgIH1cbiAgfVxuXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6IEZvdW5kICR7ZXZlbnRzLmxlbmd0aH0gZXZlbnRzIHRvIGF0dGVtcHQgdG8gcmVzb2x2ZWApXG5cbiAgLy8gRmlsdGVycyBvdXQgZXZlbnRzIHRoYXQgYXJlbid0IHlldCByZWFkeSB0byByZXNvbHZlLlxuICBjb25zdCBldmVudFJlYWR5VG9SZXNvbHZlID0gZXZlbnRzLmZpbHRlcigoeyBpZCwgc3RhdHVzIH0pID0+IHtcbiAgICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBzdGF0dXMgaW5mb2AsIHtcbiAgICAgIGlkOiBpZC50b0hleFN0cmluZygpLnNsaWNlKDIpLFxuICAgICAgc3RhdHVzLFxuICAgICAgbmVlZHNfcmVzb2x2ZTogc3RhdHVzQ29tcGxldGVkLmluY2x1ZGVzKHN0YXR1cyksXG4gICAgfSlcbiAgICByZXR1cm4gc3RhdHVzQ29tcGxldGVkLmluY2x1ZGVzKHN0YXR1cylcbiAgfSlcblxuICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBQcmVwYXJlZCB0byByZXNvbHZlICR7ZXZlbnRSZWFkeVRvUmVzb2x2ZS5sZW5ndGh9IGV2ZW50c2ApXG5cbiAgbGV0IGZhaWxlZCA9IDBcbiAgbGV0IHN1Y2NlZWRlZCA9IDBcblxuICBsZXQgbm9uY2UgPSBhd2FpdCBjb25maWcud2FsbGV0LmdldFRyYW5zYWN0aW9uQ291bnQoKVxuICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50UmVhZHlUb1Jlc29sdmUubGVuZ3RoOyBpKyspIHtcbiAgICBMb2dnZXIuaW5mbyhgQXVndXI6IHJlc29sdmluZyBldmVudCBcIiR7ZXZlbnRSZWFkeVRvUmVzb2x2ZVtpXS5pZH1cImApXG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgdHggPSBhd2FpdCBjb250cmFjdC50cnVzdGVkUmVzb2x2ZU1hcmtldHMoXG4gICAgICAgIGV2ZW50UmVhZHlUb1Jlc29sdmVbaV0uaWQsXG4gICAgICAgIGV2ZW50UmVhZHlUb1Jlc29sdmVbaV0uc3RhdHVzLFxuICAgICAgICBldmVudFJlYWR5VG9SZXNvbHZlW2ldLmhvbWVTY29yZSxcbiAgICAgICAgZXZlbnRSZWFkeVRvUmVzb2x2ZVtpXS5hd2F5U2NvcmUsXG4gICAgICAgIHsgbm9uY2UgfSxcbiAgICAgIClcbiAgICAgIExvZ2dlci5pbmZvKGBBdWd1cjogQ3JlYXRlZCB0eDogJHt0eC5oYXNofWApXG4gICAgICBub25jZSsrXG4gICAgICBzdWNjZWVkZWQrK1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGZhaWxlZCsrXG4gICAgICBMb2dnZXIuZXJyb3IoZSlcbiAgICB9XG4gIH1cblxuICBMb2dnZXIuZGVidWcoYEF1Z3VyOiAke3N1Y2NlZWRlZH0gcmVzb2x2ZWQgbWFya2V0c2ApXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6ICR7ZmFpbGVkfSBtYXJrZXRzIGZhaWxlZCB0byByZXNvbHZlYClcblxuICByZXR1cm4gUmVxdWVzdGVyLnN1Y2Nlc3Moam9iUnVuSUQsIHt9KVxufVxuXG5jb25zdCBmaWdodFN0YXR1c01hcHBpbmc6IHsgW2tleTogc3RyaW5nXTogbnVtYmVyIH0gPSB7XG4gIHVua25vd246IDAsXG4gIGhvbWU6IDEsXG4gIGF3YXk6IDIsXG4gIGRyYXc6IDMsXG59XG5cbmNvbnN0IHJlc29sdmVGaWdodHMgPSBhc3luYyAoXG4gIGpvYlJ1bklEOiBzdHJpbmcsXG4gIHNwb3J0OiBzdHJpbmcsXG4gIGNvbnRyYWN0QWRkcmVzczogc3RyaW5nLFxuICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dCxcbiAgY29uZmlnOiBDb25maWcsXG4pID0+IHtcbiAgY29uc3QgY29udHJhY3QgPSBuZXcgZXRoZXJzLkNvbnRyYWN0KGNvbnRyYWN0QWRkcmVzcywgbW1hQUJJLCBjb25maWcud2FsbGV0KVxuXG4gIGxldCBnZXRFdmVudDogRXhlY3V0ZVxuICBpZiAodGhlUnVuZG93bi5TUE9SVFNfU1VQUE9SVEVELmluY2x1ZGVzKHNwb3J0KSkge1xuICAgIGdldEV2ZW50ID0gdGhlUnVuZG93bi5yZXNvbHZlXG4gIH0gZWxzZSBpZiAoc3BvcnRzZGF0YWlvLlNQT1JUU19TVVBQT1JURUQuaW5jbHVkZXMoc3BvcnQpKSB7XG4gICAgZ2V0RXZlbnQgPSBzcG9ydHNkYXRhaW8ucmVzb2x2ZUZpZ2h0XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgRXJyb3IoYFVua25vd24gZGF0YSBwcm92aWRlciBmb3Igc3BvcnQgJHtzcG9ydH1gKVxuICB9XG5cbiAgTG9nZ2VyLmRlYnVnKCdBdWd1cjogR2V0dGluZyBsaXN0IG9mIHBvdGVudGlhbGx5IHJlc29sdmFibGUgZXZlbnRzJylcbiAgY29uc3QgZXZlbnRJRHM6IGV0aGVycy5CaWdOdW1iZXJbXSA9IGF3YWl0IGNvbnRyYWN0Lmxpc3RSZXNvbHZhYmxlRXZlbnRzKClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1cjogRm91bmQgJHtldmVudElEcy5sZW5ndGh9IHBvdGVudGlhbGx5IHJlc29sdmFibGUgZXZlbnRzYClcbiAgY29uc3QgZXZlbnRzOiBSZXNvbHZlRmlnaHRbXSA9IFtdXG4gIGZvciAoY29uc3QgZXZlbnRJZCBvZiBldmVudElEcykge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEV2ZW50KFxuICAgICAgICB7XG4gICAgICAgICAgaWQ6IGpvYlJ1bklELFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIHNwb3J0LFxuICAgICAgICAgICAgZXZlbnRJZCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBjb250ZXh0LFxuICAgICAgKVxuICAgICAgZXZlbnRzLnB1c2gocmVzcG9uc2UucmVzdWx0IGFzIFJlc29sdmVGaWdodClcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBMb2dnZXIuZXJyb3IoZSlcbiAgICB9XG4gIH1cblxuICAvLyBGaWx0ZXJzIG91dCBldmVudHMgdGhhdCBhcmVuJ3QgeWV0IHJlYWR5IHRvIHJlc29sdmUuXG4gIGNvbnN0IGV2ZW50UmVhZHlUb1Jlc29sdmUgPSBldmVudHMuZmlsdGVyKCh7IHN0YXR1cyB9KSA9PiBzdGF0dXNDb21wbGV0ZWQuaW5jbHVkZXMoc3RhdHVzKSlcblxuICBsZXQgZmFpbGVkID0gMFxuICBsZXQgc3VjY2VlZGVkID0gMFxuXG4gIGxldCBub25jZSA9IGF3YWl0IGNvbmZpZy53YWxsZXQuZ2V0VHJhbnNhY3Rpb25Db3VudCgpXG4gIGZvciAoY29uc3QgZmlnaHQgb2YgZXZlbnRSZWFkeVRvUmVzb2x2ZSkge1xuICAgIExvZ2dlci5pbmZvKGBBdWd1cjogcmVzb2x2aW5nIGV2ZW50IFwiJHtmaWdodC5pZC50b1N0cmluZygpfVwiYClcblxuICAgIGxldCBmaWdodFN0YXR1cyA9IDBcbiAgICBpZiAoZmlnaHQuZHJhdykge1xuICAgICAgZmlnaHRTdGF0dXMgPSBmaWdodFN0YXR1c01hcHBpbmcuZHJhd1xuICAgIH0gZWxzZSBpZiAoZmlnaHQud2lubmVySWQgPT09IGZpZ2h0LmZpZ2h0ZXJBKSB7XG4gICAgICBmaWdodFN0YXR1cyA9IGZpZ2h0U3RhdHVzTWFwcGluZy5ob21lXG4gICAgfSBlbHNlIGlmIChmaWdodC53aW5uZXJJZCA9PT0gZmlnaHQuZmlnaHRlckIpIHtcbiAgICAgIGZpZ2h0U3RhdHVzID0gZmlnaHRTdGF0dXNNYXBwaW5nLmF3YXlcbiAgICB9XG5cbiAgICBjb25zdCBwYXlsb2FkID0gW2ZpZ2h0LmlkLCBmaWdodC5zdGF0dXMsIGZpZ2h0LmZpZ2h0ZXJBLCBmaWdodC5maWdodGVyQiwgZmlnaHRTdGF0dXMsIHsgbm9uY2UgfV1cblxuICAgIC8vIFRoaXMgY2FsbCByZXNvbHZlcyBtYXJrZXRzLlxuICAgIHRyeSB7XG4gICAgICBMb2dnZXIuZGVidWcoYEF1Z3VyOiBSZXNvbHZpbmcgbWFya2V0IHdpdGggdGhlc2UgYXJndW1lbnRzOiAke0pTT04uc3RyaW5naWZ5KHBheWxvYWQpfWApXG4gICAgICBjb25zdCB0eCA9IGF3YWl0IGNvbnRyYWN0LnRydXN0ZWRSZXNvbHZlTWFya2V0cyguLi5wYXlsb2FkKVxuICAgICAgTG9nZ2VyLmluZm8oYEF1Z3VyOiBDcmVhdGVkIHR4OiAke3R4Lmhhc2h9YClcbiAgICAgIG5vbmNlKytcbiAgICAgIHN1Y2NlZWRlZCsrXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZmFpbGVkKytcbiAgICAgIExvZ2dlci5lcnJvcihlKVxuICAgIH1cbiAgfVxuXG4gIExvZ2dlci5kZWJ1ZyhgQXVndXI6ICR7c3VjY2VlZGVkfSByZXNvbHZlZCBtYXJrZXRzYClcbiAgTG9nZ2VyLmRlYnVnKGBBdWd1cjogJHtmYWlsZWR9IG1hcmtldHMgZmFpbGVkIHRvIHJlc29sdmVgKVxuXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwge30pXG59XG4iXX0=