"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SigmaCalculator = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const decimal_js_1 = require("decimal.js");
class SigmaCalculator {
    weightedSigma(sigmaData) {
        const { e1, e2, sigma1, sigma2, now } = sigmaData;
        const tm = new decimal_js_1.Decimal(60 * 60 * 24 * 30);
        const t1 = new decimal_js_1.Decimal(e1 - now);
        const t2 = new decimal_js_1.Decimal(e2 - now);
        const weighted = (t1.times(t2.minus(tm)).times(sigma1).minus((t2.times((t1.minus(tm)).times(sigma2)))))
            .div((t2.minus(t1)))
            .div(tm); // prettier-ignore
        return weighted;
    }
    T(nowTime, e) {
        return (e - nowTime) / (365 * 24 * 60 * 60);
    }
    oneSigma(expiration, exchangeRate, calls, puts, now) {
        const T = this.T(now, expiration);
        const r = new decimal_js_1.Decimal(0);
        let S = new decimal_js_1.Decimal(0);
        let dK = new decimal_js_1.Decimal(0);
        let F = new decimal_js_1.Decimal(0);
        let K0c = new decimal_js_1.Decimal(0);
        const compareCalls = calls.map((c) => c.midPrice ?? new decimal_js_1.Decimal(0));
        calls.forEach((call, idx) => {
            const { strikePrice, midPrice, underlyingPrice } = call;
            if (strikePrice.gt(underlyingPrice)) {
                if (!midPrice)
                    return;
                const prevMax = decimal_js_1.Decimal.max(...[0, ...compareCalls.slice(Math.max(0, idx - 10), idx)]);
                if (idx > 3 && !prevMax.isZero() && midPrice.greaterThan(prevMax.mul(2)))
                    return;
                F = underlyingPrice;
                if (idx === 0) {
                    dK = calls[idx + 1].strikePrice.minus(strikePrice);
                }
                else if (idx === calls.length - 1) {
                    dK = strikePrice.minus(calls[idx - 1].strikePrice);
                }
                else {
                    dK = calls[idx + 1].strikePrice.minus(calls[idx - 1].strikePrice).div(2);
                }
                S = S.plus(dK.times(midPrice).div(strikePrice.pow(2)));
            }
            else {
                K0c = strikePrice;
            }
        });
        let K0p = new decimal_js_1.Decimal(0);
        const comparePuts = puts.map((p) => p.midPrice ?? new decimal_js_1.Decimal(0));
        puts.forEach((put, idx) => {
            const { strikePrice, midPrice, underlyingPrice } = put;
            if (strikePrice.lt(underlyingPrice)) {
                if (!midPrice)
                    return;
                const prevMax = decimal_js_1.Decimal.max(...[0, ...comparePuts.slice(Math.max(0, idx - 10), idx)]);
                if (idx > 3 && !prevMax.isZero() && midPrice.greaterThan(prevMax.mul(2)))
                    return;
                F = underlyingPrice;
                if (idx === 0) {
                    dK = strikePrice.minus(puts[idx + 1].strikePrice);
                }
                else if (idx === puts.length - 1) {
                    dK = puts[idx - 1].strikePrice.minus(strikePrice);
                }
                else {
                    dK = puts[idx - 1].strikePrice.minus(puts[idx + 1].strikePrice).div(2);
                }
                S = S.plus(dK.times(midPrice).div(strikePrice.pow(2)));
            }
            else {
                K0p = strikePrice;
            }
        });
        const K0 = (K0c.plus(K0p)).div(2); // prettier-ignore
        const sigma = (new decimal_js_1.Decimal(2)
            .times(new decimal_js_1.Decimal(Math.exp(Number(r.mul(T).toFixed()))))
            .times(S)
            .times(exchangeRate)
            .minus((F.div(K0).minus(1)).pow(2)).div(T)); // prettier-ignore
        ea_bootstrap_1.Logger.debug(`Sigma:${sigma.toString()}`);
        return sigma;
    }
    sortByStrikePrice(currencyDerivativesData) {
        const { callsE1, putsE1, callsE2, putsE2 } = currencyDerivativesData;
        _sortByStrikePrice(callsE1);
        _sortByStrikePrice(callsE2);
        _sortByStrikePrice(putsE1, true);
        _sortByStrikePrice(putsE2, true);
    }
}
exports.SigmaCalculator = SigmaCalculator;
const _sortByStrikePrice = (optionData, isReversed = false) => {
    const sortFunc = isReversed
        ? (option1, option2) => Number(option2.strikePrice.minus(option1.strikePrice))
        : (option1, option2) => Number(option1.strikePrice.minus(option2.strikePrice));
    optionData.sort(sortFunc);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lnbWFDYWxjdWxhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3NpZ21hQ2FsY3VsYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBZ0Q7QUFDaEQsMkNBQW9DO0FBV3BDLE1BQWEsZUFBZTtJQUMxQixhQUFhLENBQUMsU0FBb0I7UUFDaEMsTUFBTSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxTQUFTLENBQUE7UUFDakQsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBTyxDQUFDLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFBO1FBQ3pDLE1BQU0sRUFBRSxHQUFHLElBQUksb0JBQU8sQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUE7UUFDaEMsTUFBTSxFQUFFLEdBQUcsSUFBSSxvQkFBTyxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQTtRQUNoQyxNQUFNLFFBQVEsR0FBRyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNwRyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7YUFDbkIsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFBLENBQUMsa0JBQWtCO1FBQzdCLE9BQU8sUUFBUSxDQUFBO0lBQ2pCLENBQUM7SUFFRCxDQUFDLENBQUMsT0FBZSxFQUFFLENBQVM7UUFDMUIsT0FBTyxDQUFDLENBQUMsR0FBRyxPQUFP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QyxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyx1QkFBZ0Q7UUFDaEUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLHVCQUF1QixDQUFBO1FBQ3BFLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQzNCLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQzNCLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNoQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUE7SUFDbEMsQ0FBQztDQUNGO0FBaEdELDBDQWdHQztBQUVELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxVQUE2QixFQUFFLFVBQVUsR0FBRyxLQUFLLEVBQUUsRUFBRTtJQUMvRSxNQUFNLFFBQVEsR0FBRyxVQUFVO1FBQ3pCLENBQUMsQ0FBQyxDQUFDLE9BQW1CLEVBQUUsT0FBbUIsRUFBRSxFQUFFLENBQzNDLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDMUQsQ0FBQyxDQUFDLENBQUMsT0FBbUIsRUFBRSxPQUFtQixFQUFFLEVBQUUsQ0FDM0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO0lBRTVELFVBQVUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7QUFDM0IsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQgeyBEZWNpbWFsIH0gZnJvbSAnZGVjaW1hbC5qcydcbmltcG9ydCB7IEN1cnJlbmN5RGVyaXZhdGl2ZXNEYXRhLCBPcHRpb25EYXRhIH0gZnJvbSAnLi9kZXJpdmF0aXZlc0RhdGFQcm92aWRlcidcblxuZXhwb3J0IHR5cGUgU2lnbWFEYXRhID0ge1xuICBlMTogbnVtYmVyXG4gIGUyOiBudW1iZXJcbiAgc2lnbWExOiBEZWNpbWFsXG4gIHNpZ21hMjogRGVjaW1hbFxuICBub3c6IG51bWJlclxufVxuXG5leHBvcnQgY2xhc3MgU2lnbWFDYWxjdWxhdG9yIHtcbiAgd2VpZ2h0ZWRTaWdtYShzaWdtYURhdGE6IFNpZ21hRGF0YSk6IERlY2ltYWwge1xuICAgIGNvbnN0IHsgZTEsIGUyLCBzaWdtYTEsIHNpZ21hMiwgbm93IH0gPSBzaWdtYURhdGFcbiAgICBjb25zdCB0bSA9IG5ldyBEZWNpbWFsKDYwICogNjAgKiAyNCAqIDMwKVxuICAgIGNvbnN0IHQxID0gbmV3IERlY2ltYWwoZTEgLSBub3cpXG4gICAgY29uc3QgdDIgPSBuZXcgRGVjaW1hbChlMiAtIG5vdylcbiAgICBjb25zdCB3ZWlnaHRlZCA9ICh0MS50aW1lcyh0Mi5taW51cyh0bSkpLnRpbWVzKHNpZ21hMSkubWludXMoKHQyLnRpbWVzKCh0MS5taW51cyh0bSkpLnRpbWVzKHNpZ21hMikpKSkpXG4gICAgICAuZGl2KCh0Mi5taW51cyh0MSkpKVxuICAgICAgLmRpdih0bSkgLy8gcHJldHRpZXItaWdub3JlXG4gICAgcmV0dXJuIHdlaWdodGVkXG4gIH1cblxuICBUKG5vd1RpbWU6IG51bWJlciwgZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gKGUgLSBub3dUaW1lKSAvICgzNjUgKiAyNCAqIDYwICogNjApXG4gIH1cblxuICBvbmVTaWdtYShcbiAgICBleHBpcmF0aW9uOiBudW1iZXIsXG4gICAgZXhjaGFuZ2VSYXRlOiBEZWNpbWFsLFxuICAgIGNhbGxzOiBBcnJheTxPcHRpb25EYXRhPixcbiAgICBwdXRzOiBBcnJheTxPcHRpb25EYXRhPixcbiAgICBub3c6IG51bWJlcixcbiAgKTogRGVjaW1hbCB7XG4gICAgY29uc3QgVCA9IHRoaXMuVChub3csIGV4cGlyYXRpb24pXG4gICAgY29uc3QgciA9IG5ldyBEZWNpbWFsKDApXG4gICAgbGV0IFMgPSBuZXcgRGVjaW1hbCgwKVxuICAgIGxldCBkSyA9IG5ldyBEZWNpbWFsKDApXG4gICAgbGV0IEYgPSBuZXcgRGVjaW1hbCgwKVxuICAgIGxldCBLMGMgPSBuZXcgRGVjaW1hbCgwKVxuICAgIGNvbnN0IGNvbXBhcmVDYWxsczogRGVjaW1hbFtdID0gY2FsbHMubWFwKChjKSA9PiBjLm1pZFByaWNlID8/IG5ldyBEZWNpbWFsKDApKVxuICAgIGNhbGxzLmZvckVhY2goKGNhbGw6IE9wdGlvbkRhdGEsIGlkeDogbnVtYmVyKSA9PiB7XG4gICAgICBjb25zdCB7IHN0cmlrZVByaWNlLCBtaWRQcmljZSwgdW5kZXJseWluZ1ByaWNlIH0gPSBjYWxsXG4gICAgICBpZiAoc3RyaWtlUHJpY2UuZ3QodW5kZXJseWluZ1ByaWNlKSkge1xuICAgICAgICBpZiAoIW1pZFByaWNlKSByZXR1cm5cbiAgICAgICAgY29uc3QgcHJldk1heDogRGVjaW1hbCA9IERlY2ltYWwubWF4KFxuICAgICAgICAgIC4uLlswLCAuLi5jb21wYXJlQ2FsbHMuc2xpY2UoTWF0aC5tYXgoMCwgaWR4IC0gMTApLCBpZHgpXSxcbiAgICAgICAgKVxuICAgICAgICBpZiAoaWR4ID4gMyAmJiAhcHJldk1heC5pc1plcm8oKSAmJiBtaWRQcmljZS5ncmVhdGVyVGhhbihwcmV2TWF4Lm11bCgyKSkpIHJldHVyblxuICAgICAgICBGID0gdW5kZXJseWluZ1ByaWNlXG4gICAgICAgIGlmIChpZHggPT09IDApIHtcbiAgICAgICAgICBkSyA9IGNhbGxzW2lkeCArIDFdLnN0cmlrZVByaWNlLm1pbnVzKHN0cmlrZVByaWNlKVxuICAgICAgICB9IGVsc2UgaWYgKGlkeCA9PT0gY2FsbHMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGRLID0gc3RyaWtlUHJpY2UubWludXMoY2FsbHNbaWR4IC0gMV0uc3RyaWtlUHJpY2UpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZEsgPSBjYWxsc1tpZHggKyAxXS5zdHJpa2VQcmljZS5taW51cyhjYWxsc1tpZHggLSAxXS5zdHJpa2VQcmljZSkuZGl2KDIpXG4gICAgICAgIH1cblxuICAgICAgICBTID0gUy5wbHVzKGRLLnRpbWVzKG1pZFByaWNlKS5kaXYoc3RyaWtlUHJpY2UucG93KDIpKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIEswYyA9IHN0cmlrZVByaWNlXG4gICAgICB9XG4gICAgfSlcblxuICAgIGxldCBLMHAgPSBuZXcgRGVjaW1hbCgwKVxuICAgIGNvbnN0IGNvbXBhcmVQdXRzOiBEZWNpbWFsW10gPSBwdXRzLm1hcCgocCkgPT4gcC5taWRQcmljZSA/PyBuZXcgRGVjaW1hbCgwKSlcbiAgICBwdXRzLmZvckVhY2goKHB1dDogT3B0aW9uRGF0YSwgaWR4OiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IHsgc3RyaWtlUHJpY2UsIG1pZFByaWNlLCB1bmRlcmx5aW5nUHJpY2UgfSA9IHB1dFxuICAgICAgaWYgKHN0cmlrZVByaWNlLmx0KHVuZGVybHlpbmdQcmljZSkpIHtcbiAgICAgICAgaWYgKCFtaWRQcmljZSkgcmV0dXJuXG4gICAgICAgIGNvbnN0IHByZXZNYXg6IERlY2ltYWwgPSBEZWNpbWFsLm1heChcbiAgICAgICAgICAuLi5bMCwgLi4uY29tcGFyZVB1dHMuc2xpY2UoTWF0aC5tYXgoMCwgaWR4IC0gMTApLCBpZHgpXSxcbiAgICAgICAgKVxuICAgICAgICBpZiAoaWR4ID4gMyAmJiAhcHJldk1heC5pc1plcm8oKSAmJiBtaWRQcmljZS5ncmVhdGVyVGhhbihwcmV2TWF4Lm11bCgyKSkpIHJldHVyblxuICAgICAgICBGID0gdW5kZXJseWluZ1ByaWNlXG4gICAgICAgIGlmIChpZHggPT09IDApIHtcbiAgICAgICAgICBkSyA9IHN0cmlrZVByaWNlLm1pbnVzKHB1dHNbaWR4ICsgMV0uc3RyaWtlUHJpY2UpXG4gICAgICAgIH0gZWxzZSBpZiAoaWR4ID09PSBwdXRzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICBkSyA9IHB1dHNbaWR4IC0gMV0uc3RyaWtlUHJpY2UubWludXMoc3RyaWtlUHJpY2UpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZEsgPSBwdXRzW2lkeCAtIDFdLnN0cmlrZVByaWNlLm1pbnVzKHB1dHNbaWR4ICsgMV0uc3RyaWtlUHJpY2UpLmRpdigyKVxuICAgICAgICB9XG5cbiAgICAgICAgUyA9IFMucGx1cyhkSy50aW1lcyhtaWRQcmljZSkuZGl2KHN0cmlrZVByaWNlLnBvdygyKSkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBLMHAgPSBzdHJpa2VQcmljZVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBjb25zdCBLMCA9IChLMGMucGx1cyhLMHApKS5kaXYoMikgLy8gcHJldHRpZXItaWdub3JlXG4gICAgY29uc3Qgc2lnbWEgPSAobmV3IERlY2ltYWwoMilcbiAgICAgIC50aW1lcyhuZXcgRGVjaW1hbChNYXRoLmV4cChOdW1iZXIoci5tdWwoVCkudG9GaXhlZCgpKSkpKVxuICAgICAgLnRpbWVzKFMpXG4gICAgICAudGltZXMoZXhjaGFuZ2VSYXRlKVxuICAgICAgLm1pbnVzKChGLmRpdihLMCkubWludXMoMSkpLnBvdygyKSkuZGl2KFQpKSAvLyBwcmV0dGllci1pZ25vcmVcblxuICAgIExvZ2dlci5kZWJ1ZyhgU2lnbWE6JHtzaWdtYS50b1N0cmluZygpfWApXG4gICAgcmV0dXJuIHNpZ21hXG4gIH1cblxuICBzb3J0QnlTdHJpa2VQcmljZShjdXJyZW5jeURlcml2YXRpdmVzRGF0YTogQ3VycmVuY3lEZXJpdmF0aXZlc0RhdGEpOiB2b2lkIHtcbiAgICBjb25zdCB7IGNhbGxzRTEsIHB1dHNFMSwgY2FsbHNFMiwgcHV0c0UyIH0gPSBjdXJyZW5jeURlcml2YXRpdmVzRGF0YVxuICAgIF9zb3J0QnlTdHJpa2VQcmljZShjYWxsc0UxKVxuICAgIF9zb3J0QnlTdHJpa2VQcmljZShjYWxsc0UyKVxuICAgIF9zb3J0QnlTdHJpa2VQcmljZShwdXRzRTEsIHRydWUpXG4gICAgX3NvcnRCeVN0cmlrZVByaWNlKHB1dHNFMiwgdHJ1ZSlcbiAgfVxufVxuXG5jb25zdCBfc29ydEJ5U3RyaWtlUHJpY2UgPSAob3B0aW9uRGF0YTogQXJyYXk8T3B0aW9uRGF0YT4sIGlzUmV2ZXJzZWQgPSBmYWxzZSkgPT4ge1xuICBjb25zdCBzb3J0RnVuYyA9IGlzUmV2ZXJzZWRcbiAgICA/IChvcHRpb24xOiBPcHRpb25EYXRhLCBvcHRpb24yOiBPcHRpb25EYXRhKSA9PlxuICAgICAgICBOdW1iZXIob3B0aW9uMi5zdHJpa2VQcmljZS5taW51cyhvcHRpb24xLnN0cmlrZVByaWNlKSlcbiAgICA6IChvcHRpb24xOiBPcHRpb25EYXRhLCBvcHRpb24yOiBPcHRpb25EYXRhKSA9PlxuICAgICAgICBOdW1iZXIob3B0aW9uMS5zdHJpa2VQcmljZS5taW51cyhvcHRpb24yLnN0cmlrZVByaWNlKSlcblxuICBvcHRpb25EYXRhLnNvcnQoc29ydEZ1bmMpXG59XG4iXX0=