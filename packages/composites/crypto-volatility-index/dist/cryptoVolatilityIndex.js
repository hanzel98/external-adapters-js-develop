"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculate = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const ea_reference_data_reader_1 = require("@chainlink/ea-reference-data-reader");
const derivativesDataProvider_1 = require("./derivativesDataProvider");
const sigmaCalculator_1 = require("./sigmaCalculator");
const decimal_js_1 = require("decimal.js");
const moment_1 = tslib_1.__importDefault(require("moment"));
const dominanceDataProvider_1 = require("./dominanceDataProvider");
const config_1 = require("./config");
const calculate = async (validated, requestParams, context) => {
    const { contract: oracleAddress, multiply = 1e18, heartbeatMinutes = 60, isAdaptive = true, cryptoCurrencies = ['BTC', 'ETH'], deviationThreshold = 0.11, lambdaMin = 0.031, lambdaK = 0.31, network = config_1.DEFAULT_NETWORK, } = validated.data;
    // Get all of the required derivatives data for the calculations, for all the relevant currencies
    const derivativesData = await derivativesDataProvider_1.getDerivativesData(cryptoCurrencies);
    // Calculate vix values for all currencies
    const volatilityIndexData = await calculateVixValues(derivativesData, cryptoCurrencies);
    // Apply weights to calculate the Crypto Vix
    const weightedCVI = await calculateWeighted(volatilityIndexData, validated.id, requestParams, context, cryptoCurrencies);
    // Smooth CVI with previous on-chain value if exists
    const cvi = !isAdaptive
        ? toOnChainValue(weightedCVI, multiply)
        : await applySmoothing(weightedCVI, oracleAddress, multiply, heartbeatMinutes, deviationThreshold, lambdaMin, lambdaK, network);
    ea_bootstrap_1.Logger.info(`CVI: ${cvi}`);
    validateIndex(cvi);
    return cvi;
};
exports.calculate = calculate;
const calculateVixValues = async (derivativesData, cryptoCurrencies) => {
    const now = moment_1.default().utc().unix();
    const sigmaCalculator = new sigmaCalculator_1.SigmaCalculator();
    const vixValues = cryptoCurrencies.map((currency) => {
        sigmaCalculator.sortByStrikePrice(derivativesData[currency]);
        const { e1, e2, exchangeRate, callsE1, putsE1, callsE2, putsE2 } = derivativesData[currency];
        const weightedSigma = sigmaCalculator.weightedSigma({
            e1,
            e2,
            sigma1: sigmaCalculator.oneSigma(e1, exchangeRate, callsE1, putsE1, now),
            sigma2: sigmaCalculator.oneSigma(e2, exchangeRate, callsE2, putsE2, now),
            now,
        });
        return weightedSigma.sqrt().times(100);
    });
    return vixValues;
};
const calculateWeighted = async (vixData, id, requestParams, context, cryptoCurrencies) => {
    const dominanceByCurrency = await getDominanceByCurrency(id, requestParams, context, cryptoCurrencies);
    const weightedVix = cryptoCurrencies.reduce((vix, currency, idx) => {
        const dominance = dominanceByCurrency[currency];
        if (!dominance)
            throw new Error(`No dominance found for currency ${currency}`);
        const currencyVix = new decimal_js_1.Decimal(vixData[idx]);
        // Weight by dominance
        vix = vix.plus(currencyVix.times(new decimal_js_1.Decimal(dominance)));
        return vix;
    }, new decimal_js_1.Decimal(0));
    const weighted = Number(weightedVix.toFixed());
    ea_bootstrap_1.Logger.debug(`Weighted volatility index:${weighted}`);
    return weighted;
};
const getDominanceByCurrency = async (id, requestParams, context, cryptoCurrencies) => {
    const dominanceAdapter = await dominanceDataProvider_1.getDominanceAdapter();
    const allocations = cryptoCurrencies.map((symbol) => {
        return { symbol };
    });
    const quote = 'USD';
    const input = {
        id: id,
        data: {
            ...requestParams,
            allocations,
            quote,
        },
    };
    const dominanceData = await dominanceAdapter(input, context);
    return dominanceDataProvider_1.dominanceByCurrency(dominanceData.data, quote);
};
const applySmoothing = async (weightedCVI, oracleAddress, multiply, heartBeatMinutes, deviationThreshold, lambdaMin, lambdaK, network) => {
    const roundData = await ea_reference_data_reader_1.getRpcLatestRound(network, oracleAddress);
    const latestIndex = new decimal_js_1.Decimal(roundData.answer.toString()).div(multiply);
    const updatedAt = roundData.updatedAt.mul(1000).toNumber();
    if (latestIndex.lte(0)) {
        ea_bootstrap_1.Logger.warn('No on-chain index value found - Is first run of adapter?');
        return weightedCVI;
    }
    const now = moment_1.default().utc();
    const dtSeconds = moment_1.default.duration(now.diff(updatedAt)).asSeconds();
    if (dtSeconds < 0) {
        throw new Error('invalid time, please check the node clock');
    }
    const d = Math.abs(latestIndex.toNumber() / weightedCVI - 1);
    const l = d >= deviationThreshold ? lambdaMin : lambda(dtSeconds, heartBeatMinutes, lambdaMin, lambdaK);
    const smoothed = latestIndex.mul(new decimal_js_1.Decimal(1 - l)).add(new decimal_js_1.Decimal(weightedCVI).mul(l));
    ea_bootstrap_1.Logger.debug(`Previous value:${latestIndex}, updatedAt:${updatedAt}, dtSeconds:${dtSeconds}`);
    return smoothed.toNumber();
};
const lambda = function (t, heartBeatMinutes, lambdaMin, lambdaK) {
    const T = moment_1.default.duration(heartBeatMinutes, 'minutes').asSeconds();
    return lambdaMin + (lambdaK * Math.min(t, T)) / T;
};
const MAX_INDEX = 200;
const validateIndex = function (cvi) {
    if (cvi <= 0 || cvi > MAX_INDEX) {
        throw new Error('Invalid calculated index value');
    }
};
const toOnChainValue = function (cvi, multiply) {
    return Number(cvi.toFixed(multiply.toString().length - 1)); // Keep decimal precision in same magnitude as multiply
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvVm9sYXRpbGl0eUluZGV4LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NyeXB0b1ZvbGF0aWxpdHlJbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQWdEO0FBQ2hELGtGQUF1RTtBQUN2RSx1RUFBdUY7QUFDdkYsdURBQW1EO0FBQ25ELDJDQUFvQztBQUNwQyw0REFBMkI7QUFDM0IsbUVBQWtGO0FBRWxGLHFDQUEwQztBQUVuQyxNQUFNLFNBQVMsR0FBRyxLQUFLLEVBQzVCLFNBQThCLEVBQzlCLGFBQWtCLEVBQ2xCLE9BQXVCLEVBQ04sRUFBRTtJQUNuQixNQUFNLEVBQ0osUUFBUSxFQUFFLGFBQWEsRUFDdkIsUUFBUSxHQUFHLElBQUksRUFDZixnQkFBZ0IsR0FBRyxFQUFFLEVBQ3JCLFVBQVUsR0FBRyxJQUFJLEVBQ2pCLGdCQUFnQixHQUFHLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxFQUNqQyxrQkFBa0IsR0FBRyxJQUFJLEVBQ3pCLFNBQVMsR0FBRyxLQUFLLEVBQ2pCLE9BQU8sR0FBRyxJQUFJLEVBQ2QsT0FBTyxHQUFHLHdCQUFlLEdBQzFCLEdBQUcsU0FBUyxDQUFDLElBQUksQ0FBQTtJQUVsQixpR0FBaUc7SUFDakcsTUFBTSxlQUFlLEdBQUcsTUFBTSw0Q0FBa0IsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO0lBQ2xFLDBDQUEwQztJQUMxQyxNQUFNLG1CQUFtQixHQUFHLE1BQU0sa0JBQWtCLENBQUMsZUFBZSxFQUFFLGdCQUFnQixDQUFDLENBQUE7SUFDdkYsNENBQTRDO0lBQzVDLE1BQU0sV0FBVyxHQUFHLE1BQU0saUJBQWlCLENBQ3pDLG1CQUFtQixFQUNuQixTQUFTLENBQUMsRUFBRSxFQUNaLGFBQWEsRUFDYixPQUFPLEVBQ1AsZ0JBQWdCLENBQ2pCLENBQUE7SUFDRCxvREFBb0Q7SUFDcEQsTUFBTSxHQUFHLEdBQUcsQ0FBQyxVQUFVO1FBQ3JCLENBQUMsQ0FBQyxjQUFj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QyxDQUFBO0FBRUQsTUFBTSxNQUFNLEdBQUcsVUFBVSxDQUFTLEVBQUUsZ0JBQXdCLEVBQUUsU0FBaUIsRUFBRSxPQUFlO0lBQzlGLE1BQU0sQ0FBQyxHQUFHLGdCQUFNLENBQUMsUUFBUSxDQUFDLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFBO0lBQ2xFLE9BQU8sU0FBUyxHQUFHLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0FBQ25ELENBQUMsQ0FBQTtBQUVELE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQTtBQUNyQixNQUFNLGFBQWEsR0FBRyxVQUFVLEdBQVc7SUFDekMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxTQUFTLEVBQUU7UUFDL0IsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFBO0tBQ2xEO0FBQ0gsQ0FBQyxDQUFBO0FBRUQsTUFBTSxjQUFjLEdBQUcsVUFBVSxHQUFXLEVBQUUsUUFBZ0I7SUFDNUQsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyx1REFBdUQ7QUFDcEgsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQgeyBnZXRScGNMYXRlc3RSb3VuZCB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtcmVmZXJlbmNlLWRhdGEtcmVhZGVyJ1xuaW1wb3J0IHsgZ2V0RGVyaXZhdGl2ZXNEYXRhLCBDdXJyZW5jeURlcml2YXRpdmVzRGF0YSB9IGZyb20gJy4vZGVyaXZhdGl2ZXNEYXRhUHJvdmlkZXInXG5pbXBvcnQgeyBTaWdtYUNhbGN1bGF0b3IgfSBmcm9tICcuL3NpZ21hQ2FsY3VsYXRvcidcbmltcG9ydCB7IERlY2ltYWwgfSBmcm9tICdkZWNpbWFsLmpzJ1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnXG5pbXBvcnQgeyBkb21pbmFuY2VCeUN1cnJlbmN5LCBnZXREb21pbmFuY2VBZGFwdGVyIH0gZnJvbSAnLi9kb21pbmFuY2VEYXRhUHJvdmlkZXInXG5pbXBvcnQgeyBBZGFwdGVyQ29udGV4dCwgQWRhcHRlclJlcXVlc3QgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgREVGQVVMVF9ORVRXT1JLIH0gZnJvbSAnLi9jb25maWcnXG5cbmV4cG9ydCBjb25zdCBjYWxjdWxhdGUgPSBhc3luYyAoXG4gIHZhbGlkYXRlZDogUmVjb3JkPHN0cmluZywgYW55PixcbiAgcmVxdWVzdFBhcmFtczogYW55LFxuICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dCxcbik6IFByb21pc2U8bnVtYmVyPiA9PiB7XG4gIGNvbnN0IHtcbiAgICBjb250cmFjdDogb3JhY2xlQWRkcmVzcyxcbiAgICBtdWx0aXBseSA9IDFlMTgsXG4gICAgaGVhcnRiZWF0TWludXRlcyA9IDYwLFxuICAgIGlzQWRhcHRpdmUgPSB0cnVlLFxuICAgIGNyeXB0b0N1cnJlbmNpZXMgPSBbJ0JUQycsICdFVEgnXSxcbiAgICBkZXZpYXRpb25UaHJlc2hvbGQgPSAwLjExLFxuICAgIGxhbWJkYU1pbiA9IDAuMDMxLFxuICAgIGxhbWJkYUsgPSAwLjMxLFxuICAgIG5ldHdvcmsgPSBERUZBVUxUX05FVFdPUkssXG4gIH0gPSB2YWxpZGF0ZWQuZGF0YVxuXG4gIC8vIEdldCBhbGwgb2YgdGhlIHJlcXVpcmVkIGRlcml2YXRpdmVzIGRhdGEgZm9yIHRoZSBjYWxjdWxhdGlvbnMsIGZvciBhbGwgdGhlIHJlbGV2YW50IGN1cnJlbmNpZXNcbiAgY29uc3QgZGVyaXZhdGl2ZXNEYXRhID0gYXdhaXQgZ2V0RGVyaXZhdGl2ZXNEYXRhKGNyeXB0b0N1cnJlbmNpZXMpXG4gIC8vIENhbGN1bGF0ZSB2aXggdmFsdWVzIGZvciBhbGwgY3VycmVuY2llc1xuICBjb25zdCB2b2xhdGlsaXR5SW5kZXhEYXRhID0gYXdhaXQgY2FsY3VsYXRlVml4VmFsdWVzKGRlcml2YXRpdmVzRGF0YSwgY3J5cHRvQ3VycmVuY2llcylcbiAgLy8gQXBwbHkgd2VpZ2h0cyB0byBjYWxjdWxhdGUgdGhlIENyeXB0byBWaXhcbiAgY29uc3Qgd2VpZ2h0ZWRDVkkgPSBhd2FpdCBjYWxjdWxhdGVXZWlnaHRlZChcbiAgICB2b2xhdGlsaXR5SW5kZXhEYXRhLFxuICAgIHZhbGlkYXRlZC5pZCxcbiAgICByZXF1ZXN0UGFyYW1zLFxuICAgIGNvbnRleHQsXG4gICAgY3J5cHRvQ3VycmVuY2llcyxcbiAgKVxuICAvLyBTbW9vdGggQ1ZJIHdpdGggcHJldmlvdXMgb24tY2hhaW4gdmFsdWUgaWYgZXhpc3RzXG4gIGNvbnN0IGN2aSA9ICFpc0FkYXB0aXZlXG4gICAgPyB0b09uQ2hhaW5WYWx1ZSh3ZWlnaHRlZENWSSwgbXVsdGlwbHkpXG4gICAgOiBhd2FpdCBhcHBseVNtb290aGluZyhcbiAgICAgICAgd2VpZ2h0ZWRDVkksXG4gICAgICAgIG9yYWNsZUFkZHJlc3MsXG4gICAgICAgIG11bHRpcGx5LFxuICAgICAgICBoZWFydGJlYXRNaW51dGVzLFxuICAgICAgICBkZXZpYXRpb25UaHJlc2hvbGQsXG4gICAgICAgIGxhbWJkYU1pbixcbiAgICAgICAgbGFtYmRhSyxcbiAgICAgICAgbmV0d29yayxcbiAgICAgIClcblxuICBMb2dnZXIuaW5mbyhgQ1ZJOiAke2N2aX1gKVxuICB2YWxpZGF0ZUluZGV4KGN2aSlcbiAgcmV0dXJuIGN2aVxufVxuXG5jb25zdCBjYWxjdWxhdGVWaXhWYWx1ZXMgPSBhc3luYyAoXG4gIGRlcml2YXRpdmVzRGF0YTogUmVjb3JkPHN0cmluZywgQ3VycmVuY3lEZXJpdmF0aXZlc0RhdGE+LFxuICBjcnlwdG9DdXJyZW5jaWVzOiBzdHJpbmdbXSxcbikgPT4ge1xuICBjb25zdCBub3cgPSBtb21lbnQoKS51dGMoKS51bml4KClcbiAgY29uc3Qgc2lnbWFDYWxjdWxhdG9yID0gbmV3IFNpZ21hQ2FsY3VsYXRvcigpXG4gIGNvbnN0IHZpeFZhbHVlcyA9IGNyeXB0b0N1cnJlbmNpZXMubWFwKChjdXJyZW5jeSkgPT4ge1xuICAgIHNpZ21hQ2FsY3VsYXRvci5zb3J0QnlTdHJpa2VQcmljZShkZXJpdmF0aXZlc0RhdGFbY3VycmVuY3ldKVxuICAgIGNvbnN0IHsgZTEsIGUyLCBleGNoYW5nZVJhdGUsIGNhbGxzRTEsIHB1dHNFMSwgY2FsbHNFMiwgcHV0c0UyIH0gPSBkZXJpdmF0aXZlc0RhdGFbY3VycmVuY3ldXG4gICAgY29uc3Qgd2VpZ2h0ZWRTaWdtYTogRGVjaW1hbCA9IHNpZ21hQ2FsY3VsYXRvci53ZWlnaHRlZFNpZ21hKHtcbiAgICAgIGUxLFxuICAgICAgZTIsXG4gICAgICBzaWdtYTE6IHNpZ21hQ2FsY3VsYXRvci5vbmVTaWdtYShlMSwgZXhjaGFuZ2VSYXRlLCBjYWxsc0UxLCBwdXRzRTEsIG5vdyksXG4gICAgICBzaWdtYTI6IHNpZ21hQ2FsY3VsYXRvci5vbmVTaWdtYShlMiwgZXhjaGFuZ2VSYXRlLCBjYWxsc0UyLCBwdXRzRTIsIG5vdyksXG4gICAgICBub3csXG4gICAgfSlcbiAgICByZXR1cm4gd2VpZ2h0ZWRTaWdtYS5zcXJ0KCkudGltZXMoMTAwKVxuICB9KVxuXG4gIHJldHVybiB2aXhWYWx1ZXNcbn1cblxuY29uc3QgY2FsY3VsYXRlV2VpZ2h0ZWQgPSBhc3luYyAoXG4gIHZpeERhdGE6IEFycmF5PERlY2ltYWw+LFxuICBpZDogc3RyaW5nLFxuICByZXF1ZXN0UGFyYW1zOiBhbnksXG4gIGNvbnRleHQ6IEFkYXB0ZXJDb250ZXh0LFxuICBjcnlwdG9DdXJyZW5jaWVzOiBzdHJpbmdbXSxcbikgPT4ge1xuICBjb25zdCBkb21pbmFuY2VCeUN1cnJlbmN5ID0gYXdhaXQgZ2V0RG9taW5hbmNlQnlDdXJyZW5jeShcbiAgICBpZCxcbiAgICByZXF1ZXN0UGFyYW1zLFxuICAgIGNvbnRleHQsXG4gICAgY3J5cHRvQ3VycmVuY2llcyxcbiAgKVxuICBjb25zdCB3ZWlnaHRlZFZpeCA9IGNyeXB0b0N1cnJlbmNpZXMucmVkdWNlKCh2aXgsIGN1cnJlbmN5LCBpZHgpID0+IHtcbiAgICBjb25zdCBkb21pbmFuY2UgPSBkb21pbmFuY2VCeUN1cnJlbmN5W2N1cnJlbmN5XVxuICAgIGlmICghZG9taW5hbmNlKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGRvbWluYW5jZSBmb3VuZCBmb3IgY3VycmVuY3kgJHtjdXJyZW5jeX1gKVxuICAgIGNvbnN0IGN1cnJlbmN5Vml4ID0gbmV3IERlY2ltYWwodml4RGF0YVtpZHhdKVxuICAgIC8vIFdlaWdodCBieSBkb21pbmFuY2VcbiAgICB2aXggPSB2aXgucGx1cyhjdXJyZW5jeVZpeC50aW1lcyhuZXcgRGVjaW1hbChkb21pbmFuY2UpKSlcbiAgICByZXR1cm4gdml4XG4gIH0sIG5ldyBEZWNpbWFsKDApKVxuXG4gIGNvbnN0IHdlaWdodGVkID0gTnVtYmVyKHdlaWdodGVkVml4LnRvRml4ZWQoKSlcbiAgTG9nZ2VyLmRlYnVnKGBXZWlnaHRlZCB2b2xhdGlsaXR5IGluZGV4OiR7d2VpZ2h0ZWR9YClcbiAgcmV0dXJuIHdlaWdodGVkXG59XG5cbmNvbnN0IGdldERvbWluYW5jZUJ5Q3VycmVuY3kgPSBhc3luYyAoXG4gIGlkOiBzdHJpbmcsXG4gIHJlcXVlc3RQYXJhbXM6IGFueSxcbiAgY29udGV4dDogQWRhcHRlckNvbnRleHQsXG4gIGNyeXB0b0N1cnJlbmNpZXM6IHN0cmluZ1tdLFxuKSA9PiB7XG4gIGNvbnN0IGRvbWluYW5jZUFkYXB0ZXIgPSBhd2FpdCBnZXREb21pbmFuY2VBZGFwdGVyKClcbiAgY29uc3QgYWxsb2NhdGlvbnMgPSBjcnlwdG9DdXJyZW5jaWVzLm1hcCgoc3ltYm9sKSA9PiB7XG4gICAgcmV0dXJuIHsgc3ltYm9sIH1cbiAgfSlcbiAgY29uc3QgcXVvdGUgPSAnVVNEJ1xuICBjb25zdCBpbnB1dDogQWRhcHRlclJlcXVlc3QgPSB7XG4gICAgaWQ6IGlkLFxuICAgIGRhdGE6IHtcbiAgICAgIC4uLnJlcXVlc3RQYXJhbXMsXG4gICAgICBhbGxvY2F0aW9ucyxcbiAgICAgIHF1b3RlLFxuICAgIH0sXG4gIH1cbiAgY29uc3QgZG9taW5hbmNlRGF0YSA9IGF3YWl0IGRvbWluYW5jZUFkYXB0ZXIoaW5wdXQsIGNvbnRleHQpXG4gIHJldHVybiBkb21pbmFuY2VCeUN1cnJlbmN5KGRvbWluYW5jZURhdGEuZGF0YSwgcXVvdGUpXG59XG5cbmNvbnN0IGFwcGx5U21vb3RoaW5nID0gYXN5bmMgKFxuICB3ZWlnaHRlZENWSTogbnVtYmVyLFxuICBvcmFjbGVBZGRyZXNzOiBzdHJpbmcsXG4gIG11bHRpcGx5OiBudW1iZXIsXG4gIGhlYXJ0QmVhdE1pbnV0ZXM6IG51bWJlcixcbiAgZGV2aWF0aW9uVGhyZXNob2xkOiBudW1iZXIsXG4gIGxhbWJkYU1pbjogbnVtYmVyLFxuICBsYW1iZGFLOiBudW1iZXIsXG4gIG5ldHdvcms6IHN0cmluZyxcbik6IFByb21pc2U8bnVtYmVyPiA9PiB7XG4gIGNvbnN0IHJvdW5kRGF0YSA9IGF3YWl0IGdldFJwY0xhdGVzdFJvdW5kKG5ldHdvcmssIG9yYWNsZUFkZHJlc3MpXG4gIGNvbnN0IGxhdGVzdEluZGV4ID0gbmV3IERlY2ltYWwocm91bmREYXRhLmFuc3dlci50b1N0cmluZygpKS5kaXYobXVsdGlwbHkpXG4gIGNvbnN0IHVwZGF0ZWRBdCA9IHJvdW5kRGF0YS51cGRhdGVkQXQubXVsKDEwMDApLnRvTnVtYmVyKClcblxuICBpZiAobGF0ZXN0SW5kZXgubHRlKDApKSB7XG4gICAgTG9nZ2VyLndhcm4oJ05vIG9uLWNoYWluIGluZGV4IHZhbHVlIGZvdW5kIC0gSXMgZmlyc3QgcnVuIG9mIGFkYXB0ZXI/JylcbiAgICByZXR1cm4gd2VpZ2h0ZWRDVklcbiAgfVxuXG4gIGNvbnN0IG5vdyA9IG1vbWVudCgpLnV0YygpXG4gIGNvbnN0IGR0U2Vjb25kcyA9IG1vbWVudC5kdXJhdGlvbihub3cuZGlmZih1cGRhdGVkQXQpKS5hc1NlY29uZHMoKVxuICBpZiAoZHRTZWNvbmRzIDwgMCkge1xuICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCB0aW1lLCBwbGVhc2UgY2hlY2sgdGhlIG5vZGUgY2xvY2snKVxuICB9XG5cbiAgY29uc3QgZCA9IE1hdGguYWJzKGxhdGVzdEluZGV4LnRvTnVtYmVyKCkgLyB3ZWlnaHRlZENWSSAtIDEpXG4gIGNvbnN0IGwgPVxuICAgIGQgPj0gZGV2aWF0aW9uVGhyZXNob2xkID8gbGFtYmRhTWluIDogbGFtYmRhKGR0U2Vjb25kcywgaGVhcnRCZWF0TWludXRlcywgbGFtYmRhTWluLCBsYW1iZGFLKVxuICBjb25zdCBzbW9vdGhlZCA9IGxhdGVzdEluZGV4Lm11bChuZXcgRGVjaW1hbCgxIC0gbCkpLmFkZChuZXcgRGVjaW1hbCh3ZWlnaHRlZENWSSkubXVsKGwpKVxuICBMb2dnZXIuZGVidWcoYFByZXZpb3VzIHZhbHVlOiR7bGF0ZXN0SW5kZXh9LCB1cGRhdGVkQXQ6JHt1cGRhdGVkQXR9LCBkdFNlY29uZHM6JHtkdFNlY29uZHN9YClcbiAgcmV0dXJuIHNtb290aGVkLnRvTnVtYmVyKClcbn1cblxuY29uc3QgbGFtYmRhID0gZnVuY3Rpb24gKHQ6IG51bWJlciwgaGVhcnRCZWF0TWludXRlczogbnVtYmVyLCBsYW1iZGFNaW46IG51bWJlciwgbGFtYmRhSzogbnVtYmVyKSB7XG4gIGNvbnN0IFQgPSBtb21lbnQuZHVyYXRpb24oaGVhcnRCZWF0TWludXRlcywgJ21pbnV0ZXMnKS5hc1NlY29uZHMoKVxuICByZXR1cm4gbGFtYmRhTWluICsgKGxhbWJkYUsgKiBNYXRoLm1pbih0LCBUKSkgLyBUXG59XG5cbmNvbnN0IE1BWF9JTkRFWCA9IDIwMFxuY29uc3QgdmFsaWRhdGVJbmRleCA9IGZ1bmN0aW9uIChjdmk6IG51bWJlcikge1xuICBpZiAoY3ZpIDw9IDAgfHwgY3ZpID4gTUFYX0lOREVYKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGNhbGN1bGF0ZWQgaW5kZXggdmFsdWUnKVxuICB9XG59XG5cbmNvbnN0IHRvT25DaGFpblZhbHVlID0gZnVuY3Rpb24gKGN2aTogbnVtYmVyLCBtdWx0aXBseTogbnVtYmVyKSB7XG4gIHJldHVybiBOdW1iZXIoY3ZpLnRvRml4ZWQobXVsdGlwbHkudG9TdHJpbmcoKS5sZW5ndGggLSAxKSkgLy8gS2VlcCBkZWNpbWFsIHByZWNpc2lvbiBpbiBzYW1lIG1hZ25pdHVkZSBhcyBtdWx0aXBseVxufVxuIl19