"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDerivativesData = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const moment_1 = tslib_1.__importDefault(require("moment"));
const decimal_js_1 = require("decimal.js");
const EXCHANGE_URL = `https://www.deribit.com/api/v2/public`;
const currencyEndpoint = `${EXCHANGE_URL}/get_index`;
const bookDataEndpoint = `${EXCHANGE_URL}/get_book_summary_by_currency`;
const instrumentEndpoint = `${EXCHANGE_URL}/get_instruments`;
const expirationHour = 8;
const getDerivativesData = async (cryptoCurrencies) => {
    const currencyValues = await Promise.all(cryptoCurrencies.map(async (currency) => {
        return await getCurrencyData(currency);
    }));
    ea_bootstrap_1.Logger.debug('currencyValues:', currencyValues);
    const optionsData = await Promise.all(cryptoCurrencies.map(async (currency, index) => {
        return await getOptionsData(currency, new decimal_js_1.Decimal(currencyValues[index]));
    }));
    // Return derivatives data mapped by currency
    return optionsData.reduce((obj, data, idx) => {
        obj[cryptoCurrencies[idx]] = data;
        return obj;
    }, {});
};
exports.getDerivativesData = getDerivativesData;
const getCurrencyData = async (currency) => {
    const config = {
        url: currencyEndpoint,
        params: { currency },
    };
    const response = await ea_bootstrap_1.Requester.request(config);
    const path = ['result', currency];
    return ea_bootstrap_1.Requester.validateResultNumber(response.data, path);
};
const getInstrumentData = async (currency) => {
    const config = {
        url: instrumentEndpoint,
        params: { currency },
    };
    const response = await ea_bootstrap_1.Requester.request(config);
    return response.data.result;
};
const olderThanHour = (instrumentName, hourAgo, instruments) => {
    for (const instrument of instruments) {
        if (instrument.instrument_name === instrumentName) {
            return hourAgo > instrument.creation_timestamp;
        }
    }
    return false;
};
const getOptionsData = async (currency, exchangeRate) => {
    const config = {
        url: bookDataEndpoint,
        params: { currency, kind: 'option' },
    };
    try {
        const response = await ea_bootstrap_1.Requester.request(config);
        const result = response.data.result;
        const calls = {};
        const puts = {};
        const instruments = await getInstrumentData(currency);
        const hourAgo = moment_1.default().utc().subtract(1, 'hours').unix() * 1000;
        result.map(convertToOptionData).forEach((optionData) => {
            const { instrumentName, expiration, type } = optionData;
            if (olderThanHour(instrumentName, hourAgo, instruments) &&
                moment_1.default.unix(expiration).weekday() == 5) {
                if (type === 'C') {
                    if (!calls[expiration])
                        calls[expiration] = [];
                    calls[expiration].push(optionData);
                }
                else if (type === 'P') {
                    if (!puts[expiration])
                        puts[expiration] = [];
                    puts[expiration].push(optionData);
                }
                else {
                    throw new Error(`Invalid option type:${type}`);
                }
            }
        });
        const { e1, e2 } = findNearMonthExpirations(calls);
        ea_bootstrap_1.Logger.debug(`e1:${e1},e2:${e2}`);
        ea_bootstrap_1.Logger.debug(`exchangeRate:${exchangeRate}`);
        return {
            e1: e1 + expirationHour * 60 * 60,
            e2: e2 + expirationHour * 60 * 60,
            callsE1: calls[e1],
            callsE2: calls[e2],
            putsE1: puts[e1],
            putsE2: puts[e2],
            exchangeRate,
        };
    }
    catch (error) {
        ea_bootstrap_1.Logger.error(error);
        ea_bootstrap_1.Logger.error(error.stack);
        throw new ea_bootstrap_1.AdapterError(error);
    }
};
function findNearMonthExpirations(calls) {
    const e30 = moment_1.default().utc().add(30, 'days').subtract(expirationHour, 'hours').unix();
    let e1;
    let e2;
    // Find last expiration before a full month && first expiration after a full month
    Object.keys(calls).forEach((expirationDate) => {
        const e = +expirationDate;
        if (e <= e30) {
            if (!e1 || e1 < e) {
                e1 = e;
            }
        }
        else if (e > e30) {
            if (!e2 || e2 > e) {
                e2 = e;
            }
        }
    });
    if (!e1)
        throw new Error('Could not find an expiration date before a full month');
    if (!e2)
        throw new Error('Could not find an expiration date after a full month');
    ea_bootstrap_1.Logger.debug(`e1:${e1} e2:${e2}`);
    return { e1, e2 };
}
function convertToOptionData(option) {
    const { instrument_name, mid_price, underlying_price } = option;
    const [, expiration, strikePrice, type] = instrument_name.split('-');
    const optionData = {
        instrumentName: instrument_name,
        strikePrice: new decimal_js_1.Decimal(strikePrice),
        midPrice: mid_price ? new decimal_js_1.Decimal(mid_price) : undefined,
        underlyingPrice: new decimal_js_1.Decimal(underlying_price),
        expiration: moment_1.default.utc(expiration, 'DDMMMYY').unix(),
        type,
    };
    return optionData;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVyaXZhdGl2ZXNEYXRhUHJvdmlkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvZGVyaXZhdGl2ZXNEYXRhUHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLDBEQUF5RTtBQUN6RSw0REFBMkI7QUFDM0IsMkNBQW9DO0FBRXBDLE1BQU0sWUFBWSxHQUFHLHVDQUF1QyxDQUFBO0FBQzVELE1BQU0sZ0JBQWdCLEdBQUcsR0FBRyxZQUFZLFlBQVksQ0FBQTtBQUNwRCxNQUFNLGdCQUFnQixHQUFHLEdBQUcsWUFBWSwrQkFBK0IsQ0FBQTtBQUN2RSxNQUFNLGtCQUFrQixHQUFHLEdBQUcsWUFBWSxrQkFBa0IsQ0FBQTtBQUM1RCxNQUFNLGNBQWMsR0FBRyxDQUFDLENBQUE7QUFnQ2pCLE1BQU0sa0JBQWtCLEdBQUcsS0FBSyxFQUNyQyxnQkFBK0IsRUFDbUIsRUFBRTtJQUNwRCxNQUFNLGNBQWMsR0FBRyxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQ3RDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsUUFBZ0IsRUFBRSxFQUFFO1FBQzlDLE9BQU8sTUFBTSxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDeEMsQ0FBQyxDQUFDLENBQ0gsQ0FBQTtJQUVELHFCQUFNLENBQUMsS0FBSyxDQUFDLGlCQUFpQixFQUFFLGNBQWMsQ0FBQyxDQUFBO0lBQy9DLE1BQU0sV0FBVyxHQUFHLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDbkMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxRQUFnQixFQUFFLEtBQWEsRUFBRSxFQUFFO1FBQzdELE9BQU8sTUFBTSxjQUFjLENBQUMsUUFBUSxFQUFFLElBQUksb0JBQU8sQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzNFLENBQUMsQ0FBQyxDQUNILENBQUE7SUFDRCw2Q0FBNkM7SUFDN0MsT0FBTyxXQUFXLENBQUMsTUFBTSxD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QUUsQ0FBQyxDQUFBO0lBQ2pDLE9BQU8sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUE7QUFDbkIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsTUFBaUM7SUFDNUQsTUFBTSxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsZ0JBQWdCLEVBQUUsR0FBRyxNQUFNLENBQUE7SUFDL0QsTUFBTSxDQUFDLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsR0FBRyxlQUFlLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3BFLE1BQU0sVUFBVSxHQUFlO1FBQzdCLGNBQWMsRUFBRSxlQUFlO1FBQy9CLFdBQVcsRUFBRSxJQUFJLG9CQUFPLENBQUMsV0FBVyxDQUFDO1FBQ3JDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksb0JBQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUztRQUN4RCxlQUFlLEVBQUUsSUFBSSxvQkFBTyxDQUFDLGdCQUFnQixDQUFDO1FBQzlDLFVBQVUsRUFBRSxnQkFBTSxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsU0FBUyxDQUFDLENBQUMsSUFBSSxFQUFFO1FBQ3BELElBQUk7S0FDTCxDQUFBO0lBRUQsT0FBTyxVQUFVLENBQUE7QUFDbkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFkYXB0ZXJFcnJvciwgUmVxdWVzdGVyLCBMb2dnZXIgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCBtb21lbnQgZnJvbSAnbW9tZW50J1xuaW1wb3J0IHsgRGVjaW1hbCB9IGZyb20gJ2RlY2ltYWwuanMnXG5cbmNvbnN0IEVYQ0hBTkdFX1VSTCA9IGBodHRwczovL3d3dy5kZXJpYml0LmNvbS9hcGkvdjIvcHVibGljYFxuY29uc3QgY3VycmVuY3lFbmRwb2ludCA9IGAke0VYQ0hBTkdFX1VSTH0vZ2V0X2luZGV4YFxuY29uc3QgYm9va0RhdGFFbmRwb2ludCA9IGAke0VYQ0hBTkdFX1VSTH0vZ2V0X2Jvb2tfc3VtbWFyeV9ieV9jdXJyZW5jeWBcbmNvbnN0IGluc3RydW1lbnRFbmRwb2ludCA9IGAke0VYQ0hBTkdFX1VSTH0vZ2V0X2luc3RydW1lbnRzYFxuY29uc3QgZXhwaXJhdGlvbkhvdXIgPSA4XG5cbmV4cG9ydCB0eXBlIERlcmliaXRPcHRpb25EYXRhUmVzcG9uc2UgPSB7XG4gIGluc3RydW1lbnRfbmFtZTogc3RyaW5nXG4gIG1pZF9wcmljZTogc3RyaW5nXG4gIHVuZGVybHlpbmdfcHJpY2U6IG51bWJlclxufVxuXG5leHBvcnQgdHlwZSBPcHRpb25EYXRhID0ge1xuICBpbnN0cnVtZW50TmFtZTogc3RyaW5nXG4gIHN0cmlrZVByaWNlOiBEZWNpbWFsXG4gIG1pZFByaWNlOiBEZWNpbWFsIHwgdW5kZWZpbmVkXG4gIHVuZGVybHlpbmdQcmljZTogRGVjaW1hbFxuICBleHBpcmF0aW9uOiBudW1iZXJcbiAgdHlwZTogc3RyaW5nXG59XG5cbmV4cG9ydCB0eXBlIEN1cnJlbmN5RGVyaXZhdGl2ZXNEYXRhID0ge1xuICBlMTogbnVtYmVyXG4gIGUyOiBudW1iZXJcbiAgY2FsbHNFMTogQXJyYXk8T3B0aW9uRGF0YT5cbiAgY2FsbHNFMjogQXJyYXk8T3B0aW9uRGF0YT5cbiAgcHV0c0UxOiBBcnJheTxPcHRpb25EYXRhPlxuICBwdXRzRTI6IEFycmF5PE9wdGlvbkRhdGE+XG4gIGV4Y2hhbmdlUmF0ZTogRGVjaW1hbFxufVxuXG5leHBvcnQgdHlwZSBJbnN0cnVtZW50RGF0YSA9IHtcbiAgaW5zdHJ1bWVudF9uYW1lOiBzdHJpbmdcbiAgY3JlYXRpb25fdGltZXN0YW1wOiBudW1iZXJcbn1cblxuZXhwb3J0IGNvbnN0IGdldERlcml2YXRpdmVzRGF0YSA9IGFzeW5jIChcbiAgY3J5cHRvQ3VycmVuY2llczogQXJyYXk8c3RyaW5nPixcbik6IFByb21pc2U8UmVjb3JkPHN0cmluZywgQ3VycmVuY3lEZXJpdmF0aXZlc0RhdGE+PiA9PiB7XG4gIGNvbnN0IGN1cnJlbmN5VmFsdWVzID0gYXdhaXQgUHJvbWlzZS5hbGwoXG4gICAgY3J5cHRvQ3VycmVuY2llcy5tYXAoYXN5bmMgKGN1cnJlbmN5OiBzdHJpbmcpID0+IHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRDdXJyZW5jeURhdGEoY3VycmVuY3kpXG4gICAgfSksXG4gIClcblxuICBMb2dnZXIuZGVidWcoJ2N1cnJlbmN5VmFsdWVzOicsIGN1cnJlbmN5VmFsdWVzKVxuICBjb25zdCBvcHRpb25zRGF0YSA9IGF3YWl0IFByb21pc2UuYWxsKFxuICAgIGNyeXB0b0N1cnJlbmNpZXMubWFwKGFzeW5jIChjdXJyZW5jeTogc3RyaW5nLCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICByZXR1cm4gYXdhaXQgZ2V0T3B0aW9uc0RhdGEoY3VycmVuY3ksIG5ldyBEZWNpbWFsKGN1cnJlbmN5VmFsdWVzW2luZGV4XSkpXG4gICAgfSksXG4gIClcbiAgLy8gUmV0dXJuIGRlcml2YXRpdmVzIGRhdGEgbWFwcGVkIGJ5IGN1cnJlbmN5XG4gIHJldHVybiBvcHRpb25zRGF0YS5yZWR1Y2UoKG9iajogUmVjb3JkPHN0cmluZywgQ3VycmVuY3lEZXJpdmF0aXZlc0RhdGE+LCBkYXRhLCBpZHgpID0+IHtcbiAgICBvYmpbY3J5cHRvQ3VycmVuY2llc1tpZHhdXSA9IGRhdGFcbiAgICByZXR1cm4gb2JqXG4gIH0sIHt9KVxufVxuXG5jb25zdCBnZXRDdXJyZW5jeURhdGEgPSBhc3luYyAoY3VycmVuY3k6IHN0cmluZykgPT4ge1xuICBjb25zdCBjb25maWcgPSB7XG4gICAgdXJsOiBjdXJyZW5jeUVuZHBvaW50LFxuICAgIHBhcmFtczogeyBjdXJyZW5jeSB9LFxuICB9XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUmVxdWVzdGVyLnJlcXVlc3QoY29uZmlnKVxuICBjb25zdCBwYXRoID0gWydyZXN1bHQnLCBjdXJyZW5jeV1cbiAgcmV0dXJuIFJlcXVlc3Rlci52YWxpZGF0ZVJlc3VsdE51bWJlcihyZXNwb25zZS5kYXRhLCBwYXRoKVxufVxuXG5jb25zdCBnZXRJbnN0cnVtZW50RGF0YSA9IGFzeW5jIChjdXJyZW5jeTogc3RyaW5nKSA9PiB7XG4gIGNvbnN0IGNvbmZpZyA9IHtcbiAgICB1cmw6IGluc3RydW1lbnRFbmRwb2ludCxcbiAgICBwYXJhbXM6IHsgY3VycmVuY3kgfSxcbiAgfVxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFJlcXVlc3Rlci5yZXF1ZXN0KGNvbmZpZylcbiAgcmV0dXJuIHJlc3BvbnNlLmRhdGEucmVzdWx0XG59XG5cbmNvbnN0IG9sZGVyVGhhbkhvdXIgPSAoXG4gIGluc3RydW1lbnROYW1lOiBzdHJpbmcsXG4gIGhvdXJBZ286IG51bWJlcixcbiAgaW5zdHJ1bWVudHM6IEFycmF5PEluc3RydW1lbnREYXRhPixcbik6IGJvb2xlYW4gPT4ge1xuICBmb3IgKGNvbnN0IGluc3RydW1lbnQgb2YgaW5zdHJ1bWVudHMpIHtcbiAgICBpZiAoaW5zdHJ1bWVudC5pbnN0cnVtZW50X25hbWUgPT09IGluc3RydW1lbnROYW1lKSB7XG4gICAgICByZXR1cm4gaG91ckFnbyA+IGluc3RydW1lbnQuY3JlYXRpb25fdGltZXN0YW1wXG4gICAgfVxuICB9XG4gIHJldHVybiBmYWxzZVxufVxuXG5jb25zdCBnZXRPcHRpb25zRGF0YSA9IGFzeW5jIChjdXJyZW5jeTogc3RyaW5nLCBleGNoYW5nZVJhdGU6IERlY2ltYWwpID0+IHtcbiAgY29uc3QgY29uZmlnID0ge1xuICAgIHVybDogYm9va0RhdGFFbmRwb2ludCxcbiAgICBwYXJhbXM6IHsgY3VycmVuY3ksIGtpbmQ6ICdvcHRpb24nIH0sXG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUmVxdWVzdGVyLnJlcXVlc3QoY29uZmlnKVxuICAgIGNvbnN0IHJlc3VsdCA9IHJlc3BvbnNlLmRhdGEucmVzdWx0XG4gICAgY29uc3QgY2FsbHM6IFJlY29yZDxudW1iZXIsIEFycmF5PE9wdGlvbkRhdGE+PiA9IHt9XG4gICAgY29uc3QgcHV0czogUmVjb3JkPG51bWJlciwgQXJyYXk8T3B0aW9uRGF0YT4+ID0ge31cbiAgICBjb25zdCBpbnN0cnVtZW50czogQXJyYXk8SW5zdHJ1bWVudERhdGE+ID0gYXdhaXQgZ2V0SW5zdHJ1bWVudERhdGEoY3VycmVuY3kpXG4gICAgY29uc3QgaG91ckFnbyA9IG1vbWVudCgpLnV0YygpLnN1YnRyYWN0KDEsICdob3VycycpLnVuaXgoKSAqIDEwMDBcblxuICAgIHJlc3VsdC5tYXAoY29udmVydFRvT3B0aW9uRGF0YSkuZm9yRWFjaCgob3B0aW9uRGF0YTogT3B0aW9uRGF0YSkgPT4ge1xuICAgICAgY29uc3QgeyBpbnN0cnVtZW50TmFtZSwgZXhwaXJhdGlvbiwgdHlwZSB9ID0gb3B0aW9uRGF0YVxuICAgICAgaWYgKFxuICAgICAgICBvbGRlclRoYW5Ib3VyKGluc3RydW1lbnROYW1lLCBob3VyQWdvLCBpbnN0cnVtZW50cykgJiZcbiAgICAgICAgbW9tZW50LnVuaXgoZXhwaXJhdGlvbikud2Vla2RheSgpID09IDVcbiAgICAgICkge1xuICAgICAgICBpZiAodHlwZSA9PT0gJ0MnKSB7XG4gICAgICAgICAgaWYgKCFjYWxsc1tleHBpcmF0aW9uXSkgY2FsbHNbZXhwaXJhdGlvbl0gPSBbXVxuICAgICAgICAgIGNhbGxzW2V4cGlyYXRpb25dLnB1c2gob3B0aW9uRGF0YSlcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAnUCcpIHtcbiAgICAgICAgICBpZiAoIXB1dHNbZXhwaXJhdGlvbl0pIHB1dHNbZXhwaXJhdGlvbl0gPSBbXVxuICAgICAgICAgIHB1dHNbZXhwaXJhdGlvbl0ucHVzaChvcHRpb25EYXRhKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBvcHRpb24gdHlwZToke3R5cGV9YClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG5cbiAgICBjb25zdCB7IGUxLCBlMiB9ID0gZmluZE5lYXJNb250aEV4cGlyYXRpb25zKGNhbGxzKVxuXG4gICAgTG9nZ2VyLmRlYnVnKGBlMToke2UxfSxlMjoke2UyfWApXG4gICAgTG9nZ2VyLmRlYnVnKGBleGNoYW5nZVJhdGU6JHtleGNoYW5nZVJhdGV9YClcblxuICAgIHJldHVybiB7XG4gICAgICBlMTogZTEgKyBleHBpcmF0aW9uSG91ciAqIDYwICogNjAsXG4gICAgICBlMjogZTIgKyBleHBpcmF0aW9uSG91ciAqIDYwICogNjAsXG4gICAgICBjYWxsc0UxOiBjYWxsc1tlMV0sXG4gICAgICBjYWxsc0UyOiBjYWxsc1tlMl0sXG4gICAgICBwdXRzRTE6IHB1dHNbZTFdLFxuICAgICAgcHV0c0UyOiBwdXRzW2UyXSxcbiAgICAgIGV4Y2hhbmdlUmF0ZSxcbiAgICB9XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgTG9nZ2VyLmVycm9yKGVycm9yKVxuICAgIExvZ2dlci5lcnJvcihlcnJvci5zdGFjaylcbiAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKGVycm9yKVxuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmROZWFyTW9udGhFeHBpcmF0aW9ucyhjYWxsczogUmVjb3JkPG51bWJlciwgQXJyYXk8T3B0aW9uRGF0YT4+KSB7XG4gIGNvbnN0IGUzMCA9IG1vbWVudCgpLnV0YygpLmFkZCgzMCwgJ2RheXMnKS5zdWJ0cmFjdChleHBpcmF0aW9uSG91ciwgJ2hvdXJzJykudW5peCgpXG4gIGxldCBlMTogbnVtYmVyIHwgdW5kZWZpbmVkXG4gIGxldCBlMjogbnVtYmVyIHwgdW5kZWZpbmVkXG5cbiAgLy8gRmluZCBsYXN0IGV4cGlyYXRpb24gYmVmb3JlIGEgZnVsbCBtb250aCAmJiBmaXJzdCBleHBpcmF0aW9uIGFmdGVyIGEgZnVsbCBtb250aFxuICBPYmplY3Qua2V5cyhjYWxscykuZm9yRWFjaCgoZXhwaXJhdGlvbkRhdGUpID0+IHtcbiAgICBjb25zdCBlID0gK2V4cGlyYXRpb25EYXRlXG4gICAgaWYgKGUgPD0gZTMwKSB7XG4gICAgICBpZiAoIWUxIHx8IGUxIDwgZSkge1xuICAgICAgICBlMSA9IGVcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGUgPiBlMzApIHtcbiAgICAgIGlmICghZTIgfHwgZTIgPiBlKSB7XG4gICAgICAgIGUyID0gZVxuICAgICAgfVxuICAgIH1cbiAgfSlcblxuICBpZiAoIWUxKSB0aHJvdyBuZXcgRXJyb3IoJ0NvdWxkIG5vdCBmaW5kIGFuIGV4cGlyYXRpb24gZGF0ZSBiZWZvcmUgYSBmdWxsIG1vbnRoJylcbiAgaWYgKCFlMikgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBhbiBleHBpcmF0aW9uIGRhdGUgYWZ0ZXIgYSBmdWxsIG1vbnRoJylcbiAgTG9nZ2VyLmRlYnVnKGBlMToke2UxfSBlMjoke2UyfWApXG4gIHJldHVybiB7IGUxLCBlMiB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRUb09wdGlvbkRhdGEob3B0aW9uOiBEZXJpYml0T3B0aW9uRGF0YVJlc3BvbnNlKSB7XG4gIGNvbnN0IHsgaW5zdHJ1bWVudF9uYW1lLCBtaWRfcHJpY2UsIHVuZGVybHlpbmdfcHJpY2UgfSA9IG9wdGlvblxuICBjb25zdCBbLCBleHBpcmF0aW9uLCBzdHJpa2VQcmljZSwgdHlwZV0gPSBpbnN0cnVtZW50X25hbWUuc3BsaXQoJy0nKVxuICBjb25zdCBvcHRpb25EYXRhOiBPcHRpb25EYXRhID0ge1xuICAgIGluc3RydW1lbnROYW1lOiBpbnN0cnVtZW50X25hbWUsXG4gICAgc3RyaWtlUHJpY2U6IG5ldyBEZWNpbWFsKHN0cmlrZVByaWNlKSxcbiAgICBtaWRQcmljZTogbWlkX3ByaWNlID8gbmV3IERlY2ltYWwobWlkX3ByaWNlKSA6IHVuZGVmaW5lZCxcbiAgICB1bmRlcmx5aW5nUHJpY2U6IG5ldyBEZWNpbWFsKHVuZGVybHlpbmdfcHJpY2UpLFxuICAgIGV4cGlyYXRpb246IG1vbWVudC51dGMoZXhwaXJhdGlvbiwgJ0RETU1NWVknKS51bml4KCksXG4gICAgdHlwZSxcbiAgfVxuXG4gIHJldHVybiBvcHRpb25EYXRhXG59XG4iXX0=