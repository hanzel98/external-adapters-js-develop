"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.constructJsonTree = exports.constructMerkleTree = exports.hashFn = exports.keccakReward = exports.calcMarketMakerRewards = exports.calcTraderRewards = exports.calcRetroactiveRewards = exports.calculateRewards = exports.execute = exports.deconstructJsonTree = exports.NAME = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const ethers_1 = require("ethers");
const contracts_1 = require("../contracts");
const ipfs_data_1 = require("../ipfs-data");
const IPFS = tslib_1.__importStar(require("@chainlink/ipfs-adapter"));
const merkletreejs_1 = require("merkletreejs");
const bn = tslib_1.__importStar(require("bignumber.js"));
exports.NAME = 'poke';
const deconstructJsonTree = (data) => {
    const res = {};
    for (const datum of data) {
        res[datum[0]] = ethers_1.BigNumber.from(datum[1]);
    }
    return res;
};
exports.deconstructJsonTree = deconstructJsonTree;
const customParams = {
    traderRewardsAmount: false,
    marketMakerRewardsAmount: false,
    ipnsName: true,
    traderScoreAlpha: true,
    callbackAddress: true,
    newEpoch: true,
    activeRootIpfsCid: true,
};
const parseAddress = (address) => {
    if (address.length === 42 && address.substring(0, 2) === '0x')
        return address;
    const buf = Buffer.from(address, 'base64');
    return `0x${buf.toString('hex').slice(-40)}`;
};
const execute = async (input, context, config) => {
    const validator = new ea_bootstrap_1.Validator(input, customParams);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.jobRunID;
    let traderRewardsAmount = new bn.BigNumber(config.traderRewardsAmount);
    let marketMakerRewardsAmount = new bn.BigNumber(config.marketMakerRewardsAmount);
    // Account for CBOR encoding issue
    if (validator.validated.data.marketMakerRewardsAmount &&
        validator.validated.data.marketMakerRewardsAmount !== 'traderRewardsAmount') {
        marketMakerRewardsAmount = new bn.BigNumber(validator.validated.data.marketMakerRewardsAmount);
    }
    if (validator.validated.data.traderRewardsAmount) {
        traderRewardsAmount = new bn.BigNumber(validator.validated.data.traderRewardsAmount);
    }
    const ipnsName = validator.validated.data.ipnsName;
    const traderScoreAlpha = new bn.BigNumber(validator.validated.data.traderScoreAlpha)
        .div('1e18')
        .toNumber();
    const callbackAddress = parseAddress(validator.validated.data.callbackAddress);
    const newEpoch = ethers_1.BigNumber.from(validator.validated.data.newEpoch);
    const activeRootIpfsCidBase64 = Buffer.from(validator.validated.data.activeRootIpfsCid, 'base64');
    const activeRootIpfsCid = activeRootIpfsCidBase64.toString();
    const requesterContract = new ethers_1.ethers.Contract(callbackAddress, contracts_1.OracleRequester, config.wallet);
    const ipfs = IPFS.makeExecute(IPFS.makeConfig(IPFS.NAME));
    const rewardsInput = {
        traderRewardsAmount,
        marketMakerRewardsAmount,
        ipnsName,
        traderScoreAlpha,
        newEpoch,
        activeRootIpfsCid,
        treasuryClaimAddress: config.treasuryClaimAddress,
    };
    const addressRewards = await exports.calculateRewards(jobRunID, rewardsInput, ipfs, context);
    const merkleTree = exports.constructMerkleTree(addressRewards);
    const jsonTree = exports.constructJsonTree(addressRewards);
    const newIpfsCid = await ipfs_data_1.storeJsonTree(jobRunID, ipfs, jsonTree, context);
    const tx = await requesterContract.writeOracleData(`0x${merkleTree.getRoot().toString('hex')}`, newEpoch, Buffer.from(newIpfsCid));
    await tx.wait();
    const response = { data: { result: 1 }, status: 200 };
    return ea_bootstrap_1.Requester.success(jobRunID, response);
};
exports.execute = execute;
const calculateRewards = async (jobRunID, input, ipfs, context) => {
    const epochData = await ipfs_data_1.getDataForEpoch(jobRunID, ipfs, input.ipnsName, input.newEpoch.toNumber(), context);
    const addressRewards = {};
    if (input.newEpoch.isZero()) {
        exports.calcRetroactiveRewards(epochData, addressRewards, input.treasuryClaimAddress);
    }
    exports.calcTraderRewards(epochData, addressRewards, input.traderRewardsAmount, input.traderScoreAlpha);
    exports.calcMarketMakerRewards(epochData, addressRewards, input.marketMakerRewardsAmount);
    if (!input.newEpoch.isZero()) {
        const previousCumulativeJsonTree = await ipfs_data_1.getDataForCID(jobRunID, ipfs, input.activeRootIpfsCid, context);
        const previousAddressRewards = exports.deconstructJsonTree(previousCumulativeJsonTree);
        calcCumulativeRewards(addressRewards, previousAddressRewards);
    }
    return addressRewards;
};
exports.calculateRewards = calculateRewards;
const addReward = (addressRewards, address, amount) => {
    address = ethers_1.ethers.utils.getAddress(address);
    if (address in addressRewards) {
        addressRewards[address] = addressRewards[address].add(amount);
    }
    else {
        addressRewards[address] = ethers_1.BigNumber.from(amount);
    }
};
// We expect the amount with 2 decimal points, and the token has 18 decimals.
const rewardAmountToBigNumber = (amount) => ethers_1.BigNumber.from(amount * 100).mul(ethers_1.BigNumber.from(10).pow(16));
// Retroactive tiers are sorted descending to make it easier to find the highest applicable tier
const retroactiveTiers = [
    {
        min: 1000000,
        reward: rewardAmountToBigNumber(9529.86),
        volumeRequirement: 100000,
    },
    {
        min: 100000,
        reward: rewardAmountToBigNumber(6413.91),
        volumeRequirement: 50000,
    },
    {
        min: 10000,
        reward: rewardAmountToBigNumber(4349.63),
        volumeRequirement: 5000,
    },
    {
        min: 1,
        reward: rewardAmountToBigNumber(1163.51),
        volumeRequirement: 500,
    },
    {
        min: 0,
        reward: rewardAmountToBigNumber(310.75),
        volumeRequirement: 1,
    },
];
// Retroactive rewards is 75M (hard-coded, as the above tiers would have to change if this was changed)
const totalRetroactiveRewards = ethers_1.BigNumber.from(75000000).mul(ethers_1.BigNumber.from(10).pow(18));
const findRetroactiveRewardsTier = (tradeVolume) => {
    // Do a strict check to avoid catching "0" - which is treated differently
    if (tradeVolume === false) {
        return {
            min: 0,
            reward: ethers_1.BigNumber.from(0),
            volumeRequirement: 1,
        };
    }
    const tier = retroactiveTiers.find(({ min }) => tradeVolume >= min);
    if (!tier) {
        throw new Error(`Unable to find tier for volume: ${tradeVolume}`);
    }
    return tier;
};
const EXPO_BONUS_TOKENS = rewardAmountToBigNumber(565.61);
const calcRetroactiveRewards = (epochData, addressRewards, treasuryClaimAddress) => {
    const combinedAddresses = [
        ...Object.keys(epochData.retroactiveTradeVolume || {}),
        ...Object.keys(epochData.isExpoUser || {}),
    ];
    const uniqueAddresses = [...new Set(combinedAddresses)];
    let sumRetroactivelyDistributedRewards = ethers_1.BigNumber.from(0);
    for (const addr of uniqueAddresses) {
        const volume = epochData.tradeVolume?.[addr] || 0;
        const retroactiveVolume = epochData.retroactiveTradeVolume?.[addr] ?? false;
        const tier = findRetroactiveRewardsTier(retroactiveVolume);
        const isExpoUser = epochData.isExpoUser?.[addr] || false;
        const userPotentialRewardTokens = tier.reward.add(isExpoUser ? EXPO_BONUS_TOKENS : 0);
        const earnedFraction = bn.BigNumber.min(1, new bn.BigNumber(volume).div(tier.volumeRequirement));
        const userRetroactiveRewardTokens = new bn.BigNumber(userPotentialRewardTokens.toString())
            .times(earnedFraction)
            .decimalPlaces(0, bn.BigNumber.ROUND_FLOOR)
            .toFixed();
        if (userRetroactiveRewardTokens != '0') {
            addReward(addressRewards, addr, userRetroactiveRewardTokens);
            sumRetroactivelyDistributedRewards = sumRetroactivelyDistributedRewards.add(userRetroactiveRewardTokens);
        }
    }
    // If there are tokens not claimed (by users not reaching volume requirements), send them to the
    // treasury's merkle root claim contract.
    const totalForfeitedTokens = totalRetroactiveRewards.sub(sumRetroactivelyDistributedRewards);
    if (!totalForfeitedTokens.isZero()) {
        addReward(addressRewards, treasuryClaimAddress, totalForfeitedTokens);
    }
};
exports.calcRetroactiveRewards = calcRetroactiveRewards;
const calcTraderRewards = (epochData, addressRewards, traderRewardsAmount, traderScoreAlpha) => {
    const F = Object.keys(epochData.tradeFeesPaid).reduce((sum, addr) => sum.plus(epochData.tradeFeesPaid[addr]), new bn.BigNumber(0));
    const G = Object.keys(epochData.openInterest).reduce((sum, addr) => sum.plus(epochData.openInterest[addr]), new bn.BigNumber(0));
    const traderScore = {};
    let traderScoreSum = new bn.BigNumber(0);
    Object.keys(epochData.tradeFeesPaid).forEach((addr) => {
        const f = epochData.tradeFeesPaid[addr];
        const g = epochData.openInterest[addr] || 0;
        const score = new bn.BigNumber((f / F.toNumber()) ** traderScoreAlpha).times((g / G.toNumber()) ** (1 - traderScoreAlpha));
        traderScore[addr] = score;
        traderScoreSum = traderScoreSum.plus(score);
    });
    Object.keys(traderScore).forEach((addr) => {
        const reward = traderRewardsAmount
            .times(traderScore[addr])
            .div(traderScoreSum)
            .decimalPlaces(0, bn.BigNumber.ROUND_FLOOR)
            .toFixed();
        if (reward !== '0') {
            addReward(addressRewards, addr, reward);
        }
    });
};
exports.calcTraderRewards = calcTraderRewards;
const calcMarketMakerRewards = (epochData, addressRewards, marketMakerRewardsAmount) => {
    const quoteScoreSum = Object.keys(epochData.quoteScore).reduce((sum, addr) => sum.plus(epochData.quoteScore[addr]), new bn.BigNumber(0));
    Object.keys(epochData.quoteScore).forEach((addr) => {
        const reward = marketMakerRewardsAmount
            .times(epochData.quoteScore[addr])
            .div(quoteScoreSum)
            .decimalPlaces(0, bn.BigNumber.ROUND_FLOOR)
            .toFixed();
        if (reward !== '0') {
            addReward(addressRewards, addr, reward);
        }
    });
};
exports.calcMarketMakerRewards = calcMarketMakerRewards;
const calcCumulativeRewards = (addressRewards, previousRewards) => {
    Object.keys(previousRewards).forEach((addr) => {
        addReward(addressRewards, addr, previousRewards[addr]);
    });
};
const keccakReward = (address, reward) => Buffer.from(ethers_1.ethers.utils
    .solidityKeccak256(['address', 'uint256'], [ethers_1.ethers.utils.getAddress(address), reward])
    .substr(2), 'hex');
exports.keccakReward = keccakReward;
const hashFn = (value) => Buffer.from(ethers_1.ethers.utils.keccak256(value).substr(2), 'hex');
exports.hashFn = hashFn;
const constructMerkleTree = (addressRewards) => {
    const leaves = Object.keys(addressRewards).map((addr) => exports.keccakReward(addr, addressRewards[addr]));
    const options = {
        sort: true,
    };
    return new merkletreejs_1.MerkleTree(leaves, exports.hashFn, options);
};
exports.constructMerkleTree = constructMerkleTree;
const constructJsonTree = (addressRewards) => Object.keys(addressRewards)
    .sort((a, b) => Buffer.compare(exports.keccakReward(a, addressRewards[a]), exports.keccakReward(b, addressRewards[b])))
    .map((addr) => [addr, addressRewards[addr].toString()]);
exports.constructJsonTree = constructJsonTree;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9rZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tZXRob2QvcG9rZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQThEO0FBRzlELG1DQUEwQztBQUMxQyw0Q0FBOEM7QUFDOUMsNENBT3FCO0FBQ3JCLHNFQUErQztBQUMvQywrQ0FBeUM7QUFDekMseURBQWtDO0FBRXJCLFFBQUEsSUFBSSxHQUFHLE1BQU0sQ0FBQTtBQUVuQixNQUFNLG1CQUFtQixHQUFHLENBQUMsSUFBb0IsRUFBa0IsRUFBRTtJQUMxRSxNQUFNLEdBQUcsR0FBbUIsRUFBRSxDQUFBO0lBQzlCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxFQUFFO1FBQ3hCLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxrQkFBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtLQUN6QztJQUNELE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQyxDQUFBO0FBTlksUUFBQSxtQkFBbUIsdUJBTS9CO0FBRUQsTUFBTSxZQUFZLEdBQUc7SUFDbkIsbUJBQW1CLEVBQUUsS0FBSztJQUMxQix3QkFBd0IsRUFBRSxLQUFLO0lBQy9CLFFBQVEsRUFBRSxJQUFJO0lBQ2QsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixlQUFlLEVBQUUsSUFBSTtJQUNyQixRQUFRLEVBQUUsSUFBSTtJQUNkLGlCQUFpQixFQUFFLElBQUk7Q0FDeEIsQ0FBQTtBQVlELE1BQU0sWUFBWSxHQUFHLENBQUMsT0FBZSxFQUFVLEVBQUU7SUFDL0MsSUFBSSxPQUFPLENBQUMsTUFBTSxLQUFLLEVBQUUsSUFBSSxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJO1FBQUUsT0FBTyxPQUFPLENBQUE7SUFDN0UsTUFBTSxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxD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c0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdGVyLCBWYWxpZGF0b3IgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7IEV4ZWN1dGVXaXRoQ29uZmlnLCBFeGVjdXRlLCBBZGFwdGVyQ29udGV4dCB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBDb25maWcgfSBmcm9tICcuLi9jb25maWcnXG5pbXBvcnQgeyBldGhlcnMsIEJpZ051bWJlciB9IGZyb20gJ2V0aGVycydcbmltcG9ydCB7IE9yYWNsZVJlcXVlc3RlciB9IGZyb20gJy4uL2NvbnRyYWN0cydcbmltcG9ydCB7XG4gIEFkZHJlc3NSZXdhcmRzLFxuICBnZXREYXRhRm9yQ0lELFxuICBnZXREYXRhRm9yRXBvY2gsXG4gIE1lcmtsZVRyZWVEYXRhLFxuICBPcmFjbGVSZXdhcmRzRGF0YSxcbiAgc3RvcmVKc29uVHJlZSxcbn0gZnJvbSAnLi4vaXBmcy1kYXRhJ1xuaW1wb3J0ICogYXMgSVBGUyBmcm9tICdAY2hhaW5saW5rL2lwZnMtYWRhcHRlcidcbmltcG9ydCB7IE1lcmtsZVRyZWUgfSBmcm9tICdtZXJrbGV0cmVlanMnXG5pbXBvcnQgKiBhcyBibiBmcm9tICdiaWdudW1iZXIuanMnXG5cbmV4cG9ydCBjb25zdCBOQU1FID0gJ3Bva2UnXG5cbmV4cG9ydCBjb25zdCBkZWNvbnN0cnVjdEpzb25UcmVlID0gKGRhdGE6IE1lcmtsZVRyZWVEYXRhKTogQWRkcmVzc1Jld2FyZHMgPT4ge1xuICBjb25zdCByZXM6IEFkZHJlc3NSZXdhcmRzID0ge31cbiAgZm9yIChjb25zdCBkYXR1bSBvZiBkYXRhKSB7XG4gICAgcmVzW2RhdHVtWzBdXSA9IEJpZ051bWJlci5mcm9tKGRhdHVtWzFdKVxuICB9XG4gIHJldHVybiByZXNcbn1cblxuY29uc3QgY3VzdG9tUGFyYW1zID0ge1xuICB0cmFkZXJSZXdhcmRzQW1vdW50OiBmYWxzZSxcbiAgbWFya2V0TWFrZXJSZXdhcmRzQW1vdW50OiBmYWxzZSxcbiAgaXBuc05hbWU6IHRydWUsXG4gIHRyYWRlclNjb3JlQWxwaGE6IHRydWUsXG4gIGNhbGxiYWNrQWRkcmVzczogdHJ1ZSxcbiAgbmV3RXBvY2g6IHRydWUsXG4gIGFjdGl2ZVJvb3RJcGZzQ2lkOiB0cnVlLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIElucHV0IHtcbiAgdHJhZGVyUmV3YXJkc0Ftb3VudDogYm4uQmlnTnVtYmVyXG4gIG1hcmtldE1ha2VyUmV3YXJkc0Ftb3VudDogYm4uQmlnTnVtYmVyXG4gIGlwbnNOYW1lOiBzdHJpbmdcbiAgdHJhZGVyU2NvcmVBbHBoYTogbnVtYmVyXG4gIG5ld0Vwb2NoOiBCaWdOdW1iZXJcbiAgYWN0aXZlUm9vdElwZnNDaWQ6IHN0cmluZ1xuICB0cmVhc3VyeUNsYWltQWRkcmVzczogc3RyaW5nXG59XG5cbmNvbnN0IHBhcnNlQWRkcmVzcyA9IChhZGRyZXNzOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xuICBpZiAoYWRkcmVzcy5sZW5ndGggPT09IDQyICYmIGFkZHJlc3Muc3Vic3RyaW5nKDAsIDIpID09PSAnMHgnKSByZXR1cm4gYWRkcmVzc1xuICBjb25zdCBidWYgPSBCdWZmZXIuZnJvbShhZGRyZXNzLCAnYmFzZTY0JylcbiAgcmV0dXJuIGAweCR7YnVmLnRvU3RyaW5nKCdoZXgnKS5zbGljZSgtNDApfWBcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAoaW5wdXQsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCBjdXN0b21QYXJhbXMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IGpvYlJ1bklEID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5qb2JSdW5JRFxuXG4gIGxldCB0cmFkZXJSZXdhcmRzQW1vdW50ID0gbmV3IGJuLkJpZ051bWJlcihjb25maWcudHJhZGVyUmV3YXJkc0Ftb3VudClcbiAgbGV0IG1hcmtldE1ha2VyUmV3YXJkc0Ftb3VudCA9IG5ldyBibi5CaWdOdW1iZXIoY29uZmlnLm1hcmtldE1ha2VyUmV3YXJkc0Ftb3VudClcbiAgLy8gQWNjb3VudCBmb3IgQ0JPUiBlbmNvZGluZyBpc3N1ZVxuICBpZiAoXG4gICAgdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLm1hcmtldE1ha2VyUmV3YXJkc0Ftb3VudCAmJlxuICAgIHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5tYXJrZXRNYWtlclJld2FyZHNBbW91bnQgIT09ICd0cmFkZXJSZXdhcmRzQW1vdW50J1xuICApIHtcbiAgICBtYXJrZXRNYWtlclJld2FyZHNBbW91bnQgPSBuZXcgYm4uQmlnTnVtYmVyKHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5tYXJrZXRNYWtlclJld2FyZHNBbW91bnQpXG4gIH1cbiAgaWYgKHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS50cmFkZXJSZXdhcmRzQW1vdW50KSB7XG4gICAgdHJhZGVyUmV3YXJkc0Ftb3VudCA9IG5ldyBibi5CaWdOdW1iZXIodmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnRyYWRlclJld2FyZHNBbW91bnQpXG4gIH1cblxuICBjb25zdCBpcG5zTmFtZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5pcG5zTmFtZVxuICBjb25zdCB0cmFkZXJTY29yZUFscGhhID0gbmV3IGJuLkJpZ051bWJlcih2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEudHJhZGVyU2NvcmVBbHBoYSlcbiAgICAuZGl2KCcxZTE4JylcbiAgICAudG9OdW1iZXIoKVxuICBjb25zdCBjYWxsYmFja0FkZHJlc3MgPSBwYXJzZUFkZHJlc3ModmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNhbGxiYWNrQWRkcmVzcylcbiAgY29uc3QgbmV3RXBvY2ggPSBCaWdOdW1iZXIuZnJvbSh2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEubmV3RXBvY2gpXG4gIGNvbnN0IGFjdGl2ZVJvb3RJcGZzQ2lkQmFzZTY0ID0gQnVmZmVyLmZyb20odmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmFjdGl2ZVJvb3RJcGZzQ2lkLCAnYmFzZTY0JylcbiAgY29uc3QgYWN0aXZlUm9vdElwZnNDaWQgPSBhY3RpdmVSb290SXBmc0NpZEJhc2U2NC50b1N0cmluZygpXG5cbiAgY29uc3QgcmVxdWVzdGVyQ29udHJhY3QgPSBuZXcgZXRoZXJzLkNvbnRyYWN0KGNhbGxiYWNrQWRkcmVzcywgT3JhY2xlUmVxdWVzdGVyLCBjb25maWcud2FsbGV0KVxuXG4gIGNvbnN0IGlwZnMgPSBJUEZTLm1ha2VFeGVjdXRlKElQRlMubWFrZUNvbmZpZyhJUEZTLk5BTUUpKVxuICBjb25zdCByZXdhcmRzSW5wdXQ6IElucHV0ID0ge1xuICAgIHRyYWRlclJld2FyZHNBbW91bnQsXG4gICAgbWFya2V0TWFrZXJSZXdhcmRzQW1vdW50LFxuICAgIGlwbnNOYW1lLFxuICAgIHRyYWRlclNjb3JlQWxwaGEsXG4gICAgbmV3RXBvY2gsXG4gICAgYWN0aXZlUm9vdElwZnNDaWQsXG4gICAgdHJlYXN1cnlDbGFpbUFkZHJlc3M6IGNvbmZpZy50cmVhc3VyeUNsYWltQWRkcmVzcyxcbiAgfVxuICBjb25zdCBhZGRyZXNzUmV3YXJkcyA9IGF3YWl0IGNhbGN1bGF0ZVJld2FyZHMoam9iUnVuSUQsIHJld2FyZHNJbnB1dCwgaXBmcywgY29udGV4dClcblxuICBjb25zdCBtZXJrbGVUcmVlID0gY29uc3RydWN0TWVya2xlVHJlZShhZGRyZXNzUmV3YXJkcylcbiAgY29uc3QganNvblRyZWUgPSBjb25zdHJ1Y3RKc29uVHJlZShhZGRyZXNzUmV3YXJkcylcblxuICBjb25zdCBuZXdJcGZzQ2lkID0gYXdhaXQgc3RvcmVKc29uVHJlZShqb2JSdW5JRCwgaXBmcywganNvblRyZWUsIGNvbnRleHQpXG5cbiAgY29uc3QgdHggPSBhd2FpdCByZXF1ZXN0ZXJDb250cmFjdC53cml0ZU9yYWNsZURhdGEoXG4gICAgYDB4JHttZXJrbGVUcmVlLmdldFJvb3QoKS50b1N0cmluZygnaGV4Jyl9YCxcbiAgICBuZXdFcG9jaCxcbiAgICBCdWZmZXIuZnJvbShuZXdJcGZzQ2lkKSxcbiAgKVxuICBhd2FpdCB0eC53YWl0KClcblxuICBjb25zdCByZXNwb25zZSA9IHsgZGF0YTogeyByZXN1bHQ6IDEgfSwgc3RhdHVzOiAyMDAgfVxuICByZXR1cm4gUmVxdWVzdGVyLnN1Y2Nlc3Moam9iUnVuSUQsIHJlc3BvbnNlKVxufVxuXG5leHBvcnQgY29uc3QgY2FsY3VsYXRlUmV3YXJkcyA9IGFzeW5jIChcbiAgam9iUnVuSUQ6IHN0cmluZyxcbiAgaW5wdXQ6IElucHV0LFxuICBpcGZzOiBFeGVjdXRlLFxuICBjb250ZXh0OiBBZGFwdGVyQ29udGV4dCxcbik6IFByb21pc2U8QWRkcmVzc1Jld2FyZHM+ID0+IHtcbiAgY29uc3QgZXBvY2hEYXRhID0gYXdhaXQgZ2V0RGF0YUZvckVwb2NoKFxuICAgIGpvYlJ1bklELFxuICAgIGlwZnMsXG4gICAgaW5wdXQuaXBuc05hbWUsXG4gICAgaW5wdXQubmV3RXBvY2gudG9OdW1iZXIoKSxcbiAgICBjb250ZXh0LFxuICApXG5cbiAgY29uc3QgYWRkcmVzc1Jld2FyZHM6IEFkZHJlc3NSZXdhcmRzID0ge31cbiAgaWYgKGlucHV0Lm5ld0Vwb2NoLmlzWmVybygpKSB7XG4gICAgY2FsY1JldHJvYWN0aXZlUmV3YXJkcyhlcG9jaERhdGEsIGFkZHJlc3NSZXdhcmRzLCBpbnB1dC50cmVhc3VyeUNsYWltQWRkcmVzcylcbiAgfVxuXG4gIGNhbGNUcmFkZXJSZXdhcmRzKGVwb2NoRGF0YSwgYWRkcmVzc1Jld2FyZHMsIGlucHV0LnRyYWRlclJld2FyZHNBbW91bnQsIGlucHV0LnRyYWRlclNjb3JlQWxwaGEpXG4gIGNhbGNNYXJrZXRNYWtlclJld2FyZHMoZXBvY2hEYXRhLCBhZGRyZXNzUmV3YXJkcywgaW5wdXQubWFya2V0TWFrZXJSZXdhcmRzQW1vdW50KVxuXG4gIGlmICghaW5wdXQubmV3RXBvY2guaXNaZXJvKCkpIHtcbiAgICBjb25zdCBwcmV2aW91c0N1bXVsYXRpdmVKc29uVHJlZSA9IGF3YWl0IGdldERhdGFGb3JDSUQoXG4gICAgICBqb2JSdW5JRCxcbiAgICAgIGlwZnMsXG4gICAgICBpbnB1dC5hY3RpdmVSb290SXBmc0NpZCxcbiAgICAgIGNvbnRleHQsXG4gICAgKVxuICAgIGNvbnN0IHByZXZpb3VzQWRkcmVzc1Jld2FyZHMgPSBkZWNvbnN0cnVjdEpzb25UcmVlKHByZXZpb3VzQ3VtdWxhdGl2ZUpzb25UcmVlKVxuICAgIGNhbGNDdW11bGF0aXZlUmV3YXJkcyhhZGRyZXNzUmV3YXJkcywgcHJldmlvdXNBZGRyZXNzUmV3YXJkcylcbiAgfVxuXG4gIHJldHVybiBhZGRyZXNzUmV3YXJkc1xufVxuXG5jb25zdCBhZGRSZXdhcmQgPSAoXG4gIGFkZHJlc3NSZXdhcmRzOiBBZGRyZXNzUmV3YXJkcyxcbiAgYWRkcmVzczogc3RyaW5nLFxuICBhbW91bnQ6IG51bWJlciB8IHN0cmluZyB8IEJpZ051bWJlcixcbikgPT4ge1xuICBhZGRyZXNzID0gZXRoZXJzLnV0aWxzLmdldEFkZHJlc3MoYWRkcmVzcylcbiAgaWYgKGFkZHJlc3MgaW4gYWRkcmVzc1Jld2FyZHMpIHtcbiAgICBhZGRyZXNzUmV3YXJkc1thZGRyZXNzXSA9IGFkZHJlc3NSZXdhcmRzW2FkZHJlc3NdLmFkZChhbW91bnQpXG4gIH0gZWxzZSB7XG4gICAgYWRkcmVzc1Jld2FyZHNbYWRkcmVzc10gPSBCaWdOdW1iZXIuZnJvbShhbW91bnQpXG4gIH1cbn1cblxuLy8gV2UgZXhwZWN0IHRoZSBhbW91bnQgd2l0aCAyIGRlY2ltYWwgcG9pbnRzLCBhbmQgdGhlIHRva2VuIGhhcyAxOCBkZWNpbWFscy5cbmNvbnN0IHJld2FyZEFtb3VudFRvQmlnTnVtYmVyID0gKGFtb3VudDogbnVtYmVyKSA9PlxuICBCaWdOdW1iZXIuZnJvbShhbW91bnQgKiAxMDApLm11bChCaWdOdW1iZXIuZnJvbSgxMCkucG93KDE2KSlcblxuLy8gUmV0cm9hY3RpdmUgdGllcnMgYXJlIHNvcnRlZCBkZXNjZW5kaW5nIHRvIG1ha2UgaXQgZWFzaWVyIHRvIGZpbmQgdGhlIGhpZ2hlc3QgYXBwbGljYWJsZSB0aWVyXG5jb25zdCByZXRyb2FjdGl2ZVRpZXJzID0gW1xuICB7XG4gICAgbWluOiAxXzAwMF8wMDAsXG4gICAgcmV3YXJkOiByZXdhcmRBbW91bnRUb0JpZ051bWJlcig5NTI5Ljg2KSxcbiAgICB2b2x1bWVSZXF1aXJlbWVudDogMTAwXzAwMCxcbiAgfSxcbiAge1xuICAgIG1pbjogMTAwXzAwMCxcbiAgICByZXdhcmQ6IHJld2FyZEFtb3VudFRvQmlnTnVtYmVyKDY0MTMuOTEpLFxuICAgIHZvbHVtZVJlcXVpcmVtZW50OiA1MF8wMDAsXG4gIH0sXG4gIHtcbiAgICBtaW46IDEwXzAwMCxcbiAgICByZXdhcmQ6IHJld2FyZEFtb3VudFRvQmlnTnVtYmVyKDQzNDkuNjMpLFxuICAgIHZvbHVtZVJlcXVpcmVtZW50OiA1XzAwMCxcbiAgfSxcbiAge1xuICAgIG1pbjogMSxcbiAgICByZXdhcmQ6IHJld2FyZEFtb3VudFRvQmlnTnVtYmVyKDExNjMuNTEpLFxuICAgIHZvbHVtZVJlcXVpcmVtZW50OiA1MDAsXG4gIH0sXG4gIHtcbiAgICBtaW46IDAsXG4gICAgcmV3YXJkOiByZXdhcmRBbW91bnRUb0JpZ051bWJlcigzMTAuNzUpLFxuICAgIHZvbHVtZVJlcXVpcmVtZW50OiAxLFxuICB9LFxuXVxuXG4vLyBSZXRyb2FjdGl2ZSByZXdhcmRzIGlzIDc1TSAoaGFyZC1jb2RlZCwgYXMgdGhlIGFib3ZlIHRpZXJzIHdvdWxkIGhhdmUgdG8gY2hhbmdlIGlmIHRoaXMgd2FzIGNoYW5nZWQpXG5jb25zdCB0b3RhbFJldHJvYWN0aXZlUmV3YXJkcyA9IEJpZ051bWJlci5mcm9tKDc1XzAwMF8wMDApLm11bChCaWdOdW1iZXIuZnJvbSgxMCkucG93KDE4KSlcblxuY29uc3QgZmluZFJldHJvYWN0aXZlUmV3YXJkc1RpZXIgPSAodHJhZGVWb2x1bWU6IG51bWJlciB8IGJvb2xlYW4pID0+IHtcbiAgLy8gRG8gYSBzdHJpY3QgY2hlY2sgdG8gYXZvaWQgY2F0Y2hpbmcgXCIwXCIgLSB3aGljaCBpcyB0cmVhdGVkIGRpZmZlcmVudGx5XG4gIGlmICh0cmFkZVZvbHVtZSA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm4ge1xuICAgICAgbWluOiAwLFxuICAgICAgcmV3YXJkOiBCaWdOdW1iZXIuZnJvbSgwKSxcbiAgICAgIHZvbHVtZVJlcXVpcmVtZW50OiAxLFxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHRpZXIgPSByZXRyb2FjdGl2ZVRpZXJzLmZpbmQoKHsgbWluIH0pID0+IHRyYWRlVm9sdW1lID49IG1pbilcbiAgaWYgKCF0aWVyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmluZCB0aWVyIGZvciB2b2x1bWU6ICR7dHJhZGVWb2x1bWV9YClcbiAgfVxuXG4gIHJldHVybiB0aWVyXG59XG5cbmNvbnN0IEVYUE9fQk9OVVNfVE9LRU5TID0gcmV3YXJkQW1vdW50VG9CaWdOdW1iZXIoNTY1LjYxKVxuXG5leHBvcnQgY29uc3QgY2FsY1JldHJvYWN0aXZlUmV3YXJkcyA9IChcbiAgZXBvY2hEYXRhOiBPcmFjbGVSZXdhcmRzRGF0YSxcbiAgYWRkcmVzc1Jld2FyZHM6IEFkZHJlc3NSZXdhcmRzLFxuICB0cmVhc3VyeUNsYWltQWRkcmVzczogc3RyaW5nLFxuKSA9PiB7XG4gIGNvbnN0IGNvbWJpbmVkQWRkcmVzc2VzID0gW1xuICAgIC4uLk9iamVjdC5rZXlzKGVwb2NoRGF0YS5yZXRyb2FjdGl2ZVRyYWRlVm9sdW1lIHx8IHt9KSxcbiAgICAuLi5PYmplY3Qua2V5cyhlcG9jaERhdGEuaXNFeHBvVXNlciB8fCB7fSksXG4gIF1cbiAgY29uc3QgdW5pcXVlQWRkcmVzc2VzID0gWy4uLm5ldyBTZXQoY29tYmluZWRBZGRyZXNzZXMpXVxuXG4gIGxldCBzdW1SZXRyb2FjdGl2ZWx5RGlzdHJpYnV0ZWRSZXdhcmRzID0gQmlnTnVtYmVyLmZyb20oMClcblxuICBmb3IgKGNvbnN0IGFkZHIgb2YgdW5pcXVlQWRkcmVzc2VzKSB7XG4gICAgY29uc3Qgdm9sdW1lID0gZXBvY2hEYXRhLnRyYWRlVm9sdW1lPy5bYWRkcl0gfHwgMFxuICAgIGNvbnN0IHJldHJvYWN0aXZlVm9sdW1lID0gZXBvY2hEYXRhLnJldHJvYWN0aXZlVHJhZGVWb2x1bWU/LlthZGRyXSA/PyBmYWxzZVxuICAgIGNvbnN0IHRpZXIgPSBmaW5kUmV0cm9hY3RpdmVSZXdhcmRzVGllcihyZXRyb2FjdGl2ZVZvbHVtZSlcbiAgICBjb25zdCBpc0V4cG9Vc2VyID0gZXBvY2hEYXRhLmlzRXhwb1VzZXI/LlthZGRyXSB8fCBmYWxzZVxuICAgIGNvbnN0IHVzZXJQb3RlbnRpYWxSZXdhcmRUb2tlbnMgPSB0aWVyLnJld2FyZC5hZGQoaXNFeHBvVXNlciA/IEVYUE9fQk9OVVNfVE9LRU5TIDogMClcbiAgICBjb25zdCBlYXJuZWRGcmFjdGlvbiA9IGJuLkJpZ051bWJlci5taW4oMSwgbmV3IGJuLkJpZ051bWJlcih2b2x1bWUpLmRpdih0aWVyLnZvbHVtZVJlcXVpcmVtZW50KSlcbiAgICBjb25zdCB1c2VyUmV0cm9hY3RpdmVSZXdhcmRUb2tlbnMgPSBuZXcgYm4uQmlnTnVtYmVyKHVzZXJQb3RlbnRpYWxSZXdhcmRUb2tlbnMudG9TdHJpbmcoKSlcbiAgICAgIC50aW1lcyhlYXJuZWRGcmFjdGlvbilcbiAgICAgIC5kZWNpbWFsUGxhY2VzKDAsIGJuLkJpZ051bWJlci5ST1VORF9GTE9PUilcbiAgICAgIC50b0ZpeGVkKClcbiAgICBpZiAodXNlclJldHJvYWN0aXZlUmV3YXJkVG9rZW5zICE9ICcwJykge1xuICAgICAgYWRkUmV3YXJkKGFkZHJlc3NSZXdhcmRzLCBhZGRyLCB1c2VyUmV0cm9hY3RpdmVSZXdhcmRUb2tlbnMpXG4gICAgICBzdW1SZXRyb2FjdGl2ZWx5RGlzdHJpYnV0ZWRSZXdhcmRzID0gc3VtUmV0cm9hY3RpdmVseURpc3RyaWJ1dGVkUmV3YXJkcy5hZGQoXG4gICAgICAgIHVzZXJSZXRyb2FjdGl2ZVJld2FyZFRva2VucyxcbiAgICAgIClcbiAgICB9XG4gIH1cblxuICAvLyBJZiB0aGVyZSBhcmUgdG9rZW5zIG5vdCBjbGFpbWVkIChieSB1c2VycyBub3QgcmVhY2hpbmcgdm9sdW1lIHJlcXVpcmVtZW50cyksIHNlbmQgdGhlbSB0byB0aGVcbiAgLy8gdHJlYXN1cnkncyBtZXJrbGUgcm9vdCBjbGFpbSBjb250cmFjdC5cbiAgY29uc3QgdG90YWxGb3JmZWl0ZWRUb2tlbnMgPSB0b3RhbFJldHJvYWN0aXZlUmV3YXJkcy5zdWIoc3VtUmV0cm9hY3RpdmVseURpc3RyaWJ1dGVkUmV3YXJkcylcbiAgaWYgKCF0b3RhbEZvcmZlaXRlZFRva2Vucy5pc1plcm8oKSkge1xuICAgIGFkZFJld2FyZChhZGRyZXNzUmV3YXJkcywgdHJlYXN1cnlDbGFpbUFkZHJlc3MsIHRvdGFsRm9yZmVpdGVkVG9rZW5zKVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCBjYWxjVHJhZGVyUmV3YXJkcyA9IChcbiAgZXBvY2hEYXRhOiBPcmFjbGVSZXdhcmRzRGF0YSxcbiAgYWRkcmVzc1Jld2FyZHM6IEFkZHJlc3NSZXdhcmRzLFxuICB0cmFkZXJSZXdhcmRzQW1vdW50OiBibi5CaWdOdW1iZXIsXG4gIHRyYWRlclNjb3JlQWxwaGE6IG51bWJlcixcbikgPT4ge1xuICBjb25zdCBGID0gT2JqZWN0LmtleXMoZXBvY2hEYXRhLnRyYWRlRmVlc1BhaWQpLnJlZHVjZShcbiAgICAoc3VtLCBhZGRyKSA9PiBzdW0ucGx1cyhlcG9jaERhdGEudHJhZGVGZWVzUGFpZFthZGRyXSksXG4gICAgbmV3IGJuLkJpZ051bWJlcigwKSxcbiAgKVxuICBjb25zdCBHID0gT2JqZWN0LmtleXMoZXBvY2hEYXRhLm9wZW5JbnRlcmVzdCkucmVkdWNlKFxuICAgIChzdW0sIGFkZHIpID0+IHN1bS5wbHVzKGVwb2NoRGF0YS5vcGVuSW50ZXJlc3RbYWRkcl0pLFxuICAgIG5ldyBibi5CaWdOdW1iZXIoMCksXG4gIClcblxuICBjb25zdCB0cmFkZXJTY29yZTogeyBbYWRkcmVzczogc3RyaW5nXTogYm4uQmlnTnVtYmVyIH0gPSB7fVxuICBsZXQgdHJhZGVyU2NvcmVTdW0gPSBuZXcgYm4uQmlnTnVtYmVyKDApXG5cbiAgT2JqZWN0LmtleXMoZXBvY2hEYXRhLnRyYWRlRmVlc1BhaWQpLmZvckVhY2goKGFkZHIpID0+IHtcbiAgICBjb25zdCBmID0gZXBvY2hEYXRhLnRyYWRlRmVlc1BhaWRbYWRkcl1cbiAgICBjb25zdCBnID0gZXBvY2hEYXRhLm9wZW5JbnRlcmVzdFthZGRyXSB8fCAwXG4gICAgY29uc3Qgc2NvcmUgPSBuZXcgYm4uQmlnTnVtYmVyKChmIC8gRi50b051bWJlcigpKSAqKiB0cmFkZXJTY29yZUFscGhhKS50aW1lcyhcbiAgICAgIChnIC8gRy50b051bWJlcigpKSAqKiAoMSAtIHRyYWRlclNjb3JlQWxwaGEpLFxuICAgIClcblxuICAgIHRyYWRlclNjb3JlW2FkZHJdID0gc2NvcmVcbiAgICB0cmFkZXJTY29yZVN1bSA9IHRyYWRlclNjb3JlU3VtLnBsdXMoc2NvcmUpXG4gIH0pXG5cbiAgT2JqZWN0LmtleXModHJhZGVyU2NvcmUpLmZvckVhY2goKGFkZHIpID0+IHtcbiAgICBjb25zdCByZXdhcmQgPSB0cmFkZXJSZXdhcmRzQW1vdW50XG4gICAgICAudGltZXModHJhZGVyU2NvcmVbYWRkcl0pXG4gICAgICAuZGl2KHRyYWRlclNjb3JlU3VtKVxuICAgICAgLmRlY2ltYWxQbGFjZXMoMCwgYm4uQmlnTnVtYmVyLlJPVU5EX0ZMT09SKVxuICAgICAgLnRvRml4ZWQoKVxuICAgIGlmIChyZXdhcmQgIT09ICcwJykge1xuICAgICAgYWRkUmV3YXJkKGFkZHJlc3NSZXdhcmRzLCBhZGRyLCByZXdhcmQpXG4gICAgfVxuICB9KVxufVxuXG5leHBvcnQgY29uc3QgY2FsY01hcmtldE1ha2VyUmV3YXJkcyA9IChcbiAgZXBvY2hEYXRhOiBPcmFjbGVSZXdhcmRzRGF0YSxcbiAgYWRkcmVzc1Jld2FyZHM6IEFkZHJlc3NSZXdhcmRzLFxuICBtYXJrZXRNYWtlclJld2FyZHNBbW91bnQ6IGJuLkJpZ051bWJlcixcbikgPT4ge1xuICBjb25zdCBxdW90ZVNjb3JlU3VtID0gT2JqZWN0LmtleXMoZXBvY2hEYXRhLnF1b3RlU2NvcmUpLnJlZHVjZShcbiAgICAoc3VtLCBhZGRyKSA9PiBzdW0ucGx1cyhlcG9jaERhdGEucXVvdGVTY29yZVthZGRyXSksXG4gICAgbmV3IGJuLkJpZ051bWJlcigwKSxcbiAgKVxuXG4gIE9iamVjdC5rZXlzKGVwb2NoRGF0YS5xdW90ZVNjb3JlKS5mb3JFYWNoKChhZGRyKSA9PiB7XG4gICAgY29uc3QgcmV3YXJkID0gbWFya2V0TWFrZXJSZXdhcmRzQW1vdW50XG4gICAgICAudGltZXMoZXBvY2hEYXRhLnF1b3RlU2NvcmVbYWRkcl0pXG4gICAgICAuZGl2KHF1b3RlU2NvcmVTdW0pXG4gICAgICAuZGVjaW1hbFBsYWNlcygwLCBibi5CaWdOdW1iZXIuUk9VTkRfRkxPT1IpXG4gICAgICAudG9GaXhlZCgpXG4gICAgaWYgKHJld2FyZCAhPT0gJzAnKSB7XG4gICAgICBhZGRSZXdhcmQoYWRkcmVzc1Jld2FyZHMsIGFkZHIsIHJld2FyZClcbiAgICB9XG4gIH0pXG59XG5cbmNvbnN0IGNhbGNDdW11bGF0aXZlUmV3YXJkcyA9IChhZGRyZXNzUmV3YXJkczogQWRkcmVzc1Jld2FyZHMsIHByZXZpb3VzUmV3YXJkczogQWRkcmVzc1Jld2FyZHMpID0+IHtcbiAgT2JqZWN0LmtleXMocHJldmlvdXNSZXdhcmRzKS5mb3JFYWNoKChhZGRyKSA9PiB7XG4gICAgYWRkUmV3YXJkKGFkZHJlc3NSZXdhcmRzLCBhZGRyLCBwcmV2aW91c1Jld2FyZHNbYWRkcl0pXG4gIH0pXG59XG5cbmV4cG9ydCBjb25zdCBrZWNjYWtSZXdhcmQgPSAoYWRkcmVzczogc3RyaW5nLCByZXdhcmQ6IEJpZ051bWJlcik6IEJ1ZmZlciA9PlxuICBCdWZmZXIuZnJvbShcbiAgICBldGhlcnMudXRpbHNcbiAgICAgIC5zb2xpZGl0eUtlY2NhazI1NihbJ2FkZHJlc3MnLCAndWludDI1NiddLCBbZXRoZXJzLnV0aWxzLmdldEFkZHJlc3MoYWRkcmVzcyksIHJld2FyZF0pXG4gICAgICAuc3Vic3RyKDIpLFxuICAgICdoZXgnLFxuICApXG5cbmV4cG9ydCBjb25zdCBoYXNoRm4gPSAodmFsdWU6IEJ1ZmZlcik6IEJ1ZmZlciA9PlxuICBCdWZmZXIuZnJvbShldGhlcnMudXRpbHMua2VjY2FrMjU2KHZhbHVlKS5zdWJzdHIoMiksICdoZXgnKVxuXG5leHBvcnQgY29uc3QgY29uc3RydWN0TWVya2xlVHJlZSA9IChhZGRyZXNzUmV3YXJkczogQWRkcmVzc1Jld2FyZHMpOiBNZXJrbGVUcmVlID0+IHtcbiAgY29uc3QgbGVhdmVzID0gT2JqZWN0LmtleXMoYWRkcmVzc1Jld2FyZHMpLm1hcCgoYWRkcikgPT4ga2VjY2FrUmV3YXJkKGFkZHIsIGFkZHJlc3NSZXdhcmRzW2FkZHJdKSlcbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICBzb3J0OiB0cnVlLFxuICB9XG4gIHJldHVybiBuZXcgTWVya2xlVHJlZShsZWF2ZXMsIGhhc2hGbiwgb3B0aW9ucylcbn1cblxuZXhwb3J0IGNvbnN0IGNvbnN0cnVjdEpzb25UcmVlID0gKGFkZHJlc3NSZXdhcmRzOiBBZGRyZXNzUmV3YXJkcyk6IE1lcmtsZVRyZWVEYXRhID0+XG4gIE9iamVjdC5rZXlzKGFkZHJlc3NSZXdhcmRzKVxuICAgIC5zb3J0KChhLCBiKSA9PlxuICAgICAgQnVmZmVyLmNvbXBhcmUoa2VjY2FrUmV3YXJkKGEsIGFkZHJlc3NSZXdhcmRzW2FdKSwga2VjY2FrUmV3YXJkKGIsIGFkZHJlc3NSZXdhcmRzW2JdKSksXG4gICAgKVxuICAgIC5tYXAoKGFkZHIpID0+IFthZGRyLCBhZGRyZXNzUmV3YXJkc1thZGRyXS50b1N0cmluZygpXSlcbiJdfQ==