"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeExecute = exports.execute = exports.marketCapTotalValue = exports.priceTotalValue = void 0;
const config_1 = require("./config");
const decimal_js_1 = require("decimal.js");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const ethers_1 = require("ethers");
const dataProvider_1 = require("./dataProvider");
decimal_js_1.Decimal.set({ precision: 100 });
const priceTotalValue = (source, allocations, quote, data) => {
    return allocations
        .reduce((acc, t) => {
        const val = data[t.symbol].quote[quote].price;
        if (!val)
            throw new Error(`ERROR: No price value found for ${t.symbol}/${quote} from the ${source} adapter.`);
        const coins = new decimal_js_1.Decimal(t.balance.toString(10)).div(10 ** t.decimals);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return acc.add(coins.mul(val));
    }, new decimal_js_1.Decimal(0))
        .toNumber();
};
exports.priceTotalValue = priceTotalValue;
const marketCapTotalValue = (source, allocations, quote, data) => {
    return allocations
        .reduce((acc, t) => {
        const val = data[t.symbol].quote[quote].marketCap;
        if (!val)
            throw new Error(`ERROR: No marketcap value found for ${t.symbol}/${quote} from the ${source} adapter.`);
        const coins = new decimal_js_1.Decimal(t.balance.toString(10)).div(10 ** t.decimals);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        return acc.add(coins.mul(val));
    }, new decimal_js_1.Decimal(0))
        .toNumber();
};
exports.marketCapTotalValue = marketCapTotalValue;
const toValidAllocations = (allocations) => {
    const _toValidSymbol = (symbol) => {
        if (!symbol)
            throw new ea_bootstrap_1.AdapterError({ message: `Symbol not available for all tokens.`, statusCode: 400 });
        return symbol.toUpperCase();
    };
    const _toValidDecimals = (decimals) => {
        if (decimals === undefined)
            return config_1.DEFAULT_TOKEN_DECIMALS;
        return Number.isInteger(decimals) && decimals >= 0 ? decimals : config_1.DEFAULT_TOKEN_DECIMALS;
    };
    const _toValidBalance = (balance, decimals) => {
        if (!balance)
            return config_1.DEFAULT_TOKEN_BALANCE * 10 ** decimals;
        let BNbalance;
        try {
            BNbalance = ethers_1.BigNumber.from(balance.toString());
        }
        catch (e) {
            throw new ea_bootstrap_1.AdapterError({ message: `Invalid balance: ${e.message}`, statusCode: 400 });
        }
        if (BNbalance.isNegative())
            throw new ea_bootstrap_1.AdapterError({ message: `Balance cannot be negative`, statusCode: 400 });
        return balance;
    };
    return allocations.map((t) => {
        const decimals = _toValidDecimals(t.decimals);
        return {
            symbol: _toValidSymbol(t.symbol),
            decimals,
            balance: _toValidBalance(t.balance, decimals),
        };
    });
};
const computePrice = async (source, getPrices, allocations, quote) => {
    const symbols = allocations.map((t) => t.symbol);
    const payload = await getPrices(symbols, quote);
    const result = exports.priceTotalValue(source, allocations, quote, payload);
    return { payload, result };
};
const computeMarketCap = async (source, getPrices, allocations, quote) => {
    const symbols = allocations.map((t) => t.symbol);
    const payload = await getPrices(symbols, quote, true);
    const result = exports.marketCapTotalValue(source, allocations, quote, payload);
    return { payload, result };
};
const inputParams = {
    source: false,
    allocations: true,
    quote: false,
    method: false,
};
const execute = async (input, config) => {
    const paramOptions = config_1.makeOptions(config);
    const validator = new ea_bootstrap_1.Validator(input, inputParams, paramOptions);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const { quote = config.defaultQuote, method = config.defaultMethod } = validator.validated.data;
    const allocations = toValidAllocations(validator.validated.data.allocations);
    const source = (validator.validated.data.source ||
        config.defaultSource ||
        '').toLowerCase();
    if (source === '') {
        throw Error('No source specified in the request or config!');
    }
    const sourceConfig = config.sources[source];
    const _success = (payload, result) => ea_bootstrap_1.Requester.success(jobRunID, {
        status: 200,
        data: { sources: [], payload, result },
    }, true);
    const getPrices = dataProvider_1.getPriceProvider(source, jobRunID, sourceConfig.api);
    switch (method.toLowerCase()) {
        case 'price': {
            const price = await computePrice(source, getPrices, allocations, quote);
            return _success(price.payload, price.result);
        }
        case 'marketcap': {
            const marketCap = await computeMarketCap(source, getPrices, allocations, quote);
            return _success(marketCap.payload, marketCap.result);
        }
        default:
            throw new ea_bootstrap_1.AdapterError({
                jobRunID,
                message: `Method ${method} not supported.`,
                statusCode: 400,
            });
    }
};
exports.execute = execute;
const makeExecute = (config) => {
    return async (request) => exports.execute(request, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHFDQUFpRztBQUVqRywyQ0FBb0M7QUFDcEMsMERBQTRFO0FBQzVFLG1DQUFrQztBQUNsQyxpREFBaUQ7QUFFakQsb0JBQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQTtBQUV4QixNQUFNLGVBQWUsR0FBRyxDQUM3QixNQUFjLEVBQ2QsV0FBNkIsRUFDN0IsS0FBYSxFQUNiLElBQXFCLEVBQ2IsRUFBRTtJQUNWLE9BQU8sV0FBVztTQUNmLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNqQixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUE7UUFDN0MsSUFBSSxDQUFDLEdBQUc7WUFDTixNQUFNLElBQUksS0FBSyxDQUNiLG1DQUFtQyxDQUFDLENBQUMsTUFBTSxJQUFJLEtBQUssYUFBYSxNQUFNLFdBQVcsQ0FDbkYsQ0FBQTtRQUNILE1BQU0sS0FBSyxHQUFHLElBQUksb0JBQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ3ZFLG9FQUFvRTtRQUNwRSxPQUFPLEdBQUcsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFJLENBQUMsQ0FBQyxDQUFBO0lBQ2pDLENBQUMsRUFBRSxJQUFJLG9CQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakIsUUFBUSxFQUFFLENBQUE7QUFDZixDQUFDLENBQUE7QUFsQlksUUFBQSxlQUFlLG1CQWtCM0I7QUFFTSxNQUFNLG1CQUFt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ZXJSZXF1ZXN0IH0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IERFRkFVTFRfVE9LRU5fQkFMQU5DRSwgREVGQVVMVF9UT0tFTl9ERUNJTUFMUywgbWFrZUNvbmZpZywgbWFrZU9wdGlvbnMgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCB7IFRva2VuQWxsb2NhdGlvbnMsIENvbmZpZywgUmVzcG9uc2VQYXlsb2FkLCBHZXRQcmljZXMgfSBmcm9tICcuL3R5cGVzJ1xuaW1wb3J0IHsgRGVjaW1hbCB9IGZyb20gJ2RlY2ltYWwuanMnXG5pbXBvcnQgeyBBZGFwdGVyRXJyb3IsIFJlcXVlc3RlciwgVmFsaWRhdG9yIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQgeyBCaWdOdW1iZXIgfSBmcm9tICdldGhlcnMnXG5pbXBvcnQgeyBnZXRQcmljZVByb3ZpZGVyIH0gZnJvbSAnLi9kYXRhUHJvdmlkZXInXG5cbkRlY2ltYWwuc2V0KHsgcHJlY2lzaW9uOiAxMDAgfSlcblxuZXhwb3J0IGNvbnN0IHByaWNlVG90YWxWYWx1ZSA9IChcbiAgc291cmNlOiBzdHJpbmcsXG4gIGFsbG9jYXRpb25zOiBUb2tlbkFsbG9jYXRpb25zLFxuICBxdW90ZTogc3RyaW5nLFxuICBkYXRhOiBSZXNwb25zZVBheWxvYWQsXG4pOiBudW1iZXIgPT4ge1xuICByZXR1cm4gYWxsb2NhdGlvbnNcbiAgICAucmVkdWNlKChhY2MsIHQpID0+IHtcbiAgICAgIGNvbnN0IHZhbCA9IGRhdGFbdC5zeW1ib2xdLnF1b3RlW3F1b3RlXS5wcmljZVxuICAgICAgaWYgKCF2YWwpXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICBgRVJST1I6IE5vIHByaWNlIHZhbHVlIGZvdW5kIGZvciAke3Quc3ltYm9sfS8ke3F1b3RlfSBmcm9tIHRoZSAke3NvdXJjZX0gYWRhcHRlci5gLFxuICAgICAgICApXG4gICAgICBjb25zdCBjb2lucyA9IG5ldyBEZWNpbWFsKHQuYmFsYW5jZS50b1N0cmluZygxMCkpLmRpdigxMCAqKiB0LmRlY2ltYWxzKVxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIHJldHVybiBhY2MuYWRkKGNvaW5zLm11bCh2YWwhKSlcbiAgICB9LCBuZXcgRGVjaW1hbCgwKSlcbiAgICAudG9OdW1iZXIoKVxufVxuXG5leHBvcnQgY29uc3QgbWFya2V0Q2FwVG90YWxWYWx1ZSA9IChcbiAgc291cmNlOiBzdHJpbmcsXG4gIGFsbG9jYXRpb25zOiBUb2tlbkFsbG9jYXRpb25zLFxuICBxdW90ZTogc3RyaW5nLFxuICBkYXRhOiBSZXNwb25zZVBheWxvYWQsXG4pOiBudW1iZXIgPT4ge1xuICByZXR1cm4gYWxsb2NhdGlvbnNcbiAgICAucmVkdWNlKChhY2MsIHQpID0+IHtcbiAgICAgIGNvbnN0IHZhbCA9IGRhdGFbdC5zeW1ib2xdLnF1b3RlW3F1b3RlXS5tYXJrZXRDYXBcbiAgICAgIGlmICghdmFsKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEVSUk9SOiBObyBtYXJrZXRjYXAgdmFsdWUgZm91bmQgZm9yICR7dC5zeW1ib2x9LyR7cXVvdGV9IGZyb20gdGhlICR7c291cmNlfSBhZGFwdGVyLmAsXG4gICAgICAgIClcbiAgICAgIGNvbnN0IGNvaW5zID0gbmV3IERlY2ltYWwodC5iYWxhbmNlLnRvU3RyaW5nKDEwKSkuZGl2KDEwICoqIHQuZGVjaW1hbHMpXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgcmV0dXJuIGFjYy5hZGQoY29pbnMubXVsKHZhbCEpKVxuICAgIH0sIG5ldyBEZWNpbWFsKDApKVxuICAgIC50b051bWJlcigpXG59XG5cbmNvbnN0IHRvVmFsaWRBbGxvY2F0aW9ucyA9IChhbGxvY2F0aW9uczogYW55W10pOiBUb2tlbkFsbG9jYXRpb25zID0+IHtcbiAgY29uc3QgX3RvVmFsaWRTeW1ib2wgPSAoc3ltYm9sOiBzdHJpbmcpID0+IHtcbiAgICBpZiAoIXN5bWJvbClcbiAgICAgIHRocm93IG5ldyBBZGFwdGVyRXJyb3IoeyBtZXNzYWdlOiBgU3ltYm9sIG5vdCBhdmFpbGFibGUgZm9yIGFsbCB0b2tlbnMuYCwgc3RhdHVzQ29kZTogNDAwIH0pXG4gICAgcmV0dXJuIHN5bWJvbC50b1VwcGVyQ2FzZSgpXG4gIH1cbiAgY29uc3QgX3RvVmFsaWREZWNpbWFscyA9IChkZWNpbWFsczogbnVtYmVyIHwgdW5kZWZpbmVkKSA9PiB7XG4gICAgaWYgKGRlY2ltYWxzID09PSB1bmRlZmluZWQpIHJldHVybiBERUZBVUxUX1RPS0VOX0RFQ0lNQUxTXG4gICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIoZGVjaW1hbHMpICYmIGRlY2ltYWxzID49IDAgPyBkZWNpbWFscyA6IERFRkFVTFRfVE9LRU5fREVDSU1BTFNcbiAgfVxuICBjb25zdCBfdG9WYWxpZEJhbGFuY2UgPSAoYmFsYW5jZTogbnVtYmVyIHwgc3RyaW5nIHwgdW5kZWZpbmVkLCBkZWNpbWFsczogbnVtYmVyKSA9PiB7XG4gICAgaWYgKCFiYWxhbmNlKSByZXR1cm4gREVGQVVMVF9UT0tFTl9CQUxBTkNFICogMTAgKiogZGVjaW1hbHNcbiAgICBsZXQgQk5iYWxhbmNlXG4gICAgdHJ5IHtcbiAgICAgIEJOYmFsYW5jZSA9IEJpZ051bWJlci5mcm9tKGJhbGFuY2UudG9TdHJpbmcoKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHsgbWVzc2FnZTogYEludmFsaWQgYmFsYW5jZTogJHtlLm1lc3NhZ2V9YCwgc3RhdHVzQ29kZTogNDAwIH0pXG4gICAgfVxuICAgIGlmIChCTmJhbGFuY2UuaXNOZWdhdGl2ZSgpKVxuICAgICAgdGhyb3cgbmV3IEFkYXB0ZXJFcnJvcih7IG1lc3NhZ2U6IGBCYWxhbmNlIGNhbm5vdCBiZSBuZWdhdGl2ZWAsIHN0YXR1c0NvZGU6IDQwMCB9KVxuICAgIHJldHVybiBiYWxhbmNlXG4gIH1cbiAgcmV0dXJuIGFsbG9jYXRpb25zLm1hcCgodDogYW55KSA9PiB7XG4gICAgY29uc3QgZGVjaW1hbHMgPSBfdG9WYWxpZERlY2ltYWxzKHQuZGVjaW1hbHMpXG4gICAgcmV0dXJuIHtcbiAgICAgIHN5bWJvbDogX3RvVmFsaWRTeW1ib2wodC5zeW1ib2wpLFxuICAgICAgZGVjaW1hbHMsXG4gICAgICBiYWxhbmNlOiBfdG9WYWxpZEJhbGFuY2UodC5iYWxhbmNlLCBkZWNpbWFscyksXG4gICAgfVxuICB9KVxufVxuXG5jb25zdCBjb21wdXRlUHJpY2UgPSBhc3luYyAoXG4gIHNvdXJjZTogc3RyaW5nLFxuICBnZXRQcmljZXM6IEdldFByaWNlcyxcbiAgYWxsb2NhdGlvbnM6IFRva2VuQWxsb2NhdGlvbnMsXG4gIHF1b3RlOiBzdHJpbmcsXG4pID0+IHtcbiAgY29uc3Qgc3ltYm9scyA9IChhbGxvY2F0aW9ucyBhcyBUb2tlbkFsbG9jYXRpb25zKS5tYXAoKHQpID0+IHQuc3ltYm9sKVxuICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2V0UHJpY2VzKHN5bWJvbHMsIHF1b3RlKVxuICBjb25zdCByZXN1bHQgPSBwcmljZVRvdGFsVmFsdWUoc291cmNlLCBhbGxvY2F0aW9ucywgcXVvdGUsIHBheWxvYWQpXG4gIHJldHVybiB7IHBheWxvYWQsIHJlc3VsdCB9XG59XG5cbmNvbnN0IGNvbXB1dGVNYXJrZXRDYXAgPSBhc3luYyAoXG4gIHNvdXJjZTogc3RyaW5nLFxuICBnZXRQcmljZXM6IEdldFByaWNlcyxcbiAgYWxsb2NhdGlvbnM6IFRva2VuQWxsb2NhdGlvbnMsXG4gIHF1b3RlOiBzdHJpbmcsXG4pID0+IHtcbiAgY29uc3Qgc3ltYm9scyA9IChhbGxvY2F0aW9ucyBhcyBUb2tlbkFsbG9jYXRpb25zKS5tYXAoKHQpID0+IHQuc3ltYm9sKVxuICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZ2V0UHJpY2VzKHN5bWJvbHMsIHF1b3RlLCB0cnVlKVxuXG4gIGNvbnN0IHJlc3VsdCA9IG1hcmtldENhcFRvdGFsVmFsdWUoc291cmNlLCBhbGxvY2F0aW9ucywgcXVvdGUsIHBheWxvYWQpXG4gIHJldHVybiB7IHBheWxvYWQsIHJlc3VsdCB9XG59XG5cbmNvbnN0IGlucHV0UGFyYW1zID0ge1xuICBzb3VyY2U6IGZhbHNlLFxuICBhbGxvY2F0aW9uczogdHJ1ZSxcbiAgcXVvdGU6IGZhbHNlLFxuICBtZXRob2Q6IGZhbHNlLFxufVxuXG5leHBvcnQgY29uc3QgZXhlY3V0ZSA9IGFzeW5jIChpbnB1dDogQWRhcHRlclJlcXVlc3QsIGNvbmZpZzogQ29uZmlnKTogUHJvbWlzZTxBZGFwdGVyUmVzcG9uc2U+ID0+IHtcbiAgY29uc3QgcGFyYW1PcHRpb25zID0gbWFrZU9wdGlvbnMoY29uZmlnKVxuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCBpbnB1dFBhcmFtcywgcGFyYW1PcHRpb25zKVxuICBpZiAodmFsaWRhdG9yLmVycm9yKSB0aHJvdyB2YWxpZGF0b3IuZXJyb3JcblxuICBjb25zdCBqb2JSdW5JRCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuaWRcbiAgY29uc3QgeyBxdW90ZSA9IGNvbmZpZy5kZWZhdWx0UXVvdGUsIG1ldGhvZCA9IGNvbmZpZy5kZWZhdWx0TWV0aG9kIH0gPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGFcbiAgY29uc3QgYWxsb2NhdGlvbnMgPSB0b1ZhbGlkQWxsb2NhdGlvbnModmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmFsbG9jYXRpb25zKVxuICBjb25zdCBzb3VyY2U6IHN0cmluZyA9IChcbiAgICB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuc291cmNlIHx8XG4gICAgY29uZmlnLmRlZmF1bHRTb3VyY2UgfHxcbiAgICAnJ1xuICApLnRvTG93ZXJDYXNlKClcbiAgaWYgKHNvdXJjZSA9PT0gJycpIHtcbiAgICB0aHJvdyBFcnJvcignTm8gc291cmNlIHNwZWNpZmllZCBpbiB0aGUgcmVxdWVzdCBvciBjb25maWchJylcbiAgfVxuXG4gIGNvbnN0IHNvdXJjZUNvbmZpZyA9IGNvbmZpZy5zb3VyY2VzW3NvdXJjZV1cblxuICBjb25zdCBfc3VjY2VzcyA9IChwYXlsb2FkOiBSZXNwb25zZVBheWxvYWQsIHJlc3VsdDogbnVtYmVyKSA9PlxuICAgIFJlcXVlc3Rlci5zdWNjZXNzKFxuICAgICAgam9iUnVuSUQsXG4gICAgICB7XG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICBkYXRhOiB7IHNvdXJjZXM6IFtdLCBwYXlsb2FkLCByZXN1bHQgfSxcbiAgICAgIH0sXG4gICAgICB0cnVlLFxuICAgIClcblxuICBjb25zdCBnZXRQcmljZXMgPSBnZXRQcmljZVByb3ZpZGVyKHNvdXJjZSwgam9iUnVuSUQsIHNvdXJjZUNvbmZpZy5hcGkpXG4gIHN3aXRjaCAobWV0aG9kLnRvTG93ZXJDYXNlKCkpIHtcbiAgICBjYXNlICdwcmljZSc6IHtcbiAgICAgIGNvbnN0IHByaWNlID0gYXdhaXQgY29tcHV0ZVByaWNlKHNvdXJjZSwgZ2V0UHJpY2VzLCBhbGxvY2F0aW9ucywgcXVvdGUpXG4gICAgICByZXR1cm4gX3N1Y2Nlc3MocHJpY2UucGF5bG9hZCwgcHJpY2UucmVzdWx0KVxuICAgIH1cbiAgICBjYXNlICdtYXJrZXRjYXAnOiB7XG4gICAgICBjb25zdCBtYXJrZXRDYXAgPSBhd2FpdCBjb21wdXRlTWFya2V0Q2FwKHNvdXJjZSwgZ2V0UHJpY2VzLCBhbGxvY2F0aW9ucywgcXVvdGUpXG4gICAgICByZXR1cm4gX3N1Y2Nlc3MobWFya2V0Q2FwLnBheWxvYWQsIG1hcmtldENhcC5yZXN1bHQpXG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHtcbiAgICAgICAgam9iUnVuSUQsXG4gICAgICAgIG1lc3NhZ2U6IGBNZXRob2QgJHttZXRob2R9IG5vdCBzdXBwb3J0ZWQuYCxcbiAgICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgfSlcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgbWFrZUV4ZWN1dGUgPSAoY29uZmlnPzogQ29uZmlnKTogRXhlY3V0ZSA9PiB7XG4gIHJldHVybiBhc3luYyAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpID0+IGV4ZWN1dGUocmVxdWVzdCwgY29uZmlnIHx8IG1ha2VDb25maWcoKSlcbn1cbiJdfQ==