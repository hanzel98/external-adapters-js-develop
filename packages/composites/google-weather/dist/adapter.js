"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeExecute = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const BigQuery = tslib_1.__importStar(require("@chainlink/google-bigquery-adapter"));
const config_1 = require("./config");
const gjv = tslib_1.__importStar(require("geojson-validation"));
const convert_units_1 = tslib_1.__importDefault(require("convert-units"));
const customParams = {
    geoJson: true,
    pointInPolygon: false,
    dateFrom: true,
    dateTo: true,
    method: true,
    column: true,
    units: false,
};
const execute = async (input, context, config) => {
    const validator = new ea_bootstrap_1.Validator(input, customParams);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.jobRunID;
    let geoJson = validator.validated.data.geoJson;
    if (typeof geoJson === 'string') {
        geoJson = JSON.parse(geoJson);
    }
    const dateFrom = validator.validated.data.dateFrom;
    const dateTo = validator.validated.data.dateTo;
    const method = validator.validated.data.method;
    const column = validator.validated.data.column.toLowerCase();
    const units = validator.validated.data.units || 'imperial';
    if (!gjv.valid(geoJson)) {
        throw new Error('Provided GeoJSON data is not valid');
    }
    const queryBuilder = new QueryBuilder(geoJson, dateFrom, dateTo, method, column, config.dataset);
    const bigQuery = BigQuery.makeExecute(BigQuery.makeConfig());
    const response = await bigQuery({ id: jobRunID, data: queryBuilder.toQuery() }, context);
    const imperialValue = ea_bootstrap_1.Requester.validateResultNumber(response.result, [0, 'result']);
    const result = convertUnits(column, imperialValue, units);
    return ea_bootstrap_1.Requester.success(jobRunID, { data: { result } });
};
exports.execute = execute;
const convertUnits = (column, value, units) => {
    if (units !== 'metric')
        return value;
    const conv = convert_units_1.default(value);
    switch (column) {
        case 'temp':
        case 'dewp':
        case 'max':
        case 'min':
            return conv.from('F').to('C');
        case 'slp':
        case 'stp':
            return conv.from('bar').to('hPa');
        case 'visib':
            return conv.from('mi').to('m');
        case 'wdsp':
        case 'gust':
        case 'mxpsd':
            return conv.from('knot').to('m/s');
        case 'prcp':
        case 'sndp':
            return conv.from('in').to('mm');
        default:
            return value;
    }
};
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
class QueryBuilder {
    constructor(geoJson, dateFrom, dateTo, method, column, dataset) {
        this.geoJson = geoJson;
        this.dateFrom = new Date(dateFrom);
        this.dateTo = new Date(dateTo);
        this.method = method;
        this.column = column.replace(/\W/g, '');
        this.dataset = dataset;
    }
    modifiedColumn() {
        switch (this.column) {
            case 'fog':
            case 'rain_drizzle':
            case 'snow_ice_pellets':
            case 'hail':
            case 'tornado_funnel_cloud':
            case 'thunder': {
                return `cast(${this.column} as int64)`;
            }
        }
        return this.column;
    }
    select() {
        switch (this.method) {
            case 'AVG':
                return `AVG(${this.modifiedColumn()})`;
            case 'SUM':
                return `SUM(${this.modifiedColumn()})`;
            case 'MIN':
                return `MIN(${this.modifiedColumn()})`;
            case 'MAX':
                return `MAX(${this.modifiedColumn()})`;
            default:
                throw new Error(`Unrecognized method: "${this.method}"`);
        }
    }
    from() {
        const diff = this.dateTo.getUTCFullYear() - this.dateFrom.getUTCFullYear();
        if (diff === 0) {
            return `SELECT \`stn\`, \`${this.column}\`, \`date\` FROM \`${this.dataset}.gsod${this.dateTo.getUTCFullYear()}\``;
        }
        const years = new Array(diff + 1)
            .fill(0)
            .map((_, i) => `SELECT \`stn\`, \`${this.column}\`, \`date\` FROM \`${this.dataset}.gsod${this.dateTo.getUTCFullYear() - i}\``);
        return years.join('\nUNION ALL\n');
    }
    geoJsonQuery() {
        return this.geoJson.features
            .map((ft, i) => {
            switch (ft.geometry.type) {
                case 'Polygon': {
                    return `ST_CONTAINS(ST_GEOGFROMGEOJSON(@geoJson${i}), stations.geog)`;
                }
                case 'Point': {
                    return [
                        'usaf = ',
                        '(SELECT usaf FROM stations AS sts',
                        'WHERE PARSE_DATE("%Y%m%d", sts.`begin`) <= DATE(@dateFrom)',
                        'AND PARSE_DATE("%Y%m%d", sts.`end`) >= DATE(@dateTo)',
                        `ORDER BY ST_DISTANCE(ST_GEOGFROMGEOJSON(@geoJson${i}), sts.geog) LIMIT 1)`,
                    ].join('\n');
                }
                default: {
                    return undefined;
                }
            }
        })
            .filter((line) => !!line);
    }
    geoJsonParams() {
        const map = {};
        this.geoJson.features.forEach((ft, i) => {
            map[`geoJson${i}`] = JSON.stringify(ft.geometry);
        });
        return map;
    }
    static formatDate(date) {
        const year = date.getUTCFullYear();
        let month = '' + (date.getUTCMonth() + 1);
        let day = '' + date.getUTCDate();
        if (month.length < 2)
            month = '0' + month;
        if (day.length < 2)
            day = '0' + day;
        return [year, month, day].join('-');
    }
    columnFiltering() {
        switch (this.column) {
            case 'prcp': {
                // TODO: Causes issues if method is AVG, as
                // this could have been 0 instead.
                return ['AND prcp != 99.99'];
            }
            case 'visib':
            case 'wdsp': {
                return [`AND ${this.column} != 999.9`];
            }
            case 'dewp':
            case 'slp':
            case 'stp':
            case 'max':
            case 'min':
            case 'temp': {
                return [`AND ${this.column} != 9999.9`];
            }
            case 'fog':
            case 'rain_drizzle':
            case 'snow_ice_pellets':
            case 'hail':
            case 'tornado_funnel_cloud':
            case 'thunder': {
                return [`AND (${this.column} = "0" OR ${this.column} = "1")`];
            }
        }
        return [];
    }
    toQuery() {
        return {
            query: [
                // Stations
                'WITH',
                'stations AS (',
                `  SELECT usaf, ST_GEOGPOINT(lon, lat) AS geog, \`begin\`, \`end\` FROM \`${this.dataset}.stations\``,
                ')',
                // Main query
                `SELECT ${this.select()} AS result`,
                `FROM (${this.from()})`,
                'WHERE stn IN (SELECT usaf FROM stations',
                `WHERE (${this.geoJsonQuery().join(`)\nOR\n(`)}))`,
                'AND date BETWEEN @dateFrom AND @dateTo',
                ...this.columnFiltering(),
            ].join('\n') + ';',
            params: {
                ...this.geoJsonParams(),
                dateFrom: QueryBuilder.formatDate(this.dateFrom),
                dateTo: QueryBuilder.formatDate(this.dateTo),
            },
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBOEQ7QUFFOUQscUZBQThEO0FBQzlELHFDQUE2QztBQUM3QyxnRUFBeUM7QUFDekMsMEVBQW1DO0FBc0JuQyxNQUFNLFlBQVksR0FBRztJQUNuQixPQUFPLEVBQUUsSUFBSTtJQUNiLGNBQWMsRUFBRSxLQUFLO0lBQ3JCLFFBQVEsRUFBRSxJQUFJO0lBQ2QsTUFBTSxFQUFFLElBQUk7SUFDWixNQUFNLEVBQUUsSUFBSTtJQUNaLE1BQU0sRUFBRSxJQUFJO0lBQ1osS0FBSyxFQUFFLEtBQUs7Q0FDYixDQUFBO0FBRU0sTUFBTSxPQUFPLEdBQThCLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQ2pGLE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVMsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUE7SUFDcEQsSUFBSSxTQUFTLENBQUMsS0FBSztRQUFFLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQTtJQUUxQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQTtJQUM3QyxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUE7SUFDOUMsSUFBSSxPQUFPLE9BQU8sS0FBSyxRQUFRLEVBQUU7UUFDL0IsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUE7S0FDOUI7SUFFRCxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7SUFDbEQsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBO0lBQzlDLE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQTtJQUM5QyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDNUQsTUFBTSxLQUFLLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxJQUFJLFVBQVUsQ0FBQTtJQUUxRCxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLG9DQUFvQyxDQUFDLENBQUE7S0FDdEQ7SUFFRCxNQUFNLFlBQVksR0FBRyxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQTtJQUVoRyxNQUFNLFFBQVEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFBO0lBQzVELE1BQU0sUUFBUSxHQUFHLE1BQU0sUUFBUSxDQUFDLEVBQUUsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLE9BQU8sRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLENBQUE7SUFDeEYsTUFBTSxhQUFhLEdBQUcsd0JBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUE7SUFDcEYsTUFBTSxNQUFNLEdBQUcsWUFBWSxDQUFDLE1BQU0sRUFBRSxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDekQsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7QUFDMUQsQ0FBQyxDQUFBO0FBM0JZLFFBQUEsT0FBTyxXQTJCbkI7QUFFRCxNQUFNLFlBQVksR0FBRyxDQUFDLE1BQWMsRUFBRSxLQUFhLEVBQUUsS0FBYSxFQUFVLEVBQUU7SUFDNUUsSUFBSSxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sS0FBSyxDQUFBO0lBRXBDLE1BQU0sSUFBSSxHQUFHLHVCQUFPLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDM0IsUUFBUSxNQUFNLEVBQUU7UUFDZCxLQUFLLE1BQU0sQ0FBQztRQUNaLEtBQUssTUFBTSxDQUFDO1FBQ1osS0FBSyxLQUFLLENBQUM7UUFDWCxLQUFLLEtBQUs7WUFDUixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQy9CLEtBQUssS0FBSyxDQUFDO1FBQ1gsS0FBSyxLQUFLO1lBQ1IsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNuQyxLQUFLLE9BQU87WUFDVixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQ2hDLEtBQUssTUFBTSxDQUFDO1FBQ1osS0FBSyxNQUFNLENBQUM7UUFDWixLQUFLLE9BQU87WUFDVixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3BDLEtBQUssTUFBTSxDQUFDO1FBQ1osS0FBSyxNQUFNO1lBQ1QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNqQztZQUNFLE9BQU8sS0FBSyxDQUFBO0tBQ2Y7QUFDSCxDQUFDLENBQUE7QUFFTSxNQUFNLFdBQVcsR0FBMkIsQ0FBQyxNQUFNLEVBQUUsRUFBRTtJQUM1RCxPQUFPLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxlQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLElBQUksbUJBQVUsRUFBRSxDQUFDLENBQUE7QUFDdEYsQ0FBQyxDQUFBO0FBRlksUUFBQSxXQUFXLGVBRXZCO0FBSUQsTUFBTSxZQUFZO0lBUWhCLFlBQ0UsT0FBZ0IsRUFDaEIsUUFBZ0IsRUFDaEIsTUFBYyxFQUNkLE1BQWMsRUFDZCxNQUFjLEVBQ2QsT0FBZTtRQUVmLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO1FBQ3RCLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDbEMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUM5QixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQTtRQUNwQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO0lBQ3hCLENBQUM7SUFFTyxjQUFjO1FBQ3BCLFFBQVEsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNuQixLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssY0FBYyxDQUFDO1lBQ3BCLEtBQUssa0JBQWtCLENBQUM7WUFDeEIsS0FBSyxNQUFNLENBQUM7WUFDWixLQUFLLHNCQUFzQixDQUFDO1lBQzVCLEtBQUssU0FBUyxDQUFDLENBQUM7Z0JBQ2QsT0FBTyxRQUFRLElBQUksQ0FBQyxNQUFNLFlBQVksQ0FBQTthQUN2QztTQUNGO1FBRUQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFBO0lBQ3BCLENBQUM7SUFFTyxNQUFNO1FBQ1osUUFBUSxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ25CLEtBQUssS0FBSztnQkFDUixPQUFPLE9BQU8sSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUE7WUFDeEMsS0FBSyxLQUFLO2dCQUNSLE9BQU8sT0FBTyxJQUFJLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FBQTtZQUN4QyxLQUFLLEtBQUs7Z0JBQ1IsT0FBTyxPQUFPLElBQUksQ0FBQyxjQUFjLEVBQUUsR0FBRyxDQUFBO1lBQ3hDLEtBQUssS0FBSztnQkFDUixPQUFPLE9BQU8sSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUE7WUFDeEM7Z0JBQ0UsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7U0FDM0Q7SUFDSCxDQUFDO0lBRU8sSUFBSTtRQUNWLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUMxRSxJQUFJLElBQUksS0FBSyxDQUFDLEVBQUU7WUFDZCxPQUFPLHFCQUFxQixJQUFJLENBQUMsTUFBTSx1QkFDckMsSUFBSSxDQUFDLE9BQ1AsUUFBUSxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUE7U0FDekM7UUFFRCxNQUFNLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO2FBQzlCLElBQUksQ0FBQyxDQUFDLENBQUM7YUFDUCxHQUFHLENBQ0YsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FDUCxxQkFBcUIsSUFBSSxDQUFDLE1BQU0sdUJBQXVCLElBQUksQ0FBQyxPQUFPLFFBQ2pFLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEdBQUcsQ0FDakMsSUFBSSxDQUNQLENBQUE7UUFFSCxPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUVPLFlBQVk7UUFDbEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVE7YUFDekIsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ2IsUUFBUSxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtnQkFDeEIsS0FBSyxTQUFTLENBQUMsQ0FBQztvQkFDZCxPQUFPLDBDQUEwQyxDQUFDLG1CQUFtQixDQUFBO2lCQUN0RTtnQkFDRCxLQUFLLE9BQU8sQ0FBQyxDQUFDO29CQUNaLE9BQU87d0JBQ0wsU0FBUzt3QkFDVCxtQ0FBbUM7d0JBQ25DLDREQUE0RDt3QkFDNUQsc0RBQXNEO3dCQUN0RCxtREFBbUQsQ0FBQyx1QkFBdUI7cUJBQzVFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO2lCQUNiO2dCQUNELE9BQU8sQ0FBQyxDQUFDO29CQUNQLE9BQU8sU0FBUyxDQUFBO2lCQUNqQjthQUNGO1FBQ0gsQ0FBQyxDQUFDO2FBQ0QsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFhLENBQUE7SUFDekMsQ0FBQztJQUVPLGFBQWE7UUFDbkIsTUFBTSxHQUFHLEdBQThCLEVBQUUsQ0FBQTtRQUV6QyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDdEMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUNsRCxDQUFDLENBQUMsQ0FBQTtRQUVGLE9BQU8sR0FBRyxDQUFBO0lBQ1osQ0FBQztJQUVPLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBVTtRQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUE7UUFDbEMsSUFBSSxLQUFLLEdBQUcsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ3pDLElBQUksR0FBRyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7UUFFaEMsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUM7WUFBRSxLQUFLLEdBQUcsR0FBRyxHQUFHLEtBQUssQ0FBQTtRQUN6QyxJQUFJLEdBQUcsQ0FBQyxNQUFNLEdBQUcsQ0FBQztZQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxDQUFBO1FBRW5DLE9BQU8sQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUNyQyxDQUFDO0lBRU8sZUFBZTtRQUNyQixRQUFRLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDbkIsS0FBSyxNQUFNLENBQUMsQ0FBQztnQkFDWCwyQ0FBMkM7Z0JBQzNDLGtDQUFrQztnQkFDbEMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUE7YUFDN0I7WUFDRCxLQUFLLE9BQU8sQ0FBQztZQUNiLEtBQUssTUFBTSxDQUFDLENBQUM7Z0JBQ1gsT0FBTyxDQUFDLE9BQU8sSUFBSSxDQUFDLE1BQU0sV0FBVyxDQUFDLENBQUE7YUFDdkM7WUFDRCxLQUFLLE1BQU0sQ0FBQztZQUNaLEtBQUssS0FBSyxDQUFDO1lBQ1gsS0FBSyxLQUFLLENBQUM7WUFDWCxLQUFLLEtBQUssQ0FBQztZQUNYLEtBQUssS0FBSyxDQUFDO1lBQ1gsS0FBSyxNQUFNLENBQUMsQ0FBQztnQkFDWCxPQUFPLENBQUMsT0FBTyxJQUFJLENBQUMsTUFBTSxZQUFZLENBQUMsQ0FBQTthQUN4QztZQUNELEtBQUssS0FBSyxDQUFDO1lBQ1gsS0FBSyxjQUFjLENBQUM7WUFDcEIsS0FBSyxrQkFBa0IsQ0FBQztZQUN4QixLQUFLLE1BQU0sQ0FBQztZQUNaLEtBQUssc0JBQXNCLENBQUM7WUFDNUIsS0FBSyxTQUFTLENBQUMsQ0FBQztnQkFDZCxPQUFPLENBQUMsUUFBUSxJQUFJLENBQUMsTUFBTSxhQUFhLElBQUksQ0FBQyxNQUFNLFNBQVMsQ0FBQyxDQUFBO2FBQzlEO1NBQ0Y7UUFFRCxPQUFPLEVBQUUsQ0FBQTtJQUNYLENBQUM7SUFFTSxPQUFPO1FBQ1osT0FBTztZQUNMLEtBQUssRUFDSDtnQkFDRSxXQUFXO2dCQUNYLE1BQU07Z0JBQ04sZUFBZTtnQkFDZiw0RUFBNEUsSUFBSSxDQUFDLE9BQU8sYUFBYTtnQkFDckcsR0FBRztnQkFFSCxhQUFhO2dCQUNiLFVBQVUsSUFBSSxDQUFDLE1BQU0sRUFBRSxZQUFZO2dCQUNuQyxTQUFTLElBQUksQ0FBQyxJQUFJLEVBQUUsR0FBRztnQkFDdkIseUNBQXlDO2dCQUN6QyxVQUFVLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUk7Z0JBQ2xELHdDQUF3QztnQkFDeEMsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFO2FBQzFCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUc7WUFDcEIsTUFBTSxFQUFFO2dCQUNOLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFDdkIsUUFBUSxFQUFFLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztnQkFDaEQsTUFBTSxFQUFFLFlBQVksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQzthQUM3QztTQUNGLENBQUE7SUFDSCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgRXhlY3V0ZUZhY3RvcnksIEV4ZWN1dGVXaXRoQ29uZmlnIH0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCAqIGFzIEJpZ1F1ZXJ5IGZyb20gJ0BjaGFpbmxpbmsvZ29vZ2xlLWJpZ3F1ZXJ5LWFkYXB0ZXInXG5pbXBvcnQgeyBDb25maWcsIG1ha2VDb25maWcgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCAqIGFzIGdqdiBmcm9tICdnZW9qc29uLXZhbGlkYXRpb24nXG5pbXBvcnQgY29udmVydCBmcm9tICdjb252ZXJ0LXVuaXRzJ1xuXG5leHBvcnQgaW50ZXJmYWNlIFBvbHlnb24ge1xuICB0eXBlOiAnUG9seWdvbidcbiAgY29vcmRpbmF0ZXM6IFtudW1iZXIsIG51bWJlcl1bXVtdXG59XG5cbmV4cG9ydCB0eXBlIFBvaW50ID0ge1xuICB0eXBlOiAnUG9pbnQnXG4gIGNvb3JkaW5hdGVzOiBbbnVtYmVyLCBudW1iZXJdXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRmVhdHVyZSB7XG4gIHR5cGU6IHN0cmluZ1xuICBnZW9tZXRyeTogUG9seWdvbiB8IFBvaW50XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2VvSlNPTiB7XG4gIHR5cGU6IHN0cmluZ1xuICBmZWF0dXJlczogRmVhdHVyZVtdXG59XG5cbmNvbnN0IGN1c3RvbVBhcmFtcyA9IHtcbiAgZ2VvSnNvbjogdHJ1ZSxcbiAgcG9pbnRJblBvbHlnb246IGZhbHNlLFxuICBkYXRlRnJvbTogdHJ1ZSxcbiAgZGF0ZVRvOiB0cnVlLFxuICBtZXRob2Q6IHRydWUsXG4gIGNvbHVtbjogdHJ1ZSxcbiAgdW5pdHM6IGZhbHNlLFxufVxuXG5leHBvcnQgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZVdpdGhDb25maWc8Q29uZmlnPiA9IGFzeW5jIChpbnB1dCwgY29udGV4dCwgY29uZmlnKSA9PiB7XG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGN1c3RvbVBhcmFtcylcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG5cbiAgY29uc3Qgam9iUnVuSUQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmpvYlJ1bklEXG4gIGxldCBnZW9Kc29uID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmdlb0pzb25cbiAgaWYgKHR5cGVvZiBnZW9Kc29uID09PSAnc3RyaW5nJykge1xuICAgIGdlb0pzb24gPSBKU09OLnBhcnNlKGdlb0pzb24pXG4gIH1cblxuICBjb25zdCBkYXRlRnJvbSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5kYXRlRnJvbVxuICBjb25zdCBkYXRlVG8gPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuZGF0ZVRvXG4gIGNvbnN0IG1ldGhvZCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5tZXRob2RcbiAgY29uc3QgY29sdW1uID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNvbHVtbi50b0xvd2VyQ2FzZSgpXG4gIGNvbnN0IHVuaXRzID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnVuaXRzIHx8ICdpbXBlcmlhbCdcblxuICBpZiAoIWdqdi52YWxpZChnZW9Kc29uKSkge1xuICAgIHRocm93IG5ldyBFcnJvcignUHJvdmlkZWQgR2VvSlNPTiBkYXRhIGlzIG5vdCB2YWxpZCcpXG4gIH1cblxuICBjb25zdCBxdWVyeUJ1aWxkZXIgPSBuZXcgUXVlcnlCdWlsZGVyKGdlb0pzb24sIGRhdGVGcm9tLCBkYXRlVG8sIG1ldGhvZCwgY29sdW1uLCBjb25maWcuZGF0YXNldClcblxuICBjb25zdCBiaWdRdWVyeSA9IEJpZ1F1ZXJ5Lm1ha2VFeGVjdXRlKEJpZ1F1ZXJ5Lm1ha2VDb25maWcoKSlcbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBiaWdRdWVyeSh7IGlkOiBqb2JSdW5JRCwgZGF0YTogcXVlcnlCdWlsZGVyLnRvUXVlcnkoKSB9LCBjb250ZXh0KVxuICBjb25zdCBpbXBlcmlhbFZhbHVlID0gUmVxdWVzdGVyLnZhbGlkYXRlUmVzdWx0TnVtYmVyKHJlc3BvbnNlLnJlc3VsdCwgWzAsICdyZXN1bHQnXSlcbiAgY29uc3QgcmVzdWx0ID0gY29udmVydFVuaXRzKGNvbHVtbiwgaW1wZXJpYWxWYWx1ZSwgdW5pdHMpXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwgeyBkYXRhOiB7IHJlc3VsdCB9IH0pXG59XG5cbmNvbnN0IGNvbnZlcnRVbml0cyA9IChjb2x1bW46IHN0cmluZywgdmFsdWU6IG51bWJlciwgdW5pdHM6IHN0cmluZyk6IG51bWJlciA9PiB7XG4gIGlmICh1bml0cyAhPT0gJ21ldHJpYycpIHJldHVybiB2YWx1ZVxuXG4gIGNvbnN0IGNvbnYgPSBjb252ZXJ0KHZhbHVlKVxuICBzd2l0Y2ggKGNvbHVtbikge1xuICAgIGNhc2UgJ3RlbXAnOlxuICAgIGNhc2UgJ2Rld3AnOlxuICAgIGNhc2UgJ21heCc6XG4gICAgY2FzZSAnbWluJzpcbiAgICAgIHJldHVybiBjb252LmZyb20oJ0YnKS50bygnQycpXG4gICAgY2FzZSAnc2xwJzpcbiAgICBjYXNlICdzdHAnOlxuICAgICAgcmV0dXJuIGNvbnYuZnJvbSgnYmFyJykudG8oJ2hQYScpXG4gICAgY2FzZSAndmlzaWInOlxuICAgICAgcmV0dXJuIGNvbnYuZnJvbSgnbWknKS50bygnbScpXG4gICAgY2FzZSAnd2RzcCc6XG4gICAgY2FzZSAnZ3VzdCc6XG4gICAgY2FzZSAnbXhwc2QnOlxuICAgICAgcmV0dXJuIGNvbnYuZnJvbSgna25vdCcpLnRvKCdtL3MnKVxuICAgIGNhc2UgJ3ByY3AnOlxuICAgIGNhc2UgJ3NuZHAnOlxuICAgICAgcmV0dXJuIGNvbnYuZnJvbSgnaW4nKS50bygnbW0nKVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gdmFsdWVcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgbWFrZUV4ZWN1dGU6IEV4ZWN1dGVGYWN0b3J5PENvbmZpZz4gPSAoY29uZmlnKSA9PiB7XG4gIHJldHVybiBhc3luYyAocmVxdWVzdCwgY29udGV4dCkgPT4gZXhlY3V0ZShyZXF1ZXN0LCBjb250ZXh0LCBjb25maWcgfHwgbWFrZUNvbmZpZygpKVxufVxuXG50eXBlIE1ldGhvZCA9ICdTVU0nIHwgJ0FWRycgfCAnTUlOJyB8ICdNQVgnXG5cbmNsYXNzIFF1ZXJ5QnVpbGRlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgZ2VvSnNvbjogR2VvSlNPTlxuICBwcml2YXRlIHJlYWRvbmx5IGRhdGVGcm9tOiBEYXRlXG4gIHByaXZhdGUgcmVhZG9ubHkgZGF0ZVRvOiBEYXRlXG4gIHByaXZhdGUgcmVhZG9ubHkgbWV0aG9kOiBNZXRob2RcbiAgcHJpdmF0ZSByZWFkb25seSBjb2x1bW46IHN0cmluZ1xuICBwcml2YXRlIHJlYWRvbmx5IGRhdGFzZXQ6IHN0cmluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGdlb0pzb246IEdlb0pTT04sXG4gICAgZGF0ZUZyb206IHN0cmluZyxcbiAgICBkYXRlVG86IHN0cmluZyxcbiAgICBtZXRob2Q6IE1ldGhvZCxcbiAgICBjb2x1bW46IHN0cmluZyxcbiAgICBkYXRhc2V0OiBzdHJpbmcsXG4gICkge1xuICAgIHRoaXMuZ2VvSnNvbiA9IGdlb0pzb25cbiAgICB0aGlzLmRhdGVGcm9tID0gbmV3IERhdGUoZGF0ZUZyb20pXG4gICAgdGhpcy5kYXRlVG8gPSBuZXcgRGF0ZShkYXRlVG8pXG4gICAgdGhpcy5tZXRob2QgPSBtZXRob2RcbiAgICB0aGlzLmNvbHVtbiA9IGNvbHVtbi5yZXBsYWNlKC9cXFcvZywgJycpXG4gICAgdGhpcy5kYXRhc2V0ID0gZGF0YXNldFxuICB9XG5cbiAgcHJpdmF0ZSBtb2RpZmllZENvbHVtbigpIHtcbiAgICBzd2l0Y2ggKHRoaXMuY29sdW1uKSB7XG4gICAgICBjYXNlICdmb2cnOlxuICAgICAgY2FzZSAncmFpbl9kcml6emxlJzpcbiAgICAgIGNhc2UgJ3Nub3dfaWNlX3BlbGxldHMnOlxuICAgICAgY2FzZSAnaGFpbCc6XG4gICAgICBjYXNlICd0b3JuYWRvX2Z1bm5lbF9jbG91ZCc6XG4gICAgICBjYXNlICd0aHVuZGVyJzoge1xuICAgICAgICByZXR1cm4gYGNhc3QoJHt0aGlzLmNvbHVtbn0gYXMgaW50NjQpYFxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmNvbHVtblxuICB9XG5cbiAgcHJpdmF0ZSBzZWxlY3QoKSB7XG4gICAgc3dpdGNoICh0aGlzLm1ldGhvZCkge1xuICAgICAgY2FzZSAnQVZHJzpcbiAgICAgICAgcmV0dXJuIGBBVkcoJHt0aGlzLm1vZGlmaWVkQ29sdW1uKCl9KWBcbiAgICAgIGNhc2UgJ1NVTSc6XG4gICAgICAgIHJldHVybiBgU1VNKCR7dGhpcy5tb2RpZmllZENvbHVtbigpfSlgXG4gICAgICBjYXNlICdNSU4nOlxuICAgICAgICByZXR1cm4gYE1JTigke3RoaXMubW9kaWZpZWRDb2x1bW4oKX0pYFxuICAgICAgY2FzZSAnTUFYJzpcbiAgICAgICAgcmV0dXJuIGBNQVgoJHt0aGlzLm1vZGlmaWVkQ29sdW1uKCl9KWBcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5yZWNvZ25pemVkIG1ldGhvZDogXCIke3RoaXMubWV0aG9kfVwiYClcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZyb20oKSB7XG4gICAgY29uc3QgZGlmZiA9IHRoaXMuZGF0ZVRvLmdldFVUQ0Z1bGxZZWFyKCkgLSB0aGlzLmRhdGVGcm9tLmdldFVUQ0Z1bGxZZWFyKClcbiAgICBpZiAoZGlmZiA9PT0gMCkge1xuICAgICAgcmV0dXJuIGBTRUxFQ1QgXFxgc3RuXFxgLCBcXGAke3RoaXMuY29sdW1ufVxcYCwgXFxgZGF0ZVxcYCBGUk9NIFxcYCR7XG4gICAgICAgIHRoaXMuZGF0YXNldFxuICAgICAgfS5nc29kJHt0aGlzLmRhdGVUby5nZXRVVENGdWxsWWVhcigpfVxcYGBcbiAgICB9XG5cbiAgICBjb25zdCB5ZWFycyA9IG5ldyBBcnJheShkaWZmICsgMSlcbiAgICAgIC5maWxsKDApXG4gICAgICAubWFwKFxuICAgICAgICAoXywgaSkgPT5cbiAgICAgICAgICBgU0VMRUNUIFxcYHN0blxcYCwgXFxgJHt0aGlzLmNvbHVtbn1cXGAsIFxcYGRhdGVcXGAgRlJPTSBcXGAke3RoaXMuZGF0YXNldH0uZ3NvZCR7XG4gICAgICAgICAgICB0aGlzLmRhdGVUby5nZXRVVENGdWxsWWVhcigpIC0gaVxuICAgICAgICAgIH1cXGBgLFxuICAgICAgKVxuXG4gICAgcmV0dXJuIHllYXJzLmpvaW4oJ1xcblVOSU9OIEFMTFxcbicpXG4gIH1cblxuICBwcml2YXRlIGdlb0pzb25RdWVyeSgpOiBzdHJpbmdbXSB7XG4gICAgcmV0dXJuIHRoaXMuZ2VvSnNvbi5mZWF0dXJlc1xuICAgICAgLm1hcCgoZnQsIGkpID0+IHtcbiAgICAgICAgc3dpdGNoIChmdC5nZW9tZXRyeS50eXBlKSB7XG4gICAgICAgICAgY2FzZSAnUG9seWdvbic6IHtcbiAgICAgICAgICAgIHJldHVybiBgU1RfQ09OVEFJTlMoU1RfR0VPR0ZST01HRU9KU09OKEBnZW9Kc29uJHtpfSksIHN0YXRpb25zLmdlb2cpYFxuICAgICAgICAgIH1cbiAgICAgICAgICBjYXNlICdQb2ludCc6IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICd1c2FmID0gJyxcbiAgICAgICAgICAgICAgJyhTRUxFQ1QgdXNhZiBGUk9NIHN0YXRpb25zIEFTIHN0cycsXG4gICAgICAgICAgICAgICdXSEVSRSBQQVJTRV9EQVRFKFwiJVklbSVkXCIsIHN0cy5gYmVnaW5gKSA8PSBEQVRFKEBkYXRlRnJvbSknLFxuICAgICAgICAgICAgICAnQU5EIFBBUlNFX0RBVEUoXCIlWSVtJWRcIiwgc3RzLmBlbmRgKSA+PSBEQVRFKEBkYXRlVG8pJyxcbiAgICAgICAgICAgICAgYE9SREVSIEJZIFNUX0RJU1RBTkNFKFNUX0dFT0dGUk9NR0VPSlNPTihAZ2VvSnNvbiR7aX0pLCBzdHMuZ2VvZykgTElNSVQgMSlgLFxuICAgICAgICAgICAgXS5qb2luKCdcXG4nKVxuICAgICAgICAgIH1cbiAgICAgICAgICBkZWZhdWx0OiB7XG4gICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgLmZpbHRlcigobGluZSkgPT4gISFsaW5lKSBhcyBzdHJpbmdbXVxuICB9XG5cbiAgcHJpdmF0ZSBnZW9Kc29uUGFyYW1zKCk6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0ge1xuICAgIGNvbnN0IG1hcDogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9XG5cbiAgICB0aGlzLmdlb0pzb24uZmVhdHVyZXMuZm9yRWFjaCgoZnQsIGkpID0+IHtcbiAgICAgIG1hcFtgZ2VvSnNvbiR7aX1gXSA9IEpTT04uc3RyaW5naWZ5KGZ0Lmdlb21ldHJ5KVxuICAgIH0pXG5cbiAgICByZXR1cm4gbWFwXG4gIH1cblxuICBwcml2YXRlIHN0YXRpYyBmb3JtYXREYXRlKGRhdGU6IERhdGUpOiBzdHJpbmcge1xuICAgIGNvbnN0IHllYXIgPSBkYXRlLmdldFVUQ0Z1bGxZZWFyKClcbiAgICBsZXQgbW9udGggPSAnJyArIChkYXRlLmdldFVUQ01vbnRoKCkgKyAxKVxuICAgIGxldCBkYXkgPSAnJyArIGRhdGUuZ2V0VVRDRGF0ZSgpXG5cbiAgICBpZiAobW9udGgubGVuZ3RoIDwgMikgbW9udGggPSAnMCcgKyBtb250aFxuICAgIGlmIChkYXkubGVuZ3RoIDwgMikgZGF5ID0gJzAnICsgZGF5XG5cbiAgICByZXR1cm4gW3llYXIsIG1vbnRoLCBkYXldLmpvaW4oJy0nKVxuICB9XG5cbiAgcHJpdmF0ZSBjb2x1bW5GaWx0ZXJpbmcoKTogc3RyaW5nW10ge1xuICAgIHN3aXRjaCAodGhpcy5jb2x1bW4pIHtcbiAgICAgIGNhc2UgJ3ByY3AnOiB7XG4gICAgICAgIC8vIFRPRE86IENhdXNlcyBpc3N1ZXMgaWYgbWV0aG9kIGlzIEFWRywgYXNcbiAgICAgICAgLy8gdGhpcyBjb3VsZCBoYXZlIGJlZW4gMCBpbnN0ZWFkLlxuICAgICAgICByZXR1cm4gWydBTkQgcHJjcCAhPSA5OS45OSddXG4gICAgICB9XG4gICAgICBjYXNlICd2aXNpYic6XG4gICAgICBjYXNlICd3ZHNwJzoge1xuICAgICAgICByZXR1cm4gW2BBTkQgJHt0aGlzLmNvbHVtbn0gIT0gOTk5LjlgXVxuICAgICAgfVxuICAgICAgY2FzZSAnZGV3cCc6XG4gICAgICBjYXNlICdzbHAnOlxuICAgICAgY2FzZSAnc3RwJzpcbiAgICAgIGNhc2UgJ21heCc6XG4gICAgICBjYXNlICdtaW4nOlxuICAgICAgY2FzZSAndGVtcCc6IHtcbiAgICAgICAgcmV0dXJuIFtgQU5EICR7dGhpcy5jb2x1bW59ICE9IDk5OTkuOWBdXG4gICAgICB9XG4gICAgICBjYXNlICdmb2cnOlxuICAgICAgY2FzZSAncmFpbl9kcml6emxlJzpcbiAgICAgIGNhc2UgJ3Nub3dfaWNlX3BlbGxldHMnOlxuICAgICAgY2FzZSAnaGFpbCc6XG4gICAgICBjYXNlICd0b3JuYWRvX2Z1bm5lbF9jbG91ZCc6XG4gICAgICBjYXNlICd0aHVuZGVyJzoge1xuICAgICAgICByZXR1cm4gW2BBTkQgKCR7dGhpcy5jb2x1bW59ID0gXCIwXCIgT1IgJHt0aGlzLmNvbHVtbn0gPSBcIjFcIilgXVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBbXVxuICB9XG5cbiAgcHVibGljIHRvUXVlcnkoKTogeyBxdWVyeTogc3RyaW5nOyBwYXJhbXM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIH0gfSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHF1ZXJ5OlxuICAgICAgICBbXG4gICAgICAgICAgLy8gU3RhdGlvbnNcbiAgICAgICAgICAnV0lUSCcsXG4gICAgICAgICAgJ3N0YXRpb25zIEFTICgnLFxuICAgICAgICAgIGAgIFNFTEVDVCB1c2FmLCBTVF9HRU9HUE9JTlQobG9uLCBsYXQpIEFTIGdlb2csIFxcYGJlZ2luXFxgLCBcXGBlbmRcXGAgRlJPTSBcXGAke3RoaXMuZGF0YXNldH0uc3RhdGlvbnNcXGBgLFxuICAgICAgICAgICcpJyxcblxuICAgICAgICAgIC8vIE1haW4gcXVlcnlcbiAgICAgICAgICBgU0VMRUNUICR7dGhpcy5zZWxlY3QoKX0gQVMgcmVzdWx0YCxcbiAgICAgICAgICBgRlJPTSAoJHt0aGlzLmZyb20oKX0pYCxcbiAgICAgICAgICAnV0hFUkUgc3RuIElOIChTRUxFQ1QgdXNhZiBGUk9NIHN0YXRpb25zJyxcbiAgICAgICAgICBgV0hFUkUgKCR7dGhpcy5nZW9Kc29uUXVlcnkoKS5qb2luKGApXFxuT1JcXG4oYCl9KSlgLFxuICAgICAgICAgICdBTkQgZGF0ZSBCRVRXRUVOIEBkYXRlRnJvbSBBTkQgQGRhdGVUbycsXG4gICAgICAgICAgLi4udGhpcy5jb2x1bW5GaWx0ZXJpbmcoKSxcbiAgICAgICAgXS5qb2luKCdcXG4nKSArICc7JyxcbiAgICAgIHBhcmFtczoge1xuICAgICAgICAuLi50aGlzLmdlb0pzb25QYXJhbXMoKSxcbiAgICAgICAgZGF0ZUZyb206IFF1ZXJ5QnVpbGRlci5mb3JtYXREYXRlKHRoaXMuZGF0ZUZyb20pLFxuICAgICAgICBkYXRlVG86IFF1ZXJ5QnVpbGRlci5mb3JtYXREYXRlKHRoaXMuZGF0ZVRvKSxcbiAgICAgIH0sXG4gICAgfVxuICB9XG59XG4iXX0=