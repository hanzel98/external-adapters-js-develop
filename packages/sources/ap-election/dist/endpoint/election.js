"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.endpointResultPaths = exports.supportedEndpoints = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const ethers_1 = require("ethers");
exports.supportedEndpoints = ['election'];
exports.endpointResultPaths = {};
const customError = (data) => data.Response === 'Error';
exports.inputParameters = {
    date: true,
    statePostal: true,
    officeID: false,
    raceType: false,
    raceID: false,
    resultsType: false,
};
const execute = async (request, _, config) => {
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    validateRequest(request);
    const jobRunID = validator.validated.id;
    const { raceType, date, resultsType, ...rest } = validator.validated.data;
    const url = `/elections/${date}`;
    const params = {
        ...rest,
        level: 'state',
        raceTypeID: raceType,
        format: 'json',
        winner: 'X',
        resultsType: resultsType || 'l',
        apikey: config.apiKey,
    };
    const options = { ...config.api, params, url };
    const response = await ea_bootstrap_1.Requester.request(options, customError);
    validateResponse(response.data);
    const race = response.data.races[0];
    const reportingUnit = getReportingUnit(race.reportingUnits, rest.statePostal);
    const raceWinner = getReportingUnitWinner(reportingUnit);
    response.data.precinctsReporting = reportingUnit.precinctsReporting;
    response.data.precinctsReportingPct = reportingUnit.precinctsReportingPct;
    response.data.winnerFirstName = raceWinner.first;
    response.data.winnerLastName = raceWinner.last;
    response.data.winnerVoteCount = raceWinner.voteCount;
    response.data.winnerCandidateId = raceWinner.candidateID;
    response.data.winnerParty = raceWinner.party;
    response.data.candidates = encodeCandidates(reportingUnit.candidates);
    return ea_bootstrap_1.Requester.success(jobRunID, ea_bootstrap_1.Requester.withResult(response, concatenateName(raceWinner)), config.verbose);
};
exports.execute = execute;
const validateRequest = (request) => {
    const { statePostal, officeID, raceID } = request.data;
    const statePostals = statePostal.split(',');
    if (statePostals.length > 1) {
        throw new ea_bootstrap_1.AdapterError({
            jobRunID: request.id,
            statusCode: 400,
            message: 'Adapter only supports finding results from a single state',
        });
    }
    if (!officeID && !raceID) {
        throw new ea_bootstrap_1.AdapterError({
            jobRunID: request.id,
            statusCode: 400,
            message: 'Either officeID or raceID must be present',
        });
    }
};
const validateResponse = (response) => {
    const races = response.races;
    if (races.length === 0) {
        throw Error('We could not find any races');
    }
    if (races.length > 1) {
        throw Error("We don't support finding the winner from multiple races");
    }
};
const getReportingUnit = (reportingUnits, statePostal) => {
    // Response should only contain a national RU if the statePostal is US but will contain both national and state for any other statePostal codes.
    const level = statePostal === 'US' ? 'national' : 'state';
    const reportingUnit = reportingUnits.find((ru) => ru.level === level);
    if (!reportingUnit) {
        throw Error('Cannot find reporting unit');
    }
    return reportingUnit;
};
const getReportingUnitWinner = (reportingUnit) => {
    for (const candidate of reportingUnit.candidates) {
        if (candidate.winner === 'X') {
            return candidate;
        }
    }
    throw Error('Candidate not found');
};
const concatenateName = (candidate) => `${candidate.voteCount},${candidate.last}`;
const encodeCandidates = (candidates) => {
    const encodedCandidates = [];
    const encodedValTypes = ['uint32', 'string', 'string', 'string', 'uint32', 'bool'];
    const abiCoder = ethers_1.utils.defaultAbiCoder;
    for (const { candidateID, party, first, last, voteCount, winner } of candidates) {
        const encodedCandidate = abiCoder.encode(encodedValTypes, [
            candidateID,
            party,
            first,
            last,
            voteCount,
            !!winner,
        ]);
        encodedCandidates.push(encodedCandidate);
    }
    return encodedCandidates;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWxlY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZW5kcG9pbnQvZWxlY3Rpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMERBQTRFO0FBRTVFLG1DQUE4QjtBQUVqQixRQUFBLGtCQUFrQixHQUFHLENBQUMsVUFBVSxDQUFDLENBQUE7QUFFakMsUUFBQSxtQkFBbUIsR0FBRyxFQUFFLENBQUE7QUFvRHJDLE1BQU0sV0FBVyxHQUFHLENBQUMsSUFBUyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLE9BQU8sQ0FBQTtBQUUvQyxRQUFBLGVBQWUsR0FBb0I7SUFDOUMsSUFBSSxFQUFFLElBQUk7SUFDVixXQUFXLEVBQUUsSUFBSTtJQUNqQixRQUFRLEVBQUUsS0FBSztJQUNmLFFBQVEsRUFBRSxLQUFLO0lBQ2YsTUFBTSxFQUFFLEtBQUs7SUFDYixXQUFXLEVBQUUsS0FBSztDQUNuQixDQUFBO0FBRU0sTUFBTSxPQUFPLEdBQThCLEtBQUssRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQzdFLE1BQU0sU0FBUyxHQUFHLElBQUksd0JBQVMsQ0FBQyxPQUFPLEVBQUUsdUJBQWUsQ0FBQyxDQUFBO0lBQ3pELElBQUksU0FBUyxDQUFDLEtBQUs7UUFBRSxNQUFNLFNBQVMsQ0FBQyxLQUFLLENBQUE7SUFDMUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBRXhCLE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFBO0lBQ3ZDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxHQUFHLElBQUksRUFBRSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFBO0lBQ3pFLE1BQU0sR0FBRyxHQUFHLGNBQWMsSUFBSSxFQUFFLENBQUE7SUFFaEMsTUFBTSxNQUFNLEdBQUc7UUFDYixHQUFHLElBQUk7UUFDUCxL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QUFNLGVBQWUsR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLENBQUE7SUFDbEYsTUFBTSxRQUFRLEdBQUcsY0FBSyxDQUFDLGVBQWUsQ0FBQTtJQUN0QyxLQUFLLE1BQU0sRUFBRSxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxJQUFJLFVBQVUsRUFBRTtRQUMvRSxNQUFNLGdCQUFnQixHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFO1lBQ3hELFdBQVc7WUFDWCxLQUFLO1lBQ0wsS0FBSztZQUNMLElBQUk7WUFDSixTQUFTO1lBQ1QsQ0FBQyxDQUFDLE1BQU07U0FDVCxDQUFDLENBQUE7UUFDRixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsQ0FBQTtLQUN6QztJQUNELE9BQU8saUJBQWlCLENBQUE7QUFDMUIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWRhcHRlckVycm9yLCBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgQWRhcHRlclJlcXVlc3QsIENvbmZpZywgRXhlY3V0ZVdpdGhDb25maWcsIElucHV0UGFyYW1ldGVycyB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyB1dGlscyB9IGZyb20gJ2V0aGVycydcblxuZXhwb3J0IGNvbnN0IHN1cHBvcnRlZEVuZHBvaW50cyA9IFsnZWxlY3Rpb24nXVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRSZXN1bHRQYXRocyA9IHt9XG5cbmludGVyZmFjZSBDYW5kaWRhdGUge1xuICBmaXJzdDogc3RyaW5nXG4gIGxhc3Q6IHN0cmluZ1xuICBhYmJydjogc3RyaW5nXG4gIHBhcnR5OiBzdHJpbmdcbiAgY2FuZGlkYXRlSUQ6IHN0cmluZ1xuICBwb2xsSUQ6IHN0cmluZ1xuICBiYWxsb3RPcmRlcjogbnVtYmVyXG4gIHBvbE51bTogc3RyaW5nXG4gIHZvdGVDb3VudDogbnVtYmVyXG4gIHdpbm5lcj86IHN0cmluZ1xufVxuXG5pbnRlcmZhY2UgUmVwb3J0aW5nVW5pdCB7XG4gIHN0YXRlUG9zdGFsOiBzdHJpbmdcbiAgc3RhdGVOYW1lOiBzdHJpbmdcbiAgbGV2ZWw6IHN0cmluZ1xuICBsYXN0VXBkYXRlZDogc3RyaW5nXG4gIHByZWNpbmN0c1JlcG9ydGluZzogbnVtYmVyXG4gIHByZWNpbmN0c1RvdGFsOiBudW1iZXJcbiAgcHJlY2luY3RzUmVwb3J0aW5nUGN0OiBudW1iZXJcbiAgY2FuZGlkYXRlczogQ2FuZGlkYXRlW11cbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXNwb25zZVNjaGVtYSB7XG4gIHByZWNpbmN0c1JlcG9ydGluZzogbnVtYmVyXG4gIHByZWNpbmN0c1JlcG9ydGluZ1BjdDogbnVtYmVyXG4gIHdpbm5lckZpcnN0TmFtZTogc3RyaW5nXG4gIHdpbm5lckxhc3ROYW1lOiBzdHJpbmdcbiAgd2lubmVyVm90ZUNvdW50OiBudW1iZXJcbiAgd2lubmVyQ2FuZGlkYXRlSWQ6IHN0cmluZ1xuICB3aW5uZXJQYXJ0eTogc3RyaW5nXG4gIGNhbmRpZGF0ZXM6IHN0cmluZ1tdXG4gIGVsZWN0aW9uRGF0ZTogc3RyaW5nXG4gIHRpbWVzdGFtcDogc3RyaW5nXG4gIHJhY2VzOiB7XG4gICAgdGVzdDogYm9vbGVhblxuICAgIHJlc3VsdHNUeXBlOiBzdHJpbmdcbiAgICByYWNlSUQ6IHN0cmluZ1xuICAgIHJhY2VUeXBlOiBzdHJpbmdcbiAgICByYWNlVHlwZUlEOiBzdHJpbmdcbiAgICBvZmZjZUlEOiBzdHJpbmdcbiAgICBvZmZpY2VOYW1lOiBzdHJpbmdcbiAgICBwYXJ0eTogc3RyaW5nXG4gICAgZWV2cDogbnVtYmVyXG4gICAgbmF0aW9uYWw6IGJvb2xlYW5cbiAgICByZXBvcnRpbmdVbml0czogUmVwb3J0aW5nVW5pdFtdXG4gIH1bXVxufVxuXG5jb25zdCBjdXN0b21FcnJvciA9IChkYXRhOiBhbnkpID0+IGRhdGEuUmVzcG9uc2UgPT09ICdFcnJvcidcblxuZXhwb3J0IGNvbnN0IGlucHV0UGFyYW1ldGVyczogSW5wdXRQYXJhbWV0ZXJzID0ge1xuICBkYXRlOiB0cnVlLFxuICBzdGF0ZVBvc3RhbDogdHJ1ZSxcbiAgb2ZmaWNlSUQ6IGZhbHNlLFxuICByYWNlVHlwZTogZmFsc2UsXG4gIHJhY2VJRDogZmFsc2UsXG4gIHJlc3VsdHNUeXBlOiBmYWxzZSxcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAocmVxdWVzdCwgXywgY29uZmlnKSA9PiB7XG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IocmVxdWVzdCwgaW5wdXRQYXJhbWV0ZXJzKVxuICBpZiAodmFsaWRhdG9yLmVycm9yKSB0aHJvdyB2YWxpZGF0b3IuZXJyb3JcbiAgdmFsaWRhdGVSZXF1ZXN0KHJlcXVlc3QpXG5cbiAgY29uc3Qgam9iUnVuSUQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmlkXG4gIGNvbnN0IHsgcmFjZVR5cGUsIGRhdGUsIHJlc3VsdHNUeXBlLCAuLi5yZXN0IH0gPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGFcbiAgY29uc3QgdXJsID0gYC9lbGVjdGlvbnMvJHtkYXRlfWBcblxuICBjb25zdCBwYXJhbXMgPSB7XG4gICAgLi4ucmVzdCxcbiAgICBsZXZlbDogJ3N0YXRlJyxcbiAgICByYWNlVHlwZUlEOiByYWNlVHlwZSxcbiAgICBmb3JtYXQ6ICdqc29uJyxcbiAgICB3aW5uZXI6ICdYJyxcbiAgICByZXN1bHRzVHlwZTogcmVzdWx0c1R5cGUgfHwgJ2wnLFxuICAgIGFwaWtleTogY29uZmlnLmFwaUtleSxcbiAgfVxuXG4gIGNvbnN0IG9wdGlvbnMgPSB7IC4uLmNvbmZpZy5hcGksIHBhcmFtcywgdXJsIH1cblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFJlcXVlc3Rlci5yZXF1ZXN0PFJlc3BvbnNlU2NoZW1hPihvcHRpb25zLCBjdXN0b21FcnJvcilcbiAgdmFsaWRhdGVSZXNwb25zZShyZXNwb25zZS5kYXRhKVxuXG4gIGNvbnN0IHJhY2UgPSByZXNwb25zZS5kYXRhLnJhY2VzWzBdXG4gIGNvbnN0IHJlcG9ydGluZ1VuaXQgPSBnZXRSZXBvcnRpbmdVbml0KHJhY2UucmVwb3J0aW5nVW5pdHMsIHJlc3Quc3RhdGVQb3N0YWwpXG4gIGNvbnN0IHJhY2VXaW5uZXIgPSBnZXRSZXBvcnRpbmdVbml0V2lubmVyKHJlcG9ydGluZ1VuaXQpXG5cbiAgcmVzcG9uc2UuZGF0YS5wcmVjaW5jdHNSZXBvcnRpbmcgPSByZXBvcnRpbmdVbml0LnByZWNpbmN0c1JlcG9ydGluZ1xuICByZXNwb25zZS5kYXRhLnByZWNpbmN0c1JlcG9ydGluZ1BjdCA9IHJlcG9ydGluZ1VuaXQucHJlY2luY3RzUmVwb3J0aW5nUGN0XG4gIHJlc3BvbnNlLmRhdGEud2lubmVyRmlyc3ROYW1lID0gcmFjZVdpbm5lci5maXJzdFxuICByZXNwb25zZS5kYXRhLndpbm5lckxhc3ROYW1lID0gcmFjZVdpbm5lci5sYXN0XG4gIHJlc3BvbnNlLmRhdGEud2lubmVyVm90ZUNvdW50ID0gcmFjZVdpbm5lci52b3RlQ291bnRcbiAgcmVzcG9uc2UuZGF0YS53aW5uZXJDYW5kaWRhdGVJZCA9IHJhY2VXaW5uZXIuY2FuZGlkYXRlSURcbiAgcmVzcG9uc2UuZGF0YS53aW5uZXJQYXJ0eSA9IHJhY2VXaW5uZXIucGFydHlcbiAgcmVzcG9uc2UuZGF0YS5jYW5kaWRhdGVzID0gZW5jb2RlQ2FuZGlkYXRlcyhyZXBvcnRpbmdVbml0LmNhbmRpZGF0ZXMpXG5cbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKFxuICAgIGpvYlJ1bklELFxuICAgIFJlcXVlc3Rlci53aXRoUmVzdWx0KHJlc3BvbnNlLCBjb25jYXRlbmF0ZU5hbWUocmFjZVdpbm5lcikpLFxuICAgIGNvbmZpZy52ZXJib3NlLFxuICApXG59XG5cbmNvbnN0IHZhbGlkYXRlUmVxdWVzdCA9IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICBjb25zdCB7IHN0YXRlUG9zdGFsLCBvZmZpY2VJRCwgcmFjZUlEIH0gPSByZXF1ZXN0LmRhdGFcbiAgY29uc3Qgc3RhdGVQb3N0YWxzID0gc3RhdGVQb3N0YWwuc3BsaXQoJywnKVxuICBpZiAoc3RhdGVQb3N0YWxzLmxlbmd0aCA+IDEpIHtcbiAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHtcbiAgICAgIGpvYlJ1bklEOiByZXF1ZXN0LmlkLFxuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgbWVzc2FnZTogJ0FkYXB0ZXIgb25seSBzdXBwb3J0cyBmaW5kaW5nIHJlc3VsdHMgZnJvbSBhIHNpbmdsZSBzdGF0ZScsXG4gICAgfSlcbiAgfVxuICBpZiAoIW9mZmljZUlEICYmICFyYWNlSUQpIHtcbiAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHtcbiAgICAgIGpvYlJ1bklEOiByZXF1ZXN0LmlkLFxuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgbWVzc2FnZTogJ0VpdGhlciBvZmZpY2VJRCBvciByYWNlSUQgbXVzdCBiZSBwcmVzZW50JyxcbiAgICB9KVxuICB9XG59XG5cbmNvbnN0IHZhbGlkYXRlUmVzcG9uc2UgPSAocmVzcG9uc2U6IFJlc3BvbnNlU2NoZW1hKSA9PiB7XG4gIGNvbnN0IHJhY2VzID0gcmVzcG9uc2UucmFjZXNcbiAgaWYgKHJhY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgIHRocm93IEVycm9yKCdXZSBjb3VsZCBub3QgZmluZCBhbnkgcmFjZXMnKVxuICB9XG4gIGlmIChyYWNlcy5sZW5ndGggPiAxKSB7XG4gICAgdGhyb3cgRXJyb3IoXCJXZSBkb24ndCBzdXBwb3J0IGZpbmRpbmcgdGhlIHdpbm5lciBmcm9tIG11bHRpcGxlIHJhY2VzXCIpXG4gIH1cbn1cblxuY29uc3QgZ2V0UmVwb3J0aW5nVW5pdCA9IChyZXBvcnRpbmdVbml0czogUmVwb3J0aW5nVW5pdFtdLCBzdGF0ZVBvc3RhbDogc3RyaW5nKTogUmVwb3J0aW5nVW5pdCA9PiB7XG4gIC8vIFJlc3BvbnNlIHNob3VsZCBvbmx5IGNvbnRhaW4gYSBuYXRpb25hbCBSVSBpZiB0aGUgc3RhdGVQb3N0YWwgaXMgVVMgYnV0IHdpbGwgY29udGFpbiBib3RoIG5hdGlvbmFsIGFuZCBzdGF0ZSBmb3IgYW55IG90aGVyIHN0YXRlUG9zdGFsIGNvZGVzLlxuICBjb25zdCBsZXZlbCA9IHN0YXRlUG9zdGFsID09PSAnVVMnID8gJ25hdGlvbmFsJyA6ICdzdGF0ZSdcbiAgY29uc3QgcmVwb3J0aW5nVW5pdCA9IHJlcG9ydGluZ1VuaXRzLmZpbmQoKHJ1KSA9PiBydS5sZXZlbCA9PT0gbGV2ZWwpXG4gIGlmICghcmVwb3J0aW5nVW5pdCkge1xuICAgIHRocm93IEVycm9yKCdDYW5ub3QgZmluZCByZXBvcnRpbmcgdW5pdCcpXG4gIH1cbiAgcmV0dXJuIHJlcG9ydGluZ1VuaXRcbn1cblxuY29uc3QgZ2V0UmVwb3J0aW5nVW5pdFdpbm5lciA9IChyZXBvcnRpbmdVbml0OiBSZXBvcnRpbmdVbml0KTogQ2FuZGlkYXRlID0+IHtcbiAgZm9yIChjb25zdCBjYW5kaWRhdGUgb2YgcmVwb3J0aW5nVW5pdC5jYW5kaWRhdGVzKSB7XG4gICAgaWYgKGNhbmRpZGF0ZS53aW5uZXIgPT09ICdYJykge1xuICAgICAgcmV0dXJuIGNhbmRpZGF0ZVxuICAgIH1cbiAgfVxuICB0aHJvdyBFcnJvcignQ2FuZGlkYXRlIG5vdCBmb3VuZCcpXG59XG5cbmNvbnN0IGNvbmNhdGVuYXRlTmFtZSA9IChjYW5kaWRhdGU6IENhbmRpZGF0ZSk6IHN0cmluZyA9PiBgJHtjYW5kaWRhdGUudm90ZUNvdW50fSwke2NhbmRpZGF0ZS5sYXN0fWBcblxuY29uc3QgZW5jb2RlQ2FuZGlkYXRlcyA9IChjYW5kaWRhdGVzOiBDYW5kaWRhdGVbXSk6IHN0cmluZ1tdID0+IHtcbiAgY29uc3QgZW5jb2RlZENhbmRpZGF0ZXM6IHN0cmluZ1tdID0gW11cbiAgY29uc3QgZW5jb2RlZFZhbFR5cGVzID0gWyd1aW50MzInLCAnc3RyaW5nJywgJ3N0cmluZycsICdzdHJpbmcnLCAndWludDMyJywgJ2Jvb2wnXVxuICBjb25zdCBhYmlDb2RlciA9IHV0aWxzLmRlZmF1bHRBYmlDb2RlclxuICBmb3IgKGNvbnN0IHsgY2FuZGlkYXRlSUQsIHBhcnR5LCBmaXJzdCwgbGFzdCwgdm90ZUNvdW50LCB3aW5uZXIgfSBvZiBjYW5kaWRhdGVzKSB7XG4gICAgY29uc3QgZW5jb2RlZENhbmRpZGF0ZSA9IGFiaUNvZGVyLmVuY29kZShlbmNvZGVkVmFsVHlwZXMsIFtcbiAgICAgIGNhbmRpZGF0ZUlELFxuICAgICAgcGFydHksXG4gICAgICBmaXJzdCxcbiAgICAgIGxhc3QsXG4gICAgICB2b3RlQ291bnQsXG4gICAgICAhIXdpbm5lcixcbiAgICBdKVxuICAgIGVuY29kZWRDYW5kaWRhdGVzLnB1c2goZW5jb2RlZENhbmRpZGF0ZSlcbiAgfVxuICByZXR1cm4gZW5jb2RlZENhbmRpZGF0ZXNcbn1cbiJdfQ==