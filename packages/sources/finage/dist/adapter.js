"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.makeExecute = exports.execute = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const customParams = {
    base: ['base', 'from', 'symbol'],
    endpoint: false,
};
const DEFAULT_ENDPOINT = 'stock';
const execute = async (request, _, config) => {
    const validator = new ea_bootstrap_1.Validator(request, customParams);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const endpoint = validator.validated.data.endpoint || DEFAULT_ENDPOINT;
    let url;
    const base = validator.validated.data.base;
    const symbol = Array.isArray(base)
        ? base.map((symbol) => symbol.toUpperCase()).join(',')
        : validator.overrideSymbol(config_1.NAME).toUpperCase();
    const apikey = ea_bootstrap_1.util.getRandomRequiredEnv('API_KEY');
    let responsePath;
    let params;
    switch (endpoint) {
        case 'stock': {
            url = getStockURL(base, symbol);
            responsePath = ['bid'];
            params = {
                apikey,
            };
            break;
        }
        case 'eod': {
            url = `/agg/stock/prev-close/${symbol}`;
            responsePath = ['results', 0, 'c'];
            params = {
                apikey,
            };
            break;
        }
        default: {
            throw new ea_bootstrap_1.AdapterError({
                jobRunID,
                message: `Endpoint ${endpoint} not supported.`,
                statusCode: 400,
            });
        }
    }
    const options = {
        ...config.api,
        url,
        params,
    };
    const response = await ea_bootstrap_1.Requester.request(options);
    if (Array.isArray(base)) {
        return handleBatchedRequest(jobRunID, response);
    }
    response.data.result = ea_bootstrap_1.Requester.validateResultNumber(response.data, responsePath);
    return ea_bootstrap_1.Requester.success(jobRunID, response);
};
exports.execute = execute;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
const getStockURL = (base, symbol) => {
    if (Array.isArray(base)) {
        return `/last/stocks/?symbols=${symbol}`;
    }
    return `/last/stock/${symbol}`;
};
const handleBatchedRequest = (jobRunID, response) => {
    const payload = [];
    for (const base in response.data) {
        payload.push({
            symbol: response.data[base].symbol,
            bid: response.data[base].bid,
        });
        ea_bootstrap_1.Requester.validateResultNumber(response.data, [base, 'bid']);
    }
    response.data.result = payload;
    return ea_bootstrap_1.Requester.success(jobRunID, response);
};
const makeWSHandler = (config) => {
    const getSubscription = (symbols, subscribe = true) => {
        if (!symbols)
            return;
        const sub = {
            action: subscribe ? 'subscribe' : 'unsubscribe',
            symbols,
        };
        return sub;
    };
    const getSymbol = (input) => {
        const validator = new ea_bootstrap_1.Validator(input, customParams, {}, false);
        if (validator.error)
            return;
        return validator.validated.data.base.toUpperCase();
    };
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        return {
            connection: {
                url: defaultConfig.api.baseWsURL || config_1.DEFAULT_WS_API_ENDPOINT,
            },
            subscribe: (input) => getSubscription(getSymbol(input)),
            unsubscribe: (input) => getSubscription(getSymbol(input), false),
            subsFromMessage: (message) => {
                if (!message.s)
                    return undefined;
                return getSubscription(`${message.s.toUpperCase()}`);
            },
            isError: (message) => message['status_code'] && message['status_code'] !== 200,
            filter: (message) => !!message.p,
            toResponse: (message) => {
                const result = ea_bootstrap_1.Requester.validateResultNumber(message, ['p']);
                return ea_bootstrap_1.Requester.success('1', { data: { result } });
            },
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQVFBLDBEQUFrRjtBQUNsRixxQ0FBb0U7QUFFcEUsTUFBTSxZQUFZLEdBQUc7SUFDbkIsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxRQUFRLENBQUM7SUFDaEMsUUFBUSxFQUFFLEtBQUs7Q0FDaEIsQ0FBQTtBQVdELE1BQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFBO0FBRXpCLE1BQU0sT0FBTyxHQUE4QixLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRTtJQUM3RSxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsT0FBTyxFQUFFLFlBQVksQ0FBQyxDQUFBO0lBQ3RELElBQUksU0FBUyxDQUFDLEtBQUs7UUFBRSxNQUFNLFNBQVMsQ0FBQyxLQUFLLENBQUE7SUFFMUMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUE7SUFDdkMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLGdCQUFnQixDQUFBO0lBQ3RFLElBQUksR0FBVyxDQUFBO0lBQ2YsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFBO0lBQzFDLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxNQUFNLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1FBQ3RELENBQUMsQ0FBRSxTQUFTLENBQUMsY0FBYyxDQUFDLGFBQUksQ0FBWSxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBRTVELE1BQU0sTUFB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QUFlLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtnQkFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUFFLE9BQU8sU0FBUyxDQUFBO2dCQUNoQyxPQUFPLGVBQWUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1lBQ3RELENBQUM7WUFDRCxPQUFPLEVBQUUsQ0FBQyxPQUFZLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsSUFBSSxPQUFPLENBQUMsYUFBYSxDQUFDLEtBQUssR0FBRztZQUNuRixNQUFNLEVBQUUsQ0FBQyxPQUFZLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUNyQyxVQUFVLEVBQUUsQ0FBQyxPQUFZLEVBQUUsRUFBRTtnQkFDM0IsTUFBTSxNQUFNLEdBQUcsd0JBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO2dCQUM3RCxPQUFPLHdCQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUNyRCxDQUFDO1NBQ0YsQ0FBQTtJQUNILENBQUMsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQWxDWSxRQUFBLGFBQWEsaUJBa0N6QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBFeGVjdXRlRmFjdG9yeSxcbiAgQ29uZmlnLFxuICBBeGlvc1Jlc3BvbnNlLFxuICBBZGFwdGVyUmVxdWVzdCxcbiAgTWFrZVdTSGFuZGxlcixcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IFJlcXVlc3RlciwgVmFsaWRhdG9yLCBBZGFwdGVyRXJyb3IsIHV0aWwgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7IERFRkFVTFRfV1NfQVBJX0VORFBPSU5ULCBtYWtlQ29uZmlnLCBOQU1FIH0gZnJvbSAnLi9jb25maWcnXG5cbmNvbnN0IGN1c3RvbVBhcmFtcyA9IHtcbiAgYmFzZTogWydiYXNlJywgJ2Zyb20nLCAnc3ltYm9sJ10sXG4gIGVuZHBvaW50OiBmYWxzZSxcbn1cblxuaW50ZXJmYWNlIFJlc3BvbnNlU2NoZW1lIHtcbiAgc3ltYm9sOiBzdHJpbmdcbiAgYXNrOiBudW1iZXJcbiAgYmlkOiBudW1iZXJcbiAgYXNpemU6IG51bWJlclxuICBic2l6ZTogbnVtYmVyXG4gIHRpbWVzdGFtcDogbnVtYmVyXG59XG5cbmNvbnN0IERFRkFVTFRfRU5EUE9JTlQgPSAnc3RvY2snXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKHJlcXVlc3QsIF8sIGNvbmZpZykgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKHJlcXVlc3QsIGN1c3RvbVBhcmFtcylcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG5cbiAgY29uc3Qgam9iUnVuSUQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmlkXG4gIGNvbnN0IGVuZHBvaW50ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmVuZHBvaW50IHx8IERFRkFVTFRfRU5EUE9JTlRcbiAgbGV0IHVybDogc3RyaW5nXG4gIGNvbnN0IGJhc2UgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuYmFzZVxuICBjb25zdCBzeW1ib2wgPSBBcnJheS5pc0FycmF5KGJhc2UpXG4gICAgPyBiYXNlLm1hcCgoc3ltYm9sKSA9PiBzeW1ib2wudG9VcHBlckNhc2UoKSkuam9pbignLCcpXG4gICAgOiAodmFsaWRhdG9yLm92ZXJyaWRlU3ltYm9sKE5BTUUpIGFzIHN0cmluZykudG9VcHBlckNhc2UoKVxuXG4gIGNvbnN0IGFwaWtleSA9IHV0aWwuZ2V0UmFuZG9tUmVxdWlyZWRFbnYoJ0FQSV9LRVknKVxuICBsZXQgcmVzcG9uc2VQYXRoXG4gIGxldCBwYXJhbXNcblxuICBzd2l0Y2ggKGVuZHBvaW50KSB7XG4gICAgY2FzZSAnc3RvY2snOiB7XG4gICAgICB1cmwgPSBnZXRTdG9ja1VSTChiYXNlLCBzeW1ib2wpXG4gICAgICByZXNwb25zZVBhdGggPSBbJ2JpZCddXG4gICAgICBwYXJhbXMgPSB7XG4gICAgICAgIGFwaWtleSxcbiAgICAgIH1cbiAgICAgIGJyZWFrXG4gICAgfVxuICAgIGNhc2UgJ2VvZCc6IHtcbiAgICAgIHVybCA9IGAvYWdnL3N0b2NrL3ByZXYtY2xvc2UvJHtzeW1ib2x9YFxuICAgICAgcmVzcG9uc2VQYXRoID0gWydyZXN1bHRzJywgMCwgJ2MnXVxuICAgICAgcGFyYW1zID0ge1xuICAgICAgICBhcGlrZXksXG4gICAgICB9XG4gICAgICBicmVha1xuICAgIH1cbiAgICBkZWZhdWx0OiB7XG4gICAgICB0aHJvdyBuZXcgQWRhcHRlckVycm9yKHtcbiAgICAgICAgam9iUnVuSUQsXG4gICAgICAgIG1lc3NhZ2U6IGBFbmRwb2ludCAke2VuZHBvaW50fSBub3Qgc3VwcG9ydGVkLmAsXG4gICAgICAgIHN0YXR1c0NvZGU6IDQwMCxcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAuLi5jb25maWcuYXBpLFxuICAgIHVybCxcbiAgICBwYXJhbXMsXG4gIH1cblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFJlcXVlc3Rlci5yZXF1ZXN0KG9wdGlvbnMpXG4gIGlmIChBcnJheS5pc0FycmF5KGJhc2UpKSB7XG4gICAgcmV0dXJuIGhhbmRsZUJhdGNoZWRSZXF1ZXN0KGpvYlJ1bklELCByZXNwb25zZSlcbiAgfVxuXG4gIHJlc3BvbnNlLmRhdGEucmVzdWx0ID0gUmVxdWVzdGVyLnZhbGlkYXRlUmVzdWx0TnVtYmVyKHJlc3BvbnNlLmRhdGEsIHJlc3BvbnNlUGF0aClcbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCByZXNwb25zZSlcbn1cblxuZXhwb3J0IGNvbnN0IG1ha2VFeGVjdXRlOiBFeGVjdXRlRmFjdG9yeTxDb25maWc+ID0gKGNvbmZpZykgPT4ge1xuICByZXR1cm4gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQpID0+IGV4ZWN1dGUocmVxdWVzdCwgY29udGV4dCwgY29uZmlnIHx8IG1ha2VDb25maWcoKSlcbn1cblxuY29uc3QgZ2V0U3RvY2tVUkwgPSAoYmFzZTogc3RyaW5nIHwgc3RyaW5nW10sIHN5bWJvbDogc3RyaW5nKSA9PiB7XG4gIGlmIChBcnJheS5pc0FycmF5KGJhc2UpKSB7XG4gICAgcmV0dXJuIGAvbGFzdC9zdG9ja3MvP3N5bWJvbHM9JHtzeW1ib2x9YFxuICB9XG4gIHJldHVybiBgL2xhc3Qvc3RvY2svJHtzeW1ib2x9YFxufVxuXG5jb25zdCBoYW5kbGVCYXRjaGVkUmVxdWVzdCA9IChqb2JSdW5JRDogc3RyaW5nLCByZXNwb25zZTogQXhpb3NSZXNwb25zZTxSZXNwb25zZVNjaGVtZT4pID0+IHtcbiAgY29uc3QgcGF5bG9hZDogeyBzeW1ib2w6IHN0cmluZzsgYmlkOiBudW1iZXIgfVtdID0gW11cbiAgZm9yIChjb25zdCBiYXNlIGluIHJlc3BvbnNlLmRhdGEpIHtcbiAgICBwYXlsb2FkLnB1c2goe1xuICAgICAgc3ltYm9sOiByZXNwb25zZS5kYXRhW2Jhc2VdLnN5bWJvbCxcbiAgICAgIGJpZDogcmVzcG9uc2UuZGF0YVtiYXNlXS5iaWQsXG4gICAgfSlcbiAgICBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocmVzcG9uc2UuZGF0YSwgW2Jhc2UsICdiaWQnXSlcbiAgfVxuICByZXNwb25zZS5kYXRhLnJlc3VsdCA9IHBheWxvYWRcbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCByZXNwb25zZSlcbn1cblxuZXhwb3J0IGNvbnN0IG1ha2VXU0hhbmRsZXIgPSAoY29uZmlnPzogQ29uZmlnKTogTWFrZVdTSGFuZGxlciA9PiB7XG4gIGNvbnN0IGdldFN1YnNjcmlwdGlvbiA9IChzeW1ib2xzPzogc3RyaW5nLCBzdWJzY3JpYmUgPSB0cnVlKSA9PiB7XG4gICAgaWYgKCFzeW1ib2xzKSByZXR1cm5cbiAgICBjb25zdCBzdWIgPSB7XG4gICAgICBhY3Rpb246IHN1YnNjcmliZSA/ICdzdWJzY3JpYmUnIDogJ3Vuc3Vic2NyaWJlJyxcbiAgICAgIHN5bWJvbHMsXG4gICAgfVxuICAgIHJldHVybiBzdWJcbiAgfVxuICBjb25zdCBnZXRTeW1ib2wgPSAoaW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0KSA9PiB7XG4gICAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihpbnB1dCwgY3VzdG9tUGFyYW1zLCB7fSwgZmFsc2UpXG4gICAgaWYgKHZhbGlkYXRvci5lcnJvcikgcmV0dXJuXG4gICAgcmV0dXJuIHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5iYXNlLnRvVXBwZXJDYXNlKClcbiAgfVxuICByZXR1cm4gKCkgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPSBjb25maWcgfHwgbWFrZUNvbmZpZygpXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgdXJsOiBkZWZhdWx0Q29uZmlnLmFwaS5iYXNlV3NVUkwgfHwgREVGQVVMVF9XU19BUElfRU5EUE9JTlQsXG4gICAgICB9LFxuICAgICAgc3Vic2NyaWJlOiAoaW5wdXQpID0+IGdldFN1YnNjcmlwdGlvbihnZXRTeW1ib2woaW5wdXQpKSxcbiAgICAgIHVuc3Vic2NyaWJlOiAoaW5wdXQpID0+IGdldFN1YnNjcmlwdGlvbihnZXRTeW1ib2woaW5wdXQpLCBmYWxzZSksXG4gICAgICBzdWJzRnJvbU1lc3NhZ2U6IChtZXNzYWdlKSA9PiB7XG4gICAgICAgIGlmICghbWVzc2FnZS5zKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgICAgIHJldHVybiBnZXRTdWJzY3JpcHRpb24oYCR7bWVzc2FnZS5zLnRvVXBwZXJDYXNlKCl9YClcbiAgICAgIH0sXG4gICAgICBpc0Vycm9yOiAobWVzc2FnZTogYW55KSA9PiBtZXNzYWdlWydzdGF0dXNfY29kZSddICYmIG1lc3NhZ2VbJ3N0YXR1c19jb2RlJ10gIT09IDIwMCxcbiAgICAgIGZpbHRlcjogKG1lc3NhZ2U6IGFueSkgPT4gISFtZXNzYWdlLnAsXG4gICAgICB0b1Jlc3BvbnNlOiAobWVzc2FnZTogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFJlcXVlc3Rlci52YWxpZGF0ZVJlc3VsdE51bWJlcihtZXNzYWdlLCBbJ3AnXSlcbiAgICAgICAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKCcxJywgeyBkYXRhOiB7IHJlc3VsdCB9IH0pXG4gICAgICB9LFxuICAgIH1cbiAgfVxufVxuIl19