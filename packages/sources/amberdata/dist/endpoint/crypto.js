"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.supportedEndpoints = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("../config");
exports.supportedEndpoints = ['crypto', 'price'];
const customError = (data) => {
    return Object.keys(data.payload).length === 0;
};
const symbolOptions = (from, to) => ({
    url: `/api/v2/market/spot/prices/pairs/${from.toLowerCase()}_${to.toLowerCase()}/latest`,
    params: { includeCrossRates: true },
});
const tokenOptions = (from, to) => ({
    url: `/api/v2/market/defi/prices/pairs/bases/${from}/quotes/${to}/latest`,
    params: {},
});
exports.inputParameters = {
    base: ['base', 'from', 'coin'],
    quote: ['quote', 'to', 'market'],
    includes: false,
};
const execute = async (input, _, config) => {
    const validator = new ea_bootstrap_1.Validator(input, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const { url, params, inverse } = getOptions(validator);
    const reqConfig = { ...config.api, params, url };
    const response = await ea_bootstrap_1.Requester.request(reqConfig, customError);
    response.data.result = ea_bootstrap_1.Requester.validateResultNumber(response.data, ['payload', 'price'], {
        inverse,
    });
    return ea_bootstrap_1.Requester.success(jobRunID, response, config.verbose);
};
exports.execute = execute;
const getOptions = (validator) => {
    const base = validator.overrideSymbol(config_1.NAME);
    const quote = validator.validated.data.quote;
    const includes = validator.validated.includes || [];
    const includeOptions = getIncludesOptions(validator, base, quote, includes);
    return includeOptions ?? symbolOptions(base, quote);
};
const getIncludesOptions = (validator, from, to, includes) => {
    const include = getIncludes(validator, from, to, includes);
    if (!include)
        return undefined;
    if (include.tokens) {
        const fromAddress = validator.overrideToken(include.from);
        const toAddress = validator.overrideToken(include.to);
        if (!fromAddress || !toAddress)
            return undefined;
        return {
            ...tokenOptions(fromAddress, toAddress),
            inverse: include.inverse,
        };
    }
    return {
        ...symbolOptions(include.from, include.to),
        inverse: include.inverse,
    };
};
const getIncludes = (validator, from, to, includes) => {
    if (includes.length === 0)
        return undefined;
    const presetIncludes = validator.overrideIncludes(config_1.NAME, from, to);
    if (presetIncludes && typeof includes[0] === 'string')
        return presetIncludes;
    else if (typeof includes[0] === 'string') {
        return {
            from,
            to: includes[0],
            inverse: false,
            tokens: true,
        };
    }
    return presetIncludes;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBOEQ7QUFFOUQsc0NBQStDO0FBRWxDLFFBQUEsa0JBQWtCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUE7QUFFckQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUFTLEVBQUUsRUFBRTtJQUNoQyxPQUFPLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUE7QUFDL0MsQ0FBQyxDQUFBO0FBRUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELEdBQUcsRUFBRSxvQ0FBb0MsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsU0FBUztJQUN4RixNQUFNLEVBQUUsRUFBRSxpQkFBaUIsRUFBRSxJQUFJLEVBQUU7Q0FDcEMsQ0FBQyxDQUFBO0FBRUYsTUFBTSxZQUFZLEdBQUcsQ0FBQyxJQUFZLEVBQUUsRUFBVSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELEdBQUcsRUFBRSwwQ0FBMEMsSUFBSSxXQUFXLEVBQUUsU0FBUztJQUN6RSxNQUFNLEVBQUUsRUFBRTtDQUNYLENBQUMsQ0FBQTtBQUVXLFFBQUEsZUFBZSxHQUFvQjtJQUM5QyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQztJQUM5QixLQUFLLEVBQUUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsQ0FBQztJQUNoQyxRQUFRLEVBQUUsS0FBSztDQUNoQixDQUFBO0FBRU0sTUFBTSxPQUFPLEdBQThCLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQzNFLE1BQU0sU0FBUyxHQUFH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QyxhQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBQ3hFLElBQUksY0FBYyxJQUFJLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVE7UUFBRSxPQUFPLGNBQWMsQ0FBQTtTQUN2RSxJQUFJLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLFFBQVEsRUFBRTtRQUN4QyxPQUFPO1lBQ0wsSUFBSTtZQUNKLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2YsT0FBTyxFQUFFLEtBQUs7WUFDZCxNQUFNLEVBQUUsSUFBSTtTQUNiLENBQUE7S0FDRjtJQUNELE9BQU8sY0FBYyxDQUFBO0FBQ3ZCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3RlciwgVmFsaWRhdG9yIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQgeyBFeGVjdXRlV2l0aENvbmZpZywgQ29uZmlnLCBJbmNsdWRlcywgSW5jbHVkZVBhaXIsIElucHV0UGFyYW1ldGVycyB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBOQU1FIGFzIEFkYXB0ZXJOYW1lIH0gZnJvbSAnLi4vY29uZmlnJ1xuXG5leHBvcnQgY29uc3Qgc3VwcG9ydGVkRW5kcG9pbnRzID0gWydjcnlwdG8nLCAncHJpY2UnXVxuXG5jb25zdCBjdXN0b21FcnJvciA9IChkYXRhOiBhbnkpID0+IHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKGRhdGEucGF5bG9hZCkubGVuZ3RoID09PSAwXG59XG5cbmNvbnN0IHN5bWJvbE9wdGlvbnMgPSAoZnJvbTogc3RyaW5nLCB0bzogc3RyaW5nKSA9PiAoe1xuICB1cmw6IGAvYXBpL3YyL21hcmtldC9zcG90L3ByaWNlcy9wYWlycy8ke2Zyb20udG9Mb3dlckNhc2UoKX1fJHt0by50b0xvd2VyQ2FzZSgpfS9sYXRlc3RgLFxuICBwYXJhbXM6IHsgaW5jbHVkZUNyb3NzUmF0ZXM6IHRydWUgfSxcbn0pXG5cbmNvbnN0IHRva2VuT3B0aW9ucyA9IChmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcpID0+ICh7XG4gIHVybDogYC9hcGkvdjIvbWFya2V0L2RlZmkvcHJpY2VzL3BhaXJzL2Jhc2VzLyR7ZnJvbX0vcXVvdGVzLyR7dG99L2xhdGVzdGAsXG4gIHBhcmFtczoge30sXG59KVxuXG5leHBvcnQgY29uc3QgaW5wdXRQYXJhbWV0ZXJzOiBJbnB1dFBhcmFtZXRlcnMgPSB7XG4gIGJhc2U6IFsnYmFzZScsICdmcm9tJywgJ2NvaW4nXSxcbiAgcXVvdGU6IFsncXVvdGUnLCAndG8nLCAnbWFya2V0J10sXG4gIGluY2x1ZGVzOiBmYWxzZSxcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAoaW5wdXQsIF8sIGNvbmZpZykgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKGlucHV0LCBpbnB1dFBhcmFtZXRlcnMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuICBjb25zdCBqb2JSdW5JRCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuaWRcblxuICBjb25zdCB7IHVybCwgcGFyYW1zLCBpbnZlcnNlIH0gPSBnZXRPcHRpb25zKHZhbGlkYXRvcilcbiAgY29uc3QgcmVxQ29uZmlnID0geyAuLi5jb25maWcuYXBpLCBwYXJhbXMsIHVybCB9XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBSZXF1ZXN0ZXIucmVxdWVzdChyZXFDb25maWcsIGN1c3RvbUVycm9yKVxuICByZXNwb25zZS5kYXRhLnJlc3VsdCA9IFJlcXVlc3Rlci52YWxpZGF0ZVJlc3VsdE51bWJlcihyZXNwb25zZS5kYXRhLCBbJ3BheWxvYWQnLCAncHJpY2UnXSwge1xuICAgIGludmVyc2UsXG4gIH0pXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwgcmVzcG9uc2UsIGNvbmZpZy52ZXJib3NlKVxufVxuXG5jb25zdCBnZXRPcHRpb25zID0gKFxuICB2YWxpZGF0b3I6IFZhbGlkYXRvcixcbik6IHtcbiAgdXJsOiBzdHJpbmdcbiAgcGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICBpbnZlcnNlPzogYm9vbGVhblxufSA9PiB7XG4gIGNvbnN0IGJhc2UgPSB2YWxpZGF0b3Iub3ZlcnJpZGVTeW1ib2woQWRhcHRlck5hbWUpIGFzIHN0cmluZ1xuICBjb25zdCBxdW90ZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5xdW90ZVxuICBjb25zdCBpbmNsdWRlcyA9IHZhbGlkYXRvci52YWxpZGF0ZWQuaW5jbHVkZXMgfHwgW11cblxuICBjb25zdCBpbmNsdWRlT3B0aW9ucyA9IGdldEluY2x1ZGVzT3B0aW9ucyh2YWxpZGF0b3IsIGJhc2UsIHF1b3RlLCBpbmNsdWRlcylcbiAgcmV0dXJuIGluY2x1ZGVPcHRpb25zID8/IHN5bWJvbE9wdGlvbnMoYmFzZSwgcXVvdGUpXG59XG5cbmNvbnN0IGdldEluY2x1ZGVzT3B0aW9ucyA9IChcbiAgdmFsaWRhdG9yOiBWYWxpZGF0b3IsXG4gIGZyb206IHN0cmluZyxcbiAgdG86IHN0cmluZyxcbiAgaW5jbHVkZXM6IHN0cmluZ1tdIHwgSW5jbHVkZXNbXSxcbikgPT4ge1xuICBjb25zdCBpbmNsdWRlID0gZ2V0SW5jbHVkZXModmFsaWRhdG9yLCBmcm9tLCB0bywgaW5jbHVkZXMpXG4gIGlmICghaW5jbHVkZSkgcmV0dXJuIHVuZGVmaW5lZFxuICBpZiAoaW5jbHVkZS50b2tlbnMpIHtcbiAgICBjb25zdCBmcm9tQWRkcmVzcyA9IHZhbGlkYXRvci5vdmVycmlkZVRva2VuKGluY2x1ZGUuZnJvbSlcbiAgICBjb25zdCB0b0FkZHJlc3MgPSB2YWxpZGF0b3Iub3ZlcnJpZGVUb2tlbihpbmNsdWRlLnRvKVxuXG4gICAgaWYgKCFmcm9tQWRkcmVzcyB8fCAhdG9BZGRyZXNzKSByZXR1cm4gdW5kZWZpbmVkXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnRva2VuT3B0aW9ucyhmcm9tQWRkcmVzcywgdG9BZGRyZXNzKSxcbiAgICAgIGludmVyc2U6IGluY2x1ZGUuaW52ZXJzZSxcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIC4uLnN5bWJvbE9wdGlvbnMoaW5jbHVkZS5mcm9tLCBpbmNsdWRlLnRvKSxcbiAgICBpbnZlcnNlOiBpbmNsdWRlLmludmVyc2UsXG4gIH1cbn1cblxuY29uc3QgZ2V0SW5jbHVkZXMgPSAoXG4gIHZhbGlkYXRvcjogVmFsaWRhdG9yLFxuICBmcm9tOiBzdHJpbmcsXG4gIHRvOiBzdHJpbmcsXG4gIGluY2x1ZGVzOiBzdHJpbmdbXSB8IEluY2x1ZGVzW10sXG4pOiBJbmNsdWRlUGFpciB8IHVuZGVmaW5lZCA9PiB7XG4gIGlmIChpbmNsdWRlcy5sZW5ndGggPT09IDApIHJldHVybiB1bmRlZmluZWRcblxuICBjb25zdCBwcmVzZXRJbmNsdWRlcyA9IHZhbGlkYXRvci5vdmVycmlkZUluY2x1ZGVzKEFkYXB0ZXJOYW1lLCBmcm9tLCB0bylcbiAgaWYgKHByZXNldEluY2x1ZGVzICYmIHR5cGVvZiBpbmNsdWRlc1swXSA9PT0gJ3N0cmluZycpIHJldHVybiBwcmVzZXRJbmNsdWRlc1xuICBlbHNlIGlmICh0eXBlb2YgaW5jbHVkZXNbMF0gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGZyb20sXG4gICAgICB0bzogaW5jbHVkZXNbMF0sXG4gICAgICBpbnZlcnNlOiBmYWxzZSxcbiAgICAgIHRva2VuczogdHJ1ZSxcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHByZXNldEluY2x1ZGVzXG59XG4iXX0=