"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.endpointResultPaths = exports.batchablePropertyPath = exports.supportedEndpoints = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("../config");
const util_1 = require("../util");
exports.supportedEndpoints = ['crypto', 'price', 'marketcap', 'volume'];
exports.batchablePropertyPath = [{ name: 'base' }, { name: 'quote' }];
const customError = (data) => {
    if (Object.keys(data).length === 0)
        return true;
    return false;
};
const buildResultPath = (path) => (request) => {
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const quote = validator.validated.data.quote;
    if (Array.isArray(quote))
        return '';
    return `${quote.toLowerCase()}${path}`;
};
exports.endpointResultPaths = {
    price: buildResultPath(''),
    crypto: buildResultPath(''),
    marketcap: buildResultPath('_market_cap'),
    volume: buildResultPath('_24h_vol'),
};
exports.inputParameters = {
    base: ['base', 'from', 'coin'],
    quote: ['quote', 'to', 'market'],
    coinid: false,
    resultPath: false,
    endpoint: false,
};
const handleBatchedRequest = (jobRunID, request, response, validator, endpoint, idToSymbol) => {
    const payload = [];
    for (const base in response.data) {
        const quoteArray = Array.isArray(request.data.quote) ? request.data.quote : [request.data.quote];
        for (const quote of quoteArray) {
            const symbol = idToSymbol?.[base];
            if (symbol) {
                const individualRequest = {
                    ...request,
                    data: {
                        ...request.data,
                        base: validator.overrideReverseLookup(config_1.NAME, 'overrides', symbol).toUpperCase(),
                        quote: quote.toUpperCase(),
                    },
                };
                payload.push([
                    individualRequest,
                    ea_bootstrap_1.Requester.validateResultNumber(response.data, [
                        base,
                        exports.endpointResultPaths[endpoint](individualRequest),
                    ]),
                ]);
            }
            else
                ea_bootstrap_1.Logger.debug('WARNING: Symbol not found ', base);
        }
    }
    response.data.results = payload;
    return ea_bootstrap_1.Requester.success(jobRunID, response, true, exports.batchablePropertyPath);
};
const execute = async (request, context, config) => {
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const endpoint = validator.validated.data.endpoint;
    const jobRunID = validator.validated.id;
    const base = validator.overrideSymbol(config_1.NAME);
    const quote = validator.validated.data.quote;
    const coinid = validator.validated.data.coinid;
    let idToSymbol = {};
    let ids = coinid;
    if (!ids) {
        const coinIds = await util_1.getCoinIds(context, jobRunID);
        const symbols = Array.isArray(base) ? base : [base];
        idToSymbol = util_1.getSymbolsToIds(symbols, coinIds);
        ids = Object.keys(idToSymbol).join(',');
    }
    const url = '/simple/price';
    const resultPath = validator.validated.data.resultPath;
    const params = {
        ids,
        vs_currencies: Array.isArray(quote) ? quote.join(',') : quote,
        include_market_cap: endpoint === 'marketcap',
        include_24hr_vol: endpoint === 'volume',
        x_cg_pro_api_key: config.apiKey,
    };
    const options = {
        ...config.api,
        url,
        params,
    };
    const response = await ea_bootstrap_1.Requester.request(options, customError);
    if (Array.isArray(base) || Array.isArray(quote))
        return handleBatchedRequest(jobRunID, request, response, validator, endpoint, idToSymbol);
    response.data.result = ea_bootstrap_1.Requester.validateResultNumber(response.data, [
        ids.toLowerCase(),
        resultPath,
    ]);
    return ea_bootstrap_1.Requester.success(jobRunID, response, config.verbose, exports.batchablePropertyPath);
};
exports.execute = execute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBc0U7QUFRdEUsc0NBQStDO0FBQy9DLGtDQUFxRDtBQUV4QyxRQUFBLGtCQUFrQixHQUFHLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUE7QUFDL0QsUUFBQSxxQkFBcUIsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7QUFFMUUsTUFBTSxXQUFXLEdBQUcsQ0FBQyxJQUFTLEVBQUUsRUFBRTtJQUNoQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPLElBQUksQ0FBQTtJQUMvQyxPQUFPLEtBQUssQ0FBQTtBQUNkLENBQUMsQ0FBQTtBQUVELE1BQU0sZUFBZSxHQUFHLENBQUMsSUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQXVCLEVBQUUsRUFBRTtJQUNwRSxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsT0FBTyxFQUFFLHVCQUFlLENBQUMsQ0FBQTtJQUN6RCxJQUFJLFNBQVMsQ0FBQyxLQUFLO1FBQUUsTUFBTSxTQUFTLENBQUMsS0FBSyxDQUFBO0lBQzFDLE1BQU0sS0FBSyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUM1QyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxFQUFFLENBQUE7SUFDbkMsT0FBTyxHQUFHLEtBQUssQ0FBQyxXQUFXLEVBQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQTtBQUN4QyxDQUFDLENBQUE7QUFFWSxRQUFBLG1CQUFtQixHQUU1QjtJQUNGLEtBQUssRUFBRSxlQUFlLENBQUMsRUFBRSxDQUFDO0lBQzFCLE1BQU0sRUFBRSxlQUFlLENBQUMsRUFBRSxDQUFDO0lBQzNCLFNBQVMsRUFBRSxlQUFlLENBQUMsYUFBYSxDQUFDO0lBQ3pDLE1BQU0sRUFBRSxlQUFlLENBQUMsVUFBVSxDQUFDO0NBQ3BDLENBQUE7QUFFWSxRQUFBLGVBQWUsR0FBb0I7SUFDOUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUM7SUFDOUIsS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUM7SUFDaEMsTUFBTSxFQUFFLEtBQUs7SUFDYixVQUFVLEVBQUUsS0FBSztJQUNqQixRQUFRLEVBQUUsS0FBSztDQUNoQixDQUFBO0FBRUQsTUFBTSxvQkFBb0IsR0FBRyxDQUMzQixRQUFnQixFQUNoQixPQUF1QixFQUN2QixRQUF1QixFQUN2QixTQUFvQixFQUNwQixRQUFnQixFQUNoQixVQUFrQyxFQUNsQyxFQUFFO0lBQ0YsTUFBTSxPQUFPLEdBQStCLEVBQUUsQ0FBQTtJQUM5QyxLQUFLLE1BQU0sSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUU7UUFDaEMsTUFBTSxVQUFVLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ2hHLEtBQUssTUFBTSxLQUFLLElBQUksVUFBVSxFQUFFO1lBQzlCLE1BQU0sTUFBTSxHQUFHLFVBQVUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ2pDLElBQUksTUFBTSxFQUFFO2dCQUNWLE1BQU0saUJBQWlCLEdBQUc7b0JBQ3hCLEdBQUcsT0FBTztvQkFDVixJQUFJLEVBQUU7d0JBQ0osR0FBRyxPQUFPLENBQUMsSUFBSTt3QkFDZixJQUFJLEVBQUUsU0FBUyxDQUFDLHFCQUFxQixDQUFDLGFBQVcsRUFBRSxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFO3dCQUNyRixLQUFLLEVBQUUsS0FBSyxDQUFDLFdBQVcsRUFBRTtxQkFDM0I7aUJBQ0YsQ0FBQTtnQkFDRCxPQUFPLENBQUMsSUFBSSxDQUFDO29CQUNYLGlCQUFpQjtvQkFDakIsd0JBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFO3dCQUM1QyxJQUFJO3dCQUNKLDJCQUFtQixDQUFDLFFBQVEsQ0FBQyxDQUFDLGlCQUFpQixDQUFDO3FCQUNqRCxDQUFDO2lCQUNILENBQUMsQ0FBQTthQUNIOztnQkFBTSxxQkFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxJQUFJLENBQUMsQ0FBQTtTQUN4RDtLQUNGO0lBQ0QsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFBO0lBQy9CLE9BQU8sd0JBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsNkJBQXFCLENBQUMsQ0FBQTtBQUMzRSxDQUFDLENBQUE7QUFFTSxNQUFNLE9BQU8sR0FBOEIsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDbkYsTUFBTSxTQUFTLEdBQUcsSUFBSSx3QkFBUyxDQUFDLE9BQU8sRUFBRSx1QkFBZSxDQUFDLENBQUE7SUFDekQsSUFBSSxTQUFTLENBQUMsS0FBSztRQUFFLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQTtJQUUxQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7SUFDbEQsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUE7SUFDdkMsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQyxhQUFXLENBQUMsQ0FBQTtJQUNsRCxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUE7SUFDNUMsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFBO0lBQzlDLElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQTtJQUNuQixJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUE7SUFDaEIsSUFBSSxDQUFDLEdBQUcsRUFBRTtRQUNSLE1BQU0sT0FBTyxHQUFHLE1BQU0saUJBQVUsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFDbkQsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25ELFVBQVUsR0FBRyxzQkFBZSxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUM5QyxHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7S0FDeEM7SUFFRCxNQUFNLEdBQUcsR0FBRyxlQUFlLENBQUE7SUFDM0IsTUFBTSxVQUFVLEdBQVcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFBO0lBRTlELE1BQU0sTUFBTSxHQUFHO1FBQ2IsR0FBRztRQUNILGFBQWEsRUFBRSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLO1FBQzdELGtCQUFrQixFQUFFLFFBQVEsS0FBSyxXQUFXO1FBQzVDLGdCQUFnQixFQUFFLFFBQVEsS0FBSyxRQUFRO1FBQ3ZDLGdCQUFnQixFQUFFLE1BQU0sQ0FBQyxNQUFNO0tBQ2hDLENBQUE7SUFFRCxNQUFNLE9BQU8sR0FBRztRQUNkLEdBQUcsTUFBTSxDQUFDLEdBQUc7UUFDYixHQUFHO1FBQ0gsTUFBTTtLQUNQLENBQUE7SUFFRCxNQUFNLFFBQVEsR0FBRyxNQUFNLHdCQUFTLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxXQUFXLENBQUMsQ0FBQTtJQUU5RCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDN0MsT0FBTyxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFVBQVUsQ0FBQyxDQUFBO0lBQzNGLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLHdCQUFTLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtRQUNuRSxHQUFHLENBQUMsV0FBVyxFQUFFO1FBQ2pCLFVBQVU7S0FDWCxDQUFDLENBQUE7SUFFRixPQUFPLHdCQUFTLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxDQUFDLE9BQU8sRUFBRSw2QkFBcUIsQ0FBQyxDQUFBO0FBQ3JGLENBQUMsQ0FBQTtBQTdDWSxRQUFBLE9BQU8sV0E2Q25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdGVyLCBWYWxpZGF0b3IsIExvZ2dlciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHtcbiAgQ29uZmlnLFxuICBFeGVjdXRlV2l0aENvbmZpZyxcbiAgQXhpb3NSZXNwb25zZSxcbiAgQWRhcHRlclJlcXVlc3QsXG4gIElucHV0UGFyYW1ldGVycyxcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IE5BTUUgYXMgQWRhcHRlck5hbWUgfSBmcm9tICcuLi9jb25maWcnXG5pbXBvcnQgeyBnZXRDb2luSWRzLCBnZXRTeW1ib2xzVG9JZHMgfSBmcm9tICcuLi91dGlsJ1xuXG5leHBvcnQgY29uc3Qgc3VwcG9ydGVkRW5kcG9pbnRzID0gWydjcnlwdG8nLCAncHJpY2UnLCAnbWFya2V0Y2FwJywgJ3ZvbHVtZSddXG5leHBvcnQgY29uc3QgYmF0Y2hhYmxlUHJvcGVydHlQYXRoID0gW3sgbmFtZTogJ2Jhc2UnIH0sIHsgbmFtZTogJ3F1b3RlJyB9XVxuXG5jb25zdCBjdXN0b21FcnJvciA9IChkYXRhOiBhbnkpID0+IHtcbiAgaWYgKE9iamVjdC5rZXlzKGRhdGEpLmxlbmd0aCA9PT0gMCkgcmV0dXJuIHRydWVcbiAgcmV0dXJuIGZhbHNlXG59XG5cbmNvbnN0IGJ1aWxkUmVzdWx0UGF0aCA9IChwYXRoOiBzdHJpbmcpID0+IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKHJlcXVlc3QsIGlucHV0UGFyYW1ldGVycylcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG4gIGNvbnN0IHF1b3RlID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnF1b3RlXG4gIGlmIChBcnJheS5pc0FycmF5KHF1b3RlKSkgcmV0dXJuICcnXG4gIHJldHVybiBgJHtxdW90ZS50b0xvd2VyQ2FzZSgpfSR7cGF0aH1gXG59XG5cbmV4cG9ydCBjb25zdCBlbmRwb2ludFJlc3VsdFBhdGhzOiB7XG4gIFtlbmRwb2ludDogc3RyaW5nXTogUmV0dXJuVHlwZTx0eXBlb2YgYnVpbGRSZXN1bHRQYXRoPlxufSA9IHtcbiAgcHJpY2U6IGJ1aWxkUmVzdWx0UGF0aCgnJyksXG4gIGNyeXB0bzogYnVpbGRSZXN1bHRQYXRoKCcnKSxcbiAgbWFya2V0Y2FwOiBidWlsZFJlc3VsdFBhdGgoJ19tYXJrZXRfY2FwJyksXG4gIHZvbHVtZTogYnVpbGRSZXN1bHRQYXRoKCdfMjRoX3ZvbCcpLFxufVxuXG5leHBvcnQgY29uc3QgaW5wdXRQYXJhbWV0ZXJzOiBJbnB1dFBhcmFtZXRlcnMgPSB7XG4gIGJhc2U6IFsnYmFzZScsICdmcm9tJywgJ2NvaW4nXSxcbiAgcXVvdGU6IFsncXVvdGUnLCAndG8nLCAnbWFya2V0J10sXG4gIGNvaW5pZDogZmFsc2UsXG4gIHJlc3VsdFBhdGg6IGZhbHNlLFxuICBlbmRwb2ludDogZmFsc2UsXG59XG5cbmNvbnN0IGhhbmRsZUJhdGNoZWRSZXF1ZXN0ID0gKFxuICBqb2JSdW5JRDogc3RyaW5nLFxuICByZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCxcbiAgcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UsXG4gIHZhbGlkYXRvcjogVmFsaWRhdG9yLFxuICBlbmRwb2ludDogc3RyaW5nLFxuICBpZFRvU3ltYm9sOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuKSA9PiB7XG4gIGNvbnN0IHBheWxvYWQ6IFtBZGFwdGVyUmVxdWVzdCwgbnVtYmVyXVtdID0gW11cbiAgZm9yIChjb25zdCBiYXNlIGluIHJlc3BvbnNlLmRhdGEpIHtcbiAgICBjb25zdCBxdW90ZUFycmF5ID0gQXJyYXkuaXNBcnJheShyZXF1ZXN0LmRhdGEucXVvdGUpID8gcmVxdWVzdC5kYXRhLnF1b3RlIDogW3JlcXVlc3QuZGF0YS5xdW90ZV1cbiAgICBmb3IgKGNvbnN0IHF1b3RlIG9mIHF1b3RlQXJyYXkpIHtcbiAgICAgIGNvbnN0IHN5bWJvbCA9IGlkVG9TeW1ib2w/LltiYXNlXVxuICAgICAgaWYgKHN5bWJvbCkge1xuICAgICAgICBjb25zdCBpbmRpdmlkdWFsUmVxdWVzdCA9IHtcbiAgICAgICAgICAuLi5yZXF1ZXN0LFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIC4uLnJlcXVlc3QuZGF0YSxcbiAgICAgICAgICAgIGJhc2U6IHZhbGlkYXRvci5vdmVycmlkZVJldmVyc2VMb29rdXAoQWRhcHRlck5hbWUsICdvdmVycmlkZXMnLCBzeW1ib2wpLnRvVXBwZXJDYXNlKCksXG4gICAgICAgICAgICBxdW90ZTogcXVvdGUudG9VcHBlckNhc2UoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICAgIHBheWxvYWQucHVzaChbXG4gICAgICAgICAgaW5kaXZpZHVhbFJlcXVlc3QsXG4gICAgICAgICAgUmVxdWVzdGVyLnZhbGlkYXRlUmVzdWx0TnVtYmVyKHJlc3BvbnNlLmRhdGEsIFtcbiAgICAgICAgICAgIGJhc2UsXG4gICAgICAgICAgICBlbmRwb2ludFJlc3VsdFBhdGhzW2VuZHBvaW50XShpbmRpdmlkdWFsUmVxdWVzdCksXG4gICAgICAgICAgXSksXG4gICAgICAgIF0pXG4gICAgICB9IGVsc2UgTG9nZ2VyLmRlYnVnKCdXQVJOSU5HOiBTeW1ib2wgbm90IGZvdW5kICcsIGJhc2UpXG4gICAgfVxuICB9XG4gIHJlc3BvbnNlLmRhdGEucmVzdWx0cyA9IHBheWxvYWRcbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCByZXNwb25zZSwgdHJ1ZSwgYmF0Y2hhYmxlUHJvcGVydHlQYXRoKVxufVxuXG5leHBvcnQgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZVdpdGhDb25maWc8Q29uZmlnPiA9IGFzeW5jIChyZXF1ZXN0LCBjb250ZXh0LCBjb25maWcpID0+IHtcbiAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihyZXF1ZXN0LCBpbnB1dFBhcmFtZXRlcnMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IGVuZHBvaW50ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmVuZHBvaW50XG4gIGNvbnN0IGpvYlJ1bklEID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5pZFxuICBjb25zdCBiYXNlID0gdmFsaWRhdG9yLm92ZXJyaWRlU3ltYm9sKEFkYXB0ZXJOYW1lKVxuICBjb25zdCBxdW90ZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5xdW90ZVxuICBjb25zdCBjb2luaWQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuY29pbmlkXG4gIGxldCBpZFRvU3ltYm9sID0ge31cbiAgbGV0IGlkcyA9IGNvaW5pZFxuICBpZiAoIWlkcykge1xuICAgIGNvbnN0IGNvaW5JZHMgPSBhd2FpdCBnZXRDb2luSWRzKGNvbnRleHQsIGpvYlJ1bklEKVxuICAgIGNvbnN0IHN5bWJvbHMgPSBBcnJheS5pc0FycmF5KGJhc2UpID8gYmFzZSA6IFtiYXNlXVxuICAgIGlkVG9TeW1ib2wgPSBnZXRTeW1ib2xzVG9JZHMoc3ltYm9scywgY29pbklkcylcbiAgICBpZHMgPSBPYmplY3Qua2V5cyhpZFRvU3ltYm9sKS5qb2luKCcsJylcbiAgfVxuXG4gIGNvbnN0IHVybCA9ICcvc2ltcGxlL3ByaWNlJ1xuICBjb25zdCByZXN1bHRQYXRoOiBzdHJpbmcgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEucmVzdWx0UGF0aFxuXG4gIGNvbnN0IHBhcmFtcyA9IHtcbiAgICBpZHMsXG4gICAgdnNfY3VycmVuY2llczogQXJyYXkuaXNBcnJheShxdW90ZSkgPyBxdW90ZS5qb2luKCcsJykgOiBxdW90ZSxcbiAgICBpbmNsdWRlX21hcmtldF9jYXA6IGVuZHBvaW50ID09PSAnbWFya2V0Y2FwJyxcbiAgICBpbmNsdWRlXzI0aHJfdm9sOiBlbmRwb2ludCA9PT0gJ3ZvbHVtZScsXG4gICAgeF9jZ19wcm9fYXBpX2tleTogY29uZmlnLmFwaUtleSxcbiAgfVxuXG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgLi4uY29uZmlnLmFwaSxcbiAgICB1cmwsXG4gICAgcGFyYW1zLFxuICB9XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBSZXF1ZXN0ZXIucmVxdWVzdChvcHRpb25zLCBjdXN0b21FcnJvcilcblxuICBpZiAoQXJyYXkuaXNBcnJheShiYXNlKSB8fCBBcnJheS5pc0FycmF5KHF1b3RlKSlcbiAgICByZXR1cm4gaGFuZGxlQmF0Y2hlZFJlcXVlc3Qoam9iUnVuSUQsIHJlcXVlc3QsIHJlc3BvbnNlLCB2YWxpZGF0b3IsIGVuZHBvaW50LCBpZFRvU3ltYm9sKVxuICByZXNwb25zZS5kYXRhLnJlc3VsdCA9IFJlcXVlc3Rlci52YWxpZGF0ZVJlc3VsdE51bWJlcihyZXNwb25zZS5kYXRhLCBbXG4gICAgaWRzLnRvTG93ZXJDYXNlKCksXG4gICAgcmVzdWx0UGF0aCxcbiAgXSlcblxuICByZXR1cm4gUmVxdWVzdGVyLnN1Y2Nlc3Moam9iUnVuSUQsIHJlc3BvbnNlLCBjb25maWcudmVyYm9zZSwgYmF0Y2hhYmxlUHJvcGVydHlQYXRoKVxufVxuIl19