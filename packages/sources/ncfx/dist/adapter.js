"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.makeExecute = exports.endpointSelector = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const endpoints = tslib_1.__importStar(require("./endpoint"));
const execute = async (request, context, config) => {
    return ea_bootstrap_1.Builder.buildSelector(request, context, config, endpoints);
};
exports.execute = execute;
const endpointSelector = (request) => ea_bootstrap_1.Builder.selectEndpoint(request, config_1.makeConfig(), endpoints);
exports.endpointSelector = endpointSelector;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
const makeWSHandler = (config) => {
    const getPair = (input) => {
        const validator = new ea_bootstrap_1.Validator(input, endpoints.crypto.inputParameters, {}, false);
        if (validator.error)
            return;
        const base = validator.validated.data.base.toUpperCase();
        const quote = validator.validated.data.quote.toUpperCase();
        const endpoint = input.data.endpoint;
        return endpoints.forex.supportedEndpoints.indexOf(endpoint) !== -1
            ? `${base}${quote}`
            : `${base}/${quote}`;
    };
    const getSubscription = (request, pair) => {
        if (!pair)
            return;
        return { request, ccy: pair };
    };
    const isForexEndpoint = (endpoint) => endpoints.forex.supportedEndpoints.indexOf(endpoint) !== -1;
    const getPairFieldFromNCFXResponse = (endpoint) => isForexEndpoint(endpoint) ? 'ccy' : 'currencyPair';
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        return {
            connection: {
                getUrl: async (input) => {
                    const endpoint = input.data.endpoint;
                    if (isForexEndpoint(endpoint)) {
                        return `${defaultConfig.adapterSpecificParams?.forexDefaultBaseWSUrl}/spotdata`;
                    }
                    return `${defaultConfig.api.baseWebsocketURL}/cryptodata`;
                },
            },
            noHttp: true,
            subscribe: (input) => getSubscription('subscribe', getPair(input)),
            unsubscribe: (input) => getSubscription('unsubscribe', getPair(input)),
            subsFromMessage: (message, subscriptionMsg, input) => {
                if (Array.isArray(message) && message.length > 0) {
                    const pairField = getPairFieldFromNCFXResponse(input.data.endpoint);
                    const pairMessage = message.find((m) => m[pairField] === subscriptionMsg.ccy);
                    if (!pairMessage)
                        return;
                    return getSubscription('subscribe', `${pairMessage.currencyPair || pairMessage.ccy}`);
                }
                return getSubscription('subscribe', `${message}`);
            },
            isError: (message) => Number(message.TYPE) > 400 && Number(message.TYPE) < 900,
            filter: (message) => {
                return Array.isArray(message) && message.length > 0;
            },
            toResponse: (message, input) => {
                const pair = getPair(input);
                const pairMessage = message.find((m) => m[getPairFieldFromNCFXResponse(input.data.endpoint)] === pair);
                if (!pairMessage) {
                    throw new Error(`${pair} not found in message`);
                }
                const endpoint = input.data.endpoint;
                const resultField = isForexEndpoint(endpoint) ? 'rate' : 'mid';
                const result = ea_bootstrap_1.Requester.validateResultNumber(pairMessage, [resultField]);
                return ea_bootstrap_1.Requester.success('1', { data: { ...pairMessage, result } }, defaultConfig.verbose);
            },
            onConnect: (input) => {
                const endpoint = input.data.endpoint;
                const username = isForexEndpoint(endpoint)
                    ? defaultConfig.adapterSpecificParams?.forexWSUsername
                    : defaultConfig.api.auth.username;
                const password = isForexEndpoint(endpoint)
                    ? defaultConfig.adapterSpecificParams?.forexWSPassword
                    : defaultConfig.api.auth.password;
                return {
                    request: 'login',
                    username,
                    password,
                };
            },
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBdUU7QUFTdkUscUNBQXFDO0FBQ3JDLDhEQUF1QztBQUVoQyxNQUFNLE9BQU8sR0FBOEIsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDbkYsT0FBTyxzQkFBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQTtBQUNuRSxDQUFDLENBQUE7QUFGWSxRQUFBLE9BQU8sV0FFbkI7QUFFTSxNQUFNLGdCQUFnQixHQUFHLENBQUMsT0FBdUIsRUFBZSxFQUFFLENBQ3ZFLHNCQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBVSxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUE7QUFEN0MsUUFBQSxnQkFBZ0Isb0JBQzZCO0FBRW5ELE1BQU0sV0FBVyxHQUEyQixDQUFDLE1BQU0sRUFBRSxFQUFFO0lBQzVELE9BQU8sS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLGVBQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sSUFBSSxtQkFBVSxFQUFFLENBQUMsQ0FBQTtBQUN0RixDQUFDLENBQUE7QUFGWSxRQUFBLFdBQVcsZUFFdkI7QUFFTSxNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQWUsRUFBaUIsRUFBRTtJQUM5RCxNQUFNLE9BQU8sR0FBRyxDQUFDLEtBQXFCLEVBQUUsRUFBRTtRQUN4QyxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUNuRixJQUFJLFNBQVMsQ0FBQyxLQUFLO1lBQUUsT0FBTTtRQUMzQixNQUFNLElBQUksR0FBRyxTQUFT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YSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQzVGLENBQUM7WUFDRCxTQUFTLEVBQUUsQ0FBQyxLQUFxQixFQUFFLEVBQUU7Z0JBQ25DLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFBO2dCQUNwQyxNQUFNLFFBQVEsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDO29CQUN4QyxDQUFDLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLGVBQWU7b0JBQ3RELENBQUMsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUE7Z0JBQ25DLE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUM7b0JBQ3hDLENBQUMsQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsZUFBZTtvQkFDdEQsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQTtnQkFDbkMsT0FBTztvQkFDTCxPQUFPLEVBQUUsT0FBTztvQkFDaEIsUUFBUTtvQkFDUixRQUFRO2lCQUNULENBQUE7WUFDSCxDQUFDO1NBQ0YsQ0FBQTtJQUNILENBQUMsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQXJGWSxRQUFBLGFBQWEsaUJBcUZ6QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlcXVlc3RlciwgVmFsaWRhdG9yLCBCdWlsZGVyIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQge1xuICBDb25maWcsXG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBFeGVjdXRlRmFjdG9yeSxcbiAgTWFrZVdTSGFuZGxlcixcbiAgQWRhcHRlclJlcXVlc3QsXG4gIEFQSUVuZHBvaW50LFxufSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgbWFrZUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuaW1wb3J0ICogYXMgZW5kcG9pbnRzIGZyb20gJy4vZW5kcG9pbnQnXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICByZXR1cm4gQnVpbGRlci5idWlsZFNlbGVjdG9yKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZywgZW5kcG9pbnRzKVxufVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRTZWxlY3RvciA9IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCk6IEFQSUVuZHBvaW50ID0+XG4gIEJ1aWxkZXIuc2VsZWN0RW5kcG9pbnQocmVxdWVzdCwgbWFrZUNvbmZpZygpLCBlbmRwb2ludHMpXG5cbmV4cG9ydCBjb25zdCBtYWtlRXhlY3V0ZTogRXhlY3V0ZUZhY3Rvcnk8Q29uZmlnPiA9IChjb25maWcpID0+IHtcbiAgcmV0dXJuIGFzeW5jIChyZXF1ZXN0LCBjb250ZXh0KSA9PiBleGVjdXRlKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZyB8fCBtYWtlQ29uZmlnKCkpXG59XG5cbmV4cG9ydCBjb25zdCBtYWtlV1NIYW5kbGVyID0gKGNvbmZpZz86IENvbmZpZyk6IE1ha2VXU0hhbmRsZXIgPT4ge1xuICBjb25zdCBnZXRQYWlyID0gKGlucHV0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICAgIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGVuZHBvaW50cy5jcnlwdG8uaW5wdXRQYXJhbWV0ZXJzLCB7fSwgZmFsc2UpXG4gICAgaWYgKHZhbGlkYXRvci5lcnJvcikgcmV0dXJuXG4gICAgY29uc3QgYmFzZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5iYXNlLnRvVXBwZXJDYXNlKClcbiAgICBjb25zdCBxdW90ZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5xdW90ZS50b1VwcGVyQ2FzZSgpXG4gICAgY29uc3QgZW5kcG9pbnQgPSBpbnB1dC5kYXRhLmVuZHBvaW50XG4gICAgcmV0dXJuIGVuZHBvaW50cy5mb3JleC5zdXBwb3J0ZWRFbmRwb2ludHMuaW5kZXhPZihlbmRwb2ludCkgIT09IC0xXG4gICAgICA/IGAke2Jhc2V9JHtxdW90ZX1gXG4gICAgICA6IGAke2Jhc2V9LyR7cXVvdGV9YFxuICB9XG4gIGNvbnN0IGdldFN1YnNjcmlwdGlvbiA9IChyZXF1ZXN0OiAnc3Vic2NyaWJlJyB8ICd1bnN1YnNjcmliZScsIHBhaXI/OiBzdHJpbmcpID0+IHtcbiAgICBpZiAoIXBhaXIpIHJldHVyblxuICAgIHJldHVybiB7IHJlcXVlc3QsIGNjeTogcGFpciB9XG4gIH1cblxuICBpbnRlcmZhY2UgTkNGWFdTUmVzcG9uc2Uge1xuICAgIGNjeT86IHN0cmluZ1xuICAgIGN1cnJlbmN5UGFpcj86IHN0cmluZ1xuICB9XG5cbiAgY29uc3QgaXNGb3JleEVuZHBvaW50ID0gKGVuZHBvaW50OiBzdHJpbmcpID0+XG4gICAgZW5kcG9pbnRzLmZvcmV4LnN1cHBvcnRlZEVuZHBvaW50cy5pbmRleE9mKGVuZHBvaW50KSAhPT0gLTFcbiAgY29uc3QgZ2V0UGFpckZpZWxkRnJvbU5DRlhSZXNwb25zZSA9IChlbmRwb2ludDogc3RyaW5nKSA9PlxuICAgIGlzRm9yZXhFbmRwb2ludChlbmRwb2ludCkgPyAnY2N5JyA6ICdjdXJyZW5jeVBhaXInXG5cbiAgcmV0dXJuICgpID0+IHtcbiAgICBjb25zdCBkZWZhdWx0Q29uZmlnID0gY29uZmlnIHx8IG1ha2VDb25maWcoKVxuICAgIHJldHVybiB7XG4gICAgICBjb25uZWN0aW9uOiB7XG4gICAgICAgIGdldFVybDogYXN5bmMgKGlucHV0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICAgICAgICAgIGNvbnN0IGVuZHBvaW50ID0gaW5wdXQuZGF0YS5lbmRwb2ludFxuICAgICAgICAgIGlmIChpc0ZvcmV4RW5kcG9pbnQoZW5kcG9pbnQpKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7ZGVmYXVsdENvbmZpZy5hZGFwdGVyU3BlY2lmaWNQYXJhbXM/LmZvcmV4RGVmYXVsdEJhc2VXU1VybH0vc3BvdGRhdGFgXG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBgJHtkZWZhdWx0Q29uZmlnLmFwaS5iYXNlV2Vic29ja2V0VVJMfS9jcnlwdG9kYXRhYFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIG5vSHR0cDogdHJ1ZSxcbiAgICAgIHN1YnNjcmliZTogKGlucHV0KSA9PiBnZXRTdWJzY3JpcHRpb24oJ3N1YnNjcmliZScsIGdldFBhaXIoaW5wdXQpKSxcbiAgICAgIHVuc3Vic2NyaWJlOiAoaW5wdXQpID0+IGdldFN1YnNjcmlwdGlvbigndW5zdWJzY3JpYmUnLCBnZXRQYWlyKGlucHV0KSksXG4gICAgICBzdWJzRnJvbU1lc3NhZ2U6IChtZXNzYWdlLCBzdWJzY3JpcHRpb25Nc2csIGlucHV0KSA9PiB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG1lc3NhZ2UpICYmIG1lc3NhZ2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgIGNvbnN0IHBhaXJGaWVsZCA9IGdldFBhaXJGaWVsZEZyb21OQ0ZYUmVzcG9uc2UoaW5wdXQuZGF0YS5lbmRwb2ludClcbiAgICAgICAgICBjb25zdCBwYWlyTWVzc2FnZSA9IG1lc3NhZ2UuZmluZChcbiAgICAgICAgICAgIChtOiBOQ0ZYV1NSZXNwb25zZSkgPT4gbVtwYWlyRmllbGRdID09PSBzdWJzY3JpcHRpb25Nc2cuY2N5LFxuICAgICAgICAgIClcbiAgICAgICAgICBpZiAoIXBhaXJNZXNzYWdlKSByZXR1cm5cbiAgICAgICAgICByZXR1cm4gZ2V0U3Vic2NyaXB0aW9uKCdzdWJzY3JpYmUnLCBgJHtwYWlyTWVzc2FnZS5jdXJyZW5jeVBhaXIgfHwgcGFpck1lc3NhZ2UuY2N5fWApXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGdldFN1YnNjcmlwdGlvbignc3Vic2NyaWJlJywgYCR7bWVzc2FnZX1gKVxuICAgICAgfSxcbiAgICAgIGlzRXJyb3I6IChtZXNzYWdlOiBhbnkpID0+IE51bWJlcihtZXNzYWdlLlRZUEUpID4gNDAwICYmIE51bWJlcihtZXNzYWdlLlRZUEUpIDwgOTAwLFxuICAgICAgZmlsdGVyOiAobWVzc2FnZTogYW55KSA9PiB7XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KG1lc3NhZ2UpICYmIG1lc3NhZ2UubGVuZ3RoID4gMFxuICAgICAgfSxcbiAgICAgIHRvUmVzcG9uc2U6IChtZXNzYWdlOiBhbnksIGlucHV0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCBwYWlyID0gZ2V0UGFpcihpbnB1dClcbiAgICAgICAgY29uc3QgcGFpck1lc3NhZ2UgPSBtZXNzYWdlLmZpbmQoXG4gICAgICAgICAgKG06IE5DRlhXU1Jlc3BvbnNlKSA9PiBtW2dldFBhaXJGaWVsZEZyb21OQ0ZYUmVzcG9uc2UoaW5wdXQuZGF0YS5lbmRwb2ludCldID09PSBwYWlyLFxuICAgICAgICApXG4gICAgICAgIGlmICghcGFpck1lc3NhZ2UpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7cGFpcn0gbm90IGZvdW5kIGluIG1lc3NhZ2VgKVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGVuZHBvaW50ID0gaW5wdXQuZGF0YS5lbmRwb2ludFxuICAgICAgICBjb25zdCByZXN1bHRGaWVsZCA9IGlzRm9yZXhFbmRwb2ludChlbmRwb2ludCkgPyAncmF0ZScgOiAnbWlkJ1xuICAgICAgICBjb25zdCByZXN1bHQgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocGFpck1lc3NhZ2UsIFtyZXN1bHRGaWVsZF0pXG4gICAgICAgIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2VzcygnMScsIHsgZGF0YTogeyAuLi5wYWlyTWVzc2FnZSwgcmVzdWx0IH0gfSwgZGVmYXVsdENvbmZpZy52ZXJib3NlKVxuICAgICAgfSxcbiAgICAgIG9uQ29ubmVjdDogKGlucHV0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICAgICAgICBjb25zdCBlbmRwb2ludCA9IGlucHV0LmRhdGEuZW5kcG9pbnRcbiAgICAgICAgY29uc3QgdXNlcm5hbWUgPSBpc0ZvcmV4RW5kcG9pbnQoZW5kcG9pbnQpXG4gICAgICAgICAgPyBkZWZhdWx0Q29uZmlnLmFkYXB0ZXJTcGVjaWZpY1BhcmFtcz8uZm9yZXhXU1VzZXJuYW1lXG4gICAgICAgICAgOiBkZWZhdWx0Q29uZmlnLmFwaS5hdXRoLnVzZXJuYW1lXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkID0gaXNGb3JleEVuZHBvaW50KGVuZHBvaW50KVxuICAgICAgICAgID8gZGVmYXVsdENvbmZpZy5hZGFwdGVyU3BlY2lmaWNQYXJhbXM/LmZvcmV4V1NQYXNzd29yZFxuICAgICAgICAgIDogZGVmYXVsdENvbmZpZy5hcGkuYXV0aC5wYXNzd29yZFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHJlcXVlc3Q6ICdsb2dpbicsXG4gICAgICAgICAgdXNlcm5hbWUsXG4gICAgICAgICAgcGFzc3dvcmQsXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfVxuICB9XG59XG4iXX0=