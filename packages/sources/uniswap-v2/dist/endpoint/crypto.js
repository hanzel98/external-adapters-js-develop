"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.endpointResultPaths = exports.supportedEndpoints = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("../config");
const ethers_1 = require("ethers");
const uniswap_v2_router_02_json_1 = tslib_1.__importDefault(require("../abis/uniswap_v2_router_02.json"));
const ERC20_json_1 = tslib_1.__importDefault(require("../abis/ERC20.json"));
const decimal_js_1 = require("decimal.js");
exports.supportedEndpoints = ['crypto'];
exports.endpointResultPaths = {
    crypto: 'rate',
};
exports.inputParameters = {
    from: ['base', 'from', 'coin'],
    fromAddress: false,
    fromDecimals: false,
    to: ['quote', 'to', 'market'],
    toAddress: false,
    toDecimals: false,
    amount: false,
    resultPath: false,
};
const execute = async (request, _, config) => {
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const { address: from, decimals: fromDecimals } = await getTokenDetails(validator, 'from', config);
    const { address: to, decimals: toDecimals } = await getTokenDetails(validator, 'to', config);
    const inputAmount = validator.validated.data.amount || 1;
    const amount = ethers_1.BigNumber.from(inputAmount).mul(ethers_1.BigNumber.from(10).pow(fromDecimals));
    const resultPath = validator.validated.data.resultPath;
    const [_amountIn, output] = await getBestRate(from, to, amount, config);
    const outputAmount = new decimal_js_1.Decimal(output.toString()).div(new decimal_js_1.Decimal(10).pow(toDecimals));
    const rate = outputAmount.div(inputAmount);
    const data = {
        input: amount.toString(),
        inputToken: from,
        inputDecimals: fromDecimals,
        output: output.toString(),
        outputToken: to,
        outputDecimals: toDecimals,
        rate: rate.toNumber(),
    };
    const response = {
        status: 200,
        statusText: 'OK',
        headers: {},
        config: {},
        data: data,
    };
    const result = ea_bootstrap_1.Requester.validateResultNumber(response.data, [resultPath]);
    return ea_bootstrap_1.Requester.success(jobRunID, ea_bootstrap_1.Requester.withResult(response, result), config.verbose);
};
exports.execute = execute;
/**
 * getTokenDetails will find the address and number of decimal for a token.
 *
 * The order of operations is as follows:
 *  - address:
 *     1. Check if the address was provided in the request.
 *     2. If not, check the symbol in the request to see if we have pre-set the address for this symbol/network.
 *     3. If not, we assume the symbol param was actually the address.
 *  - decimals:
 *     1. Check if the number of decimals was provided in the request.
 *     2. Query the contract at the address found above to see how many decimals it's set to.
 * @param validator The validation class to use
 * @param direction Used to get the params in the request
 * - `{direction}` is the symbol of the token (to find pre-set token details)
 * - `{direction}Address` is the token address as set in the request
 * - `{direction}Decimals` is the number of decimals for the token as set in the request
 * @param config Configuration to extract token decimals from
 */
const getTokenDetails = async (validator, direction, config) => {
    const symbol = validator.overrideSymbol(config_1.NAME, validator.validated.data[direction]);
    const address = validator.validated.data[`${direction}Address`] ||
        validator.overrideToken(symbol, config.network) ||
        symbol;
    const decimals = validator.validated.data[`${direction}Decimals`] || (await getDecimals(address, config));
    return { address, decimals };
};
const getDecimals = async (address, config) => new ethers_1.ethers.Contract(address, ERC20_json_1.default, config.provider).decimals();
const getBestRate = async (from, to, amount, config) => {
    const uniRouter = new ethers_1.ethers.Contract(config.uniswapRouter, uniswap_v2_router_02_json_1.default, config.provider);
    return await uniRouter.getAmountsOut(amount, [from, to]);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQThEO0FBRTlELHNDQUF1RDtBQUN2RCxtQ0FBMEM7QUFDMUMsMEdBQWtFO0FBQ2xFLDRFQUF5QztBQUN6QywyQ0FBb0M7QUFFdkIsUUFBQSxrQkFBa0IsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO0FBRS9CLFFBQUEsbUJBQW1CLEdBQUc7SUFDakMsTUFBTSxFQUFFLE1BQU07Q0FDZixDQUFBO0FBWVksUUFBQSxlQUFlLEdBQW9CO0lBQzlDLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDO0lBQzlCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFlBQVksRUFBRSxLQUFLO0lBQ25CLEVBQUUsRUFBRSxDQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDO0lBQzdCLFNBQVMsRUFBRSxLQUFLO0lBQ2hCLFVBQVUsRUFBRSxLQUFLO0lBQ2pCLE1BQU0sRUFBRSxLQUFLO0lBQ2IsVUFBVSxFQUFFLEtBQUs7Q0FDbEIsQ0FBQTtBQUVNLE1BQU0sT0FBTyxHQUE4QixLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsRUFBRTtJQUM3RSxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsT0FBTyxFQUFFLHVCQUFlLENBQUMsQ0FBQTtJQUN6RCxJQUFJLFNBQVMsQ0FBQyxLQUFLO1FBQUUsTUFBTSxTQUFTLENBQUMsS0FBSyxDQUFBO0lBRTFDLE1BQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFBO0lBQ3ZDLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxZQUFZLEVBQUUsR0FBRyxNQUFNLGVBQWUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFBO0lB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QUFXLEdBQUcsS0FBSyxFQUFFLE9BQWUsRUFBRSxNQUFjLEVBQW1CLEVBQUUsQ0FDN0UsSUFBSSxlQUFNLENBQUMsUUFBUSxDQUFDLE9BQU8sRUFBRSxvQkFBUSxFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtBQUVwRSxNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQ3ZCLElBQVksRUFDWixFQUFVLEVBQ1YsTUFBaUIsRUFDakIsTUFBYyxFQUNxQyxFQUFFO0lBQ3JELE1BQU0sU0FBUyxHQUFHLElBQUksZUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFLG1DQUFrQixFQUFFLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUNoRyxPQUFPLE1BQU0sU0FBUyxDQUFDLGFBQWEsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUMxRCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgRXhlY3V0ZVdpdGhDb25maWcsIElucHV0UGFyYW1ldGVycyB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBOQU1FIGFzIEFkYXB0ZXJOYW1lLCBDb25maWcgfSBmcm9tICcuLi9jb25maWcnXG5pbXBvcnQgeyBldGhlcnMsIEJpZ051bWJlciB9IGZyb20gJ2V0aGVycydcbmltcG9ydCB1bmlzd2FwUm91dGVyVjJBQkkgZnJvbSAnLi4vYWJpcy91bmlzd2FwX3YyX3JvdXRlcl8wMi5qc29uJ1xuaW1wb3J0IGVyYzIwQUJJIGZyb20gJy4uL2FiaXMvRVJDMjAuanNvbidcbmltcG9ydCB7IERlY2ltYWwgfSBmcm9tICdkZWNpbWFsLmpzJ1xuXG5leHBvcnQgY29uc3Qgc3VwcG9ydGVkRW5kcG9pbnRzID0gWydjcnlwdG8nXVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRSZXN1bHRQYXRocyA9IHtcbiAgY3J5cHRvOiAncmF0ZScsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzcG9uc2VTY2hlbWEge1xuICBpbnB1dDogc3RyaW5nXG4gIGlucHV0VG9rZW46IHN0cmluZ1xuICBpbnB1dERlY2ltYWxzOiBudW1iZXJcbiAgb3V0cHV0OiBzdHJpbmdcbiAgb3V0cHV0VG9rZW46IHN0cmluZ1xuICBvdXRwdXREZWNpbWFsczogbnVtYmVyXG4gIHJhdGU6IG51bWJlclxufVxuXG5leHBvcnQgY29uc3QgaW5wdXRQYXJhbWV0ZXJzOiBJbnB1dFBhcmFtZXRlcnMgPSB7XG4gIGZyb206IFsnYmFzZScsICdmcm9tJywgJ2NvaW4nXSxcbiAgZnJvbUFkZHJlc3M6IGZhbHNlLFxuICBmcm9tRGVjaW1hbHM6IGZhbHNlLFxuICB0bzogWydxdW90ZScsICd0bycsICdtYXJrZXQnXSxcbiAgdG9BZGRyZXNzOiBmYWxzZSxcbiAgdG9EZWNpbWFsczogZmFsc2UsXG4gIGFtb3VudDogZmFsc2UsXG4gIHJlc3VsdFBhdGg6IGZhbHNlLFxufVxuXG5leHBvcnQgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZVdpdGhDb25maWc8Q29uZmlnPiA9IGFzeW5jIChyZXF1ZXN0LCBfLCBjb25maWcpID0+IHtcbiAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihyZXF1ZXN0LCBpbnB1dFBhcmFtZXRlcnMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IGpvYlJ1bklEID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5pZFxuICBjb25zdCB7IGFkZHJlc3M6IGZyb20sIGRlY2ltYWxzOiBmcm9tRGVjaW1hbHMgfSA9IGF3YWl0IGdldFRva2VuRGV0YWlscyh2YWxpZGF0b3IsICdmcm9tJywgY29uZmlnKVxuICBjb25zdCB7IGFkZHJlc3M6IHRvLCBkZWNpbWFsczogdG9EZWNpbWFscyB9ID0gYXdhaXQgZ2V0VG9rZW5EZXRhaWxzKHZhbGlkYXRvciwgJ3RvJywgY29uZmlnKVxuICBjb25zdCBpbnB1dEFtb3VudCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5hbW91bnQgfHwgMVxuICBjb25zdCBhbW91bnQgPSBCaWdOdW1iZXIuZnJvbShpbnB1dEFtb3VudCkubXVsKEJpZ051bWJlci5mcm9tKDEwKS5wb3coZnJvbURlY2ltYWxzKSlcbiAgY29uc3QgcmVzdWx0UGF0aCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5yZXN1bHRQYXRoXG5cbiAgY29uc3QgW19hbW91bnRJbiwgb3V0cHV0XSA9IGF3YWl0IGdldEJlc3RSYXRlKGZyb20sIHRvLCBhbW91bnQsIGNvbmZpZylcblxuICBjb25zdCBvdXRwdXRBbW91bnQgPSBuZXcgRGVjaW1hbChvdXRwdXQudG9TdHJpbmcoKSkuZGl2KG5ldyBEZWNpbWFsKDEwKS5wb3codG9EZWNpbWFscykpXG4gIGNvbnN0IHJhdGUgPSBvdXRwdXRBbW91bnQuZGl2KGlucHV0QW1vdW50KVxuXG4gIGNvbnN0IGRhdGE6IFJlc3BvbnNlU2NoZW1hID0ge1xuICAgIGlucHV0OiBhbW91bnQudG9TdHJpbmcoKSxcbiAgICBpbnB1dFRva2VuOiBmcm9tLFxuICAgIGlucHV0RGVjaW1hbHM6IGZyb21EZWNpbWFscyxcbiAgICBvdXRwdXQ6IG91dHB1dC50b1N0cmluZygpLFxuICAgIG91dHB1dFRva2VuOiB0byxcbiAgICBvdXRwdXREZWNpbWFsczogdG9EZWNpbWFscyxcbiAgICByYXRlOiByYXRlLnRvTnVtYmVyKCksXG4gIH1cblxuICBjb25zdCByZXNwb25zZSA9IHtcbiAgICBzdGF0dXM6IDIwMCxcbiAgICBzdGF0dXNUZXh0OiAnT0snLFxuICAgIGhlYWRlcnM6IHt9LFxuICAgIGNvbmZpZzoge30sXG4gICAgZGF0YTogZGF0YSxcbiAgfVxuICBjb25zdCByZXN1bHQgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocmVzcG9uc2UuZGF0YSwgW3Jlc3VsdFBhdGhdKVxuXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwgUmVxdWVzdGVyLndpdGhSZXN1bHQocmVzcG9uc2UsIHJlc3VsdCksIGNvbmZpZy52ZXJib3NlKVxufVxuXG4vKipcbiAqIGdldFRva2VuRGV0YWlscyB3aWxsIGZpbmQgdGhlIGFkZHJlc3MgYW5kIG51bWJlciBvZiBkZWNpbWFsIGZvciBhIHRva2VuLlxuICpcbiAqIFRoZSBvcmRlciBvZiBvcGVyYXRpb25zIGlzIGFzIGZvbGxvd3M6XG4gKiAgLSBhZGRyZXNzOlxuICogICAgIDEuIENoZWNrIGlmIHRoZSBhZGRyZXNzIHdhcyBwcm92aWRlZCBpbiB0aGUgcmVxdWVzdC5cbiAqICAgICAyLiBJZiBub3QsIGNoZWNrIHRoZSBzeW1ib2wgaW4gdGhlIHJlcXVlc3QgdG8gc2VlIGlmIHdlIGhhdmUgcHJlLXNldCB0aGUgYWRkcmVzcyBmb3IgdGhpcyBzeW1ib2wvbmV0d29yay5cbiAqICAgICAzLiBJZiBub3QsIHdlIGFzc3VtZSB0aGUgc3ltYm9sIHBhcmFtIHdhcyBhY3R1YWxseSB0aGUgYWRkcmVzcy5cbiAqICAtIGRlY2ltYWxzOlxuICogICAgIDEuIENoZWNrIGlmIHRoZSBudW1iZXIgb2YgZGVjaW1hbHMgd2FzIHByb3ZpZGVkIGluIHRoZSByZXF1ZXN0LlxuICogICAgIDIuIFF1ZXJ5IHRoZSBjb250cmFjdCBhdCB0aGUgYWRkcmVzcyBmb3VuZCBhYm92ZSB0byBzZWUgaG93IG1hbnkgZGVjaW1hbHMgaXQncyBzZXQgdG8uXG4gKiBAcGFyYW0gdmFsaWRhdG9yIFRoZSB2YWxpZGF0aW9uIGNsYXNzIHRvIHVzZVxuICogQHBhcmFtIGRpcmVjdGlvbiBVc2VkIHRvIGdldCB0aGUgcGFyYW1zIGluIHRoZSByZXF1ZXN0XG4gKiAtIGB7ZGlyZWN0aW9ufWAgaXMgdGhlIHN5bWJvbCBvZiB0aGUgdG9rZW4gKHRvIGZpbmQgcHJlLXNldCB0b2tlbiBkZXRhaWxzKVxuICogLSBge2RpcmVjdGlvbn1BZGRyZXNzYCBpcyB0aGUgdG9rZW4gYWRkcmVzcyBhcyBzZXQgaW4gdGhlIHJlcXVlc3RcbiAqIC0gYHtkaXJlY3Rpb259RGVjaW1hbHNgIGlzIHRoZSBudW1iZXIgb2YgZGVjaW1hbHMgZm9yIHRoZSB0b2tlbiBhcyBzZXQgaW4gdGhlIHJlcXVlc3RcbiAqIEBwYXJhbSBjb25maWcgQ29uZmlndXJhdGlvbiB0byBleHRyYWN0IHRva2VuIGRlY2ltYWxzIGZyb21cbiAqL1xuY29uc3QgZ2V0VG9rZW5EZXRhaWxzID0gYXN5bmMgKFxuICB2YWxpZGF0b3I6IFZhbGlkYXRvcixcbiAgZGlyZWN0aW9uOiBzdHJpbmcsXG4gIGNvbmZpZzogQ29uZmlnLFxuKTogUHJvbWlzZTx7IGFkZHJlc3M6IHN0cmluZzsgZGVjaW1hbHM6IG51bWJlciB9PiA9PiB7XG4gIGNvbnN0IHN5bWJvbCA9IHZhbGlkYXRvci5vdmVycmlkZVN5bWJvbChcbiAgICBBZGFwdGVyTmFtZSxcbiAgICB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGFbZGlyZWN0aW9uXSxcbiAgKSBhcyBzdHJpbmdcbiAgY29uc3QgYWRkcmVzcyA9XG4gICAgdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhW2Ake2RpcmVjdGlvbn1BZGRyZXNzYF0gfHxcbiAgICB2YWxpZGF0b3Iub3ZlcnJpZGVUb2tlbihzeW1ib2wsIGNvbmZpZy5uZXR3b3JrKSB8fFxuICAgIHN5bWJvbFxuICBjb25zdCBkZWNpbWFscyA9XG4gICAgdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhW2Ake2RpcmVjdGlvbn1EZWNpbWFsc2BdIHx8IChhd2FpdCBnZXREZWNpbWFscyhhZGRyZXNzLCBjb25maWcpKVxuXG4gIHJldHVybiB7IGFkZHJlc3MsIGRlY2ltYWxzIH1cbn1cblxuY29uc3QgZ2V0RGVjaW1hbHMgPSBhc3luYyAoYWRkcmVzczogc3RyaW5nLCBjb25maWc6IENvbmZpZyk6IFByb21pc2U8bnVtYmVyPiA9PlxuICBuZXcgZXRoZXJzLkNvbnRyYWN0KGFkZHJlc3MsIGVyYzIwQUJJLCBjb25maWcucHJvdmlkZXIpLmRlY2ltYWxzKClcblxuY29uc3QgZ2V0QmVzdFJhdGUgPSBhc3luYyAoXG4gIGZyb206IHN0cmluZyxcbiAgdG86IHN0cmluZyxcbiAgYW1vdW50OiBCaWdOdW1iZXIsXG4gIGNvbmZpZzogQ29uZmlnLFxuKTogUHJvbWlzZTxbYW1vdW50SW46IEJpZ051bWJlciwgb3V0cHV0OiBCaWdOdW1iZXJdPiA9PiB7XG4gIGNvbnN0IHVuaVJvdXRlciA9IG5ldyBldGhlcnMuQ29udHJhY3QoY29uZmlnLnVuaXN3YXBSb3V0ZXIsIHVuaXN3YXBSb3V0ZXJWMkFCSSwgY29uZmlnLnByb3ZpZGVyKVxuICByZXR1cm4gYXdhaXQgdW5pUm91dGVyLmdldEFtb3VudHNPdXQoYW1vdW50LCBbZnJvbSwgdG9dKVxufVxuIl19