"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.endpointResultPaths = exports.batchablePropertyPath = exports.supportedEndpoints = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("../config");
exports.supportedEndpoints = ['crypto', 'price', 'marketcap', 'volume'];
exports.batchablePropertyPath = [{ name: 'base' }, { name: 'convert', limit: 120 }];
exports.endpointResultPaths = {
    crypto: 'price',
    price: 'price',
    marketcap: 'market_cap',
    volume: 'volume_24h',
};
// Coin IDs fetched from the ID map: https://coinmarketcap.com/api/documentation/v1/#operation/getV1CryptocurrencyMap
const presetIds = {
    COMP: 5692,
    BNT: 1727,
    RCN: 2096,
    UNI: 7083,
    CRV: 6538,
    FNX: 5712,
    ETC: 1321,
    BAT: 1697,
    CRO: 3635,
    LEO: 3957,
    FTT: 4195,
    HT: 2502,
    OKB: 3897,
    KCS: 2087,
    BTC: 1,
    ETH: 1027,
    BNB: 1839,
    LINK: 1975,
    BCH: 1831,
    MKR: 1518,
    AAVE: 7278,
    UMA: 5617,
    SNX: 2586,
    REN: 2539,
    KNC: 1982,
    SUSHI: 6758,
    YFI: 5864,
    BAL: 5728,
    '1INCH': 8104,
};
exports.inputParameters = {
    base: ['base', 'from', 'coin', 'sym', 'symbol'],
    convert: ['quote', 'to', 'market', 'convert'],
    cid: false,
    slug: false,
    resultPath: false,
};
const handleBatchedRequest = (jobRunID, request, response, validator, resultPath) => {
    const payload = [];
    for (const base in response.data.data) {
        const originalBase = validator.overrideReverseLookup(config_1.NAME, 'overrides', response.data.data[base].symbol);
        for (const quote in response.data.data[base].quote) {
            payload.push([
                {
                    ...request,
                    data: {
                        ...request.data,
                        base: originalBase.toUpperCase(),
                        convert: quote.toUpperCase(),
                    },
                },
                ea_bootstrap_1.Requester.validateResultNumber(response.data, ['data', base, 'quote', quote, resultPath]),
            ]);
        }
    }
    response.data.results = payload;
    response.data.cost = ea_bootstrap_1.Requester.validateResultNumber(response.data, ['status', 'credit_count']);
    return ea_bootstrap_1.Requester.success(jobRunID, response, true, exports.batchablePropertyPath);
};
const execute = async (request, _, config) => {
    const url = 'cryptocurrency/quotes/latest';
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const symbol = validator.overrideSymbol(config_1.NAME);
    // CMC allows a coin name to be specified instead of a symbol
    const slug = validator.validated.data.slug;
    // CMC allows a coin ID to be specified instead of a symbol
    const cid = validator.validated.data.cid || '';
    const convert = validator.validated.data.convert;
    if (!config.apiKey && Array.isArray(convert))
        throw new Error(' Free CMCPro API only supports a single symbol to convert');
    const resultPath = validator.validated.data.resultPath;
    const params = {
        convert: Array.isArray(convert)
            ? convert.map((symbol) => symbol.toUpperCase()).join(',')
            : convert.toUpperCase(),
    };
    if (cid) {
        params.id = cid;
    }
    else if (slug) {
        params.slug = slug;
    }
    else if (Array.isArray(symbol)) {
        let hasIds = true;
        const idsForSymbols = symbol.map((symbol) => {
            const idForSymbol = presetIds[symbol];
            if (!idForSymbol)
                hasIds = false;
            return idForSymbol;
        });
        if (hasIds) {
            params.id = idsForSymbols.join(',');
        }
        else {
            params.symbol = symbol.map((s) => s.toUpperCase()).join(',');
        }
    }
    else {
        const idForSymbol = presetIds[symbol];
        if (idForSymbol) {
            params.id = String(idForSymbol);
        }
        else {
            params.symbol = symbol.toUpperCase();
        }
    }
    const options = {
        ...config.api,
        url,
        params,
    };
    const response = await ea_bootstrap_1.Requester.request(options);
    if (Array.isArray(symbol) || Array.isArray(convert))
        return handleBatchedRequest(jobRunID, request, response, validator, resultPath);
    // CMC API currently uses ID as key in response, when querying with "slug" param
    const _keyForSlug = (data, slug) => {
        if (!data || !data.data)
            return;
        // First try to find slug key in response (in case the API starts returning keys correctly)
        if (Object.keys(data.data).includes(slug))
            return slug;
        // Fallback to ID
        const _iEqual = (s1, s2) => s1.toUpperCase() === s2.toUpperCase();
        const o = Object.values(data.data).find((o) => _iEqual(o.slug, slug));
        return o && o.id;
    };
    const key = params.id || _keyForSlug(response.data, params.slug || '') || params.symbol;
    response.data.result = ea_bootstrap_1.Requester.validateResultNumber(response.data, [
        'data',
        key,
        'quote',
        convert,
        resultPath,
    ]);
    return ea_bootstrap_1.Requester.success(jobRunID, response, config.verbose, exports.batchablePropertyPath);
};
exports.execute = execute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBOEQ7QUFDOUQsc0NBQStDO0FBU2xDLFFBQUEsa0JBQWtCLEdBQUcsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLFdBQVcsRUFBRSxRQUFRLENBQUMsQ0FBQTtBQUMvRCxRQUFBLHFCQUFxQixHQUFHLENBQUMsRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFBO0FBRTNFLFFBQUEsbUJBQW1CLEdBQUc7SUFDakMsTUFBTSxFQUFFLE9BQU87SUFDZixLQUFLLEVBQUUsT0FBTztJQUNkLFNBQVMsRUFBRSxZQUFZO0lBQ3ZCLE1BQU0sRUFBRSxZQUFZO0NBQ3JCLENBQUE7QUFFRCxxSEFBcUg7QUFDckgsTUFBTSxTQUFTLEdBQWlDO0lBQzlDLElBQUksRUFBRSxJQUFJO0lBQ1YsR0FBRyxFQUFFLElBQUk7SUFDVCxHQUFHLEVBQUUsSUFBSTtJQUNULEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxHQUFHLEVBQUUsSUFBSTtJQUNULEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxHQUFHLEVBQUUsSUFBSTtJQUNULEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxFQUFFLEVBQUUsSUFBSTtJQUNSLEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxHQUFHLEVBQUUsQ0FBQztJQUNOLEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxJQUFJLEVBQUUsSUFBSTtJQUNWLEdBQUcsRUFBRSxJQUFJO0lBQ1QsR0FBRyxFQUFFLElBQUk7SUFDVCxJQUFJLEVBQUUsSUFBSTtJ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RSxPQUFPLElBQUksQ0FBQTtRQUN0RCxpQkFBaUI7UUFDakIsTUFBTSxPQUFPLEdBQUcsQ0FBQyxFQUFVLEVBQUUsRUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLEtBQUssRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ2pGLE1BQU0sQ0FBQyxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQU0sRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQTtRQUMvRSxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFBO0lBQ2xCLENBQUMsQ0FBQTtJQUVELE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxFQUFFLElBQUksV0FBVyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFBO0lBQ3ZGLFFBQVEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLHdCQUFTLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtRQUNuRSxNQUFNO1FBQ04sR0FBRztRQUNILE9BQU87UUFDUCxPQUFPO1FBQ1AsVUFBVTtLQUNYLENBQUMsQ0FBQTtJQUNGLE9BQU8sd0JBQVMsQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFFLFFBQVEsRUFBRSxNQUFNLENBQUMsT0FBTyxFQUFFLDZCQUFxQixDQUFDLENBQUE7QUFDckYsQ0FBQyxDQUFBO0FBMUVZLFFBQUEsT0FBTyxXQTBFbkIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgTkFNRSBhcyBBZGFwdGVyTmFtZSB9IGZyb20gJy4uL2NvbmZpZydcbmltcG9ydCB7XG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBDb25maWcsXG4gIEF4aW9zUmVzcG9uc2UsXG4gIEFkYXB0ZXJSZXF1ZXN0LFxuICBJbnB1dFBhcmFtZXRlcnMsXG59IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5cbmV4cG9ydCBjb25zdCBzdXBwb3J0ZWRFbmRwb2ludHMgPSBbJ2NyeXB0bycsICdwcmljZScsICdtYXJrZXRjYXAnLCAndm9sdW1lJ11cbmV4cG9ydCBjb25zdCBiYXRjaGFibGVQcm9wZXJ0eVBhdGggPSBbeyBuYW1lOiAnYmFzZScgfSwgeyBuYW1lOiAnY29udmVydCcsIGxpbWl0OiAxMjAgfV1cblxuZXhwb3J0IGNvbnN0IGVuZHBvaW50UmVzdWx0UGF0aHMgPSB7XG4gIGNyeXB0bzogJ3ByaWNlJyxcbiAgcHJpY2U6ICdwcmljZScsXG4gIG1hcmtldGNhcDogJ21hcmtldF9jYXAnLFxuICB2b2x1bWU6ICd2b2x1bWVfMjRoJyxcbn1cblxuLy8gQ29pbiBJRHMgZmV0Y2hlZCBmcm9tIHRoZSBJRCBtYXA6IGh0dHBzOi8vY29pbm1hcmtldGNhcC5jb20vYXBpL2RvY3VtZW50YXRpb24vdjEvI29wZXJhdGlvbi9nZXRWMUNyeXB0b2N1cnJlbmN5TWFwXG5jb25zdCBwcmVzZXRJZHM6IHsgW3N5bWJvbDogc3RyaW5nXTogbnVtYmVyIH0gPSB7XG4gIENPTVA6IDU2OTIsXG4gIEJOVDogMTcyNyxcbiAgUkNOOiAyMDk2LFxuICBVTkk6IDcwODMsXG4gIENSVjogNjUzOCxcbiAgRk5YOiA1NzEyLFxuICBFVEM6IDEzMjEsXG4gIEJBVDogMTY5NyxcbiAgQ1JPOiAzNjM1LFxuICBMRU86IDM5NTcsXG4gIEZUVDogNDE5NSxcbiAgSFQ6IDI1MDIsXG4gIE9LQjogMzg5NyxcbiAgS0NTOiAyMDg3LFxuICBCVEM6IDEsXG4gIEVUSDogMTAyNyxcbiAgQk5COiAxODM5LFxuICBMSU5LOiAxOTc1LFxuICBCQ0g6IDE4MzEsXG4gIE1LUjogMTUxOCxcbiAgQUFWRTogNzI3OCxcbiAgVU1BOiA1NjE3LFxuICBTTlg6IDI1ODYsXG4gIFJFTjogMjUzOSxcbiAgS05DOiAxOTgyLFxuICBTVVNISTogNjc1OCxcbiAgWUZJOiA1ODY0LFxuICBCQUw6IDU3MjgsXG4gICcxSU5DSCc6IDgxMDQsXG59XG5cbmV4cG9ydCBjb25zdCBpbnB1dFBhcmFtZXRlcnM6IElucHV0UGFyYW1ldGVycyA9IHtcbiAgYmFzZTogWydiYXNlJywgJ2Zyb20nLCAnY29pbicsICdzeW0nLCAnc3ltYm9sJ10sXG4gIGNvbnZlcnQ6IFsncXVvdGUnLCAndG8nLCAnbWFya2V0JywgJ2NvbnZlcnQnXSxcbiAgY2lkOiBmYWxzZSxcbiAgc2x1ZzogZmFsc2UsXG4gIHJlc3VsdFBhdGg6IGZhbHNlLFxufVxuXG5jb25zdCBoYW5kbGVCYXRjaGVkUmVxdWVzdCA9IChcbiAgam9iUnVuSUQ6IHN0cmluZyxcbiAgcmVxdWVzdDogQWRhcHRlclJlcXVlc3QsXG4gIHJlc3BvbnNlOiBBeGlvc1Jlc3BvbnNlLFxuICB2YWxpZGF0b3I6IFZhbGlkYXRvcixcbiAgcmVzdWx0UGF0aDogc3RyaW5nLFxuKSA9PiB7XG4gIGNvbnN0IHBheWxvYWQ6IFtBZGFwdGVyUmVxdWVzdCwgbnVtYmVyXVtdID0gW11cbiAgZm9yIChjb25zdCBiYXNlIGluIHJlc3BvbnNlLmRhdGEuZGF0YSkge1xuICAgIGNvbnN0IG9yaWdpbmFsQmFzZSA9IHZhbGlkYXRvci5vdmVycmlkZVJldmVyc2VMb29rdXAoXG4gICAgICBBZGFwdGVyTmFtZSxcbiAgICAgICdvdmVycmlkZXMnLFxuICAgICAgcmVzcG9uc2UuZGF0YS5kYXRhW2Jhc2VdLnN5bWJvbCxcbiAgICApXG4gICAgZm9yIChjb25zdCBxdW90ZSBpbiByZXNwb25zZS5kYXRhLmRhdGFbYmFzZV0ucXVvdGUpIHtcbiAgICAgIHBheWxvYWQucHVzaChbXG4gICAgICAgIHtcbiAgICAgICAgICAuLi5yZXF1ZXN0LFxuICAgICAgICAgIGRhdGE6IHtcbiAgICAgICAgICAgIC4uLnJlcXVlc3QuZGF0YSxcbiAgICAgICAgICAgIGJhc2U6IG9yaWdpbmFsQmFzZS50b1VwcGVyQ2FzZSgpLFxuICAgICAgICAgICAgY29udmVydDogcXVvdGUudG9VcHBlckNhc2UoKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocmVzcG9uc2UuZGF0YSwgWydkYXRhJywgYmFzZSwgJ3F1b3RlJywgcXVvdGUsIHJlc3VsdFBhdGhdKSxcbiAgICAgIF0pXG4gICAgfVxuICB9XG5cbiAgcmVzcG9uc2UuZGF0YS5yZXN1bHRzID0gcGF5bG9hZFxuICByZXNwb25zZS5kYXRhLmNvc3QgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocmVzcG9uc2UuZGF0YSwgWydzdGF0dXMnLCAnY3JlZGl0X2NvdW50J10pXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwgcmVzcG9uc2UsIHRydWUsIGJhdGNoYWJsZVByb3BlcnR5UGF0aClcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAocmVxdWVzdCwgXywgY29uZmlnKSA9PiB7XG4gIGNvbnN0IHVybCA9ICdjcnlwdG9jdXJyZW5jeS9xdW90ZXMvbGF0ZXN0J1xuICBjb25zdCB2YWxpZGF0b3IgPSBuZXcgVmFsaWRhdG9yKHJlcXVlc3QsIGlucHV0UGFyYW1ldGVycylcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG5cbiAgY29uc3Qgam9iUnVuSUQgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmlkXG4gIGNvbnN0IHN5bWJvbCA9IHZhbGlkYXRvci5vdmVycmlkZVN5bWJvbChBZGFwdGVyTmFtZSlcbiAgLy8gQ01DIGFsbG93cyBhIGNvaW4gbmFtZSB0byBiZSBzcGVjaWZpZWQgaW5zdGVhZCBvZiBhIHN5bWJvbFxuICBjb25zdCBzbHVnID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnNsdWdcbiAgLy8gQ01DIGFsbG93cyBhIGNvaW4gSUQgdG8gYmUgc3BlY2lmaWVkIGluc3RlYWQgb2YgYSBzeW1ib2xcbiAgY29uc3QgY2lkID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNpZCB8fCAnJ1xuICBjb25zdCBjb252ZXJ0ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNvbnZlcnRcbiAgaWYgKCFjb25maWcuYXBpS2V5ICYmIEFycmF5LmlzQXJyYXkoY29udmVydCkpXG4gICAgdGhyb3cgbmV3IEVycm9yKCcgRnJlZSBDTUNQcm8gQVBJIG9ubHkgc3VwcG9ydHMgYSBzaW5nbGUgc3ltYm9sIHRvIGNvbnZlcnQnKVxuICBjb25zdCByZXN1bHRQYXRoID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnJlc3VsdFBhdGhcbiAgY29uc3QgcGFyYW1zOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIGNvbnZlcnQ6IEFycmF5LmlzQXJyYXkoY29udmVydClcbiAgICAgID8gY29udmVydC5tYXAoKHN5bWJvbCkgPT4gc3ltYm9sLnRvVXBwZXJDYXNlKCkpLmpvaW4oJywnKVxuICAgICAgOiBjb252ZXJ0LnRvVXBwZXJDYXNlKCksXG4gIH1cbiAgaWYgKGNpZCkge1xuICAgIHBhcmFtcy5pZCA9IGNpZFxuICB9IGVsc2UgaWYgKHNsdWcpIHtcbiAgICBwYXJhbXMuc2x1ZyA9IHNsdWdcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHN5bWJvbCkpIHtcbiAgICBsZXQgaGFzSWRzID0gdHJ1ZVxuICAgIGNvbnN0IGlkc0ZvclN5bWJvbHMgPSBzeW1ib2wubWFwKChzeW1ib2wpID0+IHtcbiAgICAgIGNvbnN0IGlkRm9yU3ltYm9sID0gcHJlc2V0SWRzW3N5bWJvbF1cbiAgICAgIGlmICghaWRGb3JTeW1ib2wpIGhhc0lkcyA9IGZhbHNlXG4gICAgICByZXR1cm4gaWRGb3JTeW1ib2xcbiAgICB9KVxuICAgIGlmIChoYXNJZHMpIHtcbiAgICAgIHBhcmFtcy5pZCA9IGlkc0ZvclN5bWJvbHMuam9pbignLCcpXG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcy5zeW1ib2wgPSBzeW1ib2wubWFwKChzKSA9PiBzLnRvVXBwZXJDYXNlKCkpLmpvaW4oJywnKVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBjb25zdCBpZEZvclN5bWJvbCA9IHByZXNldElkc1tzeW1ib2xdXG4gICAgaWYgKGlkRm9yU3ltYm9sKSB7XG4gICAgICBwYXJhbXMuaWQgPSBTdHJpbmcoaWRGb3JTeW1ib2wpXG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcy5zeW1ib2wgPSBzeW1ib2wudG9VcHBlckNhc2UoKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG9wdGlvbnMgPSB7XG4gICAgLi4uY29uZmlnLmFwaSxcbiAgICB1cmwsXG4gICAgcGFyYW1zLFxuICB9XG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUmVxdWVzdGVyLnJlcXVlc3Qob3B0aW9ucylcbiAgaWYgKEFycmF5LmlzQXJyYXkoc3ltYm9sKSB8fCBBcnJheS5pc0FycmF5KGNvbnZlcnQpKVxuICAgIHJldHVybiBoYW5kbGVCYXRjaGVkUmVxdWVzdChqb2JSdW5JRCwgcmVxdWVzdCwgcmVzcG9uc2UsIHZhbGlkYXRvciwgcmVzdWx0UGF0aClcblxuICAvLyBDTUMgQVBJIGN1cnJlbnRseSB1c2VzIElEIGFzIGtleSBpbiByZXNwb25zZSwgd2hlbiBxdWVyeWluZyB3aXRoIFwic2x1Z1wiIHBhcmFtXG4gIGNvbnN0IF9rZXlGb3JTbHVnID0gKGRhdGE6IGFueSwgc2x1Zzogc3RyaW5nKSA9PiB7XG4gICAgaWYgKCFkYXRhIHx8ICFkYXRhLmRhdGEpIHJldHVyblxuICAgIC8vIEZpcnN0IHRyeSB0byBmaW5kIHNsdWcga2V5IGluIHJlc3BvbnNlIChpbiBjYXNlIHRoZSBBUEkgc3RhcnRzIHJldHVybmluZyBrZXlzIGNvcnJlY3RseSlcbiAgICBpZiAoT2JqZWN0LmtleXMoZGF0YS5kYXRhKS5pbmNsdWRlcyhzbHVnKSkgcmV0dXJuIHNsdWdcbiAgICAvLyBGYWxsYmFjayB0byBJRFxuICAgIGNvbnN0IF9pRXF1YWwgPSAoczE6IHN0cmluZywgczI6IHN0cmluZykgPT4gczEudG9VcHBlckNhc2UoKSA9PT0gczIudG9VcHBlckNhc2UoKVxuICAgIGNvbnN0IG86IGFueSA9IE9iamVjdC52YWx1ZXMoZGF0YS5kYXRhKS5maW5kKChvOiBhbnkpID0+IF9pRXF1YWwoby5zbHVnLCBzbHVnKSlcbiAgICByZXR1cm4gbyAmJiBvLmlkXG4gIH1cblxuICBjb25zdCBrZXkgPSBwYXJhbXMuaWQgfHwgX2tleUZvclNsdWcocmVzcG9uc2UuZGF0YSwgcGFyYW1zLnNsdWcgfHwgJycpIHx8IHBhcmFtcy5zeW1ib2xcbiAgcmVzcG9uc2UuZGF0YS5yZXN1bHQgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIocmVzcG9uc2UuZGF0YSwgW1xuICAgICdkYXRhJyxcbiAgICBrZXksXG4gICAgJ3F1b3RlJyxcbiAgICBjb252ZXJ0LFxuICAgIHJlc3VsdFBhdGgsXG4gIF0pXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwgcmVzcG9uc2UsIGNvbmZpZy52ZXJib3NlLCBiYXRjaGFibGVQcm9wZXJ0eVBhdGgpXG59XG4iXX0=