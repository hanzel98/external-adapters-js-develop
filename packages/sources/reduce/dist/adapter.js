"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = void 0;
const tslib_1 = require("tslib");
const object_path_1 = tslib_1.__importDefault(require("object-path"));
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const ea_bootstrap_2 = require("@chainlink/ea-bootstrap");
const decimal_js_1 = require("decimal.js");
const inputParams = {
    reducer: true,
    initialValue: false,
    dataPath: false,
    valuePath: false,
};
const MAX_DECIMALS = 18;
const DEFAULT_DATA_PATH = 'result';
// Export function to integrate with Chainlink node
const execute = async (request) => {
    const validator = new ea_bootstrap_1.Validator(request, inputParams);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const { data } = validator.validated;
    const dataPath = data.dataPath || DEFAULT_DATA_PATH;
    let inputData = object_path_1.default.get(request.data, dataPath);
    // Check if input data is valid
    if (!inputData || !Array.isArray(inputData) || inputData.length === 0) {
        throw Error(`Input must be a non-empty array.`);
    }
    const path = data.valuePath || '';
    // Check if every input object has a path specified
    if (path && !inputData.every((val) => object_path_1.default.has(val, path))) {
        throw Error(`Path '${path}' not present in every item.`);
    }
    // Get value at specified path
    const _get = (val) => object_path_1.default.get(val, path);
    // Filter undesired values
    inputData = inputData.filter((val) => !!_get(val));
    // Check if all items are numbers
    const _isNumber = (val) => !isNaN(_get(val));
    if (!inputData.every(_isNumber)) {
        throw Error(`Not every '${path}' item is a number.`);
    }
    let result;
    switch (data.reducer) {
        case 'sum': {
            result = inputData.reduce((acc, val) => {
                return acc.plus(new decimal_js_1.Decimal(_get(val)));
            }, new decimal_js_1.Decimal(data.initialValue) || new decimal_js_1.Decimal(0));
            break;
        }
        case 'product': {
            result = inputData.reduce((acc, val) => acc.mul(new decimal_js_1.Decimal(_get(val))), new decimal_js_1.Decimal(data.initialValue) || new decimal_js_1.Decimal(1));
            break;
        }
        case 'average': {
            result = inputData.reduce((acc, val, _, { length }) => acc.plus(new decimal_js_1.Decimal(_get(val)).div(new decimal_js_1.Decimal(length))), new decimal_js_1.Decimal(data.initialValue) || new decimal_js_1.Decimal(0));
            break;
        }
        case 'median': {
            const sortedData = inputData.sort((a, b) => _get(a) - _get(b));
            const mid = Math.ceil(inputData.length / 2);
            result =
                inputData.length % 2 === 0
                    ? new decimal_js_1.Decimal(sortedData[mid]).plus(new decimal_js_1.Decimal(sortedData[mid - 1])).div(new decimal_js_1.Decimal(2))
                    : new decimal_js_1.Decimal(sortedData[mid - 1]);
            break;
        }
        case 'min': {
            result = inputData.reduce((acc, val) => decimal_js_1.Decimal.min(acc, new decimal_js_1.Decimal(_get(val))), new decimal_js_1.Decimal(data.initialValue) || new decimal_js_1.Decimal(Number.MAX_VALUE));
            break;
        }
        case 'max': {
            result = inputData.reduce((acc, val) => decimal_js_1.Decimal.max(acc, new decimal_js_1.Decimal(_get(val))), new decimal_js_1.Decimal(data.initialValue) || new decimal_js_1.Decimal(Number.MIN_VALUE));
            break;
        }
        default: {
            throw Error(`Reducer ${data.reducer} not supported.`);
        }
    }
    // Avoid printing scientific notation on output with `result.toString()`
    const resultStr = ea_bootstrap_2.util.toFixedMax(result, MAX_DECIMALS);
    return ea_bootstrap_1.Requester.success(jobRunID, {
        data: { result: resultStr },
        status: 200,
    });
};
exports.execute = execute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxzRUFBb0M7QUFDcEMsMERBQThEO0FBQzlELDBEQUE4QztBQUU5QywyQ0FBb0M7QUFFcEMsTUFBTSxXQUFXLEdBQUc7SUFDbEIsT0FBTyxFQUFFLElBQUk7SUFDYixZQUFZLEVBQUUsS0FBSztJQUNuQixRQUFRLEVBQUUsS0FBSztJQUNmLFNBQVMsRUFBRSxLQUFLO0NBQ2pCLENBQUE7QUFFRCxNQUFNLFlBQVksR0FBRyxFQUFFLENBQUE7QUFDdkIsTUFBTSxpQkFBaUIsR0FBRyxRQUFRLENBQUE7QUFFbEMsbURBQW1EO0FBQzVDLE1BQU0sT0FBTyxHQUFZLEtBQUssRUFBRSxPQUFPLEVBQUUsRUFBRTtJQUNoRCxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFBO0lBQ3JELElBQUksU0FBUyxDQUFDLEtBQUs7UUFBRSxNQUFNLFNBQVMsQ0FBQyxLQUFLLENBQUE7SUFFMUMsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUE7SUFFdkMsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUE7SUFFcEMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxpQkFBaUIsQ0FBQTtJQUNuRCxJQUFJLFNBQVMsR0FBYSxxQkFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBRWhFLCtCQUErQjtJQUMvQixJQUFJLENBQUMsU0FBUyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtRQUNyRSxNQUFNLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFBO0tBQ2hEO0lB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SztTQUNOO1FBQ0QsT0FBTyxDQUFDLENBQUM7WUFDUCxNQUFNLEtBQUssQ0FBQyxXQUFXLElBQUksQ0FBQyxPQUFPLGlCQUFpQixDQUFDLENBQUE7U0FDdEQ7S0FDRjtJQUVELHdFQUF3RTtJQUN4RSxNQUFNLFNBQVMsR0FBRyxtQkFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsWUFBWSxDQUFDLENBQUE7SUFFdkQsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7UUFDakMsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRTtRQUMzQixNQUFNLEVBQUUsR0FBRztLQUNaLENBQUMsQ0FBQTtBQUNKLENBQUMsQ0FBQTtBQTNGWSxRQUFBLE9BQU8sV0EyRm5CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG9iamVjdFBhdGggZnJvbSAnb2JqZWN0LXBhdGgnXG5pbXBvcnQgeyBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHsgRXhlY3V0ZSB9IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBEZWNpbWFsIH0gZnJvbSAnZGVjaW1hbC5qcydcblxuY29uc3QgaW5wdXRQYXJhbXMgPSB7XG4gIHJlZHVjZXI6IHRydWUsXG4gIGluaXRpYWxWYWx1ZTogZmFsc2UsXG4gIGRhdGFQYXRoOiBmYWxzZSxcbiAgdmFsdWVQYXRoOiBmYWxzZSxcbn1cblxuY29uc3QgTUFYX0RFQ0lNQUxTID0gMThcbmNvbnN0IERFRkFVTFRfREFUQV9QQVRIID0gJ3Jlc3VsdCdcblxuLy8gRXhwb3J0IGZ1bmN0aW9uIHRvIGludGVncmF0ZSB3aXRoIENoYWlubGluayBub2RlXG5leHBvcnQgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZSA9IGFzeW5jIChyZXF1ZXN0KSA9PiB7XG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IocmVxdWVzdCwgaW5wdXRQYXJhbXMpXG4gIGlmICh2YWxpZGF0b3IuZXJyb3IpIHRocm93IHZhbGlkYXRvci5lcnJvclxuXG4gIGNvbnN0IGpvYlJ1bklEID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5pZFxuXG4gIGNvbnN0IHsgZGF0YSB9ID0gdmFsaWRhdG9yLnZhbGlkYXRlZFxuXG4gIGNvbnN0IGRhdGFQYXRoID0gZGF0YS5kYXRhUGF0aCB8fCBERUZBVUxUX0RBVEFfUEFUSFxuICBsZXQgaW5wdXREYXRhID0gPG51bWJlcltdPm9iamVjdFBhdGguZ2V0KHJlcXVlc3QuZGF0YSwgZGF0YVBhdGgpXG5cbiAgLy8gQ2hlY2sgaWYgaW5wdXQgZGF0YSBpcyB2YWxpZFxuICBpZiAoIWlucHV0RGF0YSB8fCAhQXJyYXkuaXNBcnJheShpbnB1dERhdGEpIHx8IGlucHV0RGF0YS5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBFcnJvcihgSW5wdXQgbXVzdCBiZSBhIG5vbi1lbXB0eSBhcnJheS5gKVxuICB9XG5cbiAgY29uc3QgcGF0aCA9IGRhdGEudmFsdWVQYXRoIHx8ICcnXG4gIC8vIENoZWNrIGlmIGV2ZXJ5IGlucHV0IG9iamVjdCBoYXMgYSBwYXRoIHNwZWNpZmllZFxuICBpZiAocGF0aCAmJiAhaW5wdXREYXRhLmV2ZXJ5KCh2YWwpID0+IG9iamVjdFBhdGguaGFzKHZhbCwgcGF0aCkpKSB7XG4gICAgdGhyb3cgRXJyb3IoYFBhdGggJyR7cGF0aH0nIG5vdCBwcmVzZW50IGluIGV2ZXJ5IGl0ZW0uYClcbiAgfVxuXG4gIC8vIEdldCB2YWx1ZSBhdCBzcGVjaWZpZWQgcGF0aFxuICBjb25zdCBfZ2V0ID0gKHZhbDogdW5rbm93bik6IG51bWJlciA9PiBvYmplY3RQYXRoLmdldCh2YWwsIHBhdGgpXG5cbiAgLy8gRmlsdGVyIHVuZGVzaXJlZCB2YWx1ZXNcbiAgaW5wdXREYXRhID0gaW5wdXREYXRhLmZpbHRlcigodmFsKSA9PiAhIV9nZXQodmFsKSlcblxuICAvLyBDaGVjayBpZiBhbGwgaXRlbXMgYXJlIG51bWJlcnNcbiAgY29uc3QgX2lzTnVtYmVyID0gKHZhbDogdW5rbm93bik6IGJvb2xlYW4gPT4gIWlzTmFOKF9nZXQodmFsKSlcbiAgaWYgKCFpbnB1dERhdGEuZXZlcnkoX2lzTnVtYmVyKSkge1xuICAgIHRocm93IEVycm9yKGBOb3QgZXZlcnkgJyR7cGF0aH0nIGl0ZW0gaXMgYSBudW1iZXIuYClcbiAgfVxuXG4gIGxldCByZXN1bHQ6IERlY2ltYWxcbiAgc3dpdGNoIChkYXRhLnJlZHVjZXIpIHtcbiAgICBjYXNlICdzdW0nOiB7XG4gICAgICByZXN1bHQgPSBpbnB1dERhdGEucmVkdWNlKChhY2MsIHZhbCkgPT4ge1xuICAgICAgICByZXR1cm4gYWNjLnBsdXMobmV3IERlY2ltYWwoX2dldCh2YWwpKSlcbiAgICAgIH0sIG5ldyBEZWNpbWFsKGRhdGEuaW5pdGlhbFZhbHVlKSB8fCBuZXcgRGVjaW1hbCgwKSlcbiAgICAgIGJyZWFrXG4gICAgfVxuICAgIGNhc2UgJ3Byb2R1Y3QnOiB7XG4gICAgICByZXN1bHQgPSBpbnB1dERhdGEucmVkdWNlKFxuICAgICAgICAoYWNjLCB2YWwpID0+IGFjYy5tdWwobmV3IERlY2ltYWwoX2dldCh2YWwpKSksXG4gICAgICAgIG5ldyBEZWNpbWFsKGRhdGEuaW5pdGlhbFZhbHVlKSB8fCBuZXcgRGVjaW1hbCgxKSxcbiAgICAgIClcbiAgICAgIGJyZWFrXG4gICAgfVxuICAgIGNhc2UgJ2F2ZXJhZ2UnOiB7XG4gICAgICByZXN1bHQgPSBpbnB1dERhdGEucmVkdWNlKFxuICAgICAgICAoYWNjLCB2YWwsIF8sIHsgbGVuZ3RoIH0pID0+IGFjYy5wbHVzKG5ldyBEZWNpbWFsKF9nZXQodmFsKSkuZGl2KG5ldyBEZWNpbWFsKGxlbmd0aCkpKSxcbiAgICAgICAgbmV3IERlY2ltYWwoZGF0YS5pbml0aWFsVmFsdWUpIHx8IG5ldyBEZWNpbWFsKDApLFxuICAgICAgKVxuICAgICAgYnJlYWtcbiAgICB9XG4gICAgY2FzZSAnbWVkaWFuJzoge1xuICAgICAgY29uc3Qgc29ydGVkRGF0YSA9IGlucHV0RGF0YS5zb3J0KChhLCBiKSA9PiBfZ2V0KGEpIC0gX2dldChiKSlcbiAgICAgIGNvbnN0IG1pZCA9IE1hdGguY2VpbChpbnB1dERhdGEubGVuZ3RoIC8gMilcbiAgICAgIHJlc3VsdCA9XG4gICAgICAgIGlucHV0RGF0YS5sZW5ndGggJSAyID09PSAwXG4gICAgICAgICAgPyBuZXcgRGVjaW1hbChzb3J0ZWREYXRhW21pZF0pLnBsdXMobmV3IERlY2ltYWwoc29ydGVkRGF0YVttaWQgLSAxXSkpLmRpdihuZXcgRGVjaW1hbCgyKSlcbiAgICAgICAgICA6IG5ldyBEZWNpbWFsKHNvcnRlZERhdGFbbWlkIC0gMV0pXG4gICAgICBicmVha1xuICAgIH1cbiAgICBjYXNlICdtaW4nOiB7XG4gICAgICByZXN1bHQgPSBpbnB1dERhdGEucmVkdWNlKFxuICAgICAgICAoYWNjLCB2YWwpID0+IERlY2ltYWwubWluKGFjYywgbmV3IERlY2ltYWwoX2dldCh2YWwpKSksXG4gICAgICAgIG5ldyBEZWNpbWFsKGRhdGEuaW5pdGlhbFZhbHVlKSB8fCBuZXcgRGVjaW1hbChOdW1iZXIuTUFYX1ZBTFVFKSxcbiAgICAgIClcbiAgICAgIGJyZWFrXG4gICAgfVxuICAgIGNhc2UgJ21heCc6IHtcbiAgICAgIHJlc3VsdCA9IGlucHV0RGF0YS5yZWR1Y2UoXG4gICAgICAgIChhY2MsIHZhbCkgPT4gRGVjaW1hbC5tYXgoYWNjLCBuZXcgRGVjaW1hbChfZ2V0KHZhbCkpKSxcbiAgICAgICAgbmV3IERlY2ltYWwoZGF0YS5pbml0aWFsVmFsdWUpIHx8IG5ldyBEZWNpbWFsKE51bWJlci5NSU5fVkFMVUUpLFxuICAgICAgKVxuICAgICAgYnJlYWtcbiAgICB9XG4gICAgZGVmYXVsdDoge1xuICAgICAgdGhyb3cgRXJyb3IoYFJlZHVjZXIgJHtkYXRhLnJlZHVjZXJ9IG5vdCBzdXBwb3J0ZWQuYClcbiAgICB9XG4gIH1cblxuICAvLyBBdm9pZCBwcmludGluZyBzY2llbnRpZmljIG5vdGF0aW9uIG9uIG91dHB1dCB3aXRoIGByZXN1bHQudG9TdHJpbmcoKWBcbiAgY29uc3QgcmVzdWx0U3RyID0gdXRpbC50b0ZpeGVkTWF4KHJlc3VsdCwgTUFYX0RFQ0lNQUxTKVxuXG4gIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2Vzcyhqb2JSdW5JRCwge1xuICAgIGRhdGE6IHsgcmVzdWx0OiByZXN1bHRTdHIgfSxcbiAgICBzdGF0dXM6IDIwMCxcbiAgfSlcbn1cbiJdfQ==