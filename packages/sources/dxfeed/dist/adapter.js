"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.makeExecute = exports.endpointSelector = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const endpoints = tslib_1.__importStar(require("./endpoint"));
const execute = async (request, context, config) => {
    return ea_bootstrap_1.Builder.buildSelector(request, context, config, endpoints);
};
exports.execute = execute;
const endpointSelector = (request) => ea_bootstrap_1.Builder.selectEndpoint(request, config_1.makeConfig(), endpoints);
exports.endpointSelector = endpointSelector;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
const makeWSHandler = (config) => {
    const getSubscription = (request, ticker) => {
        if (!ticker)
            return;
        return [
            {
                channel: SERVICE_SUB,
                data: {
                    [`${request === 'subscribe' ? 'add' : 'remove'}`]: {
                        Quote: [ticker],
                    },
                },
            },
        ];
    };
    const META_HANDSHAKE = '/meta/handshake';
    const META_CONNECT = '/meta/connect';
    const SERVICE_SUB = '/service/sub';
    const SERVICE_DATA = '/service/data';
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        const isDataMessage = (message) => Array.isArray(message) && message[0].channel === SERVICE_DATA;
        const isDataSubscriptionMsg = (subscriptionMessage) => Array.isArray(subscriptionMessage) && subscriptionMessage[0].channel === SERVICE_SUB;
        const handshakeMsg = [
            {
                id: '1',
                version: '1.0',
                minimumVersion: '1.0',
                channel: '/meta/handshake',
                supportedConnectionTypes: ['websocket', 'long-polling', 'callback-polling'],
                advice: {
                    timeout: 60000,
                    interval: 0,
                },
            },
        ];
        const firstHeartbeatMsg = [
            {
                id: '2',
                channel: META_CONNECT,
                connectionType: 'websocket',
                advice: {
                    timeout: 0,
                },
            },
        ];
        const heartbeatMsg = [
            {
                id: '3',
                channel: META_CONNECT,
                connectionType: 'websocket',
            },
        ];
        return {
            connection: {
                url: defaultConfig.api.baseWsURL,
            },
            subscribe: (input) => {
                const validator = new ea_bootstrap_1.Validator(input, endpoints.price.inputParameters);
                if (validator.errored)
                    throw validator.errored;
                const ticker = validator.validated.data.base;
                return getSubscription('subscribe', ticker);
            },
            unsubscribe: (input) => {
                const validator = new ea_bootstrap_1.Validator(input, endpoints.price.inputParameters);
                if (validator.errored)
                    throw validator.errored;
                const ticker = validator.validated.data.base;
                return getSubscription('unsubscribe', ticker);
            },
            subsFromMessage: (message) => {
                switch (message[0].channel) {
                    case META_HANDSHAKE:
                        return handshakeMsg;
                    case META_CONNECT:
                        return heartbeatMsg;
                    case SERVICE_DATA:
                        return getSubscription('subscribe', message[0].data[1][0]);
                    default:
                        return null;
                }
            },
            isError: (message) => message[0].successful === false,
            filter: (message) => {
                return isDataMessage(message);
            },
            toResponse: (message) => {
                const data = message[0].data[1];
                const result = data[6];
                return ea_bootstrap_1.Requester.success('1', { data: { ...message[0], result } }, defaultConfig.verbose);
            },
            saveOnConnectToConnection: (message) => {
                return {
                    requestId: parseInt(message[0].id),
                    clientId: message[0].clientId,
                };
            },
            modifySubscriptionPayload: (original, _, connectionParams, id) => {
                original[0].clientId = connectionParams.clientId;
                original[0].id = id.toString();
                return original;
            },
            shouldModifyPayload: (payload) => payload[0].channel === META_CONNECT || payload[0].channel === SERVICE_SUB,
            shouldSaveToConnection: (message) => {
                return !!message[0].clientId;
            },
            shouldReplyToServerHeartbeat: (message) => {
                const dxFeedMsg = message;
                return Object.keys(dxFeedMsg[0]).length === 3 && dxFeedMsg[0].channel === META_CONNECT;
            },
            heartbeatReplyMessage: (message, _, connectionParams) => [
                {
                    id: parseInt(message[0].id) + 1,
                    channel: META_CONNECT,
                    connectionType: 'websocket',
                    clientId: connectionParams.clientId,
                },
            ],
            heartbeatIntervalInMS: 30000,
            shouldSaveToStore: (subscriptionMessage) => isDataSubscriptionMsg(subscriptionMessage),
            isOnConnectChainMessage: (message) => message[0].channel === META_HANDSHAKE || message[0].channel === META_CONNECT,
            isDataMessage: (message) => isDataSubscriptionMsg(message),
            onConnectChain: [
                {
                    payload: handshakeMsg,
                },
                {
                    payload: firstHeartbeatMsg,
                    filter: (message) => message[0].id == '2',
                },
                {
                    payload: heartbeatMsg,
                    filter: (message) => message[0].id === '3' ||
                        (Object.keys(message[0]).length === 3 && message[0].channel === META_CONNECT),
                    shouldNeverUnsubscribe: true,
                },
            ],
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBdUU7QUFTdkUscUNBQXFDO0FBQ3JDLDhEQUF1QztBQUVoQyxNQUFNLE9BQU8sR0FBOEIsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDbkYsT0FBTyxzQkFBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQTtBQUNuRSxDQUFDLENBQUE7QUFGWSxRQUFBLE9BQU8sV0FFbkI7QUFFTSxNQUFNLGdCQUFnQixHQUFHLENBQUMsT0FBdUIsRUFBZSxFQUFFLENBQ3ZFLHNCQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBVSxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUE7QUFEN0MsUUFBQSxnQkFBZ0Isb0JBQzZCO0FBRW5ELE1BQU0sV0FBVyxHQUEyQixDQUFDLE1BQU0sRUFBRSxFQUFFO0lBQzVELE9BQU8sS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLGVBQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sSUFBSSxtQkFBVSxFQUFFLENBQUMsQ0FBQTtBQUN0RixDQUFDLENBQUE7QUFGWSxRQUFBLFdBQVcsZUFFdkI7QUFlTSxNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQWUsRUFBaUIsRUFBRTtJQUM5RCxNQUFNLGVBQWUsR0FBRyxDQUFDLE9BQW9DLEVBQUUsTUFBZSxFQUFFLEVBQUU7UUFDaEYsSUFBSSxDQUFDLE1BQU07WUFBRSxPQUFNO1FBQ25CLE9BQU87WUFDTDtnQkFDRSxPQUFPLEVBQUUsV0FBVztnQkFDcEIsSUFBSSxFQUFFO29CQUNKLENBQUMsR0FBRyxPQUFPLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFFB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WUFDRCxxQkFBcUIsRUFBRSxLQUFLO1lBQzVCLGlCQUFpQixFQUFFLENBQUMsbUJBQXdCLEVBQUUsRUFBRSxDQUFDLHFCQUFxQixDQUFDLG1CQUFtQixDQUFDO1lBQzNGLHVCQUF1QixFQUFFLENBQUMsT0FBc0IsRUFBRSxFQUFFLENBQ2xELE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEtBQUssY0FBYyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEtBQUssWUFBWTtZQUM5RSxhQUFhLEVBQUUsQ0FBQyxPQUFnQixFQUFFLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUM7WUFDbkUsY0FBYyxFQUFFO2dCQUNkO29CQUNFLE9BQU8sRUFBRSxZQUFZO2lCQUN0QjtnQkFDRDtvQkFDRSxPQUFPLEVBQUUsaUJBQWlCO29CQUMxQixNQUFNLEVBQUUsQ0FBQyxPQUFzQixFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLEdBQUc7aUJBQ3pEO2dCQUNEO29CQUNFLE9BQU8sRUFBRSxZQUFZO29CQUNyQixNQUFNLEVBQUUsQ0FBQyxPQUFzQixFQUFFLEVBQUUsQ0FDakMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxHQUFHO3dCQUNyQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLFlBQVksQ0FBQztvQkFDL0Usc0JBQXNCLEVBQUUsSUFBSTtpQkFDN0I7YUFDRjtTQUNGLENBQUE7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUE7QUFwSlksUUFBQSxhQUFhLGlCQW9KekIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCdWlsZGVyLCBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHtcbiAgQ29uZmlnLFxuICBFeGVjdXRlV2l0aENvbmZpZyxcbiAgRXhlY3V0ZUZhY3RvcnksXG4gIEFkYXB0ZXJSZXF1ZXN0LFxuICBBUElFbmRwb2ludCxcbiAgTWFrZVdTSGFuZGxlcixcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IG1ha2VDb25maWcgfSBmcm9tICcuL2NvbmZpZydcbmltcG9ydCAqIGFzIGVuZHBvaW50cyBmcm9tICcuL2VuZHBvaW50J1xuXG5leHBvcnQgY29uc3QgZXhlY3V0ZTogRXhlY3V0ZVdpdGhDb25maWc8Q29uZmlnPiA9IGFzeW5jIChyZXF1ZXN0LCBjb250ZXh0LCBjb25maWcpID0+IHtcbiAgcmV0dXJuIEJ1aWxkZXIuYnVpbGRTZWxlY3RvcihyZXF1ZXN0LCBjb250ZXh0LCBjb25maWcsIGVuZHBvaW50cylcbn1cblxuZXhwb3J0IGNvbnN0IGVuZHBvaW50U2VsZWN0b3IgPSAocmVxdWVzdDogQWRhcHRlclJlcXVlc3QpOiBBUElFbmRwb2ludCA9PlxuICBCdWlsZGVyLnNlbGVjdEVuZHBvaW50KHJlcXVlc3QsIG1ha2VDb25maWcoKSwgZW5kcG9pbnRzKVxuXG5leHBvcnQgY29uc3QgbWFrZUV4ZWN1dGU6IEV4ZWN1dGVGYWN0b3J5PENvbmZpZz4gPSAoY29uZmlnKSA9PiB7XG4gIHJldHVybiBhc3luYyAocmVxdWVzdCwgY29udGV4dCkgPT4gZXhlY3V0ZShyZXF1ZXN0LCBjb250ZXh0LCBjb25maWcgfHwgbWFrZUNvbmZpZygpKVxufVxuXG5leHBvcnQgdHlwZSBEWEZlZWRNZXNzYWdlID0ge1xuICBjaGFubmVsOiBzdHJpbmdcbiAgY2xpZW50SWQ/OiBzdHJpbmdcbiAgaWQ6IHN0cmluZ1xuICBkYXRhOiBhbnlbXVxuICBzdWNjZXNzZnVsPzogYm9vbGVhblxuICBhZHZpY2U/OiB7XG4gICAgaW50ZXJ2YWw6IG51bWJlclxuICAgIHRpbWVvdXQ6IG51bWJlclxuICAgIHJlY29ubmVjdDogc3RyaW5nXG4gIH1cbn1bXVxuXG5leHBvcnQgY29uc3QgbWFrZVdTSGFuZGxlciA9IChjb25maWc/OiBDb25maWcpOiBNYWtlV1NIYW5kbGVyID0+IHtcbiAgY29uc3QgZ2V0U3Vic2NyaXB0aW9uID0gKHJlcXVlc3Q6ICdzdWJzY3JpYmUnIHwgJ3Vuc3Vic2NyaWJlJywgdGlja2VyPzogc3RyaW5nKSA9PiB7XG4gICAgaWYgKCF0aWNrZXIpIHJldHVyblxuICAgIHJldHVybiBbXG4gICAgICB7XG4gICAgICAgIGNoYW5uZWw6IFNFUlZJQ0VfU1VCLFxuICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgW2Ake3JlcXVlc3QgPT09ICdzdWJzY3JpYmUnID8gJ2FkZCcgOiAncmVtb3ZlJ31gXToge1xuICAgICAgICAgICAgUXVvdGU6IFt0aWNrZXJdLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF1cbiAgfVxuXG4gIGNvbnN0IE1FVEFfSEFORFNIQUtFID0gJy9tZXRhL2hhbmRzaGFrZSdcbiAgY29uc3QgTUVUQV9DT05ORUNUID0gJy9tZXRhL2Nvbm5lY3QnXG4gIGNvbnN0IFNFUlZJQ0VfU1VCID0gJy9zZXJ2aWNlL3N1YidcbiAgY29uc3QgU0VSVklDRV9EQVRBID0gJy9zZXJ2aWNlL2RhdGEnXG5cbiAgcmV0dXJuICgpID0+IHtcbiAgICBjb25zdCBkZWZhdWx0Q29uZmlnID0gY29uZmlnIHx8IG1ha2VDb25maWcoKVxuICAgIGNvbnN0IGlzRGF0YU1lc3NhZ2UgPSAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT5cbiAgICAgIEFycmF5LmlzQXJyYXkobWVzc2FnZSkgJiYgbWVzc2FnZVswXS5jaGFubmVsID09PSBTRVJWSUNFX0RBVEFcbiAgICBjb25zdCBpc0RhdGFTdWJzY3JpcHRpb25Nc2cgPSAoc3Vic2NyaXB0aW9uTWVzc2FnZTogYW55KSA9PlxuICAgICAgQXJyYXkuaXNBcnJheShzdWJzY3JpcHRpb25NZXNzYWdlKSAmJiBzdWJzY3JpcHRpb25NZXNzYWdlWzBdLmNoYW5uZWwgPT09IFNFUlZJQ0VfU1VCXG5cbiAgICBjb25zdCBoYW5kc2hha2VNc2cgPSBbXG4gICAgICB7XG4gICAgICAgIGlkOiAnMScsXG4gICAgICAgIHZlcnNpb246ICcxLjAnLFxuICAgICAgICBtaW5pbXVtVmVyc2lvbjogJzEuMCcsXG4gICAgICAgIGNoYW5uZWw6ICcvbWV0YS9oYW5kc2hha2UnLFxuICAgICAgICBzdXBwb3J0ZWRDb25uZWN0aW9uVHlwZXM6IFsnd2Vic29ja2V0JywgJ2xvbmctcG9sbGluZycsICdjYWxsYmFjay1wb2xsaW5nJ10sXG4gICAgICAgIGFkdmljZToge1xuICAgICAgICAgIHRpbWVvdXQ6IDYwMDAwLFxuICAgICAgICAgIGludGVydmFsOiAwLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICBdXG5cbiAgICBjb25zdCBmaXJzdEhlYXJ0YmVhdE1zZyA9IFtcbiAgICAgIHtcbiAgICAgICAgaWQ6ICcyJyxcbiAgICAgICAgY2hhbm5lbDogTUVUQV9DT05ORUNULFxuICAgICAgICBjb25uZWN0aW9uVHlwZTogJ3dlYnNvY2tldCcsXG4gICAgICAgIGFkdmljZToge1xuICAgICAgICAgIHRpbWVvdXQ6IDAsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgIF1cblxuICAgIGNvbnN0IGhlYXJ0YmVhdE1zZyA9IFtcbiAgICAgIHtcbiAgICAgICAgaWQ6ICczJyxcbiAgICAgICAgY2hhbm5lbDogTUVUQV9DT05ORUNULFxuICAgICAgICBjb25uZWN0aW9uVHlwZTogJ3dlYnNvY2tldCcsXG4gICAgICB9LFxuICAgIF1cblxuICAgIHJldHVybiB7XG4gICAgICBjb25uZWN0aW9uOiB7XG4gICAgICAgIHVybDogZGVmYXVsdENvbmZpZy5hcGkuYmFzZVdzVVJMLFxuICAgICAgfSxcbiAgICAgIHN1YnNjcmliZTogKGlucHV0KSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGVuZHBvaW50cy5wcmljZS5pbnB1dFBhcmFtZXRlcnMpXG4gICAgICAgIGlmICh2YWxpZGF0b3IuZXJyb3JlZCkgdGhyb3cgdmFsaWRhdG9yLmVycm9yZWRcbiAgICAgICAgY29uc3QgdGlja2VyID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmJhc2VcbiAgICAgICAgcmV0dXJuIGdldFN1YnNjcmlwdGlvbignc3Vic2NyaWJlJywgdGlja2VyKVxuICAgICAgfSxcbiAgICAgIHVuc3Vic2NyaWJlOiAoaW5wdXQpID0+IHtcbiAgICAgICAgY29uc3QgdmFsaWRhdG9yID0gbmV3IFZhbGlkYXRvcihpbnB1dCwgZW5kcG9pbnRzLnByaWNlLmlucHV0UGFyYW1ldGVycylcbiAgICAgICAgaWYgKHZhbGlkYXRvci5lcnJvcmVkKSB0aHJvdyB2YWxpZGF0b3IuZXJyb3JlZFxuICAgICAgICBjb25zdCB0aWNrZXIgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuYmFzZVxuICAgICAgICByZXR1cm4gZ2V0U3Vic2NyaXB0aW9uKCd1bnN1YnNjcmliZScsIHRpY2tlcilcbiAgICAgIH0sXG4gICAgICBzdWJzRnJvbU1lc3NhZ2U6IChtZXNzYWdlOiBEWEZlZWRNZXNzYWdlKSA9PiB7XG4gICAgICAgIHN3aXRjaCAobWVzc2FnZVswXS5jaGFubmVsKSB7XG4gICAgICAgICAgY2FzZSBNRVRBX0hBTkRTSEFLRTpcbiAgICAgICAgICAgIHJldHVybiBoYW5kc2hha2VNc2dcbiAgICAgICAgICBjYXNlIE1FVEFfQ09OTkVDVDpcbiAgICAgICAgICAgIHJldHVybiBoZWFydGJlYXRNc2dcbiAgICAgICAgICBjYXNlIFNFUlZJQ0VfREFUQTpcbiAgICAgICAgICAgIHJldHVybiBnZXRTdWJzY3JpcHRpb24oJ3N1YnNjcmliZScsIG1lc3NhZ2VbMF0uZGF0YVsxXVswXSlcbiAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIGlzRXJyb3I6IChtZXNzYWdlKSA9PiAobWVzc2FnZSBhcyBEWEZlZWRNZXNzYWdlKVswXS5zdWNjZXNzZnVsID09PSBmYWxzZSxcbiAgICAgIGZpbHRlcjogKG1lc3NhZ2U6IERYRmVlZE1lc3NhZ2UpID0+IHtcbiAgICAgICAgcmV0dXJuIGlzRGF0YU1lc3NhZ2UobWVzc2FnZSlcbiAgICAgIH0sXG4gICAgICB0b1Jlc3BvbnNlOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT4ge1xuICAgICAgICBjb25zdCBkYXRhID0gbWVzc2FnZVswXS5kYXRhWzFdXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGRhdGFbNl1cbiAgICAgICAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKCcxJywgeyBkYXRhOiB7IC4uLm1lc3NhZ2VbMF0sIHJlc3VsdCB9IH0sIGRlZmF1bHRDb25maWcudmVyYm9zZSlcbiAgICAgIH0sXG4gICAgICBzYXZlT25Db25uZWN0VG9Db25uZWN0aW9uOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHJlcXVlc3RJZDogcGFyc2VJbnQobWVzc2FnZVswXS5pZCksXG4gICAgICAgICAgY2xpZW50SWQ6IG1lc3NhZ2VbMF0uY2xpZW50SWQsXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBtb2RpZnlTdWJzY3JpcHRpb25QYXlsb2FkOiAob3JpZ2luYWwsIF8sIGNvbm5lY3Rpb25QYXJhbXMsIGlkKSA9PiB7XG4gICAgICAgIG9yaWdpbmFsWzBdLmNsaWVudElkID0gY29ubmVjdGlvblBhcmFtcy5jbGllbnRJZFxuICAgICAgICBvcmlnaW5hbFswXS5pZCA9IGlkLnRvU3RyaW5nKClcbiAgICAgICAgcmV0dXJuIG9yaWdpbmFsXG4gICAgICB9LFxuICAgICAgc2hvdWxkTW9kaWZ5UGF5bG9hZDogKHBheWxvYWQpID0+XG4gICAgICAgIHBheWxvYWRbMF0uY2hhbm5lbCA9PT0gTUVUQV9DT05ORUNUIHx8IHBheWxvYWRbMF0uY2hhbm5lbCA9PT0gU0VSVklDRV9TVUIsXG4gICAgICBzaG91bGRTYXZlVG9Db25uZWN0aW9uOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT4ge1xuICAgICAgICByZXR1cm4gISFtZXNzYWdlWzBdLmNsaWVudElkXG4gICAgICB9LFxuICAgICAgc2hvdWxkUmVwbHlUb1NlcnZlckhlYXJ0YmVhdDogKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgY29uc3QgZHhGZWVkTXNnID0gbWVzc2FnZSBhcyBEWEZlZWRNZXNzYWdlXG4gICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhkeEZlZWRNc2dbMF0pLmxlbmd0aCA9PT0gMyAmJiBkeEZlZWRNc2dbMF0uY2hhbm5lbCA9PT0gTUVUQV9DT05ORUNUXG4gICAgICB9LFxuICAgICAgaGVhcnRiZWF0UmVwbHlNZXNzYWdlOiAobWVzc2FnZSwgXywgY29ubmVjdGlvblBhcmFtcykgPT4gW1xuICAgICAgICB7XG4gICAgICAgICAgaWQ6IHBhcnNlSW50KChtZXNzYWdlIGFzIERYRmVlZE1lc3NhZ2UpWzBdLmlkKSArIDEsXG4gICAgICAgICAgY2hhbm5lbDogTUVUQV9DT05ORUNULFxuICAgICAgICAgIGNvbm5lY3Rpb25UeXBlOiAnd2Vic29ja2V0JyxcbiAgICAgICAgICBjbGllbnRJZDogY29ubmVjdGlvblBhcmFtcy5jbGllbnRJZCxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBoZWFydGJlYXRJbnRlcnZhbEluTVM6IDMwMDAwLFxuICAgICAgc2hvdWxkU2F2ZVRvU3RvcmU6IChzdWJzY3JpcHRpb25NZXNzYWdlOiBhbnkpID0+IGlzRGF0YVN1YnNjcmlwdGlvbk1zZyhzdWJzY3JpcHRpb25NZXNzYWdlKSxcbiAgICAgIGlzT25Db25uZWN0Q2hhaW5NZXNzYWdlOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT5cbiAgICAgICAgbWVzc2FnZVswXS5jaGFubmVsID09PSBNRVRBX0hBTkRTSEFLRSB8fCBtZXNzYWdlWzBdLmNoYW5uZWwgPT09IE1FVEFfQ09OTkVDVCxcbiAgICAgIGlzRGF0YU1lc3NhZ2U6IChtZXNzYWdlOiB1bmtub3duKSA9PiBpc0RhdGFTdWJzY3JpcHRpb25Nc2cobWVzc2FnZSksXG4gICAgICBvbkNvbm5lY3RDaGFpbjogW1xuICAgICAgICB7XG4gICAgICAgICAgcGF5bG9hZDogaGFuZHNoYWtlTXNnLFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgcGF5bG9hZDogZmlyc3RIZWFydGJlYXRNc2csXG4gICAgICAgICAgZmlsdGVyOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT4gbWVzc2FnZVswXS5pZCA9PSAnMicsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBwYXlsb2FkOiBoZWFydGJlYXRNc2csXG4gICAgICAgICAgZmlsdGVyOiAobWVzc2FnZTogRFhGZWVkTWVzc2FnZSkgPT5cbiAgICAgICAgICAgIG1lc3NhZ2VbMF0uaWQgPT09ICczJyB8fFxuICAgICAgICAgICAgKE9iamVjdC5rZXlzKG1lc3NhZ2VbMF0pLmxlbmd0aCA9PT0gMyAmJiBtZXNzYWdlWzBdLmNoYW5uZWwgPT09IE1FVEFfQ09OTkVDVCksXG4gICAgICAgICAgc2hvdWxkTmV2ZXJVbnN1YnNjcmliZTogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgfVxuICB9XG59XG4iXX0=