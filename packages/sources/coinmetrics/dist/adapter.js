"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.BAD_PARAMETER = exports.BAD_PARAMETERS = exports.makeExecute = exports.endpointSelector = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const endpoints = tslib_1.__importStar(require("./endpoint"));
const execute = async (request, context, config) => {
    return ea_bootstrap_1.Builder.buildSelector(request, context, config, endpoints);
};
exports.execute = execute;
const endpointSelector = (request) => ea_bootstrap_1.Builder.selectEndpoint(request, config_1.makeConfig(), endpoints);
exports.endpointSelector = endpointSelector;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
const getSubKeyInfo = (input) => {
    const validator = new ea_bootstrap_1.Validator(input, endpoints.price.inputParameters, {}, false);
    if (validator.error)
        throw validator.error;
    const asset = validator.validated.data.base.toLowerCase();
    const quote = validator.validated.data.quote.toUpperCase();
    if (quote !== 'USD' && quote !== 'EUR')
        throw new ea_bootstrap_1.AdapterError({
            jobRunID: input.id,
            statusCode: 400,
            message: 'Quote must be of type USD or EUR',
        });
    const metrics = `ReferenceRate${quote}`;
    return { asset, metrics };
};
exports.BAD_PARAMETERS = 'bad_parameters';
exports.BAD_PARAMETER = 'bad_parameter';
const makeWSHandler = (config) => {
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        return {
            connection: {
                url: defaultConfig.api.baseWsURL,
            },
            subscribe: (input) => {
                const { asset, metrics } = getSubKeyInfo(input);
                return `${asset}${metrics}`;
            },
            unsubscribe: () => '',
            subsFromMessage: (message) => {
                const metrics = Object.keys(message).find((key) => key.includes('ReferenceRate'));
                if (!metrics)
                    ea_bootstrap_1.Logger.debug(`Error: Could not find "ReferenceRate" key in WS message. ${message}`);
                return `${message.asset}${metrics}`;
            },
            isError: (message) => !!message.error,
            filter: () => true,
            toResponse: (message, input) => {
                const { metrics } = getSubKeyInfo(input);
                const result = ea_bootstrap_1.Requester.validateResultNumber(message, [metrics]);
                return ea_bootstrap_1.Requester.success('1', { data: { result } });
            },
            programmaticConnectionInfo: (input) => {
                const { asset, metrics } = getSubKeyInfo(input);
                const key = `${asset}${metrics}`;
                const url = `${defaultConfig.api.baseWsURL}/timeseries-stream/asset-metrics?assets=${asset}&metrics=${metrics}&frequency=1s&api_key=${defaultConfig.apiKey}`;
                return {
                    key,
                    url,
                };
            },
            shouldNotRetryConnection: (error) => {
                const wsError = error;
                return wsError.error.type === exports.BAD_PARAMETERS || wsError.error.type === exports.BAD_PARAMETER;
            },
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBNkY7QUFTN0YscUNBQXFDO0FBQ3JDLDhEQUF1QztBQUVoQyxNQUFNLE9BQU8sR0FBOEIsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDbkYsT0FBTyxzQkFBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQTtBQUNuRSxDQUFDLENBQUE7QUFGWSxRQUFBLE9BQU8sV0FFbkI7QUFFTSxNQUFNLGdCQUFnQixHQUFHLENBQUMsT0FBdUIsRUFBdUIsRUFBRSxDQUMvRSxzQkFBTyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsbUJBQVUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0FBRDdDLFFBQUEsZ0JBQWdCLG9CQUM2QjtBQUVuRCxNQUFNLFdBQVcsR0FBMkIsQ0FBQyxNQUFNLEVBQUUsRUFBRTtJQUM1RCxPQUFPLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxlQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLElBQUksbUJBQVUsRUFBRSxDQUFDLENBQUE7QUFDdEYsQ0FBQyxDQUFBO0FBRlksUUFBQSxXQUFXLGVBRXZCO0FBVUQsTUFBTSxhQUFhLEdBQUcsQ0FBQyxLQUFxQixFQUFFLEVBQUU7SUFDOUMsTUFBTSxTQUFTLEdBQUcsSUFBSSx3QkFBUyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDLGVBQWUsRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDbEYsSUFBSSxTQUFTLENBQUMsS0FBSztRQUFFLE1BQU0sU0FBUyxDQUFDLEtBQUssQ0FBQTtJQUMxQyxNQUFNLEtBQUssR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUks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O1lBQ0gsQ0FBQztZQUNELHdCQUF3QixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQ2xDLE1BQU0sT0FBTyxHQUFHLEtBQWdCLENBQUE7Z0JBQ2hDLE9BQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssc0JBQWMsSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxxQkFBYSxDQUFBO1lBQ3RGLENBQUM7U0FDRixDQUFBO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBeENZLFFBQUEsYUFBYSxpQkF3Q3pCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWRhcHRlckVycm9yLCBCdWlsZGVyLCBSZXF1ZXN0ZXIsIFZhbGlkYXRvciwgTG9nZ2VyIH0gZnJvbSAnQGNoYWlubGluay9lYS1ib290c3RyYXAnXG5pbXBvcnQge1xuICBDb25maWcsXG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBFeGVjdXRlRmFjdG9yeSxcbiAgTWFrZVdTSGFuZGxlcixcbiAgQWRhcHRlclJlcXVlc3QsXG4gIEFQSUVuZHBvaW50LFxufSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuaW1wb3J0IHsgbWFrZUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuaW1wb3J0ICogYXMgZW5kcG9pbnRzIGZyb20gJy4vZW5kcG9pbnQnXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICByZXR1cm4gQnVpbGRlci5idWlsZFNlbGVjdG9yKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZywgZW5kcG9pbnRzKVxufVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRTZWxlY3RvciA9IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCk6IEFQSUVuZHBvaW50PENvbmZpZz4gPT5cbiAgQnVpbGRlci5zZWxlY3RFbmRwb2ludChyZXF1ZXN0LCBtYWtlQ29uZmlnKCksIGVuZHBvaW50cylcblxuZXhwb3J0IGNvbnN0IG1ha2VFeGVjdXRlOiBFeGVjdXRlRmFjdG9yeTxDb25maWc+ID0gKGNvbmZpZykgPT4ge1xuICByZXR1cm4gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQpID0+IGV4ZWN1dGUocmVxdWVzdCwgY29udGV4dCwgY29uZmlnIHx8IG1ha2VDb25maWcoKSlcbn1cblxuZXhwb3J0IGludGVyZmFjZSBXZWJzb2NrZXRSZXNwb25zZVNjaGVtYSB7XG4gIHRpbWU6IHN0cmluZ1xuICBhc3NldDogc3RyaW5nXG4gIFJlZmVyZW5jZVJhdGVVU0Q/OiBzdHJpbmdcbiAgUmVmZXJlbmNlUmF0ZUVVUj86IHN0cmluZ1xuICBjbV9zZXF1ZW5jZV9pZDogc3RyaW5nXG59XG5cbmNvbnN0IGdldFN1YktleUluZm8gPSAoaW5wdXQ6IEFkYXB0ZXJSZXF1ZXN0KSA9PiB7XG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGVuZHBvaW50cy5wcmljZS5pbnB1dFBhcmFtZXRlcnMsIHt9LCBmYWxzZSlcbiAgaWYgKHZhbGlkYXRvci5lcnJvcikgdGhyb3cgdmFsaWRhdG9yLmVycm9yXG4gIGNvbnN0IGFzc2V0ID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmJhc2UudG9Mb3dlckNhc2UoKVxuICBjb25zdCBxdW90ZSA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5xdW90ZS50b1VwcGVyQ2FzZSgpXG4gIGlmIChxdW90ZSAhPT0gJ1VTRCcgJiYgcXVvdGUgIT09ICdFVVInKVxuICAgIHRocm93IG5ldyBBZGFwdGVyRXJyb3Ioe1xuICAgICAgam9iUnVuSUQ6IGlucHV0LmlkLFxuICAgICAgc3RhdHVzQ29kZTogNDAwLFxuICAgICAgbWVzc2FnZTogJ1F1b3RlIG11c3QgYmUgb2YgdHlwZSBVU0Qgb3IgRVVSJyxcbiAgICB9KVxuICBjb25zdCBtZXRyaWNzID0gYFJlZmVyZW5jZVJhdGUke3F1b3RlfWBcbiAgcmV0dXJuIHsgYXNzZXQsIG1ldHJpY3MgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFdTRXJyb3Ige1xuICBlcnJvcjoge1xuICAgIHR5cGU6IHN0cmluZ1xuICAgIG1lc3NhZ2U6IHN0cmluZ1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBCQURfUEFSQU1FVEVSUyA9ICdiYWRfcGFyYW1ldGVycydcbmV4cG9ydCBjb25zdCBCQURfUEFSQU1FVEVSID0gJ2JhZF9wYXJhbWV0ZXInXG5cbmV4cG9ydCBjb25zdCBtYWtlV1NIYW5kbGVyID0gKGNvbmZpZz86IENvbmZpZyk6IE1ha2VXU0hhbmRsZXIgPT4ge1xuICByZXR1cm4gKCkgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPSBjb25maWcgfHwgbWFrZUNvbmZpZygpXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgdXJsOiBkZWZhdWx0Q29uZmlnLmFwaS5iYXNlV3NVUkwsXG4gICAgICB9LFxuICAgICAgc3Vic2NyaWJlOiAoaW5wdXQpID0+IHtcbiAgICAgICAgY29uc3QgeyBhc3NldCwgbWV0cmljcyB9ID0gZ2V0U3ViS2V5SW5mbyhpbnB1dClcbiAgICAgICAgcmV0dXJuIGAke2Fzc2V0fSR7bWV0cmljc31gXG4gICAgICB9LFxuICAgICAgdW5zdWJzY3JpYmU6ICgpID0+ICcnLFxuICAgICAgc3Vic0Zyb21NZXNzYWdlOiAobWVzc2FnZSkgPT4ge1xuICAgICAgICBjb25zdCBtZXRyaWNzID0gT2JqZWN0LmtleXMobWVzc2FnZSkuZmluZCgoa2V5KSA9PiBrZXkuaW5jbHVkZXMoJ1JlZmVyZW5jZVJhdGUnKSlcbiAgICAgICAgaWYgKCFtZXRyaWNzKVxuICAgICAgICAgIExvZ2dlci5kZWJ1ZyhgRXJyb3I6IENvdWxkIG5vdCBmaW5kIFwiUmVmZXJlbmNlUmF0ZVwiIGtleSBpbiBXUyBtZXNzYWdlLiAke21lc3NhZ2V9YClcbiAgICAgICAgcmV0dXJuIGAke21lc3NhZ2UuYXNzZXR9JHttZXRyaWNzfWBcbiAgICAgIH0sXG4gICAgICBpc0Vycm9yOiAobWVzc2FnZSkgPT4gISFtZXNzYWdlLmVycm9yLFxuICAgICAgZmlsdGVyOiAoKSA9PiB0cnVlLFxuICAgICAgdG9SZXNwb25zZTogKG1lc3NhZ2U6IFdlYnNvY2tldFJlc3BvbnNlU2NoZW1hLCBpbnB1dCkgPT4ge1xuICAgICAgICBjb25zdCB7IG1ldHJpY3MgfSA9IGdldFN1YktleUluZm8oaW5wdXQpXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFJlcXVlc3Rlci52YWxpZGF0ZVJlc3VsdE51bWJlcihtZXNzYWdlLCBbbWV0cmljc10pXG4gICAgICAgIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2VzcygnMScsIHsgZGF0YTogeyByZXN1bHQgfSB9KVxuICAgICAgfSxcbiAgICAgIHByb2dyYW1tYXRpY0Nvbm5lY3Rpb25JbmZvOiAoaW5wdXQpID0+IHtcbiAgICAgICAgY29uc3QgeyBhc3NldCwgbWV0cmljcyB9ID0gZ2V0U3ViS2V5SW5mbyhpbnB1dClcbiAgICAgICAgY29uc3Qga2V5ID0gYCR7YXNzZXR9JHttZXRyaWNzfWBcbiAgICAgICAgY29uc3QgdXJsID0gYCR7ZGVmYXVsdENvbmZpZy5hcGkuYmFzZVdzVVJMfS90aW1lc2VyaWVzLXN0cmVhbS9hc3NldC1tZXRyaWNzP2Fzc2V0cz0ke2Fzc2V0fSZtZXRyaWNzPSR7bWV0cmljc30mZnJlcXVlbmN5PTFzJmFwaV9rZXk9JHtkZWZhdWx0Q29uZmlnLmFwaUtleX1gXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAga2V5LFxuICAgICAgICAgIHVybCxcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICAgIHNob3VsZE5vdFJldHJ5Q29ubmVjdGlvbjogKGVycm9yKSA9PiB7XG4gICAgICAgIGNvbnN0IHdzRXJyb3IgPSBlcnJvciBhcyBXU0Vycm9yXG4gICAgICAgIHJldHVybiB3c0Vycm9yLmVycm9yLnR5cGUgPT09IEJBRF9QQVJBTUVURVJTIHx8IHdzRXJyb3IuZXJyb3IudHlwZSA9PT0gQkFEX1BBUkFNRVRFUlxuICAgICAgfSxcbiAgICB9XG4gIH1cbn1cbiJdfQ==