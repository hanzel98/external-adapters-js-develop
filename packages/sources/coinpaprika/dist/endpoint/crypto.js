"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.inputParameters = exports.endpointResultPaths = exports.batchablePropertyPath = exports.supportedEndpoints = void 0;
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("../config");
const util_1 = require("../util");
exports.supportedEndpoints = ['crypto', 'price', 'marketcap', 'volume'];
exports.batchablePropertyPath = [{ name: 'base' }, { name: 'quote' }];
exports.endpointResultPaths = {
    crypto: 'price',
    marketcap: 'market_cap',
    price: 'price',
    volume: 'volume_24h',
};
exports.inputParameters = {
    base: ['base', 'from', 'coin'],
    quote: ['quote', 'to', 'market'],
    coinid: false,
    resultPath: false,
};
const handleBatchedRequest = (jobRunID, request, response, requestedData, resultPath) => {
    const responseData = response.data;
    const payload = [];
    requestedData.forEach(({ coinid, symbol }) => {
        const coin = util_1.getCoin(responseData, symbol, coinid);
        if (!coin) {
            throw new Error(`unable to find coin: ${coinid || symbol}`);
        }
        for (const quote in coin.quotes) {
            payload.push([
                {
                    ...request,
                    data: {
                        ...request.data,
                        base: coin.symbol.toUpperCase(),
                        quote: quote.toUpperCase(),
                    },
                },
                ea_bootstrap_1.Requester.validateResultNumber(coin, ['quotes', quote, resultPath]),
            ]);
        }
    });
    // We'll reset the response data to not output the entire CP coins list
    const result = ea_bootstrap_1.Requester.withResult({ ...response, data: {} }, undefined, payload);
    return ea_bootstrap_1.Requester.success(jobRunID, result, true, exports.batchablePropertyPath);
};
const execute = async (request, _, config) => {
    const validator = new ea_bootstrap_1.Validator(request, exports.inputParameters);
    if (validator.error)
        throw validator.error;
    const jobRunID = validator.validated.id;
    const symbol = validator.overrideSymbol(config_1.NAME);
    const requestedQuotes = validator.validated.data.quote;
    const coinid = validator.validated.data.coinid;
    const url = 'v1/tickers';
    const resultPath = validator.validated.data.resultPath || exports.endpointResultPaths.crypto;
    let quotes;
    if (Array.isArray(requestedQuotes)) {
        quotes = requestedQuotes.map((quote) => quote.toUpperCase()).join(',');
    }
    else {
        quotes = requestedQuotes.toUpperCase();
    }
    const params = { quotes };
    const options = {
        ...config.api,
        url,
        params,
    };
    if (Array.isArray(symbol)) {
        const requestedData = [];
        for (let i = 0; i < symbol.length; i++) {
            if (symbol[i] !== validator.validated.data.base[i]) {
                requestedData.push({ coinid: symbol[i] });
            }
            else {
                requestedData.push({ symbol: symbol[i] });
            }
        }
        const response = await ea_bootstrap_1.Requester.request(options);
        return handleBatchedRequest(jobRunID, request, response, requestedData, resultPath);
    }
    // If coinid was provided or base was overridden, that symbol will be fetched
    const coin = coinid || (symbol !== validator.validated.data.base && symbol ? symbol : undefined);
    const response = await ea_bootstrap_1.Requester.request(options);
    const coinData = util_1.getCoin(response.data, symbol, coin);
    if (!coinData) {
        throw new Error(`unable to find coin: ${coin || symbol}`);
    }
    const result = ea_bootstrap_1.Requester.validateResultNumber(coinData, [
        'quotes',
        requestedQuotes.toUpperCase(),
        resultPath,
    ]);
    return ea_bootstrap_1.Requester.success(jobRunID, ea_bootstrap_1.Requester.withResult(response, result), config.verbose, exports.batchablePropertyPath);
};
exports.execute = execute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2NyeXB0by50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwwREFBOEQ7QUFROUQsc0NBQStDO0FBQy9DLGtDQUFpQztBQUVwQixRQUFBLGtCQUFrQixHQUFHLENBQUMsUUFBUSxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsUUFBUSxDQUFDLENBQUE7QUFDL0QsUUFBQSxxQkFBcUIsR0FBRyxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUE7QUFvQzdELFFBQUEsbUJBQW1CLEdBQUc7SUFDakMsTUFBTSxFQUFFLE9BQU87SUFDZixTQUFTLEVBQUUsWUFBWTtJQUN2QixLQUFLLEVBQUUsT0FBTztJQUNkLE1BQU0sRUFBRSxZQUFZO0NBQ3JCLENBQUE7QUFFWSxRQUFBLGVBQWUsR0FBb0I7SUFDOUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUM7SUFDOUIsS0FBSyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUM7SUFDaEMsTUFBTSxFQUFFLEtBQUs7SUFDYixVQUFVLEVBQUUsS0FBSztDQUNsQixDQUFBO0FBT0QsTUFBTSxvQkFBb0IsR0FBRyxDQUMzQixRQUFnQixFQUNoQixPQUF1QixFQUN2QixRQUF1QixFQUN2QixhQUE4QixFQUM5QixVQUFrQixFQUNsQixFQUFFO0lBQ0YsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLElBQXdCLENBQUE7SUFDdEQsTUFBTSxPQUFPLEdBQStCLEVBQUUsQ0FBQTtJQUU5QyxhQUFhLENBQUMsT0FBTyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUUsRUFBRTtRQUMzQyxNQUFNLElBQUksR0FBRyxjQUFPLENBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFN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RUFBRSxNQUFNLENBQUMsRUFDdEMsTUFBTSxDQUFDLE9BQU8sRUFDZCw2QkFBcUIsQ0FDdEIsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQTlEWSxRQUFBLE9BQU8sV0E4RG5CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdGVyLCBWYWxpZGF0b3IgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7XG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBDb25maWcsXG4gIEFkYXB0ZXJSZXF1ZXN0LFxuICBJbnB1dFBhcmFtZXRlcnMsXG4gIEF4aW9zUmVzcG9uc2UsXG59IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBOQU1FIGFzIEFkYXB0ZXJOYW1lIH0gZnJvbSAnLi4vY29uZmlnJ1xuaW1wb3J0IHsgZ2V0Q29pbiB9IGZyb20gJy4uL3V0aWwnXG5cbmV4cG9ydCBjb25zdCBzdXBwb3J0ZWRFbmRwb2ludHMgPSBbJ2NyeXB0bycsICdwcmljZScsICdtYXJrZXRjYXAnLCAndm9sdW1lJ11cbmV4cG9ydCBjb25zdCBiYXRjaGFibGVQcm9wZXJ0eVBhdGggPSBbeyBuYW1lOiAnYmFzZScgfSwgeyBuYW1lOiAncXVvdGUnIH1dXG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzcG9uc2VTY2hlbWEge1xuICBpZDogc3RyaW5nXG4gIG5hbWU6IHN0cmluZ1xuICBzeW1ib2w6IHN0cmluZ1xuICByYW5rOiBudW1iZXJcbiAgY2lyY3VsYXRpbmdfc3VwcGx5OiBudW1iZXJcbiAgdG90YWxfc3VwcGx5OiBudW1iZXJcbiAgbWF4X3N1cHBseTogbnVtYmVyXG4gIGJldGFfdmFsdWU6IG51bWJlclxuICBmaXJzdF9kYXRhX2F0OiBzdHJpbmdcbiAgbGFzdF91cGRhdGVkOiBzdHJpbmdcbiAgcXVvdGVzOiB7XG4gICAgW3F1b3RlOiBzdHJpbmddOiB7XG4gICAgICBwcmljZTogbnVtYmVyXG4gICAgICB2b2x1bWVfMjRoOiBudW1iZXJcbiAgICAgIHZvbHVtZV8yNGhfY2hhbmdlXzI0aDogbnVtYmVyXG4gICAgICBtYXJrZXRfY2FwOiBudW1iZXJcbiAgICAgIG1hcmtldF9jYXBfY2hhbmdlXzI0aDogbnVtYmVyXG4gICAgICBwZXJjZW50X2NoYW5nZV8xNW06IG51bWJlclxuICAgICAgcGVyY2VudF9jaGFuZ2VfMzBtOiBudW1iZXJcbiAgICAgIHBlcmNlbnRfY2hhbmdlXzFoOiBudW1iZXJcbiAgICAgIHBlcmNlbnRfY2hhbmdlXzZoOiBudW1iZXJcbiAgICAgIHBlcmNlbnRfY2hhbmdlXzEyaDogbnVtYmVyXG4gICAgICBwZXJjZW50X2NoYW5nZV8yNGg6IG51bWJlclxuICAgICAgcGVyY2VudF9jaGFuZ2VfN2Q6IG51bWJlclxuICAgICAgcGVyY2VudF9jaGFuZ2VfMzBkOiBudW1iZXJcbiAgICAgIHBlcmNlbnRfY2hhbmdlXzF5OiBudW1iZXJcbiAgICAgIGF0aF9wcmljZTogbnVtYmVyXG4gICAgICBhdGhfZGF0ZTogc3RyaW5nXG4gICAgICBwZXJjZW50X2Zyb21fcHJpY2VfYXRoOiBudW1iZXJcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGVuZHBvaW50UmVzdWx0UGF0aHMgPSB7XG4gIGNyeXB0bzogJ3ByaWNlJyxcbiAgbWFya2V0Y2FwOiAnbWFya2V0X2NhcCcsXG4gIHByaWNlOiAncHJpY2UnLFxuICB2b2x1bWU6ICd2b2x1bWVfMjRoJyxcbn1cblxuZXhwb3J0IGNvbnN0IGlucHV0UGFyYW1ldGVyczogSW5wdXRQYXJhbWV0ZXJzID0ge1xuICBiYXNlOiBbJ2Jhc2UnLCAnZnJvbScsICdjb2luJ10sXG4gIHF1b3RlOiBbJ3F1b3RlJywgJ3RvJywgJ21hcmtldCddLFxuICBjb2luaWQ6IGZhbHNlLFxuICByZXN1bHRQYXRoOiBmYWxzZSxcbn1cblxuaW50ZXJmYWNlIFJlcXVlc3RlZERhdGEge1xuICBzeW1ib2w/OiBzdHJpbmdcbiAgY29pbmlkPzogc3RyaW5nXG59XG5cbmNvbnN0IGhhbmRsZUJhdGNoZWRSZXF1ZXN0ID0gKFxuICBqb2JSdW5JRDogc3RyaW5nLFxuICByZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCxcbiAgcmVzcG9uc2U6IEF4aW9zUmVzcG9uc2UsXG4gIHJlcXVlc3RlZERhdGE6IFJlcXVlc3RlZERhdGFbXSxcbiAgcmVzdWx0UGF0aDogc3RyaW5nLFxuKSA9PiB7XG4gIGNvbnN0IHJlc3BvbnNlRGF0YSA9IHJlc3BvbnNlLmRhdGEgYXMgUmVzcG9uc2VTY2hlbWFbXVxuICBjb25zdCBwYXlsb2FkOiBbQWRhcHRlclJlcXVlc3QsIG51bWJlcl1bXSA9IFtdXG5cbiAgcmVxdWVzdGVkRGF0YS5mb3JFYWNoKCh7IGNvaW5pZCwgc3ltYm9sIH0pID0+IHtcbiAgICBjb25zdCBjb2luID0gZ2V0Q29pbihyZXNwb25zZURhdGEsIHN5bWJvbCwgY29pbmlkKVxuICAgIGlmICghY29pbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gZmluZCBjb2luOiAke2NvaW5pZCB8fCBzeW1ib2x9YClcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IHF1b3RlIGluIGNvaW4ucXVvdGVzKSB7XG4gICAgICBwYXlsb2FkLnB1c2goW1xuICAgICAgICB7XG4gICAgICAgICAgLi4ucmVxdWVzdCxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAuLi5yZXF1ZXN0LmRhdGEsXG4gICAgICAgICAgICBiYXNlOiBjb2luLnN5bWJvbC50b1VwcGVyQ2FzZSgpLFxuICAgICAgICAgICAgcXVvdGU6IHF1b3RlLnRvVXBwZXJDYXNlKCksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgUmVxdWVzdGVyLnZhbGlkYXRlUmVzdWx0TnVtYmVyKGNvaW4sIFsncXVvdGVzJywgcXVvdGUsIHJlc3VsdFBhdGhdKSxcbiAgICAgIF0pXG4gICAgfVxuICB9KVxuXG4gIC8vIFdlJ2xsIHJlc2V0IHRoZSByZXNwb25zZSBkYXRhIHRvIG5vdCBvdXRwdXQgdGhlIGVudGlyZSBDUCBjb2lucyBsaXN0XG4gIGNvbnN0IHJlc3VsdCA9IFJlcXVlc3Rlci53aXRoUmVzdWx0KHsgLi4ucmVzcG9uc2UsIGRhdGE6IHt9IH0sIHVuZGVmaW5lZCwgcGF5bG9hZClcbiAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKGpvYlJ1bklELCByZXN1bHQsIHRydWUsIGJhdGNoYWJsZVByb3BlcnR5UGF0aClcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGU6IEV4ZWN1dGVXaXRoQ29uZmlnPENvbmZpZz4gPSBhc3luYyAocmVxdWVzdCwgXywgY29uZmlnKSA9PiB7XG4gIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IocmVxdWVzdCwgaW5wdXRQYXJhbWV0ZXJzKVxuICBpZiAodmFsaWRhdG9yLmVycm9yKSB0aHJvdyB2YWxpZGF0b3IuZXJyb3JcblxuICBjb25zdCBqb2JSdW5JRCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuaWRcbiAgY29uc3Qgc3ltYm9sID0gdmFsaWRhdG9yLm92ZXJyaWRlU3ltYm9sKEFkYXB0ZXJOYW1lKVxuICBjb25zdCByZXF1ZXN0ZWRRdW90ZXMgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEucXVvdGVcbiAgY29uc3QgY29pbmlkID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmNvaW5pZCBhcyBzdHJpbmcgfCB1bmRlZmluZWRcblxuICBjb25zdCB1cmwgPSAndjEvdGlja2VycydcbiAgY29uc3QgcmVzdWx0UGF0aCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5yZXN1bHRQYXRoIHx8IGVuZHBvaW50UmVzdWx0UGF0aHMuY3J5cHRvXG5cbiAgbGV0IHF1b3Rlczogc3RyaW5nXG4gIGlmIChBcnJheS5pc0FycmF5KHJlcXVlc3RlZFF1b3RlcykpIHtcbiAgICBxdW90ZXMgPSByZXF1ZXN0ZWRRdW90ZXMubWFwKChxdW90ZSkgPT4gcXVvdGUudG9VcHBlckNhc2UoKSkuam9pbignLCcpXG4gIH0gZWxzZSB7XG4gICAgcXVvdGVzID0gcmVxdWVzdGVkUXVvdGVzLnRvVXBwZXJDYXNlKClcbiAgfVxuXG4gIGNvbnN0IHBhcmFtcyA9IHsgcXVvdGVzIH1cbiAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAuLi5jb25maWcuYXBpLFxuICAgIHVybCxcbiAgICBwYXJhbXMsXG4gIH1cblxuICBpZiAoQXJyYXkuaXNBcnJheShzeW1ib2wpKSB7XG4gICAgY29uc3QgcmVxdWVzdGVkRGF0YTogUmVxdWVzdGVkRGF0YVtdID0gW11cblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc3ltYm9sLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoc3ltYm9sW2ldICE9PSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuYmFzZVtpXSkge1xuICAgICAgICByZXF1ZXN0ZWREYXRhLnB1c2goeyBjb2luaWQ6IHN5bWJvbFtpXSB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVxdWVzdGVkRGF0YS5wdXNoKHsgc3ltYm9sOiBzeW1ib2xbaV0gfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IFJlcXVlc3Rlci5yZXF1ZXN0PFJlc3BvbnNlU2NoZW1hW10+KG9wdGlvbnMpXG4gICAgcmV0dXJuIGhhbmRsZUJhdGNoZWRSZXF1ZXN0KGpvYlJ1bklELCByZXF1ZXN0LCByZXNwb25zZSwgcmVxdWVzdGVkRGF0YSwgcmVzdWx0UGF0aClcbiAgfVxuXG4gIC8vIElmIGNvaW5pZCB3YXMgcHJvdmlkZWQgb3IgYmFzZSB3YXMgb3ZlcnJpZGRlbiwgdGhhdCBzeW1ib2wgd2lsbCBiZSBmZXRjaGVkXG4gIGNvbnN0IGNvaW4gPSBjb2luaWQgfHwgKHN5bWJvbCAhPT0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLmJhc2UgJiYgc3ltYm9sID8gc3ltYm9sIDogdW5kZWZpbmVkKVxuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgUmVxdWVzdGVyLnJlcXVlc3Q8UmVzcG9uc2VTY2hlbWFbXT4ob3B0aW9ucylcblxuICBjb25zdCBjb2luRGF0YSA9IGdldENvaW4ocmVzcG9uc2UuZGF0YSwgc3ltYm9sLCBjb2luKVxuICBpZiAoIWNvaW5EYXRhKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGB1bmFibGUgdG8gZmluZCBjb2luOiAke2NvaW4gfHwgc3ltYm9sfWApXG4gIH1cblxuICBjb25zdCByZXN1bHQgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIoY29pbkRhdGEsIFtcbiAgICAncXVvdGVzJyxcbiAgICByZXF1ZXN0ZWRRdW90ZXMudG9VcHBlckNhc2UoKSxcbiAgICByZXN1bHRQYXRoLFxuICBdKVxuICByZXR1cm4gUmVxdWVzdGVyLnN1Y2Nlc3MoXG4gICAgam9iUnVuSUQsXG4gICAgUmVxdWVzdGVyLndpdGhSZXN1bHQocmVzcG9uc2UsIHJlc3VsdCksXG4gICAgY29uZmlnLnZlcmJvc2UsXG4gICAgYmF0Y2hhYmxlUHJvcGVydHlQYXRoLFxuICApXG59XG4iXX0=