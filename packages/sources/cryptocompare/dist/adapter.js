"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.INVALID_SUB = exports.makeExecute = exports.endpointSelector = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const endpoint_1 = require("./endpoint");
const endpoints = tslib_1.__importStar(require("./endpoint"));
const execute = async (request, context, config) => {
    return ea_bootstrap_1.Builder.buildSelector(request, context, config, endpoints);
};
exports.execute = execute;
const endpointSelector = (request) => ea_bootstrap_1.Builder.selectEndpoint(request, config_1.makeConfig(), endpoints);
exports.endpointSelector = endpointSelector;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
exports.INVALID_SUB = 'INVALID_SUB';
const makeWSHandler = (config) => {
    // https://min-api.cryptocompare.com/documentation/websockets
    const subscriptions = {
        trade: 0,
        ticker: 2,
        aggregate: 5,
    };
    const getPair = (input) => {
        const validator = new ea_bootstrap_1.Validator(input, { endpoint: false, ...endpoint_1.crypto.inputParameters }, {}, false);
        if (validator.error)
            return false;
        const endpoint = validator.validated.data.endpoint?.toLowerCase();
        if (endpoint == 'marketcap')
            return false;
        const base = validator.overrideSymbol(config_1.NAME);
        const quote = validator.validated.data.quote.toUpperCase();
        return `${base}~${quote}`;
    };
    const getSubscription = (action, pair) => {
        if (!pair)
            return false;
        return { action, subs: [`${subscriptions.aggregate}~CCCAGG~${pair}`] };
    };
    const withApiKey = (url, apiKey) => `${url}?api_key=${apiKey}`;
    const shouldNotRetryAfterError = (error) => {
        return error.MESSAGE === exports.INVALID_SUB;
    };
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        return {
            connection: {
                url: withApiKey(defaultConfig.api.baseWsURL || config_1.DEFAULT_WS_API_ENDPOINT, defaultConfig.apiKey || ''),
                protocol: { query: { api_key: defaultConfig.apiKey } },
            },
            subscribe: (input) => getSubscription('SubAdd', getPair(input)),
            unsubscribe: (input) => getSubscription('SubRemove', getPair(input)),
            subsFromMessage: (message) => getSubscription('SubAdd', `${message?.FROMSYMBOL}~${message?.TOSYMBOL}`),
            isError: (message) => Number(message.TYPE) > 400 && Number(message.TYPE) < 900,
            filter: (message) => {
                // Ignore everything is not from the wanted channels
                const code = Number(message.TYPE);
                const flag = Number(message.FLAGS); // flags = 4 (means price unchanged, PRICE parameter not included)
                return (code === subscriptions.ticker || code === subscriptions.aggregate) && flag !== 4;
            },
            toResponse: (message) => {
                const result = ea_bootstrap_1.Requester.validateResultNumber(message, ['PRICE']);
                return ea_bootstrap_1.Requester.success('1', { data: { result } });
            },
            shouldNotRetrySubscription: (error) => shouldNotRetryAfterError(error),
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBdUU7QUFTdkUscUNBQW9FO0FBQ3BFLHlDQUFtQztBQUNuQyw4REFBdUM7QUFFaEMsTUFBTSxPQUFPLEdBQThCLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO0lBQ25GLE9BQU8sc0JBQU8sQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLENBQUE7QUFDbkUsQ0FBQyxDQUFBO0FBRlksUUFBQSxPQUFPLFdBRW5CO0FBRU0sTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLE9BQXVCLEVBQWUsRUFBRSxDQUN2RSxzQkFBTyxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsbUJBQVUsRUFBRSxFQUFFLFNBQVMsQ0FBQyxDQUFBO0FBRDdDLFFBQUEsZ0JBQWdCLG9CQUM2QjtBQUVuRCxNQUFNLFdBQVcsR0FBMkIsQ0FBQyxNQUFNLEVBQUUsRUFBRTtJQUM1RCxPQUFPLEtBQUssRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEVBQUUsQ0FBQyxlQUFPLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLElBQUksbUJBQVUsRUFBRSxDQUFDLENBQUE7QUFDdEYsQ0FBQyxDQUFBO0FBRlksUUFBQSxXQUFXLGVBRXZCO0FBU1ksUUFBQSxXQUFXLEdBQUcsYUFBYSxDQUFBO0FBRWpDLE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBZSxFQUFpQixFQUFFO0lBQzlELDZEQUE2RDtJQUM3RCxNQUFNLGFBQWEsR0FBRztRQUNwQixLQUFLLEVBQUUsQ0FBQztRQUNSLE1BQU0sRUFBRSxDQUFDO1FBQ1QsU0FBUyxFQUFFLENBQUM7S0FDYixDQUFBO0lBQ0QsTUFBTSxPQUFPLEdBQUcsQ0FBQyxLQUFxQixFQUFFLEVBQUU7UUFDeEMsTUFBTSxTQUFT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QUFLLENBQUMsQ0FBQTtZQUMxRixDQUFDO1lBQ0QsVUFBVSxFQUFFLENBQUMsT0FBWSxFQUFFLEVBQUU7Z0JBQzNCLE1BQU0sTUFBTSxHQUFHLHdCQUFTLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtnQkFDakUsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUE7WUFDckQsQ0FBQztZQUNELDBCQUEwQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyx3QkFBd0IsQ0FBQyxLQUFvQixDQUFDO1NBQ3RGLENBQUE7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUE7QUF6RFksUUFBQSxhQUFhLGlCQXlEekIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCdWlsZGVyLCBSZXF1ZXN0ZXIsIFZhbGlkYXRvciB9IGZyb20gJ0BjaGFpbmxpbmsvZWEtYm9vdHN0cmFwJ1xuaW1wb3J0IHtcbiAgQWRhcHRlclJlcXVlc3QsXG4gIENvbmZpZyxcbiAgRXhlY3V0ZUZhY3RvcnksXG4gIEV4ZWN1dGVXaXRoQ29uZmlnLFxuICBNYWtlV1NIYW5kbGVyLFxuICBBUElFbmRwb2ludCxcbn0gZnJvbSAnQGNoYWlubGluay90eXBlcydcbmltcG9ydCB7IERFRkFVTFRfV1NfQVBJX0VORFBPSU5ULCBtYWtlQ29uZmlnLCBOQU1FIH0gZnJvbSAnLi9jb25maWcnXG5pbXBvcnQgeyBjcnlwdG8gfSBmcm9tICcuL2VuZHBvaW50J1xuaW1wb3J0ICogYXMgZW5kcG9pbnRzIGZyb20gJy4vZW5kcG9pbnQnXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICByZXR1cm4gQnVpbGRlci5idWlsZFNlbGVjdG9yKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZywgZW5kcG9pbnRzKVxufVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRTZWxlY3RvciA9IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCk6IEFQSUVuZHBvaW50ID0+XG4gIEJ1aWxkZXIuc2VsZWN0RW5kcG9pbnQocmVxdWVzdCwgbWFrZUNvbmZpZygpLCBlbmRwb2ludHMpXG5cbmV4cG9ydCBjb25zdCBtYWtlRXhlY3V0ZTogRXhlY3V0ZUZhY3Rvcnk8Q29uZmlnPiA9IChjb25maWcpID0+IHtcbiAgcmV0dXJuIGFzeW5jIChyZXF1ZXN0LCBjb250ZXh0KSA9PiBleGVjdXRlKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZyB8fCBtYWtlQ29uZmlnKCkpXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgV1NFcnJvclR5cGUge1xuICBUWVBFOiBzdHJpbmdcbiAgTUVTU0FHRTogc3RyaW5nXG4gIFBBUkFNRVRFUjogc3RyaW5nXG4gIElORk86IHN0cmluZ1xufVxuXG5leHBvcnQgY29uc3QgSU5WQUxJRF9TVUIgPSAnSU5WQUxJRF9TVUInXG5cbmV4cG9ydCBjb25zdCBtYWtlV1NIYW5kbGVyID0gKGNvbmZpZz86IENvbmZpZyk6IE1ha2VXU0hhbmRsZXIgPT4ge1xuICAvLyBodHRwczovL21pbi1hcGkuY3J5cHRvY29tcGFyZS5jb20vZG9jdW1lbnRhdGlvbi93ZWJzb2NrZXRzXG4gIGNvbnN0IHN1YnNjcmlwdGlvbnMgPSB7XG4gICAgdHJhZGU6IDAsXG4gICAgdGlja2VyOiAyLFxuICAgIGFnZ3JlZ2F0ZTogNSxcbiAgfVxuICBjb25zdCBnZXRQYWlyID0gKGlucHV0OiBBZGFwdGVyUmVxdWVzdCkgPT4ge1xuICAgIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoXG4gICAgICBpbnB1dCxcbiAgICAgIHsgZW5kcG9pbnQ6IGZhbHNlLCAuLi5jcnlwdG8uaW5wdXRQYXJhbWV0ZXJzIH0sXG4gICAgICB7fSxcbiAgICAgIGZhbHNlLFxuICAgIClcbiAgICBpZiAodmFsaWRhdG9yLmVycm9yKSByZXR1cm4gZmFsc2VcbiAgICBjb25zdCBlbmRwb2ludCA9IHZhbGlkYXRvci52YWxpZGF0ZWQuZGF0YS5lbmRwb2ludD8udG9Mb3dlckNhc2UoKVxuICAgIGlmIChlbmRwb2ludCA9PSAnbWFya2V0Y2FwJykgcmV0dXJuIGZhbHNlXG4gICAgY29uc3QgYmFzZSA9IHZhbGlkYXRvci5vdmVycmlkZVN5bWJvbChOQU1FKVxuICAgIGNvbnN0IHF1b3RlID0gdmFsaWRhdG9yLnZhbGlkYXRlZC5kYXRhLnF1b3RlLnRvVXBwZXJDYXNlKClcbiAgICByZXR1cm4gYCR7YmFzZX1+JHtxdW90ZX1gXG4gIH1cbiAgY29uc3QgZ2V0U3Vic2NyaXB0aW9uID0gKGFjdGlvbjogJ1N1YkFkZCcgfCAnU3ViUmVtb3ZlJywgcGFpcj86IHN0cmluZyB8IGJvb2xlYW4pID0+IHtcbiAgICBpZiAoIXBhaXIpIHJldHVybiBmYWxzZVxuICAgIHJldHVybiB7IGFjdGlvbiwgc3ViczogW2Ake3N1YnNjcmlwdGlvbnMuYWdncmVnYXRlfX5DQ0NBR0d+JHtwYWlyfWBdIH1cbiAgfVxuICBjb25zdCB3aXRoQXBpS2V5ID0gKHVybDogc3RyaW5nLCBhcGlLZXk6IHN0cmluZykgPT4gYCR7dXJsfT9hcGlfa2V5PSR7YXBpS2V5fWBcbiAgY29uc3Qgc2hvdWxkTm90UmV0cnlBZnRlckVycm9yID0gKGVycm9yOiBXU0Vycm9yVHlwZSk6IGJvb2xlYW4gPT4ge1xuICAgIHJldHVybiBlcnJvci5NRVNTQUdFID09PSBJTlZBTElEX1NVQlxuICB9XG4gIHJldHVybiAoKSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdENvbmZpZyA9IGNvbmZpZyB8fCBtYWtlQ29uZmlnKClcbiAgICByZXR1cm4ge1xuICAgICAgY29ubmVjdGlvbjoge1xuICAgICAgICB1cmw6IHdpdGhBcGlLZXkoXG4gICAgICAgICAgZGVmYXVsdENvbmZpZy5hcGkuYmFzZVdzVVJMIHx8IERFRkFVTFRfV1NfQVBJX0VORFBPSU5ULFxuICAgICAgICAgIGRlZmF1bHRDb25maWcuYXBpS2V5IHx8ICcnLFxuICAgICAgICApLFxuICAgICAgICBwcm90b2NvbDogeyBxdWVyeTogeyBhcGlfa2V5OiBkZWZhdWx0Q29uZmlnLmFwaUtleSB9IH0sXG4gICAgICB9LFxuICAgICAgc3Vic2NyaWJlOiAoaW5wdXQpID0+IGdldFN1YnNjcmlwdGlvbignU3ViQWRkJywgZ2V0UGFpcihpbnB1dCkpLFxuICAgICAgdW5zdWJzY3JpYmU6IChpbnB1dCkgPT4gZ2V0U3Vic2NyaXB0aW9uKCdTdWJSZW1vdmUnLCBnZXRQYWlyKGlucHV0KSksXG4gICAgICBzdWJzRnJvbU1lc3NhZ2U6IChtZXNzYWdlKSA9PlxuICAgICAgICBnZXRTdWJzY3JpcHRpb24oJ1N1YkFkZCcsIGAke21lc3NhZ2U/LkZST01TWU1CT0x9fiR7bWVzc2FnZT8uVE9TWU1CT0x9YCksXG4gICAgICBpc0Vycm9yOiAobWVzc2FnZTogYW55KSA9PiBOdW1iZXIobWVzc2FnZS5UWVBFKSA+IDQwMCAmJiBOdW1iZXIobWVzc2FnZS5UWVBFKSA8IDkwMCxcbiAgICAgIGZpbHRlcjogKG1lc3NhZ2UpID0+IHtcbiAgICAgICAgLy8gSWdub3JlIGV2ZXJ5dGhpbmcgaXMgbm90IGZyb20gdGhlIHdhbnRlZCBjaGFubmVsc1xuICAgICAgICBjb25zdCBjb2RlID0gTnVtYmVyKG1lc3NhZ2UuVFlQRSlcbiAgICAgICAgY29uc3QgZmxhZyA9IE51bWJlcihtZXNzYWdlLkZMQUdTKSAvLyBmbGFncyA9IDQgKG1lYW5zIHByaWNlIHVuY2hhbmdlZCwgUFJJQ0UgcGFyYW1ldGVyIG5vdCBpbmNsdWRlZClcbiAgICAgICAgcmV0dXJuIChjb2RlID09PSBzdWJzY3JpcHRpb25zLnRpY2tlciB8fCBjb2RlID09PSBzdWJzY3JpcHRpb25zLmFnZ3JlZ2F0ZSkgJiYgZmxhZyAhPT0gNFxuICAgICAgfSxcbiAgICAgIHRvUmVzcG9uc2U6IChtZXNzYWdlOiBhbnkpID0+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gUmVxdWVzdGVyLnZhbGlkYXRlUmVzdWx0TnVtYmVyKG1lc3NhZ2UsIFsnUFJJQ0UnXSlcbiAgICAgICAgcmV0dXJuIFJlcXVlc3Rlci5zdWNjZXNzKCcxJywgeyBkYXRhOiB7IHJlc3VsdCB9IH0pXG4gICAgICB9LFxuICAgICAgc2hvdWxkTm90UmV0cnlTdWJzY3JpcHRpb246IChlcnJvcikgPT4gc2hvdWxkTm90UmV0cnlBZnRlckVycm9yKGVycm9yIGFzIFdTRXJyb3JUeXBlKSxcbiAgICB9XG4gIH1cbn1cbiJdfQ==