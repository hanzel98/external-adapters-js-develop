"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.execute = exports.createRequest = exports.inputParameters = exports.supportedEndpoints = void 0;
const tslib_1 = require("tslib");
const dwolla = tslib_1.__importStar(require("dwolla-v2"));
exports.supportedEndpoints = ['dwolla'];
exports.inputParameters = {
    method: false,
};
const ENV = process.env.ENVIRONMENT || 'sandbox';
const ENDPOINT = ENV.toLowerCase() === 'sandbox' ? 'https://api-sandbox.dwolla.com' : 'https://api.dwolla.com';
const FUNDING_SOURCE = process.env.FUNDING_SOURCE || '';
const client = new dwolla.Client({
    key: process.env.DWOLLA_APP_KEY || '',
    secret: process.env.DWOLLA_APP_SECRET || '',
    environment: ENV || undefined,
});
// Convert xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx (32 chars)
// into xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx format
const convertToLongUUID = (uuid) => {
    if (uuid.length != 32)
        return uuid;
    return uuid.replace(/(.{8})(.{4})(.{4})(.{4})(.{12})/, '$1-$2-$3-$4-$5');
};
const getTransfer = async (id) => {
    return new Promise((resolve, reject) => {
        client.auth
            .client()
            .then((appToken) => appToken.get(ENDPOINT + '/transfers/' + convertToLongUUID(id)))
            .then((res) => resolve({ statusCode: res.status, data: res.body }))
            .catch((err) => {
            reject({ statusCode: err.status, data: err.body.message });
        });
    });
};
const sendTransfer = async (data) => {
    return new Promise((resolve, reject) => {
        if (!('amount' in data) ||
            !('destination' in data) ||
            data.amount.length === 0 ||
            data.destination.length === 0 ||
            (!('source' in data) && FUNDING_SOURCE.length === 0)) {
            return reject({ statusCode: 400, data: 'missing required parameters' });
        }
        const transferRequest = {
            _links: {
                source: {
                    href: ENDPOINT + '/funding-sources/' + convertToLongUUID(data.source || FUNDING_SOURCE),
                },
                destination: {
                    href: ENDPOINT + '/funding-sources/' + convertToLongUUID(data.destination),
                },
            },
            amount: {
                currency: data.currency || 'USD',
                value: data.amount,
            },
        };
        client.auth
            .client()
            .then((appToken) => appToken.post('transfers', transferRequest))
            .then((res) => {
            const location = res.headers.get('location');
            const parts = location.split('/');
            return resolve({
                statusCode: res.status,
                data: {
                    // UUID is given in xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx format
                    // Convert to xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
                    result: parts[parts.length - 1].replace(/-/g, ''),
                },
            });
        })
            .catch((err) => {
            reject({ statusCode: err.status, data: err.body.message });
        });
    });
};
const createRequest = async (input) => {
    return new Promise((resolve, reject) => {
        const data = input.data;
        const method = process.env.API_METHOD || data.method || '';
        switch (method.toLowerCase()) {
            case 'sendtransfer':
                sendTransfer(data)
                    .then(resolve)
                    .catch(reject);
                break;
            case 'gettransfer':
                // eslint-disable-next-line no-case-declarations
                const getData = data;
                if (!('transfer_id' in getData))
                    return reject({ statusCode: 400, data: 'missing required parameters' });
                getTransfer(getData.transfer_id)
                    .then((response) => {
                    response.data.result = response.data.status || '';
                    return resolve(response);
                })
                    .catch(reject);
                break;
            default:
                return reject({ statusCode: 400, data: 'Invalid method' });
        }
    });
};
exports.createRequest = createRequest;
const execute = async (req) => {
    return new Promise((resolve) => {
        const response = { jobRunID: req.id || '' };
        exports.createRequest(req)
            .then(({ statusCode, data }) => {
            response.status = 'success';
            response.data = data;
            response.statusCode = statusCode;
            resolve(response);
        })
            .catch(({ statusCode, data }) => {
            response.status = 'errored';
            response.error = data;
            response.statusCode = statusCode;
            resolve(response);
        });
    });
};
exports.execute = execute;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHdvbGxhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2VuZHBvaW50L2R3b2xsYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBQUEsMERBQW1DO0FBR3RCLFFBQUEsa0JBQWtCLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQTtBQUUvQixRQUFBLGVBQWUsR0FBb0I7SUFDOUMsTUFBTSxFQUFFLEtBQUs7Q0FDZCxDQUFBO0FBK0JELE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLFNBQVMsQ0FBQTtBQUNoRCxNQUFNLFFBQVEsR0FDWixHQUFHLENBQUMsV0FBVyxFQUFFLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDLENBQUMsd0JBQXdCLENBQUE7QUFDL0YsTUFBTSxjQUFjLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksRUFBRSxDQUFBO0FBRXZELE1BQU0sTUFBTSxHQUFRLElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNwQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksRUFBRTtJQUNyQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxFQUFFO0lBQzNDLFdBQVcsRUFBRyxHQUFnQyxJQUFJLFNBQVM7Q0FDNUQsQ0FBQyxDQUFBO0FBRUYsc0RBQXNEO0FBQ3RELG1EQUFtRDtBQUNuRCxNQUFNLGlCQUFpQixHQUFHLENBQUMsSUFBWSxFQUFVLEVBQUU7SUFDakQsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLEVBQUU7UUFBRSxPQUFPLElBQUksQ0FBQTtJQUNsQyxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsaUNBQWlDLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQTtBQUMxRSxDQUFDLENBQUE7QUFFRCxNQUFNLFdBQVcsR0FBRyxLQUFLLEVBQUUsRUFBVSxFQUFFLEVBQUU7SUFDdkMsT0FB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QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGR3b2xsYSBmcm9tICdkd29sbGEtdjInXG5pbXBvcnQgeyBJbnB1dFBhcmFtZXRlcnMgfSBmcm9tICdAY2hhaW5saW5rL3R5cGVzJ1xuXG5leHBvcnQgY29uc3Qgc3VwcG9ydGVkRW5kcG9pbnRzID0gWydkd29sbGEnXVxuXG5leHBvcnQgY29uc3QgaW5wdXRQYXJhbWV0ZXJzOiBJbnB1dFBhcmFtZXRlcnMgPSB7XG4gIG1ldGhvZDogZmFsc2UsXG59XG5cbnR5cGUgUmVzcG9uc2UgPSB7XG4gIGpvYlJ1bklEOiBzdHJpbmdcbiAgc3RhdHVzQ29kZTogbnVtYmVyXG4gIHN0YXR1cz86IHN0cmluZ1xuICBkYXRhOiBhbnlcbiAgcmVzdWx0OiBhbnlcbiAgZXJyb3I/OiBhbnlcbn1cblxuZXhwb3J0IHR5cGUgSm9iUmVxdWVzdCA9IHtcbiAgaWQ6IHN0cmluZ1xuICBkYXRhOiBSZXF1ZXN0XG59XG5cbmV4cG9ydCB0eXBlIFJlcXVlc3QgPSB7XG4gIG1ldGhvZD86IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBHZXRSZXF1ZXN0ID0gUmVxdWVzdCAmIHtcbiAgdHJhbnNmZXJfaWQ6IHN0cmluZ1xufVxuXG5leHBvcnQgdHlwZSBTZW5kUmVxdWVzdCA9IFJlcXVlc3QgJiB7XG4gIGRlc3RpbmF0aW9uOiBzdHJpbmdcbiAgYW1vdW50OiBzdHJpbmdcbiAgY3VycmVuY3k/OiBzdHJpbmdcbiAgc291cmNlPzogc3RyaW5nXG59XG5cbmNvbnN0IEVOViA9IHByb2Nlc3MuZW52LkVOVklST05NRU5UIHx8ICdzYW5kYm94J1xuY29uc3QgRU5EUE9JTlQgPVxuICBFTlYudG9Mb3dlckNhc2UoKSA9PT0gJ3NhbmRib3gnID8gJ2h0dHBzOi8vYXBpLXNhbmRib3guZHdvbGxhLmNvbScgOiAnaHR0cHM6Ly9hcGkuZHdvbGxhLmNvbSdcbmNvbnN0IEZVTkRJTkdfU09VUkNFID0gcHJvY2Vzcy5lbnYuRlVORElOR19TT1VSQ0UgfHwgJydcblxuY29uc3QgY2xpZW50OiBhbnkgPSBuZXcgZHdvbGxhLkNsaWVudCh7XG4gIGtleTogcHJvY2Vzcy5lbnYuRFdPTExBX0FQUF9LRVkgfHwgJycsXG4gIHNlY3JldDogcHJvY2Vzcy5lbnYuRFdPTExBX0FQUF9TRUNSRVQgfHwgJycsXG4gIGVudmlyb25tZW50OiAoRU5WIGFzICdzYW5kYm94JyB8ICdwcm9kdWN0aW9uJykgfHwgdW5kZWZpbmVkLFxufSlcblxuLy8gQ29udmVydCB4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eCAoMzIgY2hhcnMpXG4vLyBpbnRvIHh4eHh4eHh4LXh4eHgteHh4eC14eHh4LXh4eHh4eHh4eHh4eCBmb3JtYXRcbmNvbnN0IGNvbnZlcnRUb0xvbmdVVUlEID0gKHV1aWQ6IHN0cmluZyk6IHN0cmluZyA9PiB7XG4gIGlmICh1dWlkLmxlbmd0aCAhPSAzMikgcmV0dXJuIHV1aWRcbiAgcmV0dXJuIHV1aWQucmVwbGFjZSgvKC57OH0pKC57NH0pKC57NH0pKC57NH0pKC57MTJ9KS8sICckMS0kMi0kMy0kNC0kNScpXG59XG5cbmNvbnN0IGdldFRyYW5zZmVyID0gYXN5bmMgKGlkOiBzdHJpbmcpID0+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjbGllbnQuYXV0aFxuICAgICAgLmNsaWVudCgpXG4gICAgICAudGhlbigoYXBwVG9rZW46IGFueSkgPT4gYXBwVG9rZW4uZ2V0KEVORFBPSU5UICsgJy90cmFuc2ZlcnMvJyArIGNvbnZlcnRUb0xvbmdVVUlEKGlkKSkpXG4gICAgICAudGhlbigocmVzOiBhbnkpID0+IHJlc29sdmUoeyBzdGF0dXNDb2RlOiByZXMuc3RhdHVzLCBkYXRhOiByZXMuYm9keSB9KSlcbiAgICAgIC5jYXRjaCgoZXJyOiBhbnkpID0+IHtcbiAgICAgICAgcmVqZWN0KHsgc3RhdHVzQ29kZTogZXJyLnN0YXR1cywgZGF0YTogZXJyLmJvZHkubWVzc2FnZSB9KVxuICAgICAgfSlcbiAgfSlcbn1cblxuY29uc3Qgc2VuZFRyYW5zZmVyID0gYXN5bmMgKGRhdGE6IFNlbmRSZXF1ZXN0KSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgaWYgKFxuICAgICAgISgnYW1vdW50JyBpbiBkYXRhKSB8fFxuICAgICAgISgnZGVzdGluYXRpb24nIGluIGRhdGEpIHx8XG4gICAgICBkYXRhLmFtb3VudC5sZW5ndGggPT09IDAgfHxcbiAgICAgIGRhdGEuZGVzdGluYXRpb24ubGVuZ3RoID09PSAwIHx8XG4gICAgICAoISgnc291cmNlJyBpbiBkYXRhKSAmJiBGVU5ESU5HX1NPVVJDRS5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICByZXR1cm4gcmVqZWN0KHsgc3RhdHVzQ29kZTogNDAwLCBkYXRhOiAnbWlzc2luZyByZXF1aXJlZCBwYXJhbWV0ZXJzJyB9KVxuICAgIH1cblxuICAgIGNvbnN0IHRyYW5zZmVyUmVxdWVzdCA9IHtcbiAgICAgIF9saW5rczoge1xuICAgICAgICBzb3VyY2U6IHtcbiAgICAgICAgICBocmVmOiBFTkRQT0lOVCArICcvZnVuZGluZy1zb3VyY2VzLycgKyBjb252ZXJ0VG9Mb25nVVVJRChkYXRhLnNvdXJjZSB8fCBGVU5ESU5HX1NPVVJDRSksXG4gICAgICAgIH0sXG4gICAgICAgIGRlc3RpbmF0aW9uOiB7XG4gICAgICAgICAgaHJlZjogRU5EUE9JTlQgKyAnL2Z1bmRpbmctc291cmNlcy8nICsgY29udmVydFRvTG9uZ1VVSUQoZGF0YS5kZXN0aW5hdGlvbiksXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAgYW1vdW50OiB7XG4gICAgICAgIGN1cnJlbmN5OiBkYXRhLmN1cnJlbmN5IHx8ICdVU0QnLFxuICAgICAgICB2YWx1ZTogZGF0YS5hbW91bnQsXG4gICAgICB9LFxuICAgIH1cblxuICAgIGNsaWVudC5hdXRoXG4gICAgICAuY2xpZW50KClcbiAgICAgIC50aGVuKChhcHBUb2tlbjogYW55KSA9PiBhcHBUb2tlbi5wb3N0KCd0cmFuc2ZlcnMnLCB0cmFuc2ZlclJlcXVlc3QpKVxuICAgICAgLnRoZW4oKHJlczogYW55KSA9PiB7XG4gICAgICAgIGNvbnN0IGxvY2F0aW9uID0gcmVzLmhlYWRlcnMuZ2V0KCdsb2NhdGlvbicpXG4gICAgICAgIGNvbnN0IHBhcnRzID0gbG9jYXRpb24uc3BsaXQoJy8nKVxuICAgICAgICByZXR1cm4gcmVzb2x2ZSh7XG4gICAgICAgICAgc3RhdHVzQ29kZTogcmVzLnN0YXR1cyxcbiAgICAgICAgICBkYXRhOiB7XG4gICAgICAgICAgICAvLyBVVUlEIGlzIGdpdmVuIGluIHh4eHh4eHh4LXh4eHgteHh4eC14eHh4LXh4eHh4eHh4eHh4eCBmb3JtYXRcbiAgICAgICAgICAgIC8vIENvbnZlcnQgdG8geHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHhcbiAgICAgICAgICAgIHJlc3VsdDogcGFydHNbcGFydHMubGVuZ3RoIC0gMV0ucmVwbGFjZSgvLS9nLCAnJyksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKGVycjogYW55KSA9PiB7XG4gICAgICAgIHJlamVjdCh7IHN0YXR1c0NvZGU6IGVyci5zdGF0dXMsIGRhdGE6IGVyci5ib2R5Lm1lc3NhZ2UgfSlcbiAgICAgIH0pXG4gIH0pXG59XG5cbmV4cG9ydCBjb25zdCBjcmVhdGVSZXF1ZXN0ID0gYXN5bmMgKGlucHV0OiBKb2JSZXF1ZXN0KSA9PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgY29uc3QgZGF0YSA9IGlucHV0LmRhdGFcbiAgICBjb25zdCBtZXRob2QgPSBwcm9jZXNzLmVudi5BUElfTUVUSE9EIHx8IGRhdGEubWV0aG9kIHx8ICcnXG4gICAgc3dpdGNoIChtZXRob2QudG9Mb3dlckNhc2UoKSkge1xuICAgICAgY2FzZSAnc2VuZHRyYW5zZmVyJzpcbiAgICAgICAgc2VuZFRyYW5zZmVyKGRhdGEgYXMgU2VuZFJlcXVlc3QpXG4gICAgICAgICAgLnRoZW4ocmVzb2x2ZSlcbiAgICAgICAgICAuY2F0Y2gocmVqZWN0KVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnZ2V0dHJhbnNmZXInOlxuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY2FzZS1kZWNsYXJhdGlvbnNcbiAgICAgICAgY29uc3QgZ2V0RGF0YSA9IGRhdGEgYXMgR2V0UmVxdWVzdFxuICAgICAgICBpZiAoISgndHJhbnNmZXJfaWQnIGluIGdldERhdGEpKVxuICAgICAgICAgIHJldHVybiByZWplY3QoeyBzdGF0dXNDb2RlOiA0MDAsIGRhdGE6ICdtaXNzaW5nIHJlcXVpcmVkIHBhcmFtZXRlcnMnIH0pXG5cbiAgICAgICAgZ2V0VHJhbnNmZXIoZ2V0RGF0YS50cmFuc2Zlcl9pZClcbiAgICAgICAgICAudGhlbigocmVzcG9uc2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgcmVzcG9uc2UuZGF0YS5yZXN1bHQgPSByZXNwb25zZS5kYXRhLnN0YXR1cyB8fCAnJ1xuICAgICAgICAgICAgcmV0dXJuIHJlc29sdmUocmVzcG9uc2UpXG4gICAgICAgICAgfSlcbiAgICAgICAgICAuY2F0Y2gocmVqZWN0KVxuICAgICAgICBicmVha1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHJlamVjdCh7IHN0YXR1c0NvZGU6IDQwMCwgZGF0YTogJ0ludmFsaWQgbWV0aG9kJyB9KVxuICAgIH1cbiAgfSlcbn1cblxuZXhwb3J0IGNvbnN0IGV4ZWN1dGUgPSBhc3luYyAocmVxOiBKb2JSZXF1ZXN0KTogUHJvbWlzZTxSZXNwb25zZT4gPT4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8UmVzcG9uc2U+KChyZXNvbHZlKSA9PiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSA8UmVzcG9uc2U+eyBqb2JSdW5JRDogcmVxLmlkIHx8ICcnIH1cbiAgICBjcmVhdGVSZXF1ZXN0KHJlcSlcbiAgICAgIC50aGVuKCh7IHN0YXR1c0NvZGUsIGRhdGEgfTogYW55KSA9PiB7XG4gICAgICAgIHJlc3BvbnNlLnN0YXR1cyA9ICdzdWNjZXNzJ1xuICAgICAgICByZXNwb25zZS5kYXRhID0gZGF0YVxuICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZVxuICAgICAgICByZXNvbHZlKHJlc3BvbnNlKVxuICAgICAgfSlcbiAgICAgIC5jYXRjaCgoeyBzdGF0dXNDb2RlLCBkYXRhIH0pID0+IHtcbiAgICAgICAgcmVzcG9uc2Uuc3RhdHVzID0gJ2Vycm9yZWQnXG4gICAgICAgIHJlc3BvbnNlLmVycm9yID0gZGF0YVxuICAgICAgICByZXNwb25zZS5zdGF0dXNDb2RlID0gc3RhdHVzQ29kZVxuICAgICAgICByZXNvbHZlKHJlc3BvbnNlKVxuICAgICAgfSlcbiAgfSlcbn1cbiJdfQ==