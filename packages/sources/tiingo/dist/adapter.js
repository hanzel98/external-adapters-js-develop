"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeWSHandler = exports.makeExecute = exports.endpointSelector = exports.execute = void 0;
const tslib_1 = require("tslib");
const ea_bootstrap_1 = require("@chainlink/ea-bootstrap");
const config_1 = require("./config");
const endpoints = tslib_1.__importStar(require("./endpoint"));
const execute = async (request, context, config) => {
    return ea_bootstrap_1.Builder.buildSelector(request, context, config, endpoints);
};
exports.execute = execute;
const endpointSelector = (request) => ea_bootstrap_1.Builder.selectEndpoint(request, config_1.makeConfig(), endpoints);
exports.endpointSelector = endpointSelector;
const makeExecute = (config) => {
    return async (request, context) => exports.execute(request, context, config || config_1.makeConfig());
};
exports.makeExecute = makeExecute;
const customParams = {
    base: ['base', 'from', 'coin', 'ticker'],
};
const makeWSHandler = (config) => {
    const getSubscription = (ticker, subscribe = true) => {
        const defaultConfig = config || config_1.makeConfig();
        if (!ticker)
            return;
        return {
            eventName: subscribe ? 'subscribe' : 'unsubscribe',
            authorization: defaultConfig?.apiKey,
            eventData: {
                thresholdLevel: 5,
                tickers: [ticker],
            },
        };
    };
    const getTicker = (input) => {
        const validator = new ea_bootstrap_1.Validator(input, customParams, {}, false);
        if (validator.error)
            return;
        const base = validator.validated.data.base.toLowerCase();
        return base;
    };
    return () => {
        const defaultConfig = config || config_1.makeConfig();
        return {
            connection: {
                url: defaultConfig.api.baseWsURL || config_1.DEFAULT_WS_API_ENDPOINT,
            },
            shouldNotServeInputUsingWS: (input) => endpoints.iex.supportedEndpoints.indexOf(input.data.endpoint) === -1,
            subscribe: (input) => getSubscription(getTicker(input)),
            unsubscribe: (input) => getSubscription(getTicker(input), false),
            isError: (message) => message.messageType === 'E',
            filter: (message) => message.messageType === 'A',
            subsFromMessage: (message) => message.data && getSubscription(message.data[1]),
            toResponse: (message) => {
                const result = ea_bootstrap_1.Requester.validateResultNumber(message.data, [5]);
                return ea_bootstrap_1.Requester.success('1', { data: { result } }, true);
            },
        };
    };
};
exports.makeWSHandler = makeWSHandler;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSwwREFBdUU7QUFTdkUscUNBQThEO0FBQzlELDhEQUF1QztBQUVoQyxNQUFNLE9BQU8sR0FBOEIsS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDbkYsT0FBTyxzQkFBTyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQTtBQUNuRSxDQUFDLENBQUE7QUFGWSxRQUFBLE9BQU8sV0FFbkI7QUFFTSxNQUFNLGdCQUFnQixHQUFHLENBQUMsT0FBdUIsRUFBZSxFQUFFLENBQ3ZFLHNCQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxtQkFBVSxFQUFFLEVBQUUsU0FBUyxDQUFDLENBQUE7QUFEN0MsUUFBQSxnQkFBZ0Isb0JBQzZCO0FBRW5ELE1BQU0sV0FBVyxHQUEyQixDQUFDLE1BQU0sRUFBRSxFQUFFO0lBQzVELE9BQU8sS0FBSyxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxDQUFDLGVBQU8sQ0FBQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sSUFBSSxtQkFBVSxFQUFFLENBQUMsQ0FBQTtBQUN0RixDQUFDLENBQUE7QUFGWSxRQUFBLFdBQVcsZUFFdkI7QUF1Q0QsTUFBTSxZQUFZLEdBQUc7SUFDbkIsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsUUFBUSxDQUFDO0NBQ3pDLENBQUE7QUFFTSxNQUFNLGFBQWEsR0FBRyxDQUFDLE1BQWUsRUFBNkIsRUFBRTtJQUMxRSxNQUFNLGVBQWUsR0FBRyxDQUFDLE1BQTBCLEVBQUUsU0FBUyxHQUFHLElBQUksRUFBRSxFQUFFO1FBQ3ZFLE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBSSxtQkFBVSxFQUFFLENBQUE7UUFDNUMsSUFBSSxDQUFDLE1BQU07WUFBRSxPQUFNO1FBQ25CLE9BQU87WUFDTCxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLGFBQWE7WUFDbEQsYUFBYSxFQUFFLGFBQWEsRUFBRSxNQUFNO1lBQ3BDLFNBQVMsRUFBRTtnQkFDVCxjQUFjLEVBQUUsQ0FBQztnQkFDakIsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDO2FBQ2xCO1NBQ0YsQ0FBQTtJQUNILENBQUMsQ0FBQTtJQUNELE1BQU0sU0FBUyxHQUFHLENBQUMsS0FBcUIsRUFBc0IsRUFBRTtRQUM5RCxNQUFNLFNBQVMsR0FBRyxJQUFJLHdCQUFTLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFDL0QsSUFBSSxTQUFTLENBQUMsS0FBSztZQUFFLE9BQU07UUFDM0IsTUFBTSxJQUFJLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ3hELE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQyxDQUFBO0lBQ0QsT0FBTyxHQUFHLEVBQUU7UUFDVixNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksbUJBQVUsRUFBRSxDQUFBO1FBQzVDLE9BQU87WUFDTCxVQUFVLEVBQUU7Z0JBQ1YsR0FBRyxFQUFFLGFBQWEsQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLGdDQUF1QjthQUM1RDtZQUNELDBCQUEwQixFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDcEMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEUsU0FBUyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZELFdBQVcsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLENBQUM7WUFDaEUsT0FBTyxFQUFFLENBQUMsT0FBZ0IsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFdBQVcsS0FBSyxHQUFHO1lBQzFELE1BQU0sRUFBRSxDQUFDLE9BQWdCLEVBQUUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEtBQUssR0FBRztZQUN6RCxlQUFlLEVBQUUsQ0FBQyxPQUFzQixFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLGVBQWUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdGLFVBQVUsRUFBRSxDQUFDLE9BQXNCLEVBQUUsRUFBRTtnQkFDckMsTUFBTSxNQUFNLEdBQUcsd0JBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDaEUsT0FBTyx3QkFBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFBO1lBQzNELENBQUM7U0FDRixDQUFBO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFBO0FBdENZLFFBQUEsYUFBYSxpQkFzQ3pCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVxdWVzdGVyLCBWYWxpZGF0b3IsIEJ1aWxkZXIgfSBmcm9tICdAY2hhaW5saW5rL2VhLWJvb3RzdHJhcCdcbmltcG9ydCB7XG4gIEFkYXB0ZXJSZXF1ZXN0LFxuICBDb25maWcsXG4gIEV4ZWN1dGVGYWN0b3J5LFxuICBFeGVjdXRlV2l0aENvbmZpZyxcbiAgTWFrZVdTSGFuZGxlcixcbiAgQVBJRW5kcG9pbnQsXG59IGZyb20gJ0BjaGFpbmxpbmsvdHlwZXMnXG5pbXBvcnQgeyBERUZBVUxUX1dTX0FQSV9FTkRQT0lOVCwgbWFrZUNvbmZpZyB9IGZyb20gJy4vY29uZmlnJ1xuaW1wb3J0ICogYXMgZW5kcG9pbnRzIGZyb20gJy4vZW5kcG9pbnQnXG5cbmV4cG9ydCBjb25zdCBleGVjdXRlOiBFeGVjdXRlV2l0aENvbmZpZzxDb25maWc+ID0gYXN5bmMgKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZykgPT4ge1xuICByZXR1cm4gQnVpbGRlci5idWlsZFNlbGVjdG9yKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZywgZW5kcG9pbnRzKVxufVxuXG5leHBvcnQgY29uc3QgZW5kcG9pbnRTZWxlY3RvciA9IChyZXF1ZXN0OiBBZGFwdGVyUmVxdWVzdCk6IEFQSUVuZHBvaW50ID0+XG4gIEJ1aWxkZXIuc2VsZWN0RW5kcG9pbnQocmVxdWVzdCwgbWFrZUNvbmZpZygpLCBlbmRwb2ludHMpXG5cbmV4cG9ydCBjb25zdCBtYWtlRXhlY3V0ZTogRXhlY3V0ZUZhY3Rvcnk8Q29uZmlnPiA9IChjb25maWcpID0+IHtcbiAgcmV0dXJuIGFzeW5jIChyZXF1ZXN0LCBjb250ZXh0KSA9PiBleGVjdXRlKHJlcXVlc3QsIGNvbnRleHQsIGNvbmZpZyB8fCBtYWtlQ29uZmlnKCkpXG59XG5cbnR5cGUgTWVzc2FnZVR5cGUgPVxuICB8ICdBJyAvLyBmb3IgbmV3IGRhdGFcbiAgfCAnVScgLy8gZm9yIHVwZGF0aW5nIGV4aXN0aW5nIGRhdGFcbiAgfCAnRCcgLy8gZm9yIGRlbGVpbmcgZXhpc3RpbmcgZGF0YVxuICB8ICdJJyAvLyBmb3IgaW5mb3JtYXRpb25hbC9tZXRhIGRhdGFcbiAgfCAnRScgLy8gZm9yIGVycm9yIG1lc3NhZ2VzXG4gIHwgJ0gnIC8vIGZvciBIZWFydGJlYXRzIChjYW4gYmUgaWdub3JlZCBmb3IgbW9zdCBjYXNlcylcbmludGVyZmFjZSBNZXNzYWdlIHtcbiAgc2VydmljZTogc3RyaW5nXG4gIHJlc3BvbnNlOiB7IG1lc3NhZ2U6IHN0cmluZzsgY29kZTogbnVtYmVyIH1cbiAgbWVzc2FnZVR5cGU6IE1lc3NhZ2VUeXBlXG59XG5pbnRlcmZhY2UgVG9wT2ZCb29rVXBkYXRlRGF0YSB7XG4gIDA6ICdRJ1xuICAxOiBzdHJpbmcgLy8gVGlja2VyIHJlbGF0ZWQgdG8gdGhlIGFzc2V0LlxuICAyOiBzdHJpbmcgLy8gQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBkYXRldGltZSB0aGlzIHRyYWRlIHF1b3RlIGNhbWUgaW4uXG4gIDM6IHN0cmluZyAvLyBUaGUgZXhjaGFuZ2UgdGhlIHRvcC1vZi1ib29rIHVwZGF0ZSBpcyBmb3IuXG4gIDQ6IG51bWJlciAvLyBUaGUgYW1vdW50IG9mIGNyeXB0byBhdCB0aGUgYmlkIHByaWNlIGluIHRoZSBiYXNlIGN1cnJlbmN5LlxuICA1OiBudW1iZXIgLy8gVGhlIGN1cnJlbnQgaGlnaGVzdCBiaWQgcHJpY2UuXG4gIDY6IG51bWJlciAvLyBUaGUgbWlkIHByaWNlIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcCB3aGVuIGJvdGggXCJiaWRQcmljZVwiIGFuZCBcImFza1ByaWNlXCIgYXJlIG5vdC1udWxsLiBJbiBtYXRoZW1hdGljYWwgdGVybXM6IG1pZCA9IChiaWRQcmljZSArIGFza1ByaWNlKS8yLjBcbiAgNzogbnVtYmVyIC8vIFRoZSBhbW91bnQgb2YgY3J5cHRvIGF0IHRoZSBhc2sgcHJpY2UgaW4gdGhlIGJhc2UgY3VycmVuY3kuXG4gIDg6IG51bWJlciAvLyBUaGUgY3VycmVudCBsb3dlc3QgYXNrIHByaWNlLlxufVxuaW50ZXJmYWNlIFRyYWRlVXBkYXRlRGF0YSB7XG4gIDA6ICdUJ1xuICAxOiBzdHJpbmcgLy8gVGlja2VyIHJlbGF0ZWQgdG8gdGhlIGFzc2V0LlxuICAyOiBzdHJpbmcgLy8gQSBzdHJpbmcgcmVwcmVzZW50aW5nIHRoZSBkYXRldGltZSB0aGlzIHRyYWRlIHF1b3RlIGNhbWUgaW4uXG4gIDM6IHN0cmluZyAvLyBUaGUgZXhjaGFuZ2UgdGhlIHRyYWRlIHdhcyBkb25lIG9uZS5cbiAgNDogbnVtYmVyIC8vIFRoZSBhbW91bnQgb2YgY3J5cHRvIHZvbHVtZSBkb25lIGF0IHRoZSBsYXN0IHByaWNlIGluIHRoZSBiYXNlIGN1cnJlbmN5LlxuICA1OiBudW1iZXIgLy8gVGhlIGxhc3QgcHJpY2UgdGhlIGxhc3QgdHJhZGUgd2FzIGV4ZWN1dGVkIGF0LlxufVxuaW50ZXJmYWNlIFVwZGF0ZU1lc3NhZ2UgZXh0ZW5kcyBNZXNzYWdlIHtcbiAgbWVzc2FnZVR5cGU6ICdBJ1xuICBzZXJ2aWNlOiAnY3J5cHRvX2RhdGEnXG4gIGRhdGE6IFRvcE9mQm9va1VwZGF0ZURhdGEgfCBUcmFkZVVwZGF0ZURhdGFcbn1cblxuY29uc3QgY3VzdG9tUGFyYW1zID0ge1xuICBiYXNlOiBbJ2Jhc2UnLCAnZnJvbScsICdjb2luJywgJ3RpY2tlciddLFxufVxuXG5leHBvcnQgY29uc3QgbWFrZVdTSGFuZGxlciA9IChjb25maWc/OiBDb25maWcpOiBNYWtlV1NIYW5kbGVyIHwgdW5kZWZpbmVkID0+IHtcbiAgY29uc3QgZ2V0U3Vic2NyaXB0aW9uID0gKHRpY2tlcjogc3RyaW5nIHwgdW5kZWZpbmVkLCBzdWJzY3JpYmUgPSB0cnVlKSA9PiB7XG4gICAgY29uc3QgZGVmYXVsdENvbmZpZyA9IGNvbmZpZyB8fCBtYWtlQ29uZmlnKClcbiAgICBpZiAoIXRpY2tlcikgcmV0dXJuXG4gICAgcmV0dXJuIHtcbiAgICAgIGV2ZW50TmFtZTogc3Vic2NyaWJlID8gJ3N1YnNjcmliZScgOiAndW5zdWJzY3JpYmUnLFxuICAgICAgYXV0aG9yaXphdGlvbjogZGVmYXVsdENvbmZpZz8uYXBpS2V5LFxuICAgICAgZXZlbnREYXRhOiB7XG4gICAgICAgIHRocmVzaG9sZExldmVsOiA1LCAvLyBvbmx5IExhc3QgVHJhZGUgdXBkYXRlc1xuICAgICAgICB0aWNrZXJzOiBbdGlja2VyXSxcbiAgICAgIH0sXG4gICAgfVxuICB9XG4gIGNvbnN0IGdldFRpY2tlciA9IChpbnB1dDogQWRhcHRlclJlcXVlc3QpOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICAgIGNvbnN0IHZhbGlkYXRvciA9IG5ldyBWYWxpZGF0b3IoaW5wdXQsIGN1c3RvbVBhcmFtcywge30sIGZhbHNlKVxuICAgIGlmICh2YWxpZGF0b3IuZXJyb3IpIHJldHVyblxuICAgIGNvbnN0IGJhc2UgPSB2YWxpZGF0b3IudmFsaWRhdGVkLmRhdGEuYmFzZS50b0xvd2VyQ2FzZSgpXG4gICAgcmV0dXJuIGJhc2VcbiAgfVxuICByZXR1cm4gKCkgPT4ge1xuICAgIGNvbnN0IGRlZmF1bHRDb25maWcgPSBjb25maWcgfHwgbWFrZUNvbmZpZygpXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbm5lY3Rpb246IHtcbiAgICAgICAgdXJsOiBkZWZhdWx0Q29uZmlnLmFwaS5iYXNlV3NVUkwgfHwgREVGQVVMVF9XU19BUElfRU5EUE9JTlQsXG4gICAgICB9LFxuICAgICAgc2hvdWxkTm90U2VydmVJbnB1dFVzaW5nV1M6IChpbnB1dCkgPT5cbiAgICAgICAgZW5kcG9pbnRzLmlleC5zdXBwb3J0ZWRFbmRwb2ludHMuaW5kZXhPZihpbnB1dC5kYXRhLmVuZHBvaW50KSA9PT0gLTEsXG4gICAgICBzdWJzY3JpYmU6IChpbnB1dCkgPT4gZ2V0U3Vic2NyaXB0aW9uKGdldFRpY2tlcihpbnB1dCkpLFxuICAgICAgdW5zdWJzY3JpYmU6IChpbnB1dCkgPT4gZ2V0U3Vic2NyaXB0aW9uKGdldFRpY2tlcihpbnB1dCksIGZhbHNlKSxcbiAgICAgIGlzRXJyb3I6IChtZXNzYWdlOiBNZXNzYWdlKSA9PiBtZXNzYWdlLm1lc3NhZ2VUeXBlID09PSAnRScsXG4gICAgICBmaWx0ZXI6IChtZXNzYWdlOiBNZXNzYWdlKSA9PiBtZXNzYWdlLm1lc3NhZ2VUeXBlID09PSAnQScsXG4gICAgICBzdWJzRnJvbU1lc3NhZ2U6IChtZXNzYWdlOiBVcGRhdGVNZXNzYWdlKSA9PiBtZXNzYWdlLmRhdGEgJiYgZ2V0U3Vic2NyaXB0aW9uKG1lc3NhZ2UuZGF0YVsxXSksXG4gICAgICB0b1Jlc3BvbnNlOiAobWVzc2FnZTogVXBkYXRlTWVzc2FnZSkgPT4ge1xuICAgICAgICBjb25zdCByZXN1bHQgPSBSZXF1ZXN0ZXIudmFsaWRhdGVSZXN1bHROdW1iZXIobWVzc2FnZS5kYXRhLCBbNV0pXG4gICAgICAgIHJldHVybiBSZXF1ZXN0ZXIuc3VjY2VzcygnMScsIHsgZGF0YTogeyByZXN1bHQgfSB9LCB0cnVlKVxuICAgICAgfSxcbiAgICB9XG4gIH1cbn1cbiJdfQ==